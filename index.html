<!DOCTYPE html>
<html lang="en">
<head>
  <!-- CAP Uniform Builder — Main HTML -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#002855" />
  <link rel="icon" href="images/favicon.png" />
  <title>CAP Class A Uniform Builder</title>

  <!-- Styles -->
  <link rel="stylesheet" href="css/style.css" />

  <!-- sr-only utility -->
  <style>
    .sr-only{
      position:absolute!important;width:1px;height:1px;margin:-1px;border:0;padding:0;
      clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden;white-space:nowrap
    }
  </style>

  <!-- Lib -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <!-- Core utilities -->
  <script src="js/util.js" defer></script>
  <script src="js/state.js" defer></script>
  <script src="js/uniforms.js" defer></script>

  <!-- Data modules -->
  <script src="js/ribbons.data.js" defer></script>
  <script src="js/badges.data.js" defer></script>
  <script src="js/patches.data.js" defer></script>

  <!-- UI modules -->
  <script src="js/ribbons.ui.js" defer></script>
  <script src="js/badges.ui.js" defer></script>
  <script src="js/patches.ui.js" defer></script>
  <script src="js/rank.ui.js" defer></script>

  <!-- Engine / layout -->
  <script src="js/calibration.js" defer></script>
  <script src="js/layout.js" defer></script>
  <script src="js/render.js" defer></script>

  <!-- Dev tools -->
  <script src="js/devtools.js" defer></script>
  <script src="js/devtools.ui.js" defer></script>

  <!-- Optional worker (present in repo) -->
  <script src="js/worker.render.js" defer></script>

  <!-- App bootstrap -->
  <script src="js/app.js" defer></script>
</head>
<body>
  <noscript>
    <div style="padding:12px;background:#fff0f0;border:1px solid #fca5a5;margin:12px;border-radius:8px">
      This app requires JavaScript to render the uniform builder. Please enable JavaScript and reload.
    </div>
  </noscript>

  <!-- Header -->
  <header class="appHeader" role="banner">
    <button id="hamburgerBtn" class="iconBtn" aria-label="Toggle sidebar" type="button">☰</button>
    <h1 class="appTitle">CAP Class A Uniform Builder</h1>
    <div class="headerActions">
      <button id="downloadImage" class="primary" type="button">Download Preview</button>
    </div>
  </header>

  <!-- Layout -->
  <div id="layoutShell" class="layoutShell">
    <!-- Controls panel (ID must be 'controls') -->
    <aside id="controls" class="sidebar" role="complementary" aria-label="Controls panel">
      <!-- Profile -->
      <section class="panelSection">
        <h2 class="panelTitle">Profile</h2>
        <div class="row">
          <label class="sr-only" for="memberSelect">Member type</label>
          <select id="memberSelect" aria-label="Member type">
            <option value="cadet">Cadet</option>
            <option value="senior">Senior</option>
            <option value="senior_nco">Senior NCO</option>
          </select>
        </div>
        <div class="row">
          <label class="sr-only" for="assetBase">Asset base</label>
          <input id="assetBase" type="text" value="images" aria-label="Asset base folder" />
        </div>
      </section>

      <!-- Jacket -->
      <section class="panelSection">
        <h2 class="panelTitle">Jacket</h2>
        <div class="row">
          <label class="sr-only" for="jacketSelect">Jacket</label>
          <select id="jacketSelect" aria-label="Select jacket">
            <option value="male">Male Jacket</option>
            <option value="female">Female Jacket</option>
          </select>
          <button id="applyJacket" type="button">Apply</button>
        </div>
      </section>

      <!-- Ribbons -->
      <section class="panelSection">
        <h2 class="panelTitle">Ribbons</h2>
        <div class="row">
          <button id="toggleRibbonDrag" type="button">Drag Mode</button>
          <button id="clearRibbons" type="button">Clear</button>
        </div>
        <div class="row">
          <button id="logRibbonCoords" type="button">Log Coords</button>
        </div>
        <div id="ribbonPicker" class="pickerList" aria-live="polite"></div>
      </section>

      <!-- Devices -->
      <section class="panelSection">
        <h2 class="panelTitle">Devices</h2>
        <div class="row">
          <button id="deviceApplyModeBtn" type="button">Apply Mode</button>
          <button id="deviceRemoveModeBtn" type="button">Remove Mode</button>
          <button id="deviceClearSelectionBtn" type="button">Clear</button>
        </div>
      </section>

      <!-- Badges -->
      <section class="panelSection">
        <h2 class="panelTitle">Badges</h2>
        <div class="row">
          <label class="sr-only" for="badgeSelect">Badge</label>
          <select id="badgeSelect" aria-label="Select badge"></select>
        </div>
        <div class="row">
          <button id="addBadge" type="button">Add Badge</button>
          <button id="removeBadge" type="button">Remove Badge</button>
        </div>
      </section>

      <!-- Patches -->
      <section class="panelSection">
        <h2 class="panelTitle">Patches</h2>
        <div class="row">
          <label class="sr-only" for="patchSelect">Patch</label>
          <select id="patchSelect" aria-label="Select patch"></select>
        </div>
        <div class="row">
          <button id="addPatch" type="button">Add Patch</button>
          <button id="removePatch" type="button">Remove Patch</button>
        </div>
      </section>

      <!-- Rank -->
      <section class="panelSection">
        <h2 class="panelTitle">Rank</h2>
        <div class="row">
          <label class="sr-only" for="rankSelect">Rank</label>
          <select id="rankSelect" aria-label="Select rank"></select>
        </div>
        <div class="row">
          <button id="addRank" type="button">Apply Rank</button>
        </div>
      </section>

      <!-- Nameplate -->
      <section class="panelSection">
        <h2 class="panelTitle">Nameplate</h2>
        <div class="row">
          <input id="nameplateInput" type="text" placeholder="LAST NAME" aria-label="Nameplate text" />
          <button id="addNameplate" type="button">Apply</button>
        </div>
      </section>

      <!-- Uniform list (used by app.js) -->
      <section class="panelSection">
        <h2 class="panelTitle">Uniforms</h2>
        <div id="uniformList"></div>
      </section>
    </aside>

    <!-- Resizer (ID must be 'panelResizer') -->
    <div id="panelResizer" class="resizer" role="separator" aria-orientation="vertical" aria-label="Resize panel"></div>

    <!-- Main render area -->
    <main id="main" class="main" role="main">
      <div id="panelShell" style="min-height:calc(100vh - 50px);">
        <!-- Wrapper that supports BOTH APIs (app.js + devtools/renderer) -->
        <div id="uniformCanvas" class="canvasShell">
          <div id="canvasShell" class="canvasShell" style="position:relative;">
            <img id="jacketBase" alt="Uniform jacket base" />
            <div id="epauletContainer" class="epauletContainer" aria-hidden="true"></div>
            <div id="overlayLayer" class="overlayLayer"></div>
          </div>
        </div>

        <!-- Hidden asset preloader (ID must be 'assets') -->
        <div id="assets" class="assetPreload" aria-hidden="true" style="display:none"></div>
      </div>
    </main>
  </div>

  <!-- Tooltip (ID must be 'tooltip') -->
  <div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>

  <!-- Footer -->
  <footer class="appFooter" role="contentinfo">
    <small>© <span id="year"></span> C/Capt. Guiseppe Doran — CAP Uniform Builder</small>
  </footer>

  <!-- Bootstraps -->
  <script>
    // Footer year
    (function(){ var y=document.getElementById('year'); if(y) y.textContent=new Date().getFullYear(); })();

    // Sidebar hamburger
    (function(){
      const btn=document.getElementById('hamburgerBtn');
      const shell=document.getElementById('layoutShell');
      if(!btn||!shell) return;
      btn.addEventListener('click',()=> shell.classList.toggle('sidebar-collapsed'));
    })();

    // Default type="button" safety
    (function(){
      document.querySelectorAll('button:not([type])').forEach(b=> b.setAttribute('type','button'));
    })();
  </script>

  <!-- Self-healing boot: ensures containers, sizes layers, loads base, triggers hooks -->
  <script>
  (function(){
    const log = (...a)=>console.log('[BOOT]', ...a);
    const warn = (...a)=>console.warn('[BOOT]', ...a);
    const fail = (...a)=>console.error('[BOOT]', ...a);

    // Containers/IDs
    const uniformCanvas = document.getElementById('uniformCanvas') || (function(){
      const m = document.getElementById('main') || document.body;
      const d = document.createElement('div');
      d.id = 'uniformCanvas';
      d.className = 'canvasShell';
      m.appendChild(d);
      warn('Created missing #uniformCanvas');
      return d;
    })();

    let canvasShell = document.getElementById('canvasShell');
    if (!canvasShell) {
      canvasShell = document.createElement('div');
      canvasShell.id = 'canvasShell';
      canvasShell.className = 'canvasShell';
      uniformCanvas.appendChild(canvasShell);
      warn('Created missing #canvasShell');
    }

    let jacketBase = document.getElementById('jacketBase');
    if (!jacketBase) {
      jacketBase = document.createElement('img');
      jacketBase.id = 'jacketBase';
      jacketBase.alt = 'Uniform jacket base';
      canvasShell.appendChild(jacketBase);
      warn('Created missing #jacketBase');
    }

    let epauletContainer = document.getElementById('epauletContainer');
    if (!epauletContainer) {
      epauletContainer = document.createElement('div');
      epauletContainer.id = 'epauletContainer';
      canvasShell.appendChild(epauletContainer);
      warn('Created missing #epauletContainer');
    }

    let overlayLayer = document.getElementById('overlayLayer');
    if (!overlayLayer) {
      overlayLayer = document.createElement('div');
      overlayLayer.id = 'overlayLayer';
      canvasShell.appendChild(overlayLayer);
      warn('Created missing #overlayLayer');
    }

    // Asset base + default jacket
    const assetBaseInput = document.getElementById('assetBase');
    const ASSET_BASE = (assetBaseInput && assetBaseInput.value) || 'images';
    const basePath = (p)=> `${ASSET_BASE.replace(/\/+$/,'')}/${p.replace(/^\/+/, '')}`;

    const defaultJacket = 'base/jacket_male.png';
    const testSrc = basePath(defaultJacket);

    if (!jacketBase.getAttribute('src')) {
      jacketBase.src = testSrc;
      log('Setting jacket src →', testSrc);
    } else {
      log('Using existing jacket src →', jacketBase.src);
    }

    function syncLayerSizes(){
      const rect = jacketBase.getBoundingClientRect();
      const w = Math.round(rect.width);
      const h = Math.round(rect.height);
      if (!w || !h) { requestAnimationFrame(syncLayerSizes); return; }
      overlayLayer.style.width = w + 'px';
      overlayLayer.style.height = h + 'px';
      epauletContainer.style.width = w + 'px';
      epauletContainer.style.height = h + 'px';
      canvasShell.style.width = w + 'px';
      canvasShell.style.height = h + 'px';
      log('Layer sizes synced to jacket:', w + '×' + h);
    }

    jacketBase.addEventListener('load', syncLayerSizes);
    jacketBase.addEventListener('error', function(){
      fail('Failed to load base image →', jacketBase.src);
      fail('Check file exists and path/casing matches exactly.');
    });

    // Required side containers
    const controls = document.getElementById('controls');
    if (!controls) warn('Missing #controls sidebar (UI will be limited)');
    const assets = document.getElementById('assets') || (function(){
      const d = document.createElement('div'); d.id = 'assets'; d.style.display='none'; document.body.appendChild(d);
      warn('Created missing #assets (preload container)');
      return d;
    })();
    const tooltip = document.getElementById('tooltip') || (function(){
      const d = document.createElement('div'); d.id = 'tooltip'; d.className='tooltip'; d.setAttribute('aria-hidden','true'); document.body.appendChild(d);
      warn('Created missing #tooltip');
      return d;
    })();

    // Try app hooks if present
    try {
      if (window.App && typeof window.App.init === 'function') { window.App.init(); log('App.init() called'); }
      if (typeof window.initApp === 'function') { window.initApp(); log('initApp() called'); }
      if (typeof window.boot === 'function') { window.boot(); log('boot() called'); }
      if (typeof window.fullRender === 'function') { window.fullRender(); log('fullRender() called'); }
      if (typeof window.applyJacket === 'function') { window.applyJacket(); log('applyJacket() called'); }
    } catch (e) {
      fail('Error during app boot hook:', e);
    }

    // Visibility safety
    overlayLayer.style.opacity = '1';
    epauletContainer.style.opacity = '1';
  })();
  </script>
</body>
</html>
