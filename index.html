<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================================================
       CAP Uniform Builder — Main HTML
       Author: C/Capt. Guiseppe Doran
       Fixed: JS order, missing files, stylesheet path
       ========================================================= -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#002855" />
  <link rel="icon" href="images/favicon.png" />
  <title>CAP Class A Uniform Builder</title>

  <!-- Stylesheet -->
  <link rel="stylesheet" href="css/style.css" />

  <!-- Accessibility utility -->
  <style>
    .sr-only {
      position:absolute!important;
      width:1px;height:1px;margin:-1px;border:0;padding:0;
      clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden;white-space:nowrap;
    }
  </style>

  <!-- Lib -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <!-- Core utilities -->
  <script src="js/util.js" defer></script>
  <script src="js/state.js" defer></script>
  <script src="js/uniforms.js" defer></script>

  <!-- Data modules -->
  <script src="js/ribbons.data.js" defer></script>
  <script src="js/badges.data.js" defer></script>
  <script src="js/patches.data.js" defer></script>

  <!-- UI modules -->
  <script src="js/ribbons.ui.js" defer></script>
  <script src="js/badges.ui.js" defer></script>
  <script src="js/patches.ui.js" defer></script>
  <script src="js/rank.ui.js" defer></script>

  <!-- Core engine -->
  <script src="js/calibration.js" defer></script>
  <script src="js/layout.js" defer></script>
  <script src="js/render.js" defer></script>

  <!-- Dev tools -->
  <script src="js/devtools.js" defer></script>
  <script src="js/devtools.ui.js" defer></script>

  <!-- Optional worker -->
  <script src="js/worker.render.js" defer></script>

  <!-- Main app -->
  <script src="js/app.js" defer></script>
</head>

<body>
  <noscript>
    <div style="padding:12px;background:#fff0f0;border:1px solid #fca5a5;margin:12px;border-radius:8px">
      This app requires JavaScript to render the uniform builder. Please enable JavaScript and reload.
    </div>
  </noscript>

  <!-- Header -->
  <header class="appHeader" role="banner">
    <button id="hamburgerBtn" class="iconBtn" aria-label="Toggle sidebar" type="button">☰</button>
    <h1 class="appTitle">CAP Class A Uniform Builder</h1>
    <div class="headerActions">
      <button id="downloadImage" class="primary" type="button">Download Preview</button>
    </div>
  </header>

  <!-- Layout -->
  <div id="layoutShell" class="layoutShell">
    <aside id="sidebar" class="sidebar" role="complementary" aria-label="Controls panel">
      <!-- Jacket -->
      <section class="panelSection">
        <h2 class="panelTitle">Jacket</h2>
        <div class="row">
          <select id="jacketSelect" aria-label="Select jacket">
            <option value="male">Male Jacket</option>
            <option value="female">Female Jacket</option>
          </select>
          <button id="applyJacket" type="button">Apply</button>
        </div>
      </section>

      <!-- Ribbons -->
      <section class="panelSection">
        <h2 class="panelTitle">Ribbons</h2>
        <div class="row">
          <button id="toggleRibbonDrag" type="button">Drag Mode</button>
          <button id="clearRibbons" type="button">Clear</button>
        </div>
        <div class="row">
          <button id="logRibbonCoords" type="button">Log Coords</button>
        </div>
        <div id="ribbonPicker" class="pickerList" aria-live="polite"></div>
      </section>

      <!-- Devices -->
      <section class="panelSection">
        <h2 class="panelTitle">Devices</h2>
        <div class="row">
          <button id="deviceApplyModeBtn" type="button">Apply Mode</button>
          <button id="deviceRemoveModeBtn" type="button">Remove Mode</button>
          <button id="deviceClearSelectionBtn" type="button">Clear</button>
        </div>
      </section>

      <!-- Badges -->
      <section class="panelSection">
        <h2 class="panelTitle">Badges</h2>
        <div class="row">
          <select id="badgeSelect" aria-label="Select badge"></select>
        </div>
        <div class="row">
          <button id="addBadge" type="button">Add Badge</button>
          <button id="removeBadge" type="button">Remove Badge</button>
        </div>
      </section>

      <!-- Patches -->
      <section class="panelSection">
        <h2 class="panelTitle">Patches</h2>
        <div class="row">
          <select id="patchSelect" aria-label="Select patch"></select>
        </div>
        <div class="row">
          <button id="addPatch" type="button">Add Patch</button>
          <button id="removePatch" type="button">Remove Patch</button>
        </div>
      </section>

      <!-- Rank -->
      <section class="panelSection">
        <h2 class="panelTitle">Rank</h2>
        <div class="row">
          <select id="rankSelect" aria-label="Select rank"></select>
        </div>
        <div class="row">
          <button id="addRank" type="button">Apply Rank</button>
        </div>
      </section>

      <!-- Nameplate -->
      <section class="panelSection">
        <h2 class="panelTitle">Nameplate</h2>
        <div class="row">
          <input id="nameplateInput" type="text" placeholder="LAST NAME" aria-label="Nameplate text" />
          <button id="addNameplate" type="button">Apply</button>
        </div>
      </section>
    </aside>

    <div id="resizer" class="resizer" role="separator" aria-orientation="vertical" aria-label="Resize panel"></div>

    <main id="main" class="main" role="main">
      <div id="panelShell" style="min-height:calc(100vh - 50px);">
        <div id="canvasShell" class="canvasShell">
          <img id="jacketBase" alt="Uniform jacket base" />
          <div id="epauletContainer" class="epauletContainer" aria-hidden="true"></div>
          <div id="overlayLayer" class="overlayLayer"></div>
        </div>
        <div id="assetPreload" class="assetPreload" aria-hidden="true"></div>
      </div>
    </main>
  </div>

  <!-- Calibrator -->
  <div id="calibratorTab" class="calibratorTab" aria-controls="calibratorPanel" aria-expanded="false" role="button" tabindex="0">
    <span id="calibratorArrow" aria-hidden="true">›</span>
    <span class="sr-only">Toggle calibration panel</span>
  </div>

  <aside id="calibratorPanel" class="calibratorPanel" aria-hidden="true">
    <h2>Calibration</h2>
    <div class="calRow">
      <label for="rackXRange">X (range)</label>
      <input id="rackXRange" type="range" min="-200" max="600" step="1" />
      <div class="calVal" id="readX">0</div>
    </div>
    <div class="calRow">
      <label for="rackXNumber">X (px)</label>
      <input id="rackXNumber" type="number" inputmode="numeric" />
      <div class="calVal">px</div>
    </div>
    <div class="calRow">
      <label for="rackYRange">Y (range)</label>
      <input id="rackYRange" type="range" min="-200" max="600" step="1" />
      <div class="calVal" id="readY">0</div>
    </div>
    <div class="calRow">
      <label for="rackYNumber">Y (px)</label>
      <input id="rackYNumber" type="number" inputmode="numeric" />
      <div class="calVal">px</div>
    </div>
    <div class="calRow">
      <button id="toggleMini" type="button">Toggle Mini Medals</button>
      <button id="autoMini" type="button">Auto-Layout</button>
    </div>
  </aside>

  <!-- Tooltip -->
  <div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>

  <!-- Footer -->
  <footer class="appFooter" role="contentinfo">
    <small>© <span id="year"></span> C/Capt. Guiseppe Doran — CAP Uniform Builder</small>
  </footer>

  <!-- Bootstraps -->
  <script>
    (function(){
      var y=document.getElementById('year'); if(y) y.textContent=new Date().getFullYear();
    })();
    (function(){
      const tab=document.getElementById('calibratorTab');
      const panel=document.getElementById('calibratorPanel');
      if(!tab||!panel) return;
      function toggle(){const ex=tab.getAttribute('aria-expanded')==='true';
        tab.setAttribute('aria-expanded',String(!ex));
        panel.setAttribute('aria-hidden',String(ex));
        document.documentElement.classList.toggle('cal-open',!ex);}
      tab.addEventListener('click',toggle);
      tab.addEventListener('keydown',e=>{
        if(e.key==='Enter'||e.key===' '){e.preventDefault();toggle();}
      });
    })();
    (function(){
      const btn=document.getElementById('hamburgerBtn');
      const shell=document.getElementById('layoutShell');
      if(!btn||!shell) return;
      btn.addEventListener('click',()=>shell.classList.toggle('sidebar-collapsed'));
    })();
  </script>
</body>
</html>
