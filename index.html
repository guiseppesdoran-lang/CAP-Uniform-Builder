<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CAP Class A Uniform Builder</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --bg:#eef1f5;
    --ink:#0d1b2a;
    --muted:#516079;
    --panel:#ffffff;
    --line:#cfd6df;
    --brand:#002855;
    --accent:#0062ff;
  }

  *{box-sizing:border-box;margin:0;padding:0}

  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg);
    color:var(--ink);
    min-height:100vh;
    display:flex;
    flex-direction:column;
  }

  header{
    background:var(--brand);
    color:#fff;
    padding:14px 16px 14px 48px;
    text-align:center;
    position:relative;
    box-shadow:0 2px 4px rgb(0 0 0 / .3);
    z-index:10;
  }
  header h1{
    margin:0;
    font-size:16px;
    line-height:1.3;
    font-weight:600;
    letter-spacing:.03em;
  }
  header .subtitle{
    font-size:12px;
    font-weight:400;
    opacity:.8;
  }

  /* ============ LAYOUT ============ */
  .app-shell{
    flex:1;
    min-height:0;
    display:flex;
    align-items:stretch;
    gap:12px;
    padding:12px;
  }

  /* ===== UNIFORM PREVIEW AREA (right) ===== */
  .preview-area{
    position:relative;
    flex:1 1 auto;
    min-width:200px;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:12px;
    box-shadow:0 8px 24px rgb(0 0 0 / .08);
    padding:16px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }

  .preview-header{
    font-size:13px;
    font-weight:600;
    color:var(--muted);
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:8px;
  }

  #previewCanvasWrapper{
    position:relative;
    flex:1;
    min-height:400px;
    background:#dbe2ee;
    border:1px solid var(--line);
    border-radius:8px;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:var(--muted);
  }

  /* This is where jacket, ribbons, badges, etc actually render */
  #uniformStage{
    position:relative;
    width:340px;
    height:500px;
    background:#f8fafc;
    border:1px solid var(--line);
    border-radius:6px;
    overflow:hidden;
  }
  /* example slots – you already have better logic in your builder */
  #jacketBase{
    position:absolute;
    left:0;top:0;
    width:100%;
    height:100%;
    background:url('images/jacket_placeholder.png') center/cover no-repeat;
    pointer-events:none;
  }
  #ribbonRackLayer,
  #badgeLayer,
  #rankLayer,
  #nameplateLayer,
  #epauletContainer {
    position:absolute;
    left:0;top:0;
    width:100%;
    height:100%;
    pointer-events:none;
  }

  /* ============ CONTROL PANEL (left) ============ */
  .panel-shell{
    display:flex;
    flex-direction:row;
    align-items:stretch;
    min-width:260px; /* collapsed minimum */
    max-width:480px;
  }

  #controlPanel{
    position:relative;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:12px;
    box-shadow:0 8px 24px rgb(0 0 0 / .08);
    min-width:260px;
    max-width:480px;
    width:320px; /* default */
    display:flex;
    flex-direction:column;
    min-height:0;
    overflow:hidden;
  }

  /* draggable handle on the right edge of panel */
  #panelResizer{
    position:absolute;
    top:0;
    right:0;
    width:6px;
    height:100%;
    cursor:ew-resize;
    background:transparent;
  }
  #panelResizer::after{
    content:"";
    position:absolute;
    top:50%;
    right:1px;
    transform:translateY(-50%);
    width:2px;
    height:40px;
    border-radius:1px;
    background:var(--line);
  }

  .panel-header{
    flex-shrink:0;
    border-bottom:1px solid var(--line);
    padding:12px 16px;
    display:flex;
    flex-wrap:wrap;
    row-gap:8px;
    column-gap:12px;
    align-items:flex-start;
    background:linear-gradient(#fff 0%, #f9fafc 100%);
  }

  .panel-header-row{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    width:100%;
  }

  .panel-field{
    display:flex;
    flex-direction:column;
    min-width:120px;
  }
  .panel-field label{
    font-size:11px;
    font-weight:600;
    color:var(--muted);
    margin-bottom:4px;
  }
  .panel-field select,
  .panel-field button{
    font-size:13px;
    padding:6px 8px;
    border:1px solid var(--line);
    border-radius:6px;
    background:#fff;
    color:var(--ink);
    min-height:32px;
  }
  .panel-field button{
    background:var(--brand);
    color:#fff;
    border:0;
    font-weight:600;
    cursor:pointer;
  }

  .panel-scroll{
    flex:1 1 auto;
    min-height:0;
    overflow:auto;
    padding:12px 16px 80px 16px; /* bottom space so last row not under footer */
  }

  .subsection{
    margin-bottom:20px;
  }

  .subsection-title{
    font-size:12px;
    font-weight:700;
    color:var(--ink);
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:10px;
  }
  .subsection-hint{
    font-size:11px;
    font-weight:400;
    color:var(--muted);
  }

  /* ===== Ribbon picker grid (McChord-style) ===== */
  .ribbonGrid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
    gap:12px;
  }

  .ribbonCard{
    border:1px solid var(--line);
    border-radius:8px;
    background:#fff;
    box-shadow:0 4px 12px rgb(0 0 0 / .05);
    padding:10px;
    display:flex;
    flex-direction:column;
    font-size:12px;
    min-width:0;
  }

  .ribbonHeader{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    margin-bottom:8px;
    gap:8px;
  }
  .ribbonLeft{
    display:flex;
    align-items:flex-start;
    gap:6px;
  }
  .ribbonCheck input[type="checkbox"]{
    width:16px;
    height:16px;
    cursor:pointer;
  }

  .ribbonImg{
    width:48px;
    height:14px;
    background:#999;
    border-radius:2px;
    border:1px solid #000;
    flex-shrink:0;
    background-size:cover;
    background-position:center;
  }

  .ribbonName{
    font-size:11px;
    font-weight:600;
    color:var(--ink);
    line-height:1.2;
    word-break:break-word;
    flex:1;
  }

  .ribbonBody{
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .deviceField label{
    font-size:10px;
    font-weight:600;
    color:var(--muted);
    margin-bottom:2px;
    display:block;
  }

  .deviceField select{
    width:100%;
    font-size:12px;
    padding:4px 6px;
    border:1px solid var(--line);
    border-radius:6px;
    background:#fff;
    color:var(--ink);
    min-height:28px;
  }

  /* footer / coords etc */
  .panel-footer{
    position:absolute;
    left:0;
    right:0;
    bottom:0;
    border-top:1px solid var(--line);
    background:#fff;
    padding:8px 16px;
    display:flex;
    flex-wrap:wrap;
    row-gap:4px;
    column-gap:16px;
    font-size:11px;
    color:var(--muted);
  }
  .coordField{
    display:flex;
    gap:4px;
    align-items:center;
  }
  .coordField span.label{
    font-weight:600;
  }
  .coordField span.val{
    font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:11px;
    color:var(--ink);
    min-width:28px;
    text-align:right;
  }

  /* small helper classes */
  .hidden{display:none !important;}
  .flex-row{display:flex;flex-direction:row;align-items:center;gap:8px;}
  .nowrap{white-space:nowrap;}

  @media(max-width:768px){
    .app-shell{
      flex-direction:column;
    }
    .panel-shell{
      max-width:100%;
      width:100%;
      order:2;
    }
    #controlPanel{
      width:100%!important;
      max-width:100%!important;
      min-width:100%!important;
      border-radius:12px;
    }
    #panelResizer{display:none;} /* no manual width dragging on narrow screens */
    .preview-area{
      order:1;
      min-height:320px;
    }
  }
</style>
</head>
<body>
<header>
  <h1>CAP Class A Uniform Builder</h1>
  <div class="subtitle">C/Capt. Guiseppe Doran • CAPR 39-1 logic • live rack & badge validation</div>
</header>

<div class="app-shell">

  <!-- ================= LEFT: CONTROL PANEL (RESIZABLE) ================= -->
  <div class="panel-shell">
    <aside id="controlPanel">
      <div id="panelResizer" title="Drag to resize"></div>

      <!-- ===== Top controls: Cadet / Senior etc ===== -->
      <div class="panel-header">
        <div class="panel-header-row">
          <div class="panel-field" style="min-width:140px;">
            <label for="memberType">Member Type</label>
            <select id="memberType">
              <option value="cadet">Cadet</option>
              <option value="senior">Senior Member</option>
            </select>
          </div>

          <div class="panel-field" style="min-width:140px;">
            <label for="genderSelect">Jacket Cut</label>
            <select id="genderSelect">
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>

          <div class="panel-field" style="min-width:140px;">
            <label for="rankSelect">Rank / Grade</label>
            <select id="rankSelect">
              <!-- You already have this logic: officer ranks render on epaulets, enlisted overlays jacket -->
              <option value="">-- Select Rank --</option>
              <option value="c/ab">C/AB</option>
              <option value="c/amn">C/Amn</option>
              <option value="c/a1c">C/A1C</option>
              <option value="c/sra">C/SrA</option>
              <option value="c/ssgt">C/SSgt</option>
              <option value="c/tsgt">C/TSgt</option>
              <option value="c/msgt">C/MSgt</option>
              <option value="c/smsgt">C/SMSgt</option>
              <option value="c/cmsgt">C/CMSgt</option>
              <option value="c/2lt">C/2d Lt</option>
              <option value="c/1lt">C/1st Lt</option>
              <option value="c/capt">C/Capt</option>
              <option value="senior-2lt">2d Lt (SM)</option>
              <option value="senior-1lt">1st Lt (SM)</option>
              <option value="senior-capt">Capt (SM)</option>
              <option value="senior-maj">Maj (SM)</option>
              <option value="senior-ltcol">Lt Col (SM)</option>
              <option value="senior-col">Col (SM)</option>
            </select>
          </div>

          <div class="panel-field" style="min-width:140px;">
            <label>&nbsp;</label>
            <button id="downloadBtn">Download Hi-Res</button>
          </div>
        </div>
      </div>

      <!-- ===== Scroll body ===== -->
      <div class="panel-scroll">

        <!-- Ribbons -->
        <section class="subsection" id="ribbonPickerSection">
          <div class="subsection-title">
            <div>
              Ribbons
              <div class="subsection-hint">Check to add. Devices auto-overlay in rack.</div>
            </div>
            <button style="font-size:11px;line-height:1;padding:4px 8px;border-radius:4px;border:1px solid var(--line);background:#fff;color:var(--ink);cursor:pointer;" id="clearRibbonsBtn">Clear</button>
          </div>

          <div class="ribbonGrid" id="ribbonGrid">
            <!-- Ribbon cards generated by JS -->
          </div>
        </section>

        <!-- Badges etc. (you already have complex logic; placeholder hook here) -->
        <section class="subsection">
          <div class="subsection-title">
            <div>
              Badges
              <div class="subsection-hint">Auto-placed per CAPR 39-1.</div>
            </div>
            <button style="font-size:11px;line-height:1;padding:4px 8px;border-radius:4px;border:1px solid var(--line);background:#fff;color:var(--ink);cursor:pointer;" id="manageBadgesBtn">Manage</button>
          </div>
          <div style="font-size:11px;color:var(--muted);line-height:1.4;">
            • Max over nameplate / pockets enforced<br/>
            • Model Rocketry + NRA pocket logic enforced<br/>
            • Will reflow when ribbons shift
          </div>
        </section>

        <!-- Debug / coords -->
        <section class="subsection">
          <div class="subsection-title">
            <div>Debug / Placement</div>
          </div>
          <div class="flex-row" style="flex-wrap:wrap;font-size:11px;color:var(--muted);gap:12px;">
            <div class="nowrap">Ribbon rows lock to baseline Y.</div>
            <div class="nowrap">Badges sit 25px above top row center.</div>
          </div>
        </section>

      </div>

      <!-- footer -->
      <div class="panel-footer">
        <div class="coordField">
          <span class="label">Top Row Y:</span>
          <span class="val" id="coordTopRowY">--</span>
        </div>
        <div class="coordField">
          <span class="label">Left X:</span>
          <span class="val" id="coordLeftX">--</span>
        </div>
        <div class="coordField">
          <span class="label">Rows:</span>
          <span class="val" id="coordRows">0</span>
        </div>
      </div>
    </aside>
  </div>

  <!-- ================= RIGHT: LIVE PREVIEW ================= -->
  <section class="preview-area">
    <div class="preview-header">
      <span>Live Preview</span>
      <span id="previewInfo" style="font-size:11px;color:var(--muted);">Cadet / Male / C/Capt</span>
    </div>
    <div id="previewCanvasWrapper">
      <div id="uniformStage">
        <div id="jacketBase"></div>
        <div id="ribbonRackLayer"></div>
        <div id="badgeLayer"></div>
        <div id="rankLayer"></div>
        <div id="nameplateLayer"></div>

        <!-- For officer shoulder board display next to jacket -->
        <div id="epauletContainer"></div>
      </div>
    </div>
  </section>

</div>

<script>
/* ===========================================================
   DATA DEFINITIONS
   =========================================================== */

/*
SM-only ribbons you gave. These should NOT show as selectable
when "Cadet" is chosen in the Member Type dropdown.
*/
const SM_ONLY_RIBBONS = [
  "Gill Robb Wilson Award Ribbon",
  "Paul E Garber Award Ribbon",
  "Grover Loening Aerospace Award Ribbon",
  "Leadership Award Ribbon",
  "CAP Membership Award Ribbon",
  "A Scott Crossfield Award Ribbon",
  "Brigadier General Charles E. Yeager Aerospace Education Achievement Award Ribbon",
  "Command Service Ribbon",
  "Cadet Orientation Pilot Ribbon",
  "Senior Recruiter Ribbon",
  "World War 2 Service Ribbon"
];

/*
All ribbons known to the system.
Each ribbon object:
- id: unique key
- name: display name
- img: path for the ribbon image (placeholder right now)
- devices: array of device choices (each {value,label})
- smOnly: boolean for Senior Member only
- precedence: number for ordering (1 = highest). You already sort by this.
  NOTE: You will merge your full precedence table here.
*/
const RIBBONS = [
  {
    id:"gill_robb_wilson",
    name:"Gill Robb Wilson Award Ribbon",
    img:"images/ribbons/gill_robb_wilson.png",
    smOnly:true,
    precedence:10,
    devices:[
      {value:"",label:"None"},
      {value:"bronze_star",label:"Bronze Star"},
      {value:"silver_star",label:"Silver Star"},
      {value:"gold_star",label:"Gold Star"}
    ]
  },
  {
    id:"paul_garber",
    name:"Paul E Garber Award Ribbon",
    img:"images/ribbons/paul_garber.png",
    smOnly:true,
    precedence:11,
    devices:[
      {value:"",label:"None"},
      {value:"bronze_star",label:"Bronze Star"},
      {value:"silver_star",label:"Silver Star"},
      {value:"gold_star",label:"Gold Star"}
    ]
  },
  {
    id:"grover_loening",
    name:"Grover Loening Aerospace Award Ribbon",
    img:"images/ribbons/grover_loening.png",
    smOnly:true,
    precedence:12,
    devices:[
      {value:"",label:"None"}
    ]
  },
  {
    id:"leadership_award",
    name:"Leadership Award Ribbon",
    img:"images/ribbons/leadership_award.png",
    smOnly:true,
    precedence:13,
    devices:[
      {value:"",label:"None"},
      {value:"bronze_star",label:"Bronze Star"},
      {value:"silver_star",label:"Silver Star"}
    ]
  },
  {
    id:"membership_award",
    name:"CAP Membership Award Ribbon",
    img:"images/ribbons/membership_award.png",
    smOnly:true,
    precedence:14,
    devices:[
      {value:"",label:"None"}
    ]
  },
  {
    id:"crossfield",
    name:"A Scott Crossfield Award Ribbon",
    img:"images/ribbons/crossfield.png",
    smOnly:true,
    precedence:15,
    devices:[{value:"",label:"None"}]
  },
  {
    id:"yeager",
    name:"Brigadier General Charles E. Yeager Aerospace Education Achievement Award Ribbon",
    img:"images/ribbons/yeager.png",
    smOnly:true,
    precedence:16,
    devices:[{value:"",label:"None"}]
  },
  {
    id:"command_service",
    name:"Command Service Ribbon",
    img:"images/ribbons/command_service.png",
    smOnly:true,
    precedence:17,
    devices:[
      {value:"",label:"None"},
      {value:"bronze_star",label:"Bronze Star"},
      {value:"silver_star",label:"Silver Star"},
      {value:"gold_star",label:"Gold Star"},
      {value:"gold_star_2",label:"Two Gold Stars"}
    ]
  },
  {
    id:"o_ride_pilot",
    name:"Cadet Orientation Pilot Ribbon",
    img:"images/ribbons/orientation_pilot.png",
    smOnly:true,
    precedence:18,
    devices:[
      {value:"",label:"None"},
      {value:"bronze_clasp",label:"Bronze Clasp"}
    ]
  },
  {
    id:"senior_recruiter",
    name:"Senior Recruiter Ribbon",
    img:"images/ribbons/senior_recruiter.png",
    smOnly:true,
    precedence:19,
    devices:[{value:"",label:"None"}]
  },
  {
    id:"ww2_service",
    name:"World War 2 Service Ribbon",
    img:"images/ribbons/ww2_service.png",
    smOnly:true,
    precedence:20,
    devices:[{value:"",label:"None"}]
  },

  /* EXAMPLE cadet-accessible ribbon (not smOnly) */
  {
    id:"gen_billy_mitchell",
    name:"General Billy Mitchell Award Ribbon",
    img:"images/ribbons/billy_mitchell.png",
    smOnly:false,
    precedence:3,
    devices:[
      {value:"",label:"None"}
    ]
  },
  {
    id:"earhart",
    name:"Amelia Earhart Award Ribbon",
    img:"images/ribbons/earhart.png",
    smOnly:false,
    precedence:2,
    devices:[
      {value:"",label:"None"}
    ]
  },
  {
    id:"spaetz",
    name:"General Carl A. Spaatz Award Ribbon",
    img:"images/ribbons/spaatz.png",
    smOnly:false,
    precedence:1,
    devices:[
      {value:"",label:"None"}
    ]
  },
];

/*
Selected ribbons state:
{
  ribbonId: { device:"bronze_star" }
}
*/
let selectedRibbons = {};


/* ===========================================================
   BUILD RIBBON GRID UI
   =========================================================== */

function buildRibbonGrid(){
  const grid = document.getElementById('ribbonGrid');
  grid.innerHTML = "";

  // sort by precedence ascending (1 is highest precedence)
  const sorted = [...RIBBONS].sort((a,b)=>a.precedence-b.precedence);

  const isCadet = (document.getElementById('memberType').value === "cadet");

  sorted.forEach(rib=>{
    const hiddenClass = (isCadet && rib.smOnly) ? "hidden" : "";
    // card wrapper
    const card = document.createElement('div');
    card.className = "ribbonCard " + hiddenClass;
    card.dataset.ribbonId = rib.id;
    card.dataset.ribbonName = rib.name;

    // top row w/ checkbox + ribbon img + name
    const header = document.createElement('div');
    header.className = "ribbonHeader";

    const left = document.createElement('div');
    left.className = "ribbonLeft";

    const boxWrap = document.createElement('div');
    boxWrap.className = "ribbonCheck";
    const check = document.createElement('input');
    check.type = "checkbox";
    check.checked = !!selectedRibbons[rib.id];
    check.addEventListener('change',()=>{
      if(check.checked){
        if(!selectedRibbons[rib.id]){
          selectedRibbons[rib.id]={
            device:""
          };
        }
      }else{
        delete selectedRibbons[rib.id];
      }
      renderRack();
    });
    boxWrap.appendChild(check);

    const imgDiv = document.createElement('div');
    imgDiv.className = "ribbonImg";
    imgDiv.style.backgroundImage = `url(${rib.img})`;

    left.appendChild(boxWrap);
    left.appendChild(imgDiv);

    const nameDiv = document.createElement('div');
    nameDiv.className = "ribbonName";
    nameDiv.textContent = rib.name;

    header.appendChild(left);
    header.appendChild(nameDiv);

    // body row: device dropdown
    const body = document.createElement('div');
    body.className = "ribbonBody";

    const deviceField = document.createElement('div');
    deviceField.className = "deviceField";

    const dLabel = document.createElement('label');
    dLabel.textContent = "Device";
    const dSel = document.createElement('select');

    rib.devices.forEach(dev=>{
      const opt=document.createElement('option');
      opt.value=dev.value;
      opt.textContent=dev.label;
      dSel.appendChild(opt);
    });

    dSel.value = selectedRibbons[rib.id]?.device || "";
    dSel.addEventListener('change',()=>{
      if(!selectedRibbons[rib.id]){
        // if user touches device dropdown but ribbon not selected yet:
        selectedRibbons[rib.id]={device:dSel.value};
        check.checked = true;
      }else{
        selectedRibbons[rib.id].device=dSel.value;
      }
      renderRack();
    });

    deviceField.appendChild(dLabel);
    deviceField.appendChild(dSel);

    body.appendChild(deviceField);

    card.appendChild(header);
    card.appendChild(body);

    grid.appendChild(card);
  });
}


/* ===========================================================
   RACK RENDERING LOGIC (core: precedence, rows of 1/2/3, offsets, etc.)
   =========================================================== */

/*
You already have:
- Bottom row locked to a fixed Y.
- Highest-precedence goes on the TOP row, centered or left in that row.
- When ribbons go 1 -> 2 -> 3, they live in the top row above left pocket, touching each other horizontally (no Y gap).
- After 3, new ribbons make NEW rows below, and top row re-centers to keep highest precedence in most prominent spot.
- After 9 ribbons, you start offset mode: future rows limited to 2 ribbons, shifted right, and single ribbons centered over those 2 below. This also moves the "badges above rack" X anchor.

We will NOT rewrite all your math here. Instead:
- We'll stub renderRack() with hooks where you drop your actual placement code.
- We'll still update debug coords + preview header.
*/

function renderRack(){
  // 1. Figure out active ribbons in precedence order
  const activeRibbonObjs = Object.keys(selectedRibbons)
    .map(id => RIBBONS.find(r=>r.id===id))
    .filter(Boolean)
    .sort((a,b)=>a.precedence-b.precedence);

  // 2. TODO: Your existing algorithm to:
  //    - Build rows (top row can have 1-3, etc.)
  //    - Apply 0px vertical gap between rows
  //    - Lock bottom row Y coordinate
  //    - Handle >9 ribbons offset rules
  //
  // For now we'll just visually list them stacked, and update debug display.
  const rackLayer = document.getElementById('ribbonRackLayer');
  rackLayer.innerHTML = "";

  let yBase = 300; // <-- This should be your locked baseline for the BOTTOM row of ribbons in px
  let rowHeight = 16; // ribbon height ~14px + ~2px fudge
  let rows = [];
  // Naive row packing 3 per row bottom-up just as placeholder:
  for(let i=0;i<activeRibbonObjs.length;i+=3){
    const slice = activeRibbonObjs.slice(i,i+3);
    rows.push(slice);
  }
  // rows[0] is bottom row in this naive placeholder
  // Your real code reverses etc. Adjust as needed:
  rows.reverse(); // so rows[0] becomes TOP row
  // calc coordinates
  rows.forEach((row, rowIdx)=>{
    const actualRowIndexFromBottom = rows.length-1-rowIdx;
    const y = yBase - (actualRowIndexFromBottom*rowHeight);

    // horizontally pack tight, 0px gaps
    const ribbonW = 48;
    const gapX = 0;
    // center row block over left pocket (you already know pocket X)
    const pocketCenterX = 160; // placeholder
    const totalW = row.length*ribbonW + (row.length-1)*gapX;
    let startX = pocketCenterX - totalW/2;

    row.forEach((ribObj, i)=>{
      const ribDiv = document.createElement('img');
      ribDiv.src = ribObj.img; // ribbon img
      ribDiv.style.position="absolute";
      ribDiv.style.left = (startX + i*(ribbonW+gapX))+"px";
      ribDiv.style.top  = y+"px";
      ribDiv.style.width = ribbonW+"px";
      ribDiv.style.height = "14px";
      ribDiv.style.objectFit="cover";
      ribDiv.style.border="1px solid #000";
      ribDiv.style.borderRadius="2px";
      rackLayer.appendChild(ribDiv);

      // device overlay if any:
      const deviceVal = selectedRibbons[ribObj.id]?.device || "";
      if(deviceVal){
        const dev = document.createElement('div');
        dev.textContent = deviceVal; // placeholder; you'll render actual star/clasp image here
        dev.style.position="absolute";
        dev.style.left = (startX + i*(ribbonW+gapX) + ribbonW/2 - 4)+"px";
        dev.style.top  = (y - 8)+"px";
        dev.style.fontSize="8px";
        dev.style.fontWeight="700";
        dev.style.color="#000";
        rackLayer.appendChild(dev);
      }
    });

    // TODO your badge-above-rack anchor is 25px above the TOP row's y,
    // horizontally aligned to the center ribbon in that top row.
    if(rowIdx===0){
      const badgeAnchorX = pocketCenterX;
      const badgeAnchorY = y - 25;
      // you would now position any "over the ribbons" badge(s) using badgeAnchorX,badgeAnchorY
    }
  });

  // update debug readouts
  const topRowY = rows.length
    ? (yBase - ((rows.length-1)*rowHeight))
    : "--";
  document.getElementById("coordTopRowY").textContent = topRowY;
  document.getElementById("coordLeftX").textContent = "160"; // pocketCenter placeholder
  document.getElementById("coordRows").textContent = rows.length.toString();

  // update preview header text (Cadet/Senior, Male/Female, Rank)
  const mt = document.getElementById('memberType').value;
  const g  = document.getElementById('genderSelect').value;
  const rk = document.getElementById('rankSelect').value || "No Rank";
  document.getElementById('previewInfo').textContent =
    mt.charAt(0).toUpperCase()+mt.slice(1)
    +" / "+g.charAt(0).toUpperCase()+g.slice(1)
    +" / "+rk;
}


/* ===========================================================
   PANEL RESIZER DRAG LOGIC
   =========================================================== */
(function initPanelResizer(){
  const panel = document.getElementById('controlPanel');
  const resizer = document.getElementById('panelResizer');
  let isDragging = false;
  let startX = 0;
  let startWidth = 0;

  resizer.addEventListener('mousedown',(e)=>{
    isDragging = true;
    startX = e.clientX;
    startWidth = panel.getBoundingClientRect().width;
    document.body.style.userSelect = "none";
  });

  window.addEventListener('mousemove',(e)=>{
    if(!isDragging)return;
    let newW = startWidth + (e.clientX - startX);
    // clamp
    if(newW < 260) newW = 260;
    if(newW > 480) newW = 480;
    panel.style.width = newW+"px";
  });

  window.addEventListener('mouseup',()=>{
    if(isDragging){
      isDragging=false;
      document.body.style.userSelect = "";
    }
  });
})();

/* ===========================================================
   EVENT LISTENERS
   =========================================================== */

document.getElementById('memberType').addEventListener('change',()=>{
  buildRibbonGrid();
  renderRack();
});

document.getElementById('genderSelect').addEventListener('change',()=>{
  // swap jacket image etc. in your real code
  renderRack();
});

document.getElementById('rankSelect').addEventListener('change',()=>{
  // call your renderRank() logic to show epaulets / chevrons, etc.
  renderRack();
});

document.getElementById('clearRibbonsBtn').addEventListener('click',()=>{
  selectedRibbons = {};
  buildRibbonGrid();
  renderRack();
});

document.getElementById('downloadBtn').addEventListener('click',()=>{
  // hook into your hi-res html2canvas exporter
  html2canvas(document.getElementById("uniformStage"),{scale:3}).then(canvas=>{
    const link=document.createElement("a");
    link.download="CAP_ClassA_Uniform.png";
    link.href=canvas.toDataURL("image/png");
    link.click();
  });
});

/* ===========================================================
   INIT
   =========================================================== */
buildRibbonGrid();
renderRack();

</script>
</body>
</html>
