<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CAP Uniform Builder — Full Program</title>

  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css" />

  <!-- html2canvas for downloads -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>

  <header>
    <h1>CAP Uniform Builder</h1>
    <div class="subtitle">C/Capt. Guiseppe Doran • CAPR 39-1 logic • live rack & badge validation</div>
  </header>

  <!-- HAMBURGER MENU BUTTON -->
  <button id="hamburgerBtn" class="hamburgerBtn" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>

  <!-- Floating rack-only calibrator -->
  <div id="calibratorWrapper">
    <div id="calibratorTab">
      <span>RACK</span>
      <span class="arrow" id="calibratorArrow">›</span>
    </div>

    <div id="calibratorPanel">
      <h3>Ribbon Rack Cal</h3>

      <div class="calib-row">
        <label for="rackXRange">X Offset (left px)</label>
        <input type="range" id="rackXRange" min="150" max="400" step="1">
        <input type="number" id="rackXNumber" class="numField">
      </div>

      <div class="calib-row">
        <label for="rackYRange">Y Offset (top px)</label>
        <input type="range" id="rackYRange" min="150" max="320" step="1">
        <input type="number" id="rackYNumber" class="numField">
      </div>

      <div id="calibReadout">
        <div>Base X: <code id="readX"></code> px</div>
        <div>Base Y: <code id="readY"></code> px</div>
        <div>Ribbon W×H: <code id="readSize"></code> px</div>
      </div>
    </div>
  </div>

  <!-- MAIN APP LAYOUT -->
  <main id="layoutShell" class="sidebar-open">

    <!-- SIDEBAR (resizable wrapper) -->
    <div class="panel-shell" id="panelShell">
      <aside id="controls">
        <div class="controlsHeader">
          <div>
            <h2 class="controlsTitle">Uniform Builder Controls</h2>
            <div class="controlsSub">Member type governs auth; panel can resize.</div>
          </div>
        </div>

        <div class="controlsScrollArea">
          <!-- MEMBER TYPE -->
          <section class="panelBlock">
            <label class="fieldLabel">Member Type</label>
            <select id="memberSelect">
              <option value="cadet">Cadet</option>
              <option value="senior">Senior Member / Officer</option>
              <option value="senior_nco">Senior Member NCO</option>
            </select>
            <div class="hintText">This also hides Senior-Member-only ribbons if you're a cadet.</div>
          </section>

          <!-- GENDER -->
          <section class="panelBlock">
            <label class="fieldLabel">Gender / Cut</label>
            <select id="jacketSelect">
              <option value="male">Male Cut</option>
              <option value="female">Female Cut</option>
            </select>
            <div class="hintText">Swaps which base jacket image we render.</div>
          </section>

          <!-- UNIFORM SELECTOR -->
          <section class="panelBlock">
            <label class="fieldLabel">Uniform</label>
            <div id="uniformList" class="uniformList">

              <button class="uniformOption" data-uniform-id="blues_a" data-allowed-for="cadet,senior,senior_nco">
                <div class="uName">Blues: Class A</div>
                <div class="uDesc smallText">Service coat, ribbons</div>
              </button>

              <button class="uniformOption" data-uniform-id="blues_b" data-allowed-for="cadet,senior,senior_nco">
                <div class="uName">Blues: Class B</div>
                <div class="uDesc smallText">Shirt, ribbons</div>
              </button>

              <button class="uniformOption" data-uniform-id="mess_dress" data-allowed-for="senior,senior_nco">
                <div class="uName">Mess Dress</div>
                <div class="uDesc smallText">Mini medals / formal</div>
              </button>

              <button class="uniformOption" data-uniform-id="semi_formal" data-allowed-for="senior,senior_nco">
                <div class="uName">Semi-formal</div>
                <div class="uDesc smallText">Mini medals</div>
              </button>

              <button class="uniformOption" data-uniform-id="aviator" data-allowed-for="senior,senior_nco">
                <div class="uName">Aviator Shirt</div>
                <div class="uDesc smallText">Corporate white shirt</div>
              </button>

              <button class="uniformOption" data-uniform-id="aviator_blazer" data-allowed-for="senior,senior_nco">
                <div class="uName">Aviator + Blazer</div>
                <div class="uDesc smallText">Corporate coat style</div>
              </button>

              <button class="uniformOption" data-uniform-id="corporate_field" data-allowed-for="senior,senior_nco">
                <div class="uName">Corporate Field Uniform</div>
                <div class="uDesc smallText">Field / utility variant</div>
              </button>

              <button class="uniformOption" data-uniform-id="abu" data-allowed-for="cadet,senior,senior_nco">
                <div class="uName">ABU</div>
                <div class="uDesc smallText">Legacy camo / tapes</div>
              </button>

              <button class="uniformOption" data-uniform-id="flight_suit" data-allowed-for="cadet,senior,senior_nco">
                <div class="uName">Flight Suit</div>
                <div class="uDesc smallText">Flight / utility</div>
              </button>

              <button class="uniformOption" data-uniform-id="polo" data-allowed-for="senior,senior_nco">
                <div class="uName">Polo</div>
                <div class="uDesc smallText">Corporate polo / gray slacks</div>
              </button>
            </div>

            <div class="hintText">
              Grayed-out uniforms are not authorized for the selected member type.
            </div>
          </section>

          <!-- ASSET BASE -->
          <section class="panelBlock">
            <div class="row two">
              <div class="col">
                <label class="fieldLabel">Asset Base Path</label>
                <input id="assetBase" value="images" placeholder="images"/>
              </div>
              <div class="col">
                <label class="fieldLabel" style="visibility:hidden">Apply</label>
                <button id="applyJacket" class="ghost">Apply Jacket</button>
              </div>
            </div>
            <div class="hintText">Change if your image folder path changes.</div>
          </section>

          <!-- RIBBONS GRID / DEVICES -->
          <section class="panelBlock">
            <div class="subsection-header">
              <div>
                <div class="subsection-title">Ribbons / Devices</div>
                <div class="subsection-hint">
                  Check to add. Choose a device for that ribbon.
                  Senior-Member-only ribbons are hidden for cadets.
                </div>
              </div>
              <button id="clearRibbons" class="ghost" style="font-size:11px;line-height:1;padding:4px 8px;border-radius:6px;">
                Clear
              </button>
            </div>

            <div class="ribbonGrid" id="ribbonGrid"></div>

            <label style="font-size:12px;color:var(--muted);display:block;margin-top:10px;">
              <input type="checkbox" id="toggleMini">
              Force Mini Medals (override)
            </label>

            <label style="font-size:12px;color:var(--muted);display:block;margin-top:6px;">
              <input type="checkbox" id="autoMini" checked>
              Auto-convert ribbons → mini-medals on Mess/Semi-formal
            </label>

            <!-- Multi-apply device box -->
            <div id="deviceTool">
              <strong style="font-size:12px;">Ribbon Devices — Multi-Apply</strong>
              <div id="devicePicker"></div>
              <div class="row" style="margin-top:8px">
                <button id="deviceApplyModeBtn" type="button">Enable Apply Mode</button>
                <button id="deviceRemoveModeBtn" type="button" class="ghost">Enable Remove Mode</button>
                <button id="deviceClearSelectionBtn" type="button" class="ghost">Clear Selection</button>
              </div>
              <small style="color:#516079;display:block;margin-top:6px;font-size:11px;line-height:1.3;">
                Choose devices + quantities → Enable Apply Mode → click a ribbon (in preview) to add them.
                Use Remove Mode to clear devices from that ribbon.
              </small>
            </div>

            <div class="row two" style="margin-top:12px">
              <div class="col"><button id="toggleRibbonDrag" class="ghost">Enable Drag Mode</button></div>
              <div class="col"><button id="logRibbonCoords" class="ghost">Log Ribbon Coords</button></div>
            </div>
            <div class="hintText">
              Drag Mode lets you reposition ribbons on the jacket for calibration.
              "Log Ribbon Coords" prints their exact left/top to console.
            </div>
          </section>

          <!-- BADGES -->
          <section class="panelBlock">
            <label class="fieldLabel">Badges</label>
            <div class="row two">
              <div class="col"><select id="badgeSelect"></select></div>
              <div class="col"><button id="addBadge">Add Badge</button></div>
            </div>
            <div class="row two" style="margin-top:6px">
              <div class="col"><select id="removeBadgeSelect"></select></div>
              <div class="col"><button id="removeBadge" class="ghost">Remove Badge</button></div>
            </div>
            <div class="hintText">
              Auto-placed per CAPR 39-1. Cadet-only / SM-only logic enforced. Max 5 total.
              Over-rack badges sit 25px above the top ribbon row, centered.
            </div>
          </section>

          <!-- PATCHES -->
          <section class="panelBlock" id="groupPatches">
            <label class="fieldLabel">Patches</label>
            <div class="row two">
              <div class="col"><select id="patchSelect"></select></div>
              <div class="col"><button id="addPatch">Add Patch</button></div>
            </div>
            <div class="row two" style="margin-top:6px">
              <div class="col"><select id="removePatchSelect"></select></div>
              <div class="col"><button id="removePatch" class="ghost">Remove Patch</button></div>
            </div>
            <div class="hintText">
              Field uniforms swap certain badges/ribbons into patch/tape equivalents automatically.
            </div>
          </section>

          <!-- RANK / NAME / DOWNLOAD -->
          <section class="panelBlock">
            <label class="fieldLabel">Rank Insignia & Output</label>
            <div class="row two">
              <div class="col"><select id="rankSelect"></select></div>
              <div class="col"><button id="addRank">Set Rank</button></div>
            </div>
            <div class="row two" style="margin-top:6px">
              <div class="col"><button id="addNameplate" class="ghost">Add Nameplate</button></div>
              <div class="col"><button id="downloadImage">Download PNG</button></div>
            </div>
            <div class="hintText">
              Download exports a high-res PNG of the preview.
            </div>
          </section>

          <!-- FULL CALIBRATION PANEL -->
          <section id="calibrationPanelSidebar" class="panelSection">
            <h2 style="margin-top:0;font-size:13px;font-weight:600;color:var(--ink);">
              Calibration (All Items)
            </h2>
            <p class="tinyNote">
              Live-adjust X/Y/rotations. Copy JSON below into constants once dialed.
            </p>

            <div id="calibrationControls"></div>

            <div style="margin-top:16px;">
              <label for="calibrationExport" class="tinyNote"
                     style="display:block;margin-bottom:4px;">
                Export current calibration:
              </label>
              <textarea id="calibrationExport"></textarea>
            </div>
          </section>

          <!-- COPYRIGHT -->
          <section class="panelBlock" style="text-align:center;font-size:10.5px;color:var(--muted);line-height:1.3;">
            <div id="sidebarCopyrightLine">
              © <span id="sidebarYear"></span> Civil Air Patrol Uniform Builder<br/>
              Developed by C/Capt. Guiseppe Doran
            </div>
          </section>

        </div>
      </aside>

      <!-- drag handle -->
      <div id="panelResizer" title="Drag to resize panel"></div>
    </div>

    <!-- PREVIEW AREA -->
    <section id="previewWrapper">
      <div id="previewArea">
        <div id="uniformCanvas"></div>
      </div>

      <div id="sideDisplay">
        <div id="epauletContainer"></div>
        <div id="coverContainer"></div>
      </div>
    </section>

    <!-- GLOBAL HOVER TOOLTIP -->
    <div id="tooltip" class="tooltipBubble" style="display:none;"></div>

  </main>

  <!-- Hidden assets root -->
  <div class="layer" id="assets" style="display:none"></div>

  <!-- COPYRIGHT FOOTER -->
  <footer id="pageFooter">
    © <span id="footerYear"></span> Civil Air Patrol Uniform Builder – Developed by C/Capt. Guiseppe Doran
  </footer>

  <!-- App entry (ES modules) -->
  <script type="module" src="js/app.js"></script>
</body>
</html>
