<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CAP Uniform Builder — Full Program</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --bg:#eef1f5;
    --ink:#0d1b2a;
    --muted:#516079;
    --panel:#ffffff;
    --line:#cfd6df;
    --brand:#002855;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg);
    color:var(--ink);
  }

  header{
    background:var(--brand);
    color:#fff;
    padding:14px 16px 14px 48px; /* leave space for hamburger in top-left */
    text-align:center;
    position:relative;
  }
  header h1{
    margin:0;
    font-size:18px;
    letter-spacing:.3px
  }

  /* HAMBURGER MENU BUTTON */
  .hamburgerBtn{
    position:fixed;
    left:12px;
    top:12px;
    z-index:10000;
    width:32px;
    height:32px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,.4);
    background:rgba(255,255,255,.12);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:4px;
    cursor:pointer;
    box-shadow:0 10px 25px rgb(0 0 0 / .3);
  }
  .hamburgerBtn span{
    display:block;
    width:18px;
    height:2px;
    background:#fff;
    border-radius:1px;
  }

  /* MAIN LAYOUT SHELL */
  #layoutShell {
    display:flex;
    height:calc(100vh - 58px); /* minus header height */
    position:relative;
    background:var(--bg);
    color:var(--ink);
    overflow:hidden;
  }

  /* Sidebar / Controls panel */
  #controls {
    width:340px;
    max-width:340px;
    min-width:260px;
    background:var(--panel);
    border-right:1px solid var(--line);
    box-shadow:0 0 20px rgb(0 0 0 / .07);
    display:flex;
    flex-direction:column;
    z-index:10;
    transition:
      width .2s ease,
      min-width .2s ease,
      max-width .2s ease,
      transform .2s ease;
    overflow:hidden;
  }

  .controlsHeader {
    background:var(--brand);
    color:#fff;
    padding:12px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  .controlsHeader .controlsTitle {
    margin:0;
    font-size:14px;
    font-weight:600;
    line-height:1.2;
    letter-spacing:.2px;
    width:100%;
    text-align:left;
  }

  .controlsScrollArea{
    flex:1;
    overflow-y:auto;
    padding:12px 14px 48px; /* leave room above footer bar */
  }

  .panelBlock {
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:10px;
    padding:12px 12px 10px;
    margin-bottom:12px;
    box-shadow:0 8px 20px rgb(0 0 0 / .04);
  }

  .fieldLabel{
    font-size:13px;
    font-weight:600;
    color:var(--ink);
    display:block;
    margin-bottom:6px;
  }
  .hintText{
    font-size:11px;
    line-height:1.3;
    color:var(--muted);
    margin-top:6px;
  }

  select,button,input{
    width:100%;
    margin-top:6px;
    padding:8px;
    border:1px solid var(--line);
    border-radius:10px;
    background:#f8fafc;
    font-family:inherit;
    font-size:13px;
    color:var(--ink);
  }
  button{
    cursor:pointer;
    background:#0f2a54;
    color:#fff;
    border-color:#163766;
  }
  button.ghost{
    background:#ffffff;
    color:var(--ink);
  }

  .row{display:flex;gap:8px;flex-wrap:wrap}
  .two .col{flex:1}

  .hidden{display:none !important}
  .disabledBlock{opacity:.55; pointer-events:none; filter:grayscale(.25);}

  /* uniform selector buttons */
  .uniformList{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .uniformOption{
    width:100%;
    text-align:left;
    background:#fff;
    border:1px solid var(--line);
    border-radius:8px;
    padding:10px 12px;
    font-family:inherit;
    cursor:pointer;
    position:relative;
    box-shadow:0 4px 12px rgb(0 0 0 / .03);
    transition:box-shadow .12s ease,border-color .12s ease,background .12s ease;
  }
  .uniformOption:hover{
    box-shadow:0 10px 24px rgb(0 0 0 / .07);
    border-color:var(--brand);
    background:rgba(0,40,85,.04);
  }
  .uniformOption .uName{
    font-size:13px;
    font-weight:600;
    color:var(--ink);
    margin-bottom:2px;
    line-height:1.3;
  }
  .uniformOption .uDesc{
    font-size:11px;
    color:var(--muted);
    line-height:1.3;
  }

  /* locked (not authorized for this member type) */
  .uniformOption.locked{
    cursor:not-allowed;
    opacity:.45;
    filter:grayscale(1);
    background:#f4f4f7;
    border-style:dashed;
    border-color:var(--line);
    box-shadow:none;
  }
  .uniformOption.locked:hover{
    border-color:var(--line);
    background:#f4f4f7;
    box-shadow:none;
  }
  .uniformOption.locked:hover::after{
    content:attr(data-locked-reason);
    position:absolute;
    left:100%;
    top:50%;
    transform:translate(8px,-50%);
    min-width:180px;
    max-width:220px;
    background:rgba(15,23,42,.95);
    color:#fff;
    font-size:11px;
    line-height:1.35;
    border-radius:8px;
    box-shadow:0 20px 40px rgb(0 0 0 / .6);
    padding:8px 10px;
    border:1px solid rgba(255,255,255,.2);
    pointer-events:none;
    white-space:normal;
    text-align:left;
    z-index:9999;
  }

  /* Advanced device tool box */
  #deviceTool{
    margin-top:10px;
    border:1px solid var(--line);
    border-radius:10px;
    padding:10px;
    background:#fefefe;
  }
  #devicePicker{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:8px;
    font-size:12px;
  }

  /* PREVIEW WRAPPER */
  #previewWrapper{
    flex:1;
    position:relative;
    padding:16px;
    display:flex;
    gap:16px;
    overflow:auto;
    align-items:flex-start;
    justify-content:center;
    background:var(--bg);
  }

  /* Preview canvas box */
  #previewArea{
    position:relative;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:12px;
    width:450px;
    height:600px;
    box-shadow:0 30px 60px rgb(0 0 0 / .12);
    overflow:hidden;
  }

  #uniformCanvas{
    position:relative;
    width:100%;
    height:100%;
  }
  .layer{
    position:absolute;
    image-rendering:auto;
  }

  /* Drag calibration visuals */
  .drag-mode-on .ribbonTile{
    outline:1px dashed rgba(0,40,85,.6);
    cursor:move;
    z-index:9999;
  }
  .dragging{
    opacity:.7;
  }

  #sideDisplay{
    display:flex;
    flex-direction:column;
    gap:16px;
    min-width:140px;
  }

  /* TOOLTIP BUBBLE */
  .tooltipBubble{
    position:fixed;
    z-index:9999;
    min-width:180px;
    max-width:240px;
    background:rgba(15,23,42,.95);
    color:#fff;
    font-size:12px;
    line-height:1.35;
    border-radius:8px;
    box-shadow:0 20px 40px rgb(0 0 0 / .6);
    padding:8px 10px;
    pointer-events:none;
    border:1px solid rgba(255,255,255,.2);
  }
  .tooltipBubble strong{
    font-size:12px;
    font-weight:600;
    color:#fff;
    display:block;
    margin-bottom:4px;
  }
  .tooltipBubble em{
    color:#94a3b8;
    font-style:normal;
    font-size:11px;
  }

  /* COLLAPSED SIDEBAR STATE */
  #layoutShell.sidebar-open #controls{
    width:340px;
    max-width:340px;
    min-width:260px;
    box-shadow:0 0 20px rgb(0 0 0 / .07);
    border-right:1px solid var(--line);
  }

  #layoutShell.sidebar-collapsed #controls{
    width:0;
    min-width:0;
    max-width:0;
    border-right:0;
    box-shadow:none;
    overflow:hidden;
  }

  /* GUIDE DOT (debug aid) */
  .guideDot{
    position:absolute;
    background:rgba(0,40,85,.15);
    border:1px solid rgba(0,40,85,.4);
    color:var(--ink);
    font-size:10px;
    line-height:1.2;
    padding:2px 4px;
    border-radius:4px;
    pointer-events:none;
    white-space:nowrap;
  }

  /* COPYRIGHT FOOTER */
  #pageFooter{
    text-align:center;
    font-size:11px;
    color:var(--muted);
    background:var(--panel);
    border-top:1px solid var(--line);
    padding:8px 0;
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    z-index:5;
  }

  /* CALIBRATOR WRAPPER */
  #calibratorWrapper {
    position:fixed;
    top:80px;
    left:0;
    z-index:10001;
    display:flex;
    align-items:flex-start;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    color:var(--ink);
  }
  #calibratorTab {
    background:var(--brand);
    color:#fff;
    padding:8px 6px;
    font-size:12px;
    font-weight:600;
    border-top-right-radius:6px;
    border-bottom-right-radius:6px;
    cursor:pointer;
    user-select:none;
    line-height:1.2;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    box-shadow:2px 2px 6px rgb(0 0 0 / .2);
  }
  #calibratorTab span.arrow {
    font-size:16px;
    line-height:16px;
  }
  #calibratorPanel {
    background:var(--panel);
    border:1px solid var(--line);
    border-left:none;
    border-top-right-radius:8px;
    border-bottom-right-radius:8px;
    min-width:180px;
    padding:12px;
    box-shadow:2px 2px 10px rgb(0 0 0 / .25);
    display:none;
  }
  #calibratorPanel h3 {
    margin:0 0 8px 0;
    font-size:13px;
    font-weight:600;
    color:var(--ink);
  }
  .calib-row {
    font-size:12px;
    margin-bottom:10px;
    display:grid;
    grid-template-columns:1fr auto;
    align-items:center;
    column-gap:6px;
  }
  .calib-row label {
    display:block;
    font-weight:500;
    color:var(--muted);
    grid-column:1 / span 2;
    margin-bottom:4px;
  }
  .calib-row input[type="range"] {
    width:100%;
  }
  .calib-row .numField {
    width:48px;
    font-size:12px;
    padding:2px 4px;
    border:1px solid var(--line);
    border-radius:4px;
    text-align:center;
    background:#fff;
    color:var(--ink);
  }
  #calibReadout {
    font-size:11px;
    line-height:1.4;
    background:#f6f8fa;
    border:1px solid var(--line);
    border-radius:4px;
    padding:6px;
    white-space:nowrap;
  }
  #calibReadout code {
    font-family:ui-monospace,SFMono-Regular,Consolas,"Liberation Mono",monospace;
    font-size:11px;
    background:none;
    padding:0;
  }

  /* MOBILE */
  @media (max-width:768px){
    #layoutShell{
      flex-direction:column;
      height:auto;
      min-height:calc(100vh - 58px);
    }

    #controls{
      position:absolute;
      left:0;
      top:0;
      bottom:0;

      width:80%;
      max-width:80%;
      min-width:260px;

      box-shadow:0 30px 60px rgb(0 0 0 / .4);
      border-right:1px solid var(--line);
      background:var(--panel);
      transition:transform .2s ease;
    }

    #layoutShell.sidebar-open    #controls{ transform:translateX(0); }
    #layoutShell.sidebar-collapsed #controls{ transform:translateX(-100%); }

    #previewWrapper{
      order:2;
      flex:1;
    }
  }
</style>
</head>
<body>

<header>
  <h1>CAP Uniform Builder</h1>
</header>

<!-- HAMBURGER MENU BUTTON -->
<button id="hamburgerBtn" class="hamburgerBtn" aria-label="Menu">
  <span></span><span></span><span></span>
</button>

<!-- Ribbon Rack Calibrator UI -->
<div id="calibratorWrapper">
  <div id="calibratorTab">
    <span>RACK</span>
    <span class="arrow" id="calibratorArrow">›</span>
  </div>

  <div id="calibratorPanel">
    <h3>Ribbon Rack Cal</h3>

    <div class="calib-row">
      <label for="rackXRange">X Offset (left px)</label>
      <input type="range" id="rackXRange" min="150" max="400" step="1">
      <input type="number" id="rackXNumber" class="numField">
    </div>

    <div class="calib-row">
      <label for="rackYRange">Y Offset (top px)</label>
      <input type="range" id="rackYRange" min="150" max="320" step="1">
      <input type="number" id="rackYNumber" class="numField">
    </div>

    <div id="calibReadout">
      <div>Base X: <code id="readX"></code> px</div>
      <div>Base Y: <code id="readY"></code> px</div>
      <div>Ribbon W×H: <code id="readSize"></code> px</div>
    </div>
  </div>
</div>

<!-- MAIN APP LAYOUT -->
<main id="layoutShell" class="sidebar-open">

  <!-- SIDEBAR -->
  <aside id="controls">
    <div class="controlsHeader">
      <h2 class="controlsTitle">Uniform Builder Controls</h2>
    </div>

    <div class="controlsScrollArea">

      <!-- NEW: SETUP FLOW (Membership -> Rank -> Uniform -> Gender) -->
      <section class="panelBlock">
        <label class="fieldLabel">Membership Type</label>
        <select id="membershipType">
          <option value="">Select Membership</option>
          <option value="senior">Senior Member</option>
          <option value="cadet">Cadet Member</option>
        </select>
        <div class="hintText">This controls which ranks are available and how the base uniform renders.</div>

        <label class="fieldLabel" style="margin-top:10px;">Rank</label>
        <select id="rankSetupSelect" disabled>
          <option value="">Select Rank</option>
        </select>
        <div class="hintText">For Senior Member NCO (SSgt–CMSgt), your NCO base images will be used as the jacket template.</div>
      </section>

      <!-- GENDER -->
      <section id="genderBlock" class="panelBlock disabledBlock">
        <label class="fieldLabel">Gender / Cut</label>
        <select id="jacketSelect">
          <option value="">Select Gender</option>
          <option value="male">Male Cut</option>
          <option value="female">Female Cut</option>
        </select>
        <div class="hintText">This swaps which base jacket image we render.</div>
      </section>

      <!-- UNIFORM SELECTOR -->
      <section id="uniformBlock" class="panelBlock disabledBlock">
        <label class="fieldLabel">Uniform</label>
        <div id="uniformList" class="uniformList">

          <button class="uniformOption"
                  data-uniform-id="blues_a"
                  data-allowed-for="cadet,senior">
            <div class="uName">Blues: Class A</div>
            <div class="uDesc smallText">Service coat, ribbons</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="blues_b"
                  data-allowed-for="cadet,senior">
            <div class="uName">Blues: Class B</div>
            <div class="uDesc smallText">Shirt, ribbons</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="mess_dress"
                  data-allowed-for="senior">
            <div class="uName">Mess Dress</div>
            <div class="uDesc smallText">Mini medals / formal</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="semi_formal"
                  data-allowed-for="senior">
            <div class="uName">Semi-formal</div>
            <div class="uDesc smallText">Mini medals</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="aviator"
                  data-allowed-for="senior">
            <div class="uName">Aviator Shirt</div>
            <div class="uDesc smallText">Corporate white shirt</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="aviator_blazer"
                  data-allowed-for="senior">
            <div class="uName">Aviator + Blazer</div>
            <div class="uDesc smallText">Corporate coat style</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="corporate_field"
                  data-allowed-for="senior">
            <div class="uName">Corporate Field Uniform</div>
            <div class="uDesc smallText">Field / utility variant</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="abu"
                  data-allowed-for="cadet,senior">
            <div class="uName">ABU</div>
            <div class="uDesc smallText">Legacy camo / tapes</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="flight_suit"
                  data-allowed-for="cadet,senior">
            <div class="uName">Flight Suit</div>
            <div class="uDesc smallText">Flight / utility</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="polo"
                  data-allowed-for="senior">
            <div class="uName">Polo</div>
            <div class="uDesc smallText">Corporate polo / gray slacks</div>
          </button>
        </div>

        <div class="hintText">
          Grayed-out uniforms are not authorized for the selected membership type.
        </div>
      </section>

      <!-- ASSET BASE -->
      <section class="panelBlock">
        <div class="row two">
          <div class="col">
            <label class="fieldLabel">Asset Base Path</label>
            <input id="assetBase" value="images" placeholder="images"/>
          </div>
          <div class="col">
            <label class="fieldLabel">&nbsp;</label>
            <button id="applyJacket" class="ghost">Apply Jacket</button>
          </div>
        </div>
        <div class="hintText">Change this if your image folder path changes.</div>
      </section>

      <!-- RIBBONS / DEVICES / MINI MEDALS -->
      <section id="groupRibbons" class="panelBlock">
        <label class="fieldLabel">Ribbons / Mini Medals</label>
        <div class="row two">
          <div class="col"><select id="ribbonSelect"></select></div>
          <div class="col"><select id="deviceSelect"></select></div>
        </div>
        <div class="row two" style="margin-top:6px">
          <div class="col"><button id="addRibbon">Add Ribbon</button></div>
          <div class="col"><button id="clearRibbons" class="ghost">Clear Ribbons</button></div>
        </div>

        <label style="font-size:12px;color:var(--muted);display:block;margin-top:8px;">
          <input type="checkbox" id="toggleMini">
          Show Mini Medals (override)
        </label>

        <label style="font-size:12px;color:var(--muted);display:block;margin-top:8px;">
          <input type="checkbox" id="autoMini" checked>
          Auto-convert ribbons → mini-medals on Mess/Semi-formal
        </label>

        <div id="deviceTool">
          <strong style="font-size:12px;">Ribbon Devices — Multi-Apply</strong>
          <div id="devicePicker"></div>
          <div class="row" style="margin-top:8px">
            <button id="deviceApplyModeBtn" type="button">Enable Apply Mode</button>
            <button id="deviceRemoveModeBtn" type="button" class="ghost">Enable Remove Mode</button>
            <button id="deviceClearSelectionBtn" type="button" class="ghost">Clear Selection</button>
          </div>
          <small style="color:#516079;display:block;margin-top:6px;font-size:11px;line-height:1.3;">
            Choose devices + quantities → Enable Apply Mode → click a ribbon to add them.
            Use Remove Mode to clear devices from a ribbon.
          </small>
        </div>

        <div class="row two" style="margin-top:10px">
          <div class="col"><button id="toggleRibbonDrag" class="ghost">Enable Drag Mode</button></div>
          <div class="col"><button id="logRibbonCoords" class="ghost">Log Ribbon Coords</button></div>
        </div>
        <div class="hintText">
          Drag Mode lets you reposition ribbons on the jacket for calibration. "Log Ribbon Coords" prints their exact left/top to console.
        </div>
      </section>

      <!-- BADGES -->
      <section class="panelBlock">
        <label class="fieldLabel">Badges</label>
        <div class="row two">
          <div class="col"><select id="badgeSelect"></select></div>
          <div class="col"><button id="addBadge">Add Badge</button></div>
        </div>
        <div class="row two" style="margin-top:6px">
          <div class="col"><select id="removeBadgeSelect"></select></div>
          <div class="col"><button id="removeBadge" class="ghost">Remove Badge</button></div>
        </div>
        <div class="hintText">Placement follows CAPR 39-1 rules. Some badges are cadet-only / senior-only.</div>
      </section>

      <!-- PATCHES -->
      <section id="groupPatches" class="panelBlock">
        <label class="fieldLabel">Patches</label>
        <div class="row two">
          <div class="col"><select id="patchSelect"></select></div>
          <div class="col"><button id="addPatch">Add Patch</button></div>
        </div>
        <div class="row two" style="margin-top:6px">
          <div class="col"><select id="removePatchSelect"></select></div>
          <div class="col"><button id="removePatch" class="ghost">Remove Patch</button></div>
        </div>
        <div class="hintText">Field uniforms swap certain badges/ribbons into patch/tape equivalents automatically.</div>
      </section>

      <!-- RANK / NAME / DOWNLOAD -->
      <section class="panelBlock">
        <label class="fieldLabel">Rank Insignia & Output</label>
        <div class="row two">
          <div class="col"><select id="rankSelect"></select></div>
          <div class="col"><button id="addRank">Set Rank</button></div>
        </div>
        <div class="row two" style="margin-top:6px">
          <div class="col"><button id="addNameplate" class="ghost">Add Nameplate</button></div>
          <div class="col"><button id="downloadImage">Download PNG</button></div>
        </div>
        <div class="hintText">Download will export a high-res PNG of the uniform preview.</div>
      </section>

      <!-- COPYRIGHT -->
      <section class="panelBlock" style="text-align:center;font-size:10.5px;color:var(--muted);line-height:1.3;">
        <div id="sidebarCopyrightLine">
          © <span id="sidebarYear"></span> Civil Air Patrol Uniform Builder<br/>
          Developed by C/Capt. Guiseppe Doran
        </div>
      </section>
    </div>
  </aside>

  <!-- PREVIEW AREA -->
  <section id="previewWrapper">
    <div id="previewArea">
      <div id="uniformCanvas"></div>
    </div>

    <div id="sideDisplay">
      <div id="epauletContainer"></div>
      <div id="coverContainer"></div>
    </div>
  </section>

  <!-- GLOBAL HOVER TOOLTIP -->
  <div id="tooltip" class="tooltipBubble" style="display:none;"></div>

</main>

<!-- Hidden assets root -->
<div class="layer" id="assets" style="display:none"></div>

<!-- COPYRIGHT FOOTER -->
<footer id="pageFooter">
  © <span id="footerYear"></span> Civil Air Patrol Uniform Builder – Developed by C/Capt. Guiseppe Doran
</footer>

<script>
/* ===========================
   GLOBAL STATE
   =========================== */
const State = {
  membership:'',           // 'senior' | 'cadet'
  gender:'',               // 'male' | 'female'
  uniform:'blues_a',
  assetBase:'images',
  ribbons:[],              // [{id, devices:{ devId:qty }}]
  badges:[],
  patches:[],
  rank:null,               // selected rank string (senior or cadet)
  deviceApplyMode:false,
  deviceRemoveMode:false,
  selectedDevices:{},
  ribbonDragMode:false,
  forceMini:false
};

let currentDrag = null;
let dragOffsetX = 0;
let dragOffsetY = 0;

/* ===========================
   MEMBERSHIP/RANK DATA
   =========================== */
const RANKS = {
  senior: ["SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen"],
  cadet: ["C/AB","C/Amn","C/A1C","C/SrA","C/SSgt","C/TSgt","C/MSgt","C/SMSgt","C/CMSgt","C/2d Lt","C/1st Lt","C/Capt","C/Maj","C/Lt Col","C/Col"]
};

const SENIOR_NCO_RANKS = new Set(["SSgt","TSgt","MSgt","SMSgt","CMSgt"]);
const OFFICER_RANKS = new Set([
  // senior officers
  "2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen",
  // cadet officers
  "C/2d Lt","C/1st Lt","C/Capt","C/Maj","C/Lt Col","C/Col"
]);

/* ===========================
   CALIBRATION CONSTANTS
   =========================== */
let rackBaseX = 259;
let rackBaseY = 206;

const RIBBON_WIDTH  = 23;
const RIBBON_HEIGHT = 7.2;
const RIBBON_GAP_X  = 0;
const RIBBON_GAP_Y  = 2;

function getRackOrigin(){
  return { x:rackBaseX, y:rackBaseY };
}

/* ===========================
   DOM SHORTCUTS
   =========================== */
const $ = s => document.querySelector(s);
const by = id => document.getElementById(id);

const layoutShell      = by('layoutShell');
const hamburgerBtn     = by('hamburgerBtn');
const uniformCanvas    = by('uniformCanvas');
const assetsContainer  = by('assets');
const uniformListEl    = by('uniformList');

const membershipTypeEl = by('membershipType');
const rankSetupSelect  = by('rankSetupSelect');
const jacketSelect     = by('jacketSelect');
const assetBaseInput   = by('assetBase');

const genderBlock      = by('genderBlock');
const uniformBlock     = by('uniformBlock');

/* ===========================
   YEAR AUTOFILL
   =========================== */
(function setYears(){
  const y = new Date().getFullYear();
  const sidebarYear = by('sidebarYear');
  const footerYear  = by('footerYear');
  if(sidebarYear) sidebarYear.textContent = y;
  if(footerYear)  footerYear.textContent  = y;
})();

/* ===========================
   ASSET PATH HELPER
   =========================== */
function ASSET(p){
  const b=(State.assetBase||'images').replace(/\/$/,'');
  return `${b}/${p}`;
}

/* ===========================
   UNIFORM DEFINITIONS
   =========================== */
function isFieldUniform(u){
  return u==='abu' || u==='flight_suit' || u==='corporate_field';
}

const UNIFORMS = {
  blues_a:{male:'base/jacket_male.png',         female:'base/jacket_female.png',         ribbons:true,  mini:false},
  blues_b:{male:'base/blues_class_b_male.png',  female:'base/blues_class_b_female.png',  ribbons:true,  mini:false},
  mess_dress:{male:'base/mess_dress_male.png',  female:'base/mess_dress_female.png',     ribbons:false, mini:true},
  semi_formal:{male:'base/semi_male.png',       female:'base/semi_female.png',           ribbons:false, mini:true},
  aviator:{male:'base/aviator_shirt_male.png',  female:'base/aviator_shirt_female.png',  ribbons:true,  mini:false},
  aviator_blazer:{male:'base/aviator_blazer_male.png',female:'base/aviator_blazer_female.png', ribbons:true,mini:false},
  corporate_field:{male:'base/corporate_field_male.png',female:'base/corporate_field_female.png', ribbons:true, mini:false},
  abu:{male:'base/ABU_male.png',                female:'base/ABU_female.png',            ribbons:false, mini:false},
  flight_suit:{male:'base/flight_suit_male.png',female:'base/flight_suit_female.png',    ribbons:false, mini:false},
  polo:{male:'base/polo_male.png',              female:'base/polo_female.png',           ribbons:false, mini:false}
};

const UI_AUTHZ = {
  blues_a:{ showRibbons:true, showBadges:true,  showPatches:false },
  blues_b:{ showRibbons:true, showBadges:true,  showPatches:false },
  aviator:{ showRibbons:true, showBadges:true,  showPatches:false },
  aviator_blazer:{ showRibbons:true, showBadges:true, showPatches:false },
  corporate_field:{ showRibbons:true, showBadges:false, showPatches:true },
  mess_dress:{ showRibbons:false, showBadges:true,  showPatches:false },
  semi_formal:{ showRibbons:false, showBadges:true, showPatches:false },
  abu:{ showRibbons:false, showBadges:false, showPatches:true },
  flight_suit:{ showRibbons:false, showBadges:false, showPatches:true },
  polo:{ showRibbons:false, showBadges:false, showPatches:false }
};

/* ===========================
   NEW: SENIOR MEMBER NCO BASE IMAGES
   =========================== */
/*
  Update these paths to match YOUR actual filenames.
  These are RELATIVE to your asset base (images/).
  If a path is missing, it will fall back to the normal base uniform.
*/
const SENIOR_NCO_BASE = {
  // Example: SM NCO Blues Class A base coats
  blues_a: {
    male: {
      "SSgt": "base/sm_nco/blues_a_ssgt_male.png",
      "TSgt": "base/sm_nco/blues_a_tsgt_male.png",
      "MSgt": "base/sm_nco/blues_a_msgt_male.png",
      "SMSgt":"base/sm_nco/blues_a_smsgt_male.png",
      "CMSgt":"base/sm_nco/blues_a_cmsgt_male.png"
    },
    female: {
      "SSgt": "base/sm_nco/blues_a_ssgt_female.png",
      "TSgt": "base/sm_nco/blues_a_tsgt_female.png",
      "MSgt": "base/sm_nco/blues_a_msgt_female.png",
      "SMSgt":"base/sm_nco/blues_a_smsgt_female.png",
      "CMSgt":"base/sm_nco/blues_a_cmsgt_female.png"
    }
  }
  // If you later make NCO base images for other uniforms, add them here.
};

/* ===========================
   RIBBONS / DEVICES / MINI MEDALS
   =========================== */
const ribbonList = [
  'silver_medal_of_valor','bronze_medal_of_valor','distinguished_service_award','exceptional_service_award','meritorious_service_award','commander_commendation_award','cap_achievment_award','lifesaving_award','national_commander_unit_citation_award','unit_citation_award',

  'cap_gill_robb_wilson_ribbon',
  'cap_paul_e_garber_ribbon',
  'cap_grover_loening_aerospace_ribbon',
  'cap_steven_foster_leadership_ribbon','cap_leadership_ribbon',
  'cap_membership_ribbon',
  'cap_command_service_ribbon',
  'cap_counterdrug_ribbon',
  'cap_world_war_2_service_ribbon',
  'cap_senior_recruiter_ribbon',
  'cap_bridgadier_general_charles_yaeger_ribbon',
  'cap_a_scott_crossfield_ribbon',
  'cap_cadet_orientation_pilot_ribbon',

  'spaatz_award','eaker_award','earhart_award','mitchell_award','armstrong_achievement','goddard_achievement','doolittle_achievement','lindbergh_achievement','rickenbacker_achievement','wright_brothers_award','mary_feik_achievement','hap_arnold_achievement','curry_achievement',

  'afa_award','afsa_award','vfw_officer_award','vfw_nco_award','crisis_ribbon','red_service_ribbon','search_find_ribbon','air_search_and_rescue_ribbon','disaster_relief_ribbon','homeland_security_ribbon','community_service_ribbon','iace_ribbon','national_cadet_competition_ribbon','national_color_guard_competition_ribbon','national_color_guard_competition_ribbon','cadet_advisory_council_ribbon','cadet_special_activity_ribbon','encampment_ribbon','cadet_recruiter_ribbon','orientation_pilot_ribbon'
];

const precedence = id => ribbonList.indexOf(id);

const deviceList = [
  '1_Bronze_Star_Device',
  '1_Silver_Star_Device'
];
const deviceMeta = {
  '1_Bronze_Star_Device': { label:'Bronze Star', src:'devices/1_Bronze_Star_Device.webp', w:10, h:10, weight:1 },
  '1_Silver_Star_Device': { label:'Silver Star', src:'devices/1_Silver_Star_Device.webp', w:10, h:10, weight:2 }
};

const miniMedalImages = { /* unchanged (omitted here for brevity) */ };
/* ---- keep your existing miniMedalImages object exactly as you had it ---- */
Object.assign(miniMedalImages, {
  'exceptional_service_award':      'images/medals/exceptional_service.png',
  'meritorious_service_award':      'images/medals/meritorious_service.png',
  'commander_commendation_award':   'images/medals/commanders_comendation.png',
  'cap_achievment_award':           'images/medals/achievement.png',
  'lifesaving_award':               'images/medals/crisis.png',
  'national_commander_unit_citation_award': 'images/medals/commanders_citation.png',
  'unit_citation_award':            'images/medals/unit_citation.png',
  'cap_gill_robb_wilson_ribbon':    'images/medals/gill_robb_wilson.png',
  'cap_paul_e_garber_ribbon':       'images/medals/paul_e_garber.png',
  'cap_grover_loening_aerospace_ribbon':'images/medals/grover_loening.png',
  'cap_leadership_ribbon':          'images/medals/leadership.png',
  'cap_membership_ribbon':          'images/medals/membership.png',
  'cap_command_service_ribbon':     'images/medals/command_service.png',
  'cap_counterdrug_ribbon':         'images/medals/counterdrug.png',
  'cap_world_war_2_service_ribbon': 'images/medals/world_war_2_service.png',
  'cap_senior_recruiter_ribbon':    'images/medals/recruiting.png',
  'cap_bridgadier_general_charles_yaeger_ribbon':'images/medals/charles_yaeger.png',
  'cap_a_scott_crossfield_ribbon':  'images/medals/a_scott_crossfield.png',
  'cap_cadet_orientation_pilot_ribbon':'images/medals/orientation_pilot.png',
  'crisis_ribbon':                  'images/medals/crisis.png',
  'red_service_ribbon':             'images/medals/red_service.png',
  'search_find_ribbon':             'images/medals/find.png',
  'air_search_and_rescue_ribbon':   'images/medals/search_and_rescue.png',
  'disaster_relief_ribbon':         'images/medals/wartime_service.png',
  'homeland_security_ribbon':       'images/medals/wartime_service.png',
  'community_service_ribbon':       'images/medals/membership.png',
  'iace_ribbon':                    'images/medals/iace.png',
  'spaatz_award':                   'images/medals/carl_a_spaatz.png',
  'eaker_award':                    'images/medals/ira_c_eaker.png',
  'earhart_award':                  'images/medals/amelia_earhart.png',
  'mitchell_award':                 'images/medals/billy_mitchell.png',
  'armstrong_achievement':          'images/medals/aerospace_award.png',
  'goddard_achievement':            'images/medals/a_scott_crossfield.png',
  'doolittle_achievement':          'images/medals/aerospace_education.png',
  'lindbergh_achievement':          'images/medals/leadership.png',
  'rickenbacker_achievement':       'images/medals/proficency.png',
  'wright_brothers_award':          'images/medals/leadership.png',
  'mary_feik_achievement':          'images/medals/leadership.png',
  'hap_arnold_achievement':         'images/medals/leadership.png',
  'curry_achievement':              'images/medals/leadership.png',
  'national_cadet_competition_ribbon':      'images/medals/cadet_compeition.png',
  'national_color_guard_competition_ribbon':'images/medals/color_guard_competition.png',
  'cadet_advisory_council_ribbon':          'images/medals/command_service.png',
  'cadet_special_activity_ribbon':          'images/medals/aerospace_award.png',
  'encampment_ribbon':                      'images/medals/encampment.png',
  'cadet_recruiter_ribbon':                 'images/medals/recruiting.png',
  'orientation_pilot_ribbon':               'images/medals/aerospace_award.png',
  'afa_award':                              'images/medals/aerospace_award.png',
  'afsa_award':                             'images/medals/paul_e_garber.png',
  'vfw_officer_award':                      'images/medals/wartime_service.png',
  'vfw_nco_award':                          'images/medals/wartime_service.png'
});

/* ===========================
   BADGES / PATCHES
   =========================== */
/* ---- keep your existing badgeList/badge logic/patch logic exactly as you had it ---- */
const badgeList = [ /* unchanged */ 
  'AirCrew1_DB3F0FCC3650F','BalloonPilot1_442D89C94185B','CAPMasterPilot1_621A0E2ED15DA','CAPPilot1_FA9D33EA587D8','CAPSeniorPilot1_D9725AE959752','GliderPilot1_7BFB287379918','MasterAirCrew1_72AC4CAE7A310','MasterObserver1_1B88D5071FD5C','SeniorAirCrew1_B289BAE6E515C','SeniorObserver1_0E35802A29801',
  'buddist_chaplin','christian_chaplin','communications_technician_badge','cyber_badges','emergency_services_badge','emt_basic_badge','emt_intermediate','emt_paramedic','ground_team_basic_badge','historian_technicianIbadge','information_technology_technician_badge','jewish_chaplin','legal_officer','master_ground_team_badge','medical_officer','model_rocketry_badge','muslim_chaplin','nra_marksman_badge','nurse_officer','observer_badge','pre_solo_badge','senior_ground_team_badge','solo_badge','stem_badges'
];

const allowedCadetBadges = new Set([
  'solo_badge','pre_solo_badge','ground_team_basic_badge','senior_ground_team_badge','master_ground_team_badge','emt_basic_badge','emt_intermediate','emt_paramedic','aerospace','model_rocketry_badge','communications_technician_badge','information_technology_technician_badge','cyber_badges','stem_badges','cadetadvisory','cd','nra_marksman_badge','AirCrew1_DB3F0FCC3650F','BalloonPilot1_442D89C94185B','CAPMasterPilot1_621A0E2ED15DA','CAPPilot1_FA9D33EA587D8','CAPSeniorPilot1_D9725AE959752','GliderPilot1_7BFB287379918','MasterAirCrew1_72AC4CAE7A310','SeniorAirCrew1_B289BAE6E515C','SeniorObserver1_0E35802A29801','MasterObserver1_1B88D5071FD5C','observer_badge','emergency_services_badge','historian_technicianIbadge'
]);

const exclusiveBadges = [
  ['emt_basic_badge','ground_team_basic_badge'],
  ['emt_intermediate','senior_ground_team_badge'],
  ['emt_paramedic','master_ground_team_badge']
];

const badgeLocations = { /* unchanged */ 
  'AirCrew1_DB3F0FCC3650F':'OLP','BalloonPilot1_442D89C94185B':'OLP','CAPMasterPilot1_621A0E2ED15DA':'OLP','CAPPilot1_FA9D33EA587D8':'OLP','CAPSeniorPilot1_D9725AE959752':'OLP','GliderPilot1_7BFB287379918':'OLP','MasterAirCrew1_72AC4CAE7A310':'OLP',
  'SeniorAirCrew1_B289BAE6E515C':'OLP','pre_solo_badge':'OLP','solo_badge':'OLP',
  'cyber_badges':'LP','stem_badges':'LP','communications_technician_badge':'LP','information_technology_technician_badge':'LP','MasterObserver1_1B88D5071FD5C':'LP','SeniorObserver1_0E35802A29801':'LP','observer_badge':'LP','historian_technicianIbadge':'LP','model_rocketry_badge':'LP',
  'nra_marksman_badge':'LRP',
  'ground_team_basic_badge':'OLPU','senior_ground_team_badge':'OLPU','master_ground_team_badge':'OLPU','emergency_services_badge':'OLPU','emt_basic_badge':'OLPU','emt_intermediate':'OLPU','emt_paramedic':'OLPU',
  'buddist_chaplin':'ORP','christian_chaplin':'ORP','jewish_chaplin':'ORP','legal_officer':'ORP','medical_officer':'ORP','nurse_officer':'ORP','muslim_chaplin':'ORP'
};

const customBadgeSizes = { /* unchanged */ 
  'AirCrew1_DB3F0FCC3650F':{width:60,height:25},'BalloonPilot1_442D89C94185B':{width:60,height:25},'CAPMasterPilot1_621A0E2ED15DA':{width:60,height:25},'CAPPilot1_FA9D33EA587D8':{width:60,height:25},'CAPSeniorPilot1_D9725AE959752':{width:60,height:25},'GliderPilot1_7BFB287379918':{width:60,height:25},'MasterAirCrew1_72AC4CAE7A310':{width:60,height:25},'MasterObserver1_1B88D5071FD5C':{width:60,height:25},'SeniorAirCrew1_B289BAE6E515C':{width:60,height:25},'SeniorObserver1_0E35802A29801':{width:60,height:25},
  'buddist_chaplin':{width:60,height:60},'christian_chaplin':{width:60,height:60},'communications_technician_badge':{width:60,height:60},
  'cyber_badges':{width:60,height:25},'emergency_services_badge':{width:60,height:60},'emt_basic_badge':{width:60,height:60},
  'emt_intermediate':{width:60,height:60},'emt_paramedic':{width:60,height:60},'ground_team_basic_badge':{width:25,height:20},
  'historian_technicianIbadge':{width:60,height:60},'information_technology_technician_badge':{width:60,height:60},
  'jewish_chaplin':{width:60,height:60},'legal_officer':{width:60,height:25},'master_ground_team_badge':{width:25,height:20},
  'medical_officer':{width:60,height:60},'model_rocketry_badge':{width:7,height:28.125},'muslim_chaplin':{width:60,height:60},
  'nra_marksman_badge':{width:40,height:60},'nurse_officer':{width:60,height:60},'observer_badge':{width:60,height:25},
  'pre_solo_badge':{width:60,height:25},'senior_ground_team_badge':{width:25,height:20},'solo_badge':{width:60,height:25},'stem_badges':{width:60,height:25}
};

const patchList = [
  'us_flag_patch','command_patch','wing_patch','unit_patch','aerospace_education_patch','communications_patch','orientation_pilot_patch'
];

const PATCH_META = {
  'us_flag_patch':{slotHint:'R_SHOULDER', w:60,h:40, img:'patches/us_flag_patch.png'},
  'command_patch':{slotHint:'L_SHOULDER', w:70,h:70, img:'patches/command_patch.png'},
  'wing_patch':{slotHint:'L_SHOULDER', w:60,h:60, img:'patches/wing_patch.png'},
  'unit_patch':{slotHint:'R_SHOULDER', w:60,h:60, img:'patches/unit_patch.png'},
  'aerospace_education_patch':{slotHint:'CHEST_LEFT', w:60,h:60, img:'patches/aerospace_education_patch.png'},
  'communications_patch':{slotHint:'CHEST_RIGHT', w:60,h:60, img:'patches/communications_patch.png'},
  'orientation_pilot_patch':{slotHint:'CHEST_LEFT', w:60,h:60, img:'patches/orientation_pilot_patch.png'}
};

const ALTERNATES = {
  badgeToPatch: { 'communications_technician_badge':'communications_patch' },
  patchToBadge: { 'communications_patch':'communications_technician_badge' },
  ribbonToPatch:{ 'orientation_pilot_ribbon':'orientation_pilot_patch' },
  patchToRibbon:{ 'orientation_pilot_patch':'orientation_pilot_ribbon' }
};

/* ===========================
   RANK LIST FOR THE "Set Rank" TOOL
   =========================== */
const rankListAll = [...RANKS.senior, ...RANKS.cadet];

/* ===========================
   POPULATE SELECTS & PRELOAD
   =========================== */
function optionize(sel,list, pretty=false){
  sel.innerHTML='';
  list.forEach(v=>{
    const o=document.createElement('option');
    o.value=v;
    o.textContent = pretty ? v : v.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    sel.appendChild(o);
  });
}
function populateBadgesRemove(){
  const sel=by('removeBadgeSelect'); if(!sel) return;
  sel.innerHTML='';
  State.badges.forEach(id=>{
    const o=document.createElement('option');
    o.value=id;
    o.textContent=id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    sel.appendChild(o);
  });
}
function populatePatchesRemove(){
  const sel=by('removePatchSelect'); if(!sel) return;
  sel.innerHTML='';
  State.patches.forEach(id=>{
    const o=document.createElement('option');
    o.value=id;
    o.textContent=id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    sel.appendChild(o);
  });
}
function preloadSimple(prefix,list,folder,ext=".png"){
  list.forEach(id=>{
    const img=document.createElement('img');
    img.id = `${prefix}-${id}`;
    img.src = ASSET(`${folder}/${id}${ext}`);
    img.style.display='none';
    img.loading='eager';
    img.decoding='sync';
    img.onerror=()=>{};
    assetsContainer.appendChild(img);
  });
}
function preloadWithResolver(prefix,list,resolver){
  list.forEach(id=>{
    const src = resolver(id);
    const img=document.createElement('img');
    img.id = `${prefix}-${id}`;
    img.src = ASSET(src);
    img.style.display='none';
    img.loading='eager';
    img.decoding='sync';
    img.onerror=()=>{};
    assetsContainer.appendChild(img);
  });
}

optionize(by('ribbonSelect'), ribbonList);
optionize(by('deviceSelect'), ['none',...deviceList]);
optionize(by('rankSelect'), rankListAll, true);
optionize(by('badgeSelect'), badgeList);
optionize(by('patchSelect'), patchList);

preloadSimple('ribbons', ribbonList, 'ribbons', '.png');
preloadWithResolver('devices', deviceList, id => deviceMeta[id].src);
preloadSimple('ranks', rankListAll, 'ranks', '.png');
preloadSimple('badges', badgeList, 'badges', '.png');
Object.entries(PATCH_META).forEach(([id,m])=>{
  const img=document.createElement('img');
  img.id=`patch-${id}`;
  img.src=ASSET(m.img);
  img.style.display='none';
  assetsContainer.appendChild(img);
});

/* ===========================
   SIDEBAR TOGGLE (HAMBURGER)
   =========================== */
layoutShell.classList.add('sidebar-open'); // default state
hamburgerBtn.addEventListener('click', ()=>{
  if(layoutShell.classList.contains('sidebar-open')){
    layoutShell.classList.remove('sidebar-open');
    layoutShell.classList.add('sidebar-collapsed');
  }else{
    layoutShell.classList.remove('sidebar-collapsed');
    layoutShell.classList.add('sidebar-open');
  }
});

/* ===========================
   TOOLTIP HOVER
   =========================== */
const tooltipEl = by('tooltip');
document.addEventListener('mouseover', e => {
  const t=e.target;
  if(t && t.dataset && t.dataset.tooltipTitle){
    const title=t.dataset.tooltipTitle||'';
    const reg  =t.dataset.tooltipReg||'';
    const why  =t.dataset.tooltipWhy||'';

    tooltipEl.innerHTML = `
      <strong>${title}</strong>
      ${reg ? `<div>${reg}</div>`:''}
      ${why ? `<div><em>${why}</em></div>`:''}
    `;
    tooltipEl.style.display='block';
  }
});
document.addEventListener('mousemove', e => {
  if(tooltipEl.style.display==='block'){
    tooltipEl.style.left = (e.clientX+14)+'px';
    tooltipEl.style.top  = (e.clientY+14)+'px';
  }
});
document.addEventListener('mouseout', e => {
  const t=e.target;
  if(t && t.dataset && t.dataset.tooltipTitle){
    tooltipEl.style.display='none';
  }
});

/* ===========================
   NEW: SETUP FLOW WIRING
   =========================== */
function updateSetupGates(){
  // Gate: gender + uniform locked until membership+rank selected
  const readyMembership = !!State.membership;
  const readyRank       = !!State.rank;
  const readyGender     = !!State.gender;

  // Enable rank select only after membership chosen
  rankSetupSelect.disabled = !readyMembership;

  // enable uniform/gender blocks after membership+rank
  const enableUniformGender = readyMembership && readyRank;
  uniformBlock.classList.toggle('disabledBlock', !enableUniformGender);
  genderBlock.classList.toggle('disabledBlock', !enableUniformGender);

  // once all 4 chosen, render base
  if(readyMembership && readyRank && readyGender && State.uniform){
    fullRender();
    refreshUI();
  }
}

function populateRankSetup(){
  rankSetupSelect.innerHTML = `<option value="">Select Rank</option>`;
  if(!State.membership) return;
  RANKS[State.membership].forEach(r=>{
    const opt=document.createElement('option');
    opt.value=r;
    opt.textContent=r;
    rankSetupSelect.appendChild(opt);
  });
}

membershipTypeEl.addEventListener('change', ()=>{
  State.membership = membershipTypeEl.value || '';
  State.rank = null;

  // reset gender until chosen again
  State.gender = '';
  jacketSelect.value = '';

  // reset rank select
  populateRankSetup();
  rankSetupSelect.value = '';

  // if cadet membership, enforce cadet badge filtering
  if(State.membership==='cadet'){
    State.badges = State.badges.filter(isCadetAuthorized);
  }

  // ensure current uniform is allowed
  if(State.membership && !isUniformAllowedFor(State.uniform, State.membership)){
    const fallback=findFirstAllowedUniform(State.membership) || 'blues_a';
    State.uniform=fallback;
  }

  updateSetupGates();
  applyMemberTypeToUniformOptions();
  highlightActiveUniformButton();

  // clear preview until fully selected
  fullRender();
});

rankSetupSelect.addEventListener('change', ()=>{
  State.rank = rankSetupSelect.value || null;

  // keep "Set Rank" dropdown synced
  by('rankSelect').value = State.rank || '';

  updateSetupGates();
  fullRender();
});

jacketSelect.addEventListener('change', ()=>{
  State.gender = jacketSelect.value || '';
  updateSetupGates();
  fullRender();
});

/* ===========================
   MEMBER TYPE / UNIFORM AUTHZ
   =========================== */
function isUniformAllowedFor(uniformId, membership){
  const btn = uniformListEl.querySelector(`.uniformOption[data-uniform-id="${uniformId}"]`);
  if(!btn) return false;
  const allowed=(btn.dataset.allowedFor||'').split(',').map(s=>s.trim());
  return membership ? allowed.includes(membership) : true;
}
function findFirstAllowedUniform(membership){
  const opts=[...uniformListEl.querySelectorAll('.uniformOption')];
  for(const opt of opts){
    const allowed=(opt.dataset.allowedFor||'').split(',').map(s=>s.trim());
    if(allowed.includes(membership)){
      return opt.dataset.uniformId;
    }
  }
  return null;
}
function applyMemberTypeToUniformOptions(){
  const opts=uniformListEl.querySelectorAll('.uniformOption');
  opts.forEach(opt=>{
    const allowed=(opt.dataset.allowedFor||'').split(',').map(s=>s.trim());
    const isAllowed = State.membership ? allowed.includes(State.membership) : true;

    if(isAllowed){
      opt.classList.remove('locked');
      opt.removeAttribute('data-locked-reason');
    }else{
      opt.classList.add('locked');
      let warnText='This Uniform Is Not Authorized For This Membership Type';
      opt.setAttribute('data-locked-reason', warnText);
    }
  });
}
function highlightActiveUniformButton(){
  const opts=uniformListEl.querySelectorAll('.uniformOption');
  opts.forEach(opt=>{
    if(opt.dataset.uniformId===State.uniform){
      opt.style.outline=`2px solid var(--brand)`;
      opt.style.boxShadow=`0 0 0 3px rgba(0,40,85,.15)`;
      opt.style.background=`rgba(0,40,85,.05)`;
    }else{
      opt.style.outline='';
      opt.style.boxShadow='';
      opt.style.background='';
    }
  });
}

/* ===========================
   JACKET BASE RENDER (UPDATED)
   =========================== */
function clearLayers(cls){
  const sel = cls?`.layer.${cls}`:'.layer';
  uniformCanvas.querySelectorAll(sel).forEach(n=>n.remove());
}

function resolveBaseUniformPath(){
  // must have uniform+gender
  const u = State.uniform;
  const g = State.gender;

  if(!u || !g) return null;

  // Senior Member NCO: use special base images when available
  if(State.membership==='senior' && State.rank && SENIOR_NCO_RANKS.has(State.rank)){
    const map = SENIOR_NCO_BASE[u]?.[g]?.[State.rank];
    if(map) return map;
  }

  // Default base uniform
  const base = UNIFORMS[u]?.[g];
  return base || null;
}

function applyJacket(){
  clearLayers('jacket');

  const basePath = resolveBaseUniformPath();
  if(!basePath){
    // no base selected yet, keep canvas empty
    return;
  }

  const img=document.createElement('img');
  img.className='layer jacket';
  img.src=ASSET(basePath);
  img.style.top='0px';
  img.style.left='0px';
  img.style.width='100%';
  img.style.height='100%';
  img.style.display='block';

  img.dataset.tooltipTitle = (State.uniform||'').replace(/_/g,' ').toUpperCase();
  img.dataset.tooltipReg   = "Base uniform image";
  img.dataset.tooltipWhy   = (State.membership==='senior' && SENIOR_NCO_RANKS.has(State.rank||'')) ?
    `Senior Member NCO base coat (${State.rank})` :
    "Selected uniform template for preview / alignment.";

  uniformCanvas.appendChild(img);
}

/* ===========================
   RIBBON / MEDAL RENDER LOGIC
   =========================== */
function sortRibbons(arr){
  return [...arr].sort((a,b)=>precedence(a.id)-precedence(b.id));
}
function getTopRibbonY(){
  const layers=[...uniformCanvas.querySelectorAll('.layer.ribbonTile,.layer.ribbonMini')];
  if(!layers.length) {
    return rackBaseY + 150;
  }
  return Math.min(...layers.map(l=>parseFloat(l.style.top)||0));
}
function ensureRibbonObj(id){
  let r=State.ribbons.find(x=>x.id===id);
  if(!r){
    r={id,devices:{}};
    State.ribbons.push(r);
  }
  if(!r.devices) r.devices={};
  return r;
}
function drawDevicesOnRibbon(rid,leftPx,topPx,w,h){
  const r=ensureRibbonObj(rid);
  const flat=[];
  for(const [devId,count] of Object.entries(r.devices||{})){
    const meta=deviceMeta[devId];
    if(!meta) continue;
    for(let i=0;i<count;i++){ flat.push({id:devId,...meta}); }
  }
  if(!flat.length) return;

  flat.sort((a,b)=>(b.weight-a.weight)|| (a.label||a.id).localeCompare(b.label||b.id));
  const gap=3;
  const totalW=flat.reduce((s,d,i)=>s+d.w+(i>0?gap:0),0);
  let x=Math.round(leftPx+(w-totalW)/2);
  const y=Math.round(topPx+(h-10)/2)-1;

  flat.forEach(d=>{
    const im=document.createElement('img');
    im.className='layer ribbonDevice';
    im.dataset.parentRid = rid;
    im.src=ASSET(d.src);
    im.alt=d.label||d.id;
    im.style.display='block';
    im.style.left=`${x}px`;
    im.style.top =`${y}px`;
    im.style.width =`${d.w}px`;
    im.style.height=`${d.h}px`;
    im.onerror=()=>{ im.remove(); };
    im.dataset.tooltipTitle = d.label||d.id;
    im.dataset.tooltipReg   = "Device on ribbon";
    im.dataset.tooltipWhy   = "Represents additional awards/credit per CAPR 39-3.";
    uniformCanvas.appendChild(im);
    x+=d.w+gap;
  });
}
function onRibbonTileClick(rid){
  if(State.ribbonDragMode) return;

  if(State.deviceRemoveMode){
    const r=ensureRibbonObj(rid);
    r.devices={};
    renderRack();
    return;
  }
  if(!State.deviceApplyMode)return;
  const r=ensureRibbonObj(rid);
  for(const [devId,qty] of Object.entries(State.selectedDevices)){
    r.devices[devId]=(r.devices[devId]||0)+qty;
  }
  renderRack();
}
function initRibbonDragHandlers(tileEl){
  tileEl.addEventListener('mousedown', e => {
    if(!State.ribbonDragMode) return;
    currentDrag = tileEl;
    currentDrag.classList.add('dragging');
    const startLeft = parseFloat(currentDrag.style.left) || 0;
    const startTop  = parseFloat(currentDrag.style.top)  || 0;
    dragOffsetX = e.clientX - startLeft;
    dragOffsetY = e.clientY - startTop;
    e.preventDefault();
  });
}
function syncDevicesToRibbon(ribbonTileEl){
  const rid = ribbonTileEl.dataset.rid;
  if(!rid) return;
  const baseLeft = parseFloat(ribbonTileEl.style.left) || 0;
  const baseTop  = parseFloat(ribbonTileEl.style.top)  || 0;
  const w = parseFloat(ribbonTileEl.style.width)  || RIBBON_WIDTH;
  const h = parseFloat(ribbonTileEl.style.height) || RIBBON_HEIGHT;

  const r = State.ribbons.find(x => x.id===rid);
  if(!r || !r.devices) return;

  const flat=[];
  for(const [devId,count] of Object.entries(r.devices)){
    const meta=deviceMeta[devId];
    if(!meta) continue;
    for(let i=0;i<count;i++){ flat.push({id:devId,...meta}); }
  }
  flat.sort((a,b)=>(b.weight-a.weight)|| (a.label||a.id).localeCompare(b.label||b.id));

  const gap=3;
  const totalW=flat.reduce((s,d,i)=>s+d.w+(i>0?gap:0),0);
  let x=Math.round(baseLeft+(w-totalW)/2);
  const y=Math.round(baseTop+(h-10)/2)-1;

  const devEls=[...uniformCanvas.querySelectorAll('.ribbonDevice')].filter(el=>el.dataset.parentRid===rid);
  devEls.forEach((el,idx)=>{
    const dv=flat[idx];
    if(!dv) return;
    el.style.left = x+'px';
    el.style.top  = y+'px';
    x+=dv.w+gap;
  });
}
document.addEventListener('mousemove', e => {
  if(!currentDrag || !State.ribbonDragMode) return;
  let newLeft = e.clientX - dragOffsetX;
  let newTop  = e.clientY - dragOffsetY;

  const maxX = 450 - (parseFloat(currentDrag.style.width)  || RIBBON_WIDTH);
  const maxY = 600 - (parseFloat(currentDrag.style.height) || RIBBON_HEIGHT);
  if(newLeft < 0) newLeft = 0;
  if(newTop  < 0) newTop  = 0;
  if(newLeft > maxX) newLeft = maxX;
  if(newTop  > maxY) newTop  = maxY;

  currentDrag.style.left = newLeft + 'px';
  currentDrag.style.top  = newTop  + 'px';

  syncDevicesToRibbon(currentDrag);
});
document.addEventListener('mouseup', () => {
  if(currentDrag){
    currentDrag.classList.remove('dragging');
    currentDrag = null;
  }
});

/* renderRack (unchanged from your version) */
function renderRack(){
  [...uniformCanvas.querySelectorAll('.layer.ribbonTile,.layer.ribbonMini,.layer.ribbonDevice')].forEach(n=>n.remove());

  const baseCfg = UNIFORMS[State.uniform];
  if(!baseCfg) return;

  const uniformPrefersMini   = baseCfg.mini;
  const uniformAllowsRibbons = baseCfg.ribbons;
  const autoMini   = by('autoMini').checked;
  const manualMini = State.forceMini;
  const useMini = (uniformPrefersMini && autoMini) || manualMini;

  const items = sortRibbons(State.ribbons);
  if(!items.length) return;

  const BOTTOM_ROW_Y   = 206;
  const RACK_CENTER_X  = 293.5;

  function getRowLeftPositions(count){
    const totalWidth = count * RIBBON_WIDTH + (count-1)*RIBBON_GAP_X;
    const rowLeftBase = RACK_CENTER_X - totalWidth/2;
    const arr=[];
    for(let i=0;i<count;i++){
      arr.push(rowLeftBase + i*(RIBBON_WIDTH+RIBBON_GAP_X));
    }
    return arr;
  }

  if(!useMini && uniformAllowsRibbons){
    const lowestFirst = [...items].reverse();
    const rowsBottomFirst = [];
    for(let i=0;i<lowestFirst.length;i+=3){
      rowsBottomFirst.push(lowestFirst.slice(i,i+3));
    }
    const rowsTopFirst = [...rowsBottomFirst].reverse();
    const totalRows = rowsTopFirst.length;

    rowsTopFirst.forEach((row,topIndex)=>{
      const indexFromBottom = (totalRows - 1 - topIndex);
      const rowTopPx = BOTTOM_ROW_Y - indexFromBottom * RIBBON_HEIGHT;

      const rowSortedForDisplay = [...row].reverse();
      const leftPositions = getRowLeftPositions(rowSortedForDisplay.length);

      rowSortedForDisplay.forEach((ribbonObj,i)=>{
        const rid = ribbonObj.id;
        const orig=by(`ribbons-${rid}`);
        if(!orig) return;

        const tile=orig.cloneNode();
        tile.className='layer ribbonTile';
        tile.style.display='block';

        const leftPx = leftPositions[i];
        const topPx  = rowTopPx;

        tile.style.left   = `${leftPx}px`;
        tile.style.top    = `${topPx}px`;
        tile.style.width  = `${RIBBON_WIDTH}px`;
        tile.style.height = `${RIBBON_HEIGHT}px`;

        tile.dataset.rid=rid;
        tile.style.pointerEvents='auto';
        tile.onclick=()=>onRibbonTileClick(rid);

        tile.dataset.tooltipTitle = rid.replace(/_/g,' ').toUpperCase();
        tile.dataset.tooltipReg   = "CAPR 39-3 precedence applies";
        tile.dataset.tooltipWhy   = "Highest awards sit top row, leftward.";

        initRibbonDragHandlers(tile);
        uniformCanvas.appendChild(tile);

        drawDevicesOnRibbon(rid,leftPx,topPx,RIBBON_WIDTH,RIBBON_HEIGHT);
      });
    });

    return;
  }

  const MINI_W = 20;
  const MINI_H = 28;
  const MEDAL_PER_ROW = 5;
  const PAD = 6;

  const medalItems = [];
  for(const r of items){
    const medalPath = miniMedalImages[r.id];
    if(medalPath){
      medalItems.push({ id:r.id, path:medalPath });
    }
  }
  if(!medalItems.length) return;

  const lowestFirstMedals = [...medalItems].reverse();
  const medalRowsBottomFirst = [];
  for(let i=0;i<lowestFirstMedals.length;i+=MEDAL_PER_ROW){
    medalRowsBottomFirst.push(lowestFirstMedals.slice(i,i+MEDAL_PER_ROW));
  }
  const medalRowsTopFirst = [...medalRowsBottomFirst].reverse();
  const totalMedalRows = medalRowsTopFirst.length;

  const BOTTOM_ROW_Y_MEDALS = BOTTOM_ROW_Y + 20;

  function getMedalRowLeftPositions(count){
    const totalWidth = count * MINI_W + (count-1)*PAD;
    const rowLeftBase = RACK_CENTER_X - totalWidth/2;
    const arr=[];
    for(let i=0;i<count;i++){
      arr.push(rowLeftBase + i*(MINI_W+PAD));
    }
    return arr;
  }

  medalRowsTopFirst.forEach((row,topIndex)=>{
    const indexFromBottom = (totalMedalRows - 1 - topIndex);
    const rowTopPx = BOTTOM_ROW_Y_MEDALS - indexFromBottom * (MINI_H + PAD);

    const rowSortedForDisplay = [...row].reverse();
    const leftPositions = getMedalRowLeftPositions(rowSortedForDisplay.length);

    rowSortedForDisplay.forEach((entry,i)=>{
      const mimg=document.createElement('img');

      let relPath = entry.path;
      if(relPath.startsWith('images/')){
        relPath = relPath.slice('images/'.length);
      }
      mimg.src=ASSET(relPath);

      mimg.className='layer ribbonMini';
      mimg.style.display='block';

      const leftPx=leftPositions[i];
      const topPx =rowTopPx;

      mimg.style.left   = `${leftPx}px`;
      mimg.style.top    = `${topPx}px`;
      mimg.style.width  = `${MINI_W}px`;
      mimg.style.height = `${MINI_H}px`;

      mimg.onerror=()=>{};

      mimg.dataset.tooltipTitle = entry.id.replace(/_/g,' ').toUpperCase();
      mimg.dataset.tooltipReg   = "Miniature medal arrangement";
      mimg.dataset.tooltipWhy   = "Highest awards sit top row, centered.";

      uniformCanvas.appendChild(mimg);
    });
  });
}

/* ===========================
   DEVICE TOOL UI (unchanged)
   =========================== */
function buildDevicePicker(){
  const wrap=by('devicePicker');
  wrap.innerHTML='';
  deviceList.forEach(id=>{
    const row=document.createElement('label');
    row.style.cssText="display:flex;align-items:center;gap:8px;font-size:12px;";
    row.innerHTML=`
      <input type="checkbox" data-device="${id}"/>
      <span>${deviceMeta[id].label}</span>
      <input type="number" min="1" max="10" value="1" data-qty="${id}" style="width:70px;margin-left:auto">
    `;
    wrap.appendChild(row);
  });
}
function readDevicePicker(){
  const wrap=by('devicePicker');
  const bundle={};
  wrap.querySelectorAll('input[type="checkbox"][data-device]').forEach(chk=>{
    const id=chk.getAttribute('data-device');
    if(chk.checked){
      const qty=parseInt(wrap.querySelector(`input[type="number"][data-qty="${id}"]`).value||"1",10);
      if(qty>0) bundle[id]=qty;
    }
  });
  return bundle;
}
function wireDeviceUI(){
  const applyBtn = by('deviceApplyModeBtn');
  const removeBtn= by('deviceRemoveModeBtn');
  const clearBtn = by('deviceClearSelectionBtn');

  applyBtn.addEventListener('click', ()=>{
    State.selectedDevices = readDevicePicker();
    const hasAny = Object.keys(State.selectedDevices).length>0;
    State.deviceApplyMode = hasAny;
    State.deviceRemoveMode = false;
    applyBtn.textContent = State.deviceApplyMode ? 'Apply Mode: ON' : 'Enable Apply Mode';
    applyBtn.classList.toggle('ghost', !State.deviceApplyMode);
    removeBtn.classList.add('ghost');
  });

  removeBtn.addEventListener('click', ()=>{
    State.deviceRemoveMode = !State.deviceRemoveMode;
    State.deviceApplyMode = false;
    removeBtn.textContent = State.deviceRemoveMode ? 'Remove Mode: ON' : 'Enable Remove Mode';
    removeBtn.classList.toggle('ghost', !State.deviceRemoveMode);
    applyBtn.textContent='Enable Apply Mode';
    applyBtn.classList.add('ghost');
  });

  clearBtn.addEventListener('click', ()=>{
    by('devicePicker').querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false);
    by('devicePicker').querySelectorAll('input[type="number"]').forEach(n=>n.value=1);
    State.selectedDevices={};
    State.deviceApplyMode=false;
    State.deviceRemoveMode=false;
    applyBtn.textContent='Enable Apply Mode';
    removeBtn.textContent='Enable Remove Mode';
    applyBtn.classList.add('ghost');
    removeBtn.classList.add('ghost');
  });
}

/* ===========================
   BADGES (unchanged except membership check)
   =========================== */
const badgeSlots = { OLPA:[], OLPU:[], OLP:[], ORP:[], ON:[], UN:[], LRP:[], LP:[] };
function resetBadgeSlots(){ Object.keys(badgeSlots).forEach(k=>badgeSlots[k]=[]); }

function isCadetAuthorized(id){ return allowedCadetBadges.has(id); }

function enforceExclusive(newId){
  exclusiveBadges.forEach(pair=>{
    if(pair.includes(newId)){
      pair.forEach(conf=>{
        if(conf!==newId && State.badges.includes(conf)){
          State.badges = State.badges.filter(b=>b!==conf);
        }
      });
    }
  });
}

function renderAllBadges(){
  [...uniformCanvas.querySelectorAll('.layer.badge')].forEach(n=>n.remove());
  resetBadgeSlots();
  if(!UI_AUTHZ[State.uniform]?.showBadges) return;

  const maxTotal=5;
  const applied=[];
  for(const id of State.badges){
    if(State.membership==='cadet' && !isCadetAuthorized(id)){ continue; }
    if(applied.length>=maxTotal) break;
    placeBadgeByCategory(id);
    applied.push(id);
  }
}

/* ---- your existing placeBadgeByCategory stays the same ---- */
function placeBadgeByCategory(id){
  const img=by(`badges-${id}`);
  if(!img) return;

  let slot = badgeLocations[id] || 'UN';
  if(id==='nra_marksman_badge') slot='LRP';
  if(id==='model_rocketry_badge') slot='LP';

  const size = customBadgeSizes[id] || { width:60, height:25 };
  const spacing = 5;

  const baseRibbonY = getTopRibbonY();
  const RACK_CENTER_X = 293.5;

  const overRibbonSlots = new Set(['OLP','OLPU','OLPA','ORP']);

  if(overRibbonSlots.has(slot)){
    if(!badgeSlots.OVERSTACK){ badgeSlots.OVERSTACK = []; }
    const stackIdx = badgeSlots.OVERSTACK.length;
    const bottomEdgeY = baseRibbonY - 25 - (stackIdx * (size.height + spacing));
    const topY = bottomEdgeY - size.height;
    const leftX = RACK_CENTER_X - (size.width / 2);

    const clone = img.cloneNode();
    clone.className='layer badge';
    clone.style.display='block';
    clone.style.top  = `${topY}px`;
    clone.style.left = `${leftX}px`;
    clone.style.width = `${size.width}px`;
    clone.style.height= `${size.height}px`;

    clone.dataset.tooltipTitle = id.replace(/_/g,' ').toUpperCase();
    clone.dataset.tooltipReg   = "Over-rack qualification badge";
    clone.dataset.tooltipWhy   = "Centered above ribbon rack per spec (25px gap).";

    uniformCanvas.appendChild(clone);
    badgeSlots.OVERSTACK.push(id);
    return;
  }

  const single = new Set(['LRP','LP']);
  if(single.has(slot) && badgeSlots[slot] && badgeSlots[slot].length>=1){
    return;
  }

  if(!badgeSlots[slot]) badgeSlots[slot] = [];

  const yMap={
    ON:  baseRibbonY + 140,
    UN:  baseRibbonY + 180,
    LRP: baseRibbonY + 199,
    LP:  baseRibbonY + 244
  };
  const xMap={
    ON:  rackBaseX - 105,
    UN:  rackBaseX - 105,
    LRP: rackBaseX + (RIBBON_WIDTH*3) + 60,
    LP:  rackBaseX + (RIBBON_WIDTH*3) + 80
  };

  let y = yMap[slot] !== undefined ? yMap[slot] : (baseRibbonY+180);
  let x = xMap[slot] !== undefined ? xMap[slot] : (rackBaseX-105);

  if(slot==='ON'||slot==='UN'){
    const stackIdx = badgeSlots[slot].length;
    for(let i=0;i<stackIdx;i++){
      const prev=badgeSlots[slot][i];
      const ps=customBadgeSizes[prev]||{height:25};
      y+=ps.height+spacing;
    }
  }

  if(id==='model_rocketry_badge' && State.badges.includes('nra_marksman_badge')){
    y+=50;
  }

  const clone=img.cloneNode();
  clone.className='layer badge';
  clone.style.display='block';
  clone.style.top  = `${y}px`;
  clone.style.left = `${x}px`;
  clone.style.width = `${size.width}px`;
  clone.style.height= `${size.height}px`;

  clone.dataset.tooltipTitle = id.replace(/_/g,' ').toUpperCase();
  clone.dataset.tooltipReg   = "CAPR 39-1 badge placement";
  clone.dataset.tooltipWhy   = "Auto-placed relative to pockets / nameplate.";

  uniformCanvas.appendChild(clone);

  badgeSlots[slot].push(id);
}

/* ===========================
   PATCHES (unchanged)
   =========================== */
const patchSlots = { L_SHOULDER:[], R_SHOULDER:[], CHEST_LEFT:[], CHEST_RIGHT:[] };
function resetPatchSlots(){ Object.keys(patchSlots).forEach(k=>patchSlots[k]=[]); }

function planPatches(ids){
  resetPatchSlots();
  const capsPerUniform = {
    blues_a:{L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:1,CHEST_RIGHT:1},
    blues_b:{L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:1,CHEST_RIGHT:1},
    aviator:{L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:1,CHEST_RIGHT:1},
    aviator_blazer:{L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:0,CHEST_RIGHT:0},
    corporate_field:{L_SHOULDER:2,R_SHOULDER:2,CHEST_LEFT:1,CHEST_RIGHT:1},
    abu:{L_SHOULDER:2,R_SHOULDER:2,CHEST_LEFT:1,CHEST_RIGHT:1},
    flight_suit:{L_SHOULDER:2,R_SHOULDER:2,CHEST_LEFT:2,CHEST_RIGHT:2},
    semi_formal:{L_SHOULDER:0,R_SHOULDER:0,CHEST_LEFT:0,CHEST_RIGHT:0},
    mess_dress:{L_SHOULDER:0,R_SHOULDER:0,CHEST_LEFT:0,CHEST_RIGHT:0},
    polo:{L_SHOULDER:0,R_SHOULDER:0,CHEST_LEFT:0,CHEST_RIGHT:0}
  }[State.uniform] || {L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:1,CHEST_RIGHT:1};

  for(const id of ids){
    const meta=PATCH_META[id]; if(!meta) continue;
    const hint=meta.slotHint || 'L_SHOULDER';
    const cap=capsPerUniform[hint]??0;
    if(cap===0) continue;
    if(patchSlots[hint].length>=cap) continue;
    patchSlots[hint].push(id);
  }
}

function renderPatches(){
  [...uniformCanvas.querySelectorAll('.layer.patch')].forEach(n=>n.remove());
  if(!UI_AUTHZ[State.uniform]?.showPatches) return;

  planPatches(State.patches);

  const coords={
    L_SHOULDER:{x:95,y:250,dy:80},
    R_SHOULDER:{x:505,y:250,dy:80},
    CHEST_LEFT:{x:260,y:420,dy:70},
    CHEST_RIGHT:{x:580,y:420,dy:70}
  };

  for(const slot of Object.keys(patchSlots)){
    const ids=patchSlots[slot];
    let {x,y,dy}=coords[slot]||{x:0,y:0,dy:70};
    for(const id of ids){
      const meta=PATCH_META[id];
      const src = by('patch-'+id);
      const el  = (src?src.cloneNode():new Image());
      if(!src){ el.src=ASSET(meta.img); }

      el.className='layer patch';
      el.style.display='block';
      el.style.left =`${x - meta.w/2}px`;
      el.style.top  =`${y - meta.h/2}px`;
      el.style.width =`${meta.w}px`;
      el.style.height=`${meta.h}px`;
      el.onerror=()=>{};

      el.dataset.tooltipTitle = id.replace(/_/g,' ').toUpperCase();
      el.dataset.tooltipReg   = "Field/utility patch placement";
      el.dataset.tooltipWhy   = "Displayed on sleeve/chest per OCP/ABU/corporate field rules.";

      uniformCanvas.appendChild(el);
      y+=dy;
    }
  }
}

/* ===========================
   RANK / NAMEPLATE (UPDATED)
   =========================== */
function renderRank(id){
  [...uniformCanvas.querySelectorAll('.layer.rank')].forEach(n=>n.remove());
  if(!id) return;

  // Senior NCO: base coat already has the chevrons baked in -> don't overlay rank here
  if(State.membership==='senior' && SENIOR_NCO_RANKS.has(id)){
    return;
  }

  const insigniaEl = by('ranks-'+id);
  if(!insigniaEl) return;

  const isOfficer = OFFICER_RANKS.has(id);

  if(isOfficer){
    const boardSrc=ASSET('ranks/C/shoulder_board.png');
    const boardCfg={width:50,height:100};
    const insigniaCfg={width:32,height:32};
    const placements=[
      {left:350,top:160,rot:90},
      {left:100,top:160,rot:-90}
    ];
    placements.forEach(({left,top,rot})=>{
      const board=document.createElement('img');
      board.src=boardSrc;
      board.className='layer rank';
      board.style.display='block';
      board.style.left =`${left}px`;
      board.style.top  =`${top}px`;
      board.style.width =`${boardCfg.width}px`;
      board.style.height=`${boardCfg.height}px`;
      board.style.transform=`rotate(${rot}deg)`;
      board.style.transformOrigin='center center';
      uniformCanvas.appendChild(board);

      const ins=insigniaEl.cloneNode();
      ins.className='layer rank';
      ins.style.display='block';
      ins.style.left =`${left + (boardCfg.width/2 - insigniaCfg.width/2)}px`;
      ins.style.top  =`${top  + (boardCfg.height/2 - insigniaCfg.height/2)}px`;
      ins.style.width =`${insigniaCfg.width}px`;
      ins.style.height=`${insigniaCfg.height}px`;
      ins.style.transform=`rotate(${rot}deg)`;
      ins.style.transformOrigin='center center';
      uniformCanvas.appendChild(ins);
    });
    return;
  }

  const size={w:60,h:60};
  const pos ={left:420,top:200};
  const icon=insigniaEl.cloneNode();
  icon.className='layer rank';
  icon.style.display='block';
  icon.style.left =`${pos.left}px`;
  icon.style.top  =`${pos.top}px`;
  icon.style.width =`${size.w}px`;
  icon.style.height=`${size.h}px`;
  uniformCanvas.appendChild(icon);
}

function renderNameplate(){
  [...uniformCanvas.querySelectorAll('.layer.nameplate')].forEach(n=>n.remove());
  const baseRibbonY=getTopRibbonY();
  const npTop  = baseRibbonY + 150;
  const npLeft = rackBaseX - 120;

  const el=document.createElement('img');
  el.src=ASSET('nameplate/nameplate.png');
  el.className='layer nameplate';
  el.style.display='block';
  el.style.top  = npTop+'px';
  el.style.left = npLeft+'px';
  el.style.width='100px';
  el.style.height='20px';
  uniformCanvas.appendChild(el);
}

/* ===========================
   AVAILABILITY / ALTERNATES (UPDATED membership check)
   =========================== */
function updateAvailabilityUI(prevUniform){
  const auth = UI_AUTHZ[State.uniform] || {showRibbons:true,showPatches:true,showBadges:true};
  by('groupRibbons').classList.toggle('hidden', !auth.showRibbons && !UNIFORMS[State.uniform].mini);
  by('groupPatches').classList.toggle('hidden', !auth.showPatches);

  if(prevUniform && prevUniform!==State.uniform){
    applyAlternates(prevUniform, State.uniform);
  }

  populatePatchesRemove();
  populateBadgesRemove();
}

function applyAlternates(fromU,toU){
  const fromField=isFieldUniform(fromU);
  const toField  =isFieldUniform(toU);

  if(!fromField && toField){
    Object.entries(ALTERNATES.badgeToPatch).forEach(([badge,patch])=>{
      if(State.badges.includes(badge) && !State.patches.includes(patch)){
        State.patches.push(patch);
      }
    });
    Object.entries(ALTERNATES.ribbonToPatch).forEach(([ribbon,patch])=>{
      if(State.ribbons.find(r=>r.id===ribbon) && !State.patches.includes(patch)){
        State.patches.push(patch);
      }
    });
  } else if(fromField && !toField){
    Object.entries(ALTERNATES.patchToBadge).forEach(([patch,badge])=>{
      if(State.patches.includes(patch) && badge && !State.badges.includes(badge)){
        State.badges.push(badge);
      }
    });
    Object.entries(ALTERNATES.patchToRibbon).forEach(([patch,ribbon])=>{
      if(State.patches.includes(patch) && ribbon && !State.ribbons.find(r=>r.id===ribbon)){
        State.ribbons.push({id:ribbon,devices:{}});
      }
    });
  }

  if(State.membership==='cadet'){
    State.badges = State.badges.filter(isCadetAuthorized);
  }
}

/* ===========================
   RENDER PIPELINE
   =========================== */
function fullRender(prevUniform){
  clearLayers(); // wipe all layers if you want setup gating to show empty
  applyJacket();
  if(!resolveBaseUniformPath()) return; // don't render items until base exists

  updateAvailabilityUI(prevUniform);
  renderPatches();
  renderRack();
  renderAllBadges();
  renderRank(State.rank);
}

function refreshUI(){
  // keep setup selectors aligned
  membershipTypeEl.value = State.membership || '';
  rankSetupSelect.value = State.rank || '';
  jacketSelect.value = State.gender || '';
  assetBaseInput.value=State.assetBase;

  populateBadgesRemove();
  populatePatchesRemove();
  highlightActiveUniformButton();
  applyMemberTypeToUniformOptions();

  // keep legacy rank dropdown synced
  if(State.rank) by('rankSelect').value = State.rank;
}

/* ===========================
   UNIFORM BUTTON CLICK
   =========================== */
uniformListEl.addEventListener('click', e=>{
  const btn=e.target.closest('.uniformOption');
  if(!btn) return;
  if(btn.classList.contains('locked')) return;

  const newUniform=btn.dataset.uniformId;
  const prevU=State.uniform;
  State.uniform=newUniform;

  fullRender(prevU);
  refreshUI();
});

/* ===========================
   EVENT WIRING (REST OF YOUR ORIGINAL)
   =========================== */
by('applyJacket').addEventListener('click', ()=>{
  State.assetBase=(assetBaseInput.value||'images').trim()||'images';
  fullRender();
});

assetBaseInput.addEventListener('change', ()=>{
  State.assetBase=(assetBaseInput.value||'images').trim()||'images';
  fullRender();
});

by('addRibbon').addEventListener('click', ()=>{
  const id=by('ribbonSelect').value;
  const dev=by('deviceSelect').value||'none';
  const r=ensureRibbonObj(id);
  if(dev && dev!=='none'){
    r.devices[dev]=(r.devices[dev]||0)+1;
  }
  renderRack();
  renderAllBadges();
});

by('clearRibbons').addEventListener('click', ()=>{
  State.ribbons=[];
  renderRack();
  renderAllBadges();
});

by('toggleMini').addEventListener('change', e=>{
  State.forceMini = e.target.checked;
  renderRack();
  renderAllBadges();
});

buildDevicePicker();
wireDeviceUI();

by('addBadge').addEventListener('click', ()=>{
  const id=by('badgeSelect').value;
  if(State.membership==='cadet' && !isCadetAuthorized(id)){
    alert('This badge is not authorized for cadets.');
    return;
  }
  enforceExclusive(id);
  if(!State.badges.includes(id)) State.badges.push(id);
  populateBadgesRemove();
  renderAllBadges();
});

by('removeBadge').addEventListener('click', ()=>{
  const id=by('removeBadgeSelect').value;
  State.badges=State.badges.filter(b=>b!==id);
  populateBadgesRemove();
  renderAllBadges();
});

by('addPatch').addEventListener('click', ()=>{
  const id=by('patchSelect').value;
  if(!State.patches.includes(id)) State.patches.push(id);
  populatePatchesRemove();
  renderPatches();
});

by('removePatch').addEventListener('click', ()=>{
  const id=by('removePatchSelect').value;
  State.patches=State.patches.filter(p=>p!==id);
  populatePatchesRemove();
  renderPatches();
});

by('addRank').addEventListener('click', ()=>{
  // allow manual override, but keep setup synced
  State.rank=by('rankSelect').value || null;
  rankSetupSelect.value = State.rank || '';
  renderRank(State.rank);
});

by('addNameplate').addEventListener('click', ()=>{
  renderNameplate();
});

by('downloadImage').addEventListener('click', ()=>{
  html2canvas(uniformCanvas,{scale:3,backgroundColor:'#ffffff'}).then(c=>{
    const a=document.createElement('a');
    a.download=`CAP_Uniform_${Date.now()}.png`;
    a.href=c.toDataURL();
    a.click();
  });
});

const toggleRibbonDragBtn = by('toggleRibbonDrag');
const logRibbonCoordsBtn  = by('logRibbonCoords');

toggleRibbonDragBtn.addEventListener('click', ()=>{
  State.ribbonDragMode = !State.ribbonDragMode;
  if(State.ribbonDragMode){
    toggleRibbonDragBtn.textContent = 'Disable Drag Mode';
    toggleRibbonDragBtn.classList.remove('ghost');
    uniformCanvas.classList.add('drag-mode-on');
  }else{
    toggleRibbonDragBtn.textContent = 'Enable Drag Mode';
    toggleRibbonDragBtn.classList.add('ghost');
    uniformCanvas.classList.remove('drag-mode-on');
  }
});

logRibbonCoordsBtn.addEventListener('click', ()=>{
  const data=[];
  uniformCanvas.querySelectorAll('.ribbonTile').forEach(tile=>{
    data.push({
      rid: tile.dataset.rid,
      left: tile.style.left,
      top: tile.style.top,
      width: tile.style.width,
      height: tile.style.height
    });
  });
  console.log('RIBBON_COORD_REPORT', data);
  alert('Ribbon coordinates logged to console.');
});

/* ===========================
   CALIBRATOR PANEL WIRING (unchanged)
   =========================== */
function initCalibratorUI(){
  const tab          = by('calibratorTab');
  const arrow        = by('calibratorArrow');
  const panel        = by('calibratorPanel');

  const rackXRange   = by('rackXRange');
  const rackXNumber  = by('rackXNumber');
  const rackYRange   = by('rackYRange');
  const rackYNumber  = by('rackYNumber');

  const readX        = by('readX');
  const readY        = by('readY');
  const readSize     = by('readSize');

  rackXRange.value  = rackBaseX;
  rackXNumber.value = rackBaseX;
  rackYRange.value  = rackBaseY;
  rackYNumber.value = rackBaseY;
  readX.textContent = rackBaseX;
  readY.textContent = rackBaseY;
  readSize.textContent = RIBBON_WIDTH + "×" + RIBBON_HEIGHT;

  let open=false;
  function togglePanel(){
    open=!open;
    panel.style.display=open?'block':'none';
    arrow.textContent=open?'‹':'›';
  }
  tab.addEventListener('click', togglePanel);

  function applyAndRerender(){
    readX.textContent=rackBaseX;
    readY.textContent=rackBaseY;

    renderRack();
    renderAllBadges();
    renderNameplate();
    renderRank(State.rank);
  }

  rackXRange.addEventListener('input', e=>{
    rackBaseX = parseInt(e.target.value,10);
    rackXNumber.value = rackBaseX;
    applyAndRerender();
  });
  rackXNumber.addEventListener('input', e=>{
    rackBaseX = parseInt(e.target.value,10) || 0;
    rackXRange.value = rackBaseX;
    applyAndRerender();
  });

  rackYRange.addEventListener('input', e=>{
    rackBaseY = parseInt(e.target.value,10);
    rackYNumber.value = rackBaseY;
    applyAndRerender();
  });
  rackYNumber.addEventListener('input', e=>{
    rackBaseY = parseInt(e.target.value,10) || 0;
    rackYRange.value = rackBaseY;
    applyAndRerender();
  });
}

/* ===========================
   BOOTSTRAP
   =========================== */
(function init(){
  // start with gated UI
  applyMemberTypeToUniformOptions();
  populateRankSetup();
  updateSetupGates();
  refreshUI();
  fullRender();
  initCalibratorUI();
})();
</script>
</body>
</html>
