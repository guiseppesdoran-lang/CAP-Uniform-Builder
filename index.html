<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CAP Uniform Builder — Full Program</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  :root{ --bg:#eef1f5; --ink:#0d1b2a; --muted:#516079; --panel:#ffffff; --line:#cfd6df; --brand:#002855; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
  header{background:var(--brand);color:#fff;padding:14px 16px;text-align:center}
  header h1{margin:0;font-size:18px;letter-spacing:.3px}
  main{display:flex}
  #controls{width:360px;background:var(--panel);padding:14px;border-right:1px solid var(--line);overflow:auto;height:calc(100vh - 58px)}
  #preview{flex:1;background:#d1d8e0;display:flex;align-items:flex-start;justify-content:center;position:relative;height:calc(100vh - 58px)}
  #uniformCanvas{position:relative;width:900px;height:1200px}
  .layer{position:absolute;image-rendering:auto}
  label{font-size:12px;color:var(--muted);margin-top:8px;display:block}
  select,button,input{width:100%;margin-top:6px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#f8fafc}
  button{cursor:pointer;background:#0f2a54;color:#fff;border-color:#163766}
  button.ghost{background:#ffffff;color:var(--ink)}
  .row{display:flex;gap:8px}
  .two .col{flex:1}
  .hidden{display:none !important}

  /* Device tool */
  #deviceTool{margin-top:10px;border:1px solid var(--line);border-radius:10px;padding:10px;background:#fefefe}
  #devicePicker{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  #deviceTool button{width:auto}

  @media (max-width: 1024px){
    main{flex-direction:column}
    #controls{width:100%;height:auto;border-right:none;border-bottom:1px solid var(--line)}
    #preview{height:auto}
    #uniformCanvas{width:600px;height:900px}
  }
</style>
</head>
<body>
<header>
  <h1>CAP Uniform Builder — Full Program (images/ path)</h1>
</header>

<main>
  <section id="controls">
    <div class="row two">
      <div class="col">
        <label>Member</label>
        <select id="memberSelect">
          <option value="cadet">Cadet</option>
          <option value="senior">Senior</option>
        </select>
      </div>
      <div class="col">
        <label>Gender</label>
        <select id="jacketSelect">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </div>
    </div>

    <label>Uniform</label>
    <select id="uniformSelect">
      <option value="blues_a">Blues: Class A</option>
      <option value="blues_b">Blues: Class B</option>
      <option value="mess_dress">Mess Dress (Senior)</option>
      <option value="semi_formal">Semi-formal</option>
      <option value="aviator">Aviator (Senior)</option>
      <option value="aviator_blazer">Aviator + Blazer (Senior)</option>
      <option value="corporate_field">Corporate Field</option>
      <option value="abu">ABUs</option>
      <option value="flight_suit">Flight Suit</option>
      <option value="polo">Polo (Senior)</option>
    </select>

    <div class="row two">
      <div class="col">
        <label>Asset Base</label>
        <input id="assetBase" value="images" placeholder="images"/>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button id="applyJacket" class="ghost">Apply Jacket</button>
      </div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid var(--line)">

    <div id="groupRibbons">
      <label>Ribbons</label>
      <div class="row two">
        <div class="col"><select id="ribbonSelect"></select></div>
        <div class="col"><select id="deviceSelect"></select></div>
      </div>
      <div class="row two" style="margin-top:6px">
        <div class="col"><button id="addRibbon">Add Ribbon</button></div>
        <div class="col"><button id="clearRibbons" class="ghost">Clear Ribbons</button></div>
      </div>
      <label><input type="checkbox" id="autoMini" checked> Auto-convert ribbons → mini-medals on Mess/Semi-formal</label>

      <!-- Advanced device tool (multi-select + quantities + click-to-apply) -->
      <div id="deviceTool">
        <strong>Ribbon Devices — Multi-Apply</strong>
        <div id="devicePicker"></div>
        <div class="row" style="margin-top:8px">
          <button id="deviceApplyModeBtn" type="button">Enable Apply Mode</button>
          <button id="deviceRemoveModeBtn" type="button" class="ghost">Enable Remove Mode</button>
          <button id="deviceClearSelectionBtn" type="button" class="ghost">Clear Selection</button>
        </div>
        <small style="color:#516079;display:block;margin-top:6px">
          Choose devices + quantities → Enable Apply Mode → click a ribbon to add them. Use Remove Mode to clear devices from a ribbon.
        </small>
      </div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid var(--line)">

    <label>Badges</label>
    <div class="row two">
      <div class="col"><select id="badgeSelect"></select></div>
      <div class="col"><button id="addBadge">Add Badge</button></div>
    </div>
    <div class="row two" style="margin-top:6px">
      <div class="col"><select id="removeBadgeSelect"></select></div>
      <div class="col"><button id="removeBadge" class="ghost">Remove Badge</button></div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid var(--line)">

    <div id="groupPatches">
      <label>Patches</label>
      <div class="row two">
        <div class="col"><select id="patchSelect"></select></div>
        <div class="col"><button id="addPatch">Add Patch</button></div>
      </div>
      <div class="row two" style="margin-top:6px">
        <div class="col"><select id="removePatchSelect"></select></div>
        <div class="col"><button id="removePatch" class="ghost">Remove Patch</button></div>
      </div>
      <div class="hint">Field uniforms swap certain badges/ribbons into their patch equivalents automatically.</div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid var(--line)">

    <label>Rank Insignia</label>
    <div class="row two">
      <div class="col"><select id="rankSelect"></select></div>
      <div class="col"><button id="addRank">Set Rank</button></div>
    </div>
    <div class="row two" style="margin-top:6px">
      <div class="col"><button id="addNameplate" class="ghost">Add Nameplate</button></div>
      <div class="col"><button id="downloadImage">Download PNG</button></div>
    </div>
  </section>

  <section id="preview">
    <div id="uniformCanvas"></div>
  </section>
</main>

<!-- Hidden assets root -->
<div class="layer" id="assets" style="display:none"></div>

<script>
/* ============ State ============ */
const State = {
  member:'cadet',
  gender:'male',
  uniform:'blues_a',
  assetBase:'images',
  // ribbons: [{id, devices:{ deviceId: qty, ... }}]
  ribbons:[],
  badges:[],
  patches:[],
  rank:null,
  // device tool state
  deviceApplyMode:false,
  deviceRemoveMode:false,
  selectedDevices:{} // {deviceId: qty}
};

const $  = s => document.querySelector(s);
const by = id => document.getElementById(id);
const uniformCanvas  = by('uniformCanvas');
const assetsContainer= by('assets');

/* ============ Helpers ============ */
function ASSET(p){
  const b=(State.assetBase||'images').replace(/\/$/,'');
  return `${b}/${p}`;
}
function isFieldUniform(u){ return u==='abu' || u==='flight_suit' || u==='corporate_field'; }

/* ============ UNIFORMS + UI Authz (what controls show) ============ */
const UNIFORMS = {
  blues_a:{male:'base/jacket_male.png',         female:'base/jacket_female.png',         ribbons:true,  mini:false},
  blues_b:{male:'base/blues_class_b_male.png',  female:'base/blues_class_b_female.png',  ribbons:true,  mini:false},
  mess_dress:{male:'base/mess_dress_male.png',  female:'base/mess_dress_female.png',     ribbons:false, mini:true},
  semi_formal:{male:'base/semi_male.png',       female:'base/semi_female.png',           ribbons:false, mini:true},
  aviator:{male:'base/aviator_shirt_male.png',  female:'base/aviator_shirt_female.png',  ribbons:true,  mini:false},
  aviator_blazer:{male:'base/aviator_blazer_male.png',female:'base/aviator_blazer_female.png', ribbons:true, mini:false},
  corporate_field:{male:'base/corporate_field_male.png',female:'base/corporate_field_female.png', ribbons:true, mini:false},
  abu:{male:'base/ABU_male.png',                female:'base/ABU_female.png',            ribbons:false, mini:false},
  flight_suit:{male:'base/flight_suit_male.png',female:'base/flight_suit_female.png',    ribbons:false, mini:false},
  polo:{male:'base/polo_male.png',              female:'base/polo_female.png',           ribbons:false, mini:false}
};

const UI_AUTHZ = {
  // Service/uniforms that show ribbons & badges, hide patches
  blues_a:{ showRibbons:true, showBadges:true,  showPatches:false },
  blues_b:{ showRibbons:true, showBadges:true,  showPatches:false },
  aviator:{ showRibbons:true, showBadges:true,  showPatches:false },
  aviator_blazer:{ showRibbons:true, showBadges:true, showPatches:false },
  corporate_field:{ showRibbons:true, showBadges:false, showPatches:true }, // treat as field for badges
  // Mess/semi use mini-medals (no ribbon UI)
  mess_dress:{ showRibbons:false, showBadges:true,  showPatches:false },
  semi_formal:{ showRibbons:false, showBadges:true, showPatches:false },
  // Field uniforms show patches, hide ribbons and metal badges for this tool
  abu:{ showRibbons:false, showBadges:false, showPatches:true },
  flight_suit:{ showRibbons:false, showBadges:false, showPatches:true },
  polo:{ showRibbons:false, showBadges:false, showPatches:false }
};

/* ============ RIBBONS / DEVICES ============ */
const ribbonList = [
  'silver_medal_of_valor','bronze_medal_of_valor','distinguished_service_award','exceptional_service_award','meritorious_service_award','commander_commendation_award','cap_achievment_award','lifesaving_award','national_commander_unit_citation_award','unit_citation_award','spaatz_award','eaker_award','earhart_award','mitchell_award','armstrong_achievement','goddard_achievement','doolittle_achievement','lindbergh_achievement','rickenbacker_achievement','wright_brothers_award','mary_feik_achievement','hap_arnold_achievement','curry_achievement','afa_award','afsa_award','vfw_officer_award','vfw_nco_award','crisis_ribbon','red_service_ribbon','search_find_ribbon','air_search_and_rescue_ribbon','disaster_relief_ribbon','homeland_security_ribbon','community_service_ribbon','iace_ribbon','national_cadet_competition_ribbon','national_color_guard_competition_ribbon','cadet_advisory_council_ribbon','cadet_special_activity_ribbon','encampment_ribbon','cadet_recruiter_ribbon',
  // include for alt demo
  'orientation_pilot_ribbon'
];
const precedence = id => ribbonList.indexOf(id);

const deviceList = ['1_Bronze_Star_Device','1_Silver_Star_Device'];
const deviceMeta = {
  '1_Bronze_Star_Device': { label:'Bronze Star', src:'devices/1_Bronze_Star_Device.webp', w:10, h:10, weight:1 },
  '1_Silver_Star_Device': { label:'Silver Star', src:'devices/1_Silver_Star_Device.webp', w:10, h:10, weight:2 }
};

/* ============ BADGES (subset) ============ */
const badgeList = [
  'AirCrew1_DB3F0FCC3650F','BalloonPilot1_442D89C94185B','CAPMasterPilot1_621A0E2ED15DA','CAPPilot1_FA9D33EA587D8','CAPSeniorPilot1_D9725AE959752','GliderPilot1_7BFB287379918','MasterAirCrew1_72AC4CAE7A310','MasterObserver1_1B88D5071FD5C','SeniorAirCrew1_B289BAE6E515C','SeniorObserver1_0E35802A29801',
  'buddist_chaplin','christian_chaplin','communications_technician_badge','cyber_badges','emergency_services_badge','emt_basic_badge','emt_intermediate','emt_paramedic','ground_team_basic_badge','historian_technicianIbadge','information_technology_technician_badge','jewish_chaplin','legal_officer','master_ground_team_badge','medical_officer','model_rocketry_badge','muslim_chaplin','nra_marksman_badge','nurse_officer','observer_badge','pre_solo_badge','senior_ground_team_badge','solo_badge','stem_badges'
];
const allowedCadetBadges = new Set([
  'solo_badge','pre_solo_badge','ground_team_basic_badge','senior_ground_team_badge','master_ground_team_badge','emt_basic_badge','emt_intermediate','emt_paramedic','aerospace','model_rocketry_badge','communications_technician_badge','information_technology_technician_badge','cyber_badges','stem_badges','cadetadvisory','cd','nra_marksman_badge','AirCrew1_DB3F0FCC3650F','BalloonPilot1_442D89C94185B','CAPMasterPilot1_621A0E2ED15DA','CAPPilot1_FA9D33EA587D8','CAPSeniorPilot1_D9725AE959752','GliderPilot1_7BFB287379918','MasterAirCrew1_72AC4CAE7A310','SeniorAirCrew1_B289BAE6E515C','SeniorObserver1_0E35802A29801','MasterObserver1_1B88D5071FD5C','observer_badge','emergency_services_badge','historian_technicianIbadge'
]);
const exclusiveBadges = [
  ['emt_basic_badge','ground_team_basic_badge'],
  ['emt_intermediate','senior_ground_team_badge'],
  ['emt_paramedic','master_ground_team_badge']
];
const badgeLocations = {
  'AirCrew1_DB3F0FCC3650F':'OLP','BalloonPilot1_442D89C94185B':'OLP','CAPMasterPilot1_621A0E2ED15DA':'OLP','CAPPilot1_FA9D33EA587D8':'OLP','CAPSeniorPilot1_D9725AE959752':'OLP','GliderPilot1_7BFB287379918':'OLP','MasterAirCrew1_72AC4CAE7A310':'OLP',
  'SeniorAirCrew1_B289BAE6E515C':'OLP','pre_solo_badge':'OLP','solo_badge':'OLP',
  'cyber_badges':'LP','stem_badges':'LP','communications_technician_badge':'LP','information_technology_technician_badge':'LP',
  'nra_marksman_badge':'LRP',
  'MasterObserver1_1B88D5071FD5C':'LP','SeniorObserver1_0E35802A29801':'LP','observer_badge':'LP',
  'ground_team_basic_badge':'OLPU','senior_ground_team_badge':'OLPU','master_ground_team_badge':'OLPU','emergency_services_badge':'OLPU','emt_basic_badge':'OLPU','emt_intermediate':'OLPU','emt_paramedic':'OLPU',
  'historian_technicianIbadge':'LP','model_rocketry_badge':'LP',
  'buddist_chaplin':'ORP','christian_chaplin':'ORP','jewish_chaplin':'ORP','legal_officer':'ORP','medical_officer':'ORP','nurse_officer':'ORP','muslim_chaplin':'ORP'
};
const customBadgeSizes = {
  'AirCrew1_DB3F0FCC3650F':{width:60,height:25},'BalloonPilot1_442D89C94185B':{width:60,height:25},'CAPMasterPilot1_621A0E2ED15DA':{width:60,height:25},'CAPPilot1_FA9D33EA587D8':{width:60,height:25},'CAPSeniorPilot1_D9725AE959752':{width:60,height:25},'GliderPilot1_7BFB287379918':{width:60,height:25},'MasterAirCrew1_72AC4CAE7A310':{width:60,height:25},'MasterObserver1_1B88D5071FD5C':{width:60,height:25},'SeniorAirCrew1_0E35802A29801':{width:60,height:25},'SeniorObserver1_0E35802A29801':{width:60,height:25},
  'buddist_chaplin':{width:60,height:60},'christian_chaplin':{width:60,height:60},'communications_technician_badge':{width:60,height:60},
  'cyber_badges':{width:60,height:25},'emergency_services_badge':{width:60,height:60},'emt_basic_badge':{width:60,height:60},
  'emt_intermediate':{width:60,height:60},'emt_paramedic':{width:60,height:60},'ground_team_basic_badge':{width:25,height:20},
  'historian_technicianIbadge':{width:60,height:60},'information_technology_technician_badge':{width:60,height:60},
  'jewish_chaplin':{width:60,height:60},'legal_officer':{width:60,height:25},'master_ground_team_badge':{width:25,height:20},
  'medical_officer':{width:60,height:60},'model_rocketry_badge':{width:7,height:28.125},'muslim_chaplin':{width:60,height:60},
  'nra_marksman_badge':{width:40,height:60},'nurse_officer':{width:60,height:60},'observer_badge':{width:60,height:25},
  'pre_solo_badge':{width:60,height:25},'senior_ground_team_badge':{width:25,height:20},'solo_badge':{width:60,height:25},'stem_badges':{width:60,height:25}
};

/* ============ PATCHES + Alternates ============ */
const patchList = ['us_flag_patch','command_patch','wing_patch','unit_patch','aerospace_education_patch','communications_patch','orientation_pilot_patch'];
const PATCH_META = {
  'us_flag_patch':{slotHint:'R_SHOULDER', w:60,h:40, img:'patches/us_flag_patch.png'},
  'command_patch':{slotHint:'L_SHOULDER', w:70,h:70, img:'patches/command_patch.png'},
  'wing_patch':{slotHint:'L_SHOULDER', w:60,h:60, img:'patches/wing_patch.png'},
  'unit_patch':{slotHint:'R_SHOULDER', w:60,h:60, img:'patches/unit_patch.png'},
  'aerospace_education_patch':{slotHint:'CHEST_LEFT', w:60,h:60, img:'patches/aerospace_education_patch.png'},
  // Alternates for field uniforms:
  'communications_patch':{slotHint:'CHEST_RIGHT', w:60,h:60, img:'patches/communications_patch.png'},
  'orientation_pilot_patch':{slotHint:'CHEST_LEFT', w:60,h:60, img:'patches/orientation_pilot_patch.png'}
};

// Alternates map: swap when moving to/from field uniforms.
const ALTERNATES = {
  // badge ↔ patch
  badgeToPatch: {
    'communications_technician_badge':'communications_patch'
  },
  patchToBadge: {
    'communications_patch':'communications_technician_badge'
  },
  // ribbon ↔ patch
  ribbonToPatch: {
    'orientation_pilot_ribbon':'orientation_pilot_patch'
  },
  patchToRibbon: {
    'orientation_pilot_patch':'orientation_pilot_ribbon'
  }
};

/* ============ Ranks ============ */
const rankList = ['C/AB','C/Amn','C/A1C','C/SrA','C/SSgt','C/TSgt','C/MSgt','C/SMSgt','C/CMSgt','C/2d Lt','C/1st Lt','C/Capt','C/Maj','C/Lt Col','C/Col'];
const officerRanks = new Set(['C/2d Lt','C/1st Lt','C/Capt','C/Maj','C/Lt Col','C/Col']);

/* ============ Populators & Preloaders ============ */
function optionize(sel, list){
  sel.innerHTML='';
  list.forEach(v=>{
    const o=document.createElement('option');
    o.value=v;
    o.textContent=v.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    sel.appendChild(o);
  });
}
function populateBadgesRemove(){
  const sel=by('removeBadgeSelect'); if(!sel) return;
  sel.innerHTML='';
  State.badges.forEach(id=>{
    const o=document.createElement('option');
    o.value=id;
    o.textContent=id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    sel.appendChild(o);
  });
}
function populatePatchesRemove(){
  const sel=by('removePatchSelect'); if(!sel) return;
  sel.innerHTML='';
  State.patches.forEach(id=>{
    const o=document.createElement('option');
    o.value=id;
    o.textContent=id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    sel.appendChild(o);
  });
}

function preloadSimple(prefix, list, folder, ext=".png"){
  list.forEach(id=>{
    const img=document.createElement('img');
    img.id = `${prefix}-${id}`;
    img.src = ASSET(`${folder}/${id}${ext}`);
    img.style.display='none';
    img.loading='eager';
    img.decoding='sync';
    img.onerror=()=>{}; // tolerate missing assets
    assetsContainer.appendChild(img);
  });
}
function preloadWithResolver(prefix, list, resolver){
  list.forEach(id=>{
    const src = resolver(id);
    const img=document.createElement('img');
    img.id = `${prefix}-${id}`;
    img.src = ASSET(src);
    img.style.display='none';
    img.loading='eager';
    img.decoding='sync';
    img.onerror=()=>{};
    assetsContainer.appendChild(img);
  });
}

/* Initial UI & Preloads */
optionize(by('ribbonSelect'), ribbonList);
optionize(by('deviceSelect'), ['none', ...deviceList]);
optionize(by('rankSelect'), rankList);
optionize(by('badgeSelect'), badgeList);
optionize(by('patchSelect'), patchList);

preloadSimple('ribbons', ribbonList, 'ribbons', '.png');
preloadWithResolver('devices', deviceList, id => deviceMeta[id].src);
preloadSimple('ranks', rankList, 'ranks', '.png');
preloadSimple('badges', badgeList, 'badges', '.png');
Object.entries(PATCH_META).forEach(([id,m])=>{
  const img=document.createElement('img');
  img.id=`patch-${id}`;
  img.src=ASSET(m.img);
  img.style.display='none';
  assetsContainer.appendChild(img);
});

/* ============ Base & layers ============ */
function clearLayers(cls){
  const sel = cls ? `.layer.${cls}` : '.layer';
  uniformCanvas.querySelectorAll(sel).forEach(n=>n.remove());
}
function applyJacket(){
  clearLayers('jacket');
  const base = UNIFORMS[State.uniform][State.gender];
  const img=document.createElement('img');
  img.className='layer jacket';
  img.src=ASSET(base);
  img.style.top='150px';
  img.style.left='0px';
  img.style.width='100%';
  img.style.height='auto';
  img.style.display='block';
  uniformCanvas.appendChild(img);
}

/* ============ Ribbons / Mini-Medals (Centered at 580, 507) ============ */
function sortRibbons(arr){ return [...arr].sort((a,b)=> precedence(a.id)-precedence(b.id)); }
function getTopRibbonY(){
  const layers=[...uniformCanvas.querySelectorAll('.layer.ribbonTile')];
  if(!layers.length) return null;
  return Math.min(...layers.map(l=>parseInt(l.style.top)));
}
function ensureRibbonObj(id){
  let r = State.ribbons.find(x=>x.id===id);
  if(!r){ r={id,devices:{}}; State.ribbons.push(r); }
  if(!r.devices) r.devices={};
  return r;
}

function renderRack(){
  // Clean ribbon-related layers
  [...uniformCanvas.querySelectorAll('.layer.ribbonTile,.layer.ribbonMini,.layer.ribbonDevice')].forEach(n=>n.remove());

  const allowMini = UNIFORMS[State.uniform].mini && by('autoMini').checked;
  const showRibbons = UNIFORMS[State.uniform].ribbons && !allowMini;
  const items = sortRibbons(State.ribbons);
  if(!items.length) return;

  if(showRibbons){
    // Center the rack at (cx, baseTop) with 60x19.2 tiles in rows of 3
    const W=60, H=19.2, PAD=0;
    const cx = 610;      // horizontal center
    const baseTop = 507; // top of bottom row
    const ids = items.map(x=>x.id);

    // Build rows (bottom to top), width 3 per row
    const rows=[];
    if(ids.length%3!==0){ rows.push(ids.slice(0, ids.length%3)); }
    for(let i=ids.length%3;i<ids.length;i+=3) rows.push(ids.slice(i,i+3));
    rows.reverse(); // bottom row first

    rows.forEach((row,ri)=>{
      // compute left for this row so the row is centered at cx
      const totalW = row.length*W + (row.length-1)*PAD;
      const rowLeft = Math.round(cx - totalW/2);
      const rowTop  = Math.round(baseTop - ri*(H+PAD));
      row.forEach((rid,i)=>{
        const orig=by(`ribbons-${rid}`); if(!orig) return;

        // tile
        const el=orig.cloneNode();
        el.className='layer ribbonTile';
        el.style.display='block';
        const leftPx = rowLeft + i*(W+PAD);
        const topPx  = rowTop;
        el.style.left=`${leftPx}px`;
        el.style.top =`${topPx}px`;
        el.style.width =`${W}px`;
        el.style.height=`${H}px`;
        el.dataset.rid = rid;
        el.style.pointerEvents='auto';
        el.onclick = () => onRibbonTileClick(rid);
        uniformCanvas.appendChild(el);

        // devices for this tile
        drawDevicesOnRibbon(rid, leftPx, topPx, W, H);
      });
    });
  } else {
    // Mini-medals (keep existing geometry)
    const w=20,h=28, pad=6;
    const startTop=400, startLeft=280;
    const ids = items.map(x=>x.id);

    const rows=[];
    if(ids.length%5!==0){ rows.push(ids.slice(0, ids.length%5)); }
    for(let i=ids.length%5;i<ids.length;i+=5) rows.push(ids.slice(i,i+5));
    rows.reverse();

    rows.forEach((row,ri)=>{
      const x0 = (row.length===5) ? startLeft : startLeft + Math.round((5-row.length)*(w+pad)/2);
      const y = startTop - ri*(h+pad);
      row.forEach((rid,i)=>{
        const el=document.createElement('img');
        el.src=ASSET(`mini_medals/${rid}.png`);
        el.className='layer ribbonMini';
        el.style.display='block';
        el.style.top=`${y-h}px`;
        el.style.left=`${x0 + i*(w+pad)}px`;
        el.style.width=`${w}px`;
        el.style.height=`${h}px`;
        el.onerror=()=>{}; // tolerate missing mini
        uniformCanvas.appendChild(el);
      });
    });
  }
}

function onRibbonTileClick(rid){
  if(State.deviceRemoveMode){
    const r = ensureRibbonObj(rid);
    r.devices = {};
    renderRack();
    return;
  }
  if(!State.deviceApplyMode) return;
  const r = ensureRibbonObj(rid);
  for(const [devId,qty] of Object.entries(State.selectedDevices)){
    r.devices[devId] = (r.devices[devId]||0) + qty;
  }
  renderRack();
}

function drawDevicesOnRibbon(rid, leftPx, topPx, w, h){
  const r = ensureRibbonObj(rid);
  const flat=[];
  for(const [devId,count] of Object.entries(r.devices||{})){
    const meta = deviceMeta[devId];
    if(!meta) continue;
    for(let i=0;i<count;i++){ flat.push({id:devId, ...meta}); }
  }
  if(!flat.length) return;
  // Order: heavier first, then name
  flat.sort((a,b)=>(b.weight-a.weight)|| (a.label||a.id).localeCompare(b.label||b.id));

  const gap = 3;
  const totalW = flat.reduce((s,d,i)=> s + d.w + (i>0?gap:0), 0);
  let x = Math.round(leftPx + (w-totalW)/2);
  const y = Math.round(topPx + (h-10)/2) - 1;

  flat.forEach(d=>{
    const im=document.createElement('img');
    im.className='layer ribbonDevice';
    im.src = ASSET(d.src);
    im.alt = d.label || d.id;
    im.style.display='block';
    im.style.left = `${x}px`;
    im.style.top  = `${y}px`;
    im.style.width = `${d.w}px`;
    im.style.height= `${d.h}px`;
    im.onerror=()=>{ im.remove(); };
    uniformCanvas.appendChild(im);
    x += d.w + gap;
  });
}

/* ============ Advanced Device Tool ============ */
function buildDevicePicker(){
  const wrap = by('devicePicker');
  wrap.innerHTML = '';
  deviceList.forEach(id=>{
    const row=document.createElement('label');
    row.style.cssText="display:flex;align-items:center;gap:8px";
    row.innerHTML = `
      <input type="checkbox" data-device="${id}"/>
      <span>${deviceMeta[id].label}</span>
      <input type="number" min="1" max="10" value="1" data-qty="${id}" style="width:70px;margin-left:auto">
    `;
    wrap.appendChild(row);
  });
}
function readDevicePicker(){
  const wrap=by('devicePicker');
  const bundle={};
  wrap.querySelectorAll('input[type="checkbox"][data-device]').forEach(chk=>{
    const id=chk.getAttribute('data-device');
    if(chk.checked){
      const qty=parseInt(wrap.querySelector(`input[type="number"][data-qty="${id}"]`).value||"1",10);
      if(qty>0) bundle[id]=qty;
    }
  });
  return bundle;
}
function wireDeviceUI(){
  const applyBtn = by('deviceApplyModeBtn');
  const removeBtn= by('deviceRemoveModeBtn');
  const clearBtn = by('deviceClearSelectionBtn');

  applyBtn.addEventListener('click', ()=>{
    State.selectedDevices = readDevicePicker();
    const hasAny = Object.keys(State.selectedDevices).length>0;
    State.deviceApplyMode = hasAny;
    State.deviceRemoveMode = false;
    applyBtn.textContent = State.deviceApplyMode ? 'Apply Mode: ON' : 'Enable Apply Mode';
    applyBtn.classList.toggle('ghost', !State.deviceApplyMode);
    removeBtn.classList.add('ghost');
  });
  removeBtn.addEventListener('click', ()=>{
    State.deviceRemoveMode = !State.deviceRemoveMode;
    State.deviceApplyMode = false;
    removeBtn.textContent = State.deviceRemoveMode ? 'Remove Mode: ON' : 'Enable Remove Mode';
    removeBtn.classList.toggle('ghost', !State.deviceRemoveMode);
    by('deviceApplyModeBtn').textContent = 'Enable Apply Mode';
  });
  clearBtn.addEventListener('click', ()=>{
    by('devicePicker').querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false);
    by('devicePicker').querySelectorAll('input[type="number"]').forEach(n=>n.value=1);
    State.selectedDevices = {};
    State.deviceApplyMode = false;
    State.deviceRemoveMode = false;
    applyBtn.textContent='Enable Apply Mode';
    removeBtn.textContent='Enable Remove Mode';
    applyBtn.classList.add('ghost');
    removeBtn.classList.add('ghost');
  });
}

/* ============ Badges (basic placement) ============ */
const badgeSlots = { OLPA:[], OLPU:[], OLP:[], ORP:[], ON:[], UN:[], LRP:[], LP:[] };
function resetBadgeSlots(){ Object.keys(badgeSlots).forEach(k=> badgeSlots[k]=[] ); }
function isCadetAuthorized(id){ return allowedCadetBadges.has(id); }
function enforceExclusive(newId){
  exclusiveBadges.forEach(pair=>{
    if(pair.includes(newId)){
      pair.forEach(conf=>{
        if(conf!==newId && State.badges.includes(conf)){
          State.badges = State.badges.filter(b=>b!==conf);
        }
      });
    }
  });
}
function renderAllBadges(){
  clearLayers('badge');
  resetBadgeSlots();
  // Service uniforms can show; field uniforms hide badges by UI_AUTHZ
  if(!UI_AUTHZ[State.uniform]?.showBadges) return;

  const maxTotal=5;
  const applied=[];
  for(const id of State.badges){
    if(State.member==='cadet' && !isCadetAuthorized(id)) continue;
    if(applied.length>=maxTotal) break;
    placeBadgeByCategory(id);
    applied.push(id);
  }
}
function placeBadgeByCategory(id){
  const img=by(`badges-${id}`); if(!img) return;
  let slot = badgeLocations[id] || 'UN';
  if(id==='nra_marksman_badge') slot='LRP';
  if(id==='model_rocketry_badge') slot='LP';

  const single = new Set(['OLP','OLPU','OLPA','ORP','LRP','LP']);
  if(single.has(slot) && badgeSlots[slot].length>=1) return;
  if((slot==='ON' || slot==='UN') && badgeSlots[slot].length>=2) return;

  const size = customBadgeSizes[id] || {width:60,height:25};
  const spacing=5;
  const baseRibbonY = getTopRibbonY();
  const yMap = {
    OLP: baseRibbonY!==null? baseRibbonY - 25 : 394,
    OLPU: baseRibbonY!==null? baseRibbonY -  5 : 424,
    OLPA: baseRibbonY!==null? baseRibbonY - 55 : 364,
    ORP: 300, ON: 350, UN: 390, LRP: 405, LP: 450
  };
  const xMap = { OLP:328, OLPU:328, OLPA:328, ORP:100, ON:150, UN:150, LRP:335, LP:350 };

  let y=yMap[slot]||390, x=xMap[slot]||150;
  if(slot==='ON' || slot==='UN'){
    const stackIdx = badgeSlots[slot].length;
    for(let i=0;i<stackIdx;i++){
      const prev = badgeSlots[slot][i];
      const ps = customBadgeSizes[prev]||{height:25};
      y += ps.height + spacing;
    }
  }
  if(id==='model_rocketry_badge' && State.badges.includes('nra_marksman_badge')) y += 50;

  const clone = img.cloneNode();
  clone.className='layer badge';
  clone.style.display='block';
  clone.style.top=`${y}px`;
  clone.style.left=`${x}px`;
  clone.style.width=`${size.width}px`;
  clone.style.height=`${size.height}px`;
  uniformCanvas.appendChild(clone);
  badgeSlots[slot].push(id);
}

/* ============ Patches ============ */
const patchSlots = { L_SHOULDER:[], R_SHOULDER:[], CHEST_LEFT:[], CHEST_RIGHT:[] };
function resetPatchSlots(){ Object.keys(patchSlots).forEach(k=> patchSlots[k]=[] ); }
function planPatches(ids){
  resetPatchSlots();
  const capsPerUniform = {
    blues_a:{L_SHOULDER:1, R_SHOULDER:1, CHEST_LEFT:1, CHEST_RIGHT:1},
    blues_b:{L_SHOULDER:1, R_SHOULDER:1, CHEST_LEFT:1, CHEST_RIGHT:1},
    aviator:{L_SHOULDER:1, R_SHOULDER:1, CHEST_LEFT:1, CHEST_RIGHT:1},
    aviator_blazer:{L_SHOULDER:1, R_SHOULDER:1, CHEST_LEFT:0, CHEST_RIGHT:0},
    corporate_field:{L_SHOULDER:2, R_SHOULDER:2, CHEST_LEFT:1, CHEST_RIGHT:1},
    abu:{L_SHOULDER:2, R_SHOULDER:2, CHEST_LEFT:1, CHEST_RIGHT:1},
    flight_suit:{L_SHOULDER:2, R_SHOULDER:2, CHEST_LEFT:2, CHEST_RIGHT:2},
    semi_formal:{L_SHOULDER:0, R_SHOULDER:0, CHEST_LEFT:0, CHEST_RIGHT:0},
    mess_dress:{L_SHOULDER:0, R_SHOULDER:0, CHEST_LEFT:0, CHEST_RIGHT:0},
    polo:{L_SHOULDER:0, R_SHOULDER:0, CHEST_LEFT:0, CHEST_RIGHT:0}
  }[State.uniform] || {L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:1,CHEST_RIGHT:1};

  for(const id of ids){
    const meta = PATCH_META[id]; if(!meta) continue;
    const hint = meta.slotHint || 'L_SHOULDER';
    const cap = capsPerUniform[hint] ?? 0;
    if(cap===0) continue;
    if(patchSlots[hint].length >= cap) continue;
    patchSlots[hint].push(id);
  }
}
function renderPatches(){
  clearLayers('patch');
  if(!UI_AUTHZ[State.uniform]?.showPatches) return;

  planPatches(State.patches);
  const coords = {
    L_SHOULDER:{x:95,y:250, dy:80},
    R_SHOULDER:{x:505,y:250, dy:80},
    CHEST_LEFT:{x:260,y:420, dy:70},
    CHEST_RIGHT:{x:580,y:420, dy:70}
  };
  for(const slot of Object.keys(patchSlots)){
    const ids = patchSlots[slot];
    let {x,y,dy} = coords[slot]||{x:0,y:0,dy:70};
    for(const id of ids){
      const meta = PATCH_META[id];
      const src = document.getElementById('patch-'+id);
      const el = (src? src.cloneNode(): new Image());
      if(!src){ el.src = ASSET(meta.img); }
      el.className='layer patch';
      el.style.display='block';
      el.style.left = `${x - meta.w/2}px`;
      el.style.top  = `${y - meta.h/2}px`;
      el.style.width = `${meta.w}px`;
      el.style.height= `${meta.h}px`;
      uniformCanvas.appendChild(el);
      y += dy;
    }
  }
}

/* ============ Rank & Nameplate ============ */
function renderRank(id){
  clearLayers('rank');
  if(!id) return;

  const insigniaEl = by('ranks-' + id);
  if(!insigniaEl) return;

  const isOfficer = officerRanks.has(id);

  if(isOfficer){
    const boardSrc = ASSET('ranks/C/shoulder_board.png');
    const boardCfg = {width:50,height:100};
    const insigniaCfg = {width:32,height:32};
    const placements = [
      {left:350, top:160, rot:90},   // left shoulder board (rotated right)
      {left:100, top:160, rot:-90}   // right shoulder board (rotated left)
    ];
    placements.forEach(({left,top,rot})=>{
      const board=document.createElement('img');
      board.src=boardSrc;
      board.className='layer rank';
      board.style.display='block';
      board.style.left=`${left}px`;
      board.style.top=`${top}px`;
      board.style.width=`${boardCfg.width}px`;
      board.style.height=`${boardCfg.height}px`;
      board.style.transform=`rotate(${rot}deg)`;
      board.style.transformOrigin='center center';
      uniformCanvas.appendChild(board);

      const ins=insigniaEl.cloneNode();
      ins.className='layer rank';
      ins.style.display='block';
      ins.style.left=`${left + (boardCfg.width/2 - insigniaCfg.width/2)}px`;
      ins.style.top=`${top + (boardCfg.height/2 - insigniaCfg.height/2)}px`;
      ins.style.width=`${insigniaCfg.width}px`;
      ins.style.height=`${insigniaCfg.height}px`;
      ins.style.transform=`rotate(${rot}deg)`;
      ins.style.transformOrigin='center center';
      uniformCanvas.appendChild(ins);
    });
    return;
  }

  // Enlisted (single overlay spot)
  const size = {w:60,h:60};
  const pos = {left:420, top:200};
  const icon=insigniaEl.cloneNode();
  icon.className='layer rank';
  icon.style.display='block';
  icon.style.left=`${pos.left}px`;
  icon.style.top=`${pos.top}px`;
  icon.style.width=`${size.w}px`;
  icon.style.height=`${size.h}px`;
  uniformCanvas.appendChild(icon);
}
function renderNameplate(){
  clearLayers('nameplate');
  const el=document.createElement('img');
  el.src=ASSET('nameplate/nameplate.png');
  el.className='layer nameplate';
  el.style.display='block';
  el.style.top='440px';
  el.style.left='120px';
  el.style.width='100px';
  el.style.height='20px';
  uniformCanvas.appendChild(el);
}

/* ============ UI Availability + Alternates on Uniform Change ============ */
function updateAvailabilityUI(prevUniform){
  const a = UI_AUTHZ[State.uniform] || {showRibbons:true,showPatches:true,showBadges:true};
  $('#groupRibbons').classList.toggle('hidden', !a.showRibbons);
  $('#groupPatches').classList.toggle('hidden', !a.showPatches);

  // Apply alternates when crossing service ↔ field
  if(prevUniform && prevUniform!==State.uniform){
    applyAlternates(prevUniform, State.uniform);
  }

  populatePatchesRemove();
  populateBadgesRemove();
}

function applyAlternates(fromU, toU){
  const fromField = isFieldUniform(fromU);
  const toField = isFieldUniform(toU);

  if(!fromField && toField){
    // badges → patches
    Object.entries(ALTERNATES.badgeToPatch).forEach(([badge,patch])=>{
      if(State.badges.includes(badge) && !State.patches.includes(patch)) State.patches.push(patch);
    });
    // ribbons → patches
    Object.entries(ALTERNATES.ribbonToPatch).forEach(([ribbon,patch])=>{
      if(State.ribbons.find(r=>r.id===ribbon) && !State.patches.includes(patch)) State.patches.push(patch);
    });
  } else if(fromField && !toField){
    // patches → badges
    Object.entries(ALTERNATES.patchToBadge).forEach(([patch,badge])=>{
      if(State.patches.includes(patch) && !State.badges.includes(badge)) State.badges.push(badge);
    });
    // patches → ribbons
    Object.entries(ALTERNATES.patchToRibbon).forEach(([patch,ribbon])=>{
      if(State.patches.includes(patch) && !State.ribbons.find(r=>r.id===ribbon)) State.ribbons.push({id:ribbon,devices:{}});
    });
  }

  // Role trim when landing as cadet (Cadet→Senior keeps)
  if(State.member==='cadet'){
    State.badges = State.badges.filter(isCadetAuthorized);
  }
}

/* ============ Render Orchestrator ============ */
function fullRender(prevUniform){
  applyJacket();
  updateAvailabilityUI(prevUniform);

  renderPatches();
  renderAllBadges();
  renderRack();
  renderRank(State.rank);
}
function refreshUI(){
  by('memberSelect').value=State.member;
  by('jacketSelect').value=State.gender;
  by('uniformSelect').value=State.uniform;
  by('assetBase').value=State.assetBase;
  populateBadgesRemove();
  populatePatchesRemove();
}

/* ============ Handlers ============ */
by('applyJacket').onclick=()=>{
  State.assetBase=by('assetBase').value.trim()||'images';
  State.gender=by('jacketSelect').value;
  applyJacket();
};

by('memberSelect').onchange=(e)=>{
  const was = State.member;
  State.member=e.target.value;
  if(State.member==='cadet' && (State.uniform==='polo' || State.uniform==='mess_dress')){
    alert('Cadets are not authorized Polo or Mess Dress. Switching to Blues A.');
    const prevU = State.uniform;
    State.uniform='blues_a';
    by('uniformSelect').value='blues_a';
    // trim unauthorized for cadet
    State.badges = State.badges.filter(isCadetAuthorized);
    populateBadgesRemove();
    populatePatchesRemove();
    fullRender(prevU);
    return;
  }
  // Senior → Cadet trims; Cadet → Senior keeps
  if(State.member==='cadet'){ State.badges = State.badges.filter(isCadetAuthorized); }
  populateBadgesRemove();
  fullRender();
};

by('jacketSelect').onchange=(e)=>{ State.gender=e.target.value; fullRender(); };

by('uniformSelect').onchange=(e)=>{
  const prevU = State.uniform;
  State.uniform=e.target.value;
  fullRender(prevU);
};

by('assetBase').onchange=(e)=>{ State.assetBase=e.target.value.trim()||'images'; fullRender(); };

by('addRibbon').onclick=()=>{
  const id=by('ribbonSelect').value;
  const dev=by('deviceSelect').value||'none';
  const r = ensureRibbonObj(id);
  if(dev && dev!=='none'){
    r.devices[dev] = (r.devices[dev]||0) + 1; // quick single add
  }
  renderRack();
};
by('clearRibbons').onclick=()=>{ State.ribbons=[]; renderRack(); };

/* Device tool wiring */
buildDevicePicker();
wireDeviceUI();

by('addBadge').onclick=()=>{
  const id=by('badgeSelect').value;
  if(State.member==='cadet' && !isCadetAuthorized(id)) { alert('This badge is not authorized for cadets.'); return; }
  enforceExclusive(id);
  if(!State.badges.includes(id)) State.badges.push(id);
  populateBadgesRemove();
  renderAllBadges();
};

by('removeBadge').onclick=()=>{
  const id=by('removeBadgeSelect').value;
  State.badges=State.badges.filter(b=>b!==id);
  populateBadgesRemove();
  renderAllBadges();
};

by('addPatch').onclick=()=>{
  const id=by('patchSelect').value;
  if(!State.patches.includes(id)) State.patches.push(id);
  populatePatchesRemove();
  renderPatches();
};
by('removePatch').onclick=()=>{
  const id=by('removePatchSelect').value;
  State.patches = State.patches.filter(p=>p!==id);
  populatePatchesRemove();
  renderPatches();
};

by('addRank').onclick=()=>{ State.rank=by('rankSelect').value; renderRank(State.rank); };
by('addNameplate').onclick=()=> renderNameplate();

by('downloadImage').onclick=()=>{
  html2canvas(uniformCanvas,{scale:3, backgroundColor:'#ffffff'}).then(c=>{
    const a=document.createElement('a');
    a.download=`CAP_Uniform_${Date.now()}.png`;
    a.href=c.toDataURL();
    a.click();
  });
};

/* ============ Boot ============ */
(function init(){
  refreshUI();
  fullRender();
})();
</script>
</body>
</html>
