/* =========================================================================
   CAP Uniform Builder — DevTools UI (Hardened)
   Toggle panel: Alt + D
   Toggle grid:  Alt + G
   ========================================================================= */
(function () {
  const NS = 'CAPDevTools';
  if (window[NS]) return;
  window[NS] = {};

  const $ = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
  const on = (el, ev, fn, opts) => el && el.addEventListener(ev, fn, opts);
  const copyText = async (text) => { try { await navigator.clipboard.writeText(text); return true; } catch { return false; } };

  const roots = { jacketBase: null, canvasShell: null, overlayLayer: null, epauletContainer: null, panelShell: null };
  function refreshRoots() {
    roots.jacketBase = $('#jacketBase');
    roots.canvasShell = $('#canvasShell');
    roots.overlayLayer = $('#overlayLayer');
    roots.epauletContainer = $('#epauletContainer');
    roots.panelShell = $('#panelShell');
  }

  // Panel
  function createPanel() {
    const panel = document.createElement('div');
    panel.id = 'capDevPanel';
    panel.setAttribute('role', 'dialog');
    panel.setAttribute('aria-label', 'Dev Tools');
    panel.style.cssText = 'position:fixed; right:16px; bottom:16px; width:320px; max-height:70vh;background:#0b1220; color:#e6edf6; border:1px solid #2a3550; border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:9999; display:none; overflow:hidden;font:13px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;';
    panel.innerHTML = `
      <div id="capDevHeader" style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:#0e1a35;border-bottom:1px solid #223055;cursor:move;">
        <strong style="font-size:12px;letter-spacing:.3px">CAP DevTools</strong>
        <span id="capDevDragHint" style="margin-left:auto;opacity:.7">drag</span>
        <button id="capDevClose" title="Close" aria-label="Close" style="background:#1a2446;border:1px solid #2e3d6c;color:#e6edf6;padding:2px 8px;border-radius:6px;cursor:pointer">✕</button>
      </div>
      <div style="padding:8px 10px;display:grid;gap:8px;grid-auto-rows:min-content">
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button data-act="toggle-grid" class="capDevBtn">Grid (Alt+G)</button>
          <button data-act="toggle-outlines" class="capDevBtn">Highlight Overlays</button>
          <button data-act="log-rack" class="capDevBtn">Log Rack Coords</button>
        </div>
        <fieldset style="border:1px solid #2a3550;border-radius:8px;padding:8px">
          <legend style="padding:0 6px;opacity:.9">Quick Dumps</legend>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button data-act="dump-overlays" class="capDevBtn">Dump Overlays JSON</button>
            <button data-act="dump-ribbons" class="capDevBtn">Dump Ribbons JSON</button>
            <button data-act="dump-badges" class="capDevBtn">Dump Badges JSON</button>
          </div>
        </fieldset>
        <fieldset style="border:1px solid #2a3550;border-radius:8px;padding:8px">
          <legend style="padding:0 6px;opacity:.9">Mouse / Canvas</legend>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px">
            <div><div style="opacity:.7;font-size:12px">Mouse (page)</div><div id="capDevMousePage">—</div></div>
            <div><div style="opacity:.7;font-size:12px">Mouse (canvas)</div><div id="capDevMouseCanvas">—</div></div>
          </div>
        </fieldset>
        <details><summary style="cursor:pointer">Overlay Nodes</summary><div id="capDevOverlayList" style="margin-top:6px;max-height:180px;overflow:auto;border:1px solid #2a3550;border-radius:6px;padding:6px"></div></details>
      </div>
      <style>
        .capDevBtn{ background:#1a2446;border:1px solid #2e3d6c;color:#e6edf6;padding:6px 10px;border-radius:8px;cursor:pointer }
        .capDevBtn:hover{ background:#253162 }
        .capDevOutline{ outline:2px dashed #00d8ff99; outline-offset:-2px !important; }
        #capDevGridCanvas{ position:absolute; inset:0; pointer-events:none; opacity:.5 }
      </style>`;
    document.body.appendChild(panel);

    // draggable
    const header = panel.querySelector('#capDevHeader');
    let sx=0, sy=0, ox=0, oy=0, dragging=false;
    header.addEventListener('mousedown', (e)=>{
      dragging=true; sx=e.clientX; sy=e.clientY;
      const rect=panel.getBoundingClientRect(); ox=rect.left; oy=rect.top;
      const mm=(ev)=>{ if(!dragging) return; panel.style.left=Math.max(8, ox+(ev.clientX-sx))+'px'; panel.style.top=Math.max(8, oy+(ev.clientY-sy))+'px'; panel.style.right='auto'; panel.style.bottom='auto'; };
      const mu=()=>{ dragging=false; document.removeEventListener('mousemove',mm); document.removeEventListener('mouseup',mu); };
      document.addEventListener('mousemove',mm); document.addEventListener('mouseup',mu);
    });
    panel.querySelector('#capDevClose').addEventListener('click', ()=>togglePanel(false));
    panel.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act]'); if(!btn) return;
      (actions[btn.getAttribute('data-act')]||(()=>{}))();
    });
    return panel;
  }

  // Grid
  let gridEnabled=false, gridCanvas=null;
  function drawGrid() {
    refreshRoots();
    if (!roots.canvasShell) return;
    const rect = roots.canvasShell.getBoundingClientRect();
    if (rect.width < 2 || rect.height < 2) return; // nothing to draw yet

    if (!gridCanvas) {
      gridCanvas = document.createElement('canvas');
      gridCanvas.id = 'capDevGridCanvas';
      roots.canvasShell.appendChild(gridCanvas);
    }
    gridCanvas.width = Math.max(2, Math.floor(rect.width));
    gridCanvas.height = Math.max(2, Math.floor(rect.height));
    const ctx = gridCanvas.getContext('2d');
    ctx.clearRect(0,0,gridCanvas.width,gridCanvas.height);
    const minor=10, major=50;

    for (let x=0; x<=gridCanvas.width; x+=minor) {
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,gridCanvas.height);
      ctx.strokeStyle = (x%major===0)?'#00d8ff66':'#00d8ff22'; ctx.lineWidth = (x%major===0)?1:0.5; ctx.stroke();
    }
    for (let y=0; y<=gridCanvas.height; y+=minor) {
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(gridCanvas.width,y);
      ctx.strokeStyle = (y%major===0)?'#00d8ff66':'#00d8ff22'; ctx.lineWidth = (y%major===0)?1:0.5; ctx.stroke();
    }

    // jacket bounds box, if we can compute
    if (roots.jacketBase) {
      const r = roots.jacketBase.getBoundingClientRect();
      const shell = roots.canvasShell.getBoundingClientRect();
      const bx = r.left - shell.left;
      const by = r.top - shell.top;
      ctx.strokeStyle = '#22ff8866'; ctx.lineWidth = 2; ctx.strokeRect(bx, by, r.width, r.height);
    }
  }
  function toggleGrid(force) {
    gridEnabled = typeof force === 'boolean' ? force : !gridEnabled;
    if (!roots.canvasShell) refreshRoots();
    if (!roots.canvasShell) return;
    if (gridEnabled) {
      drawGrid();
      window.addEventListener('resize', drawGrid);
      if (roots.jacketBase) roots.jacketBase.addEventListener('load', drawGrid, { once:true });
    } else {
      if (gridCanvas?.parentNode) gridCanvas.parentNode.removeChild(gridCanvas);
      gridCanvas = null;
      window.removeEventListener('resize', drawGrid);
    }
  }

  // Outlines
  let outlinesEnabled=false;
  function toggleOutlines(force){
    outlinesEnabled = typeof force === 'boolean' ? force : !outlinesEnabled;
    const targets = [];
    if (roots.overlayLayer) targets.push(...roots.overlayLayer.children);
    if (roots.epauletContainer) targets.push(...roots.epauletContainer.children);
    targets.forEach(n => outlinesEnabled ? n.classList.add('capDevOutline') : n.classList.remove('capDevOutline'));
  }

  // Dumps
  function shellRect(){ refreshRoots(); return roots.canvasShell?.getBoundingClientRect() || null; }
  function snapshotSelector(sel){
    const hostRect = shellRect();
    const list = $$(sel).map(el=>{
      const r = el.getBoundingClientRect();
      const x = hostRect ? Math.round(r.left - hostRect.left) : Math.round(r.left);
      const y = hostRect ? Math.round(r.top  - hostRect.top ) : Math.round(r.top );
      return { id: el.id||null, dataset: { ...el.dataset }, x, y, w:Math.round(r.width), h:Math.round(r.height), src: el.getAttribute('src')||null };
    });
    return list;
  }
  async function dumpOverlays(){ const json = JSON.stringify(snapshotSelector('#overlayLayer > *, #epauletContainer > *'), null, 2); console.log('[DevTools] Overlays:', json); (await copyText(json)) && toast('Overlays JSON copied'); }
  async function dumpRibbons (){
    const byState = window.AppState?.ribbons || window.RIBBONS || null;
    const data = byState ? byState : snapshotSelector('#overlayLayer img[data-type="ribbon"], #overlayLayer .ribbon');
    const json = JSON.stringify(data, null, 2); console.log('[DevTools] Ribbons:', json); (await copyText(json)) && toast('Ribbons JSON copied');
  }
  async function dumpBadges (){
    const byState = window.AppState?.badges || window.BADGES || null;
    const data = byState ? byState : snapshotSelector('#overlayLayer img[data-type="badge"], #overlayLayer .badge, #overlayLayer [data-badge]');
    const json = JSON.stringify(data, null, 2); console.log('[DevTools] Badges:', json); (await copyText(json)) && toast('Badges JSON copied');
  }
  function logRackCoords(){
    const data = snapshotSelector('#overlayLayer img[data-type="ribbon"], #overlayLayer .ribbon');
    console.table(data); toast(`Logged ${data.length} ribbons`);
  }

  function renderOverlayList(){
    const host = document.getElementById('capDevOverlayList'); if(!host) return;
    const list = snapshotSelector('#overlayLayer > *, #epauletContainer > *');
    host.innerHTML = list.length ? list.map((n,i)=> `<div style="display:flex;justify-content:space-between;gap:8px;border-bottom:1px dashed #2a3550;padding:4px 0"><span style="opacity:.85">${n.id||n.dataset?.type||('#'+i)}</span><code style="opacity:.8">${n.x},${n.y} · ${n.w}×${n.h}</code></div>`).join('') : '<em style="opacity:.7">No overlay nodes found.</em>';
  }

  // mouse coords HUD
  function attachMouseTracking(){
    const mPage = document.getElementById('capDevMousePage');
    const mCanvas = document.getElementById('capDevMouseCanvas');
    if (!mPage || !mCanvas) return;
    document.addEventListener('mousemove', (e)=>{
      const rect = shellRect();
      const cx = rect ? Math.round(e.clientX - rect.left) : 0;
      const cy = rect ? Math.round(e.clientY - rect.top)  : 0;
      mPage.textContent   = `${e.pageX}, ${e.pageY}`;
      mCanvas.textContent = `${cx}, ${cy}`;
    });
  }

  // tiny toast
  let toastTimer=null;
  function toast(msg){
    let t = document.getElementById('capDevToast');
    if(!t){ t = document.createElement('div'); t.id='capDevToast'; t.style.cssText='position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#0b1220; color:#e6edf6; border:1px solid #2a3550; padding:8px 12px; border-radius:8px; z-index:10000; opacity:0; transition:opacity .15s;'; document.body.appendChild(t); }
    t.textContent = msg; t.style.opacity='1'; clearTimeout(toastTimer); toastTimer=setTimeout(()=> t.style.opacity='0', 1400);
  }

  const actions = {
    'toggle-grid': () => { toggleGrid(); toast(`Grid: ${gridEnabled?'ON':'OFF'}`); },
    'toggle-outlines': () => { toggleOutlines(); toast(`Highlight: ${outlinesEnabled?'ON':'OFF'}`); },
    'log-rack': logRackCoords,
    'dump-overlays': dumpOverlays,
    'dump-ribbons': dumpRibbons,
    'dump-badges': dumpBadges
  };

  let panel;
  function togglePanel(force){
    if (!panel) panel = createPanel();
    const show = typeof force==='boolean' ? force : (panel.style.display === 'none' || panel.style.display === '');
    panel.style.display = show ? 'block' : 'none';
    if (show) { refreshRoots(); renderOverlayList(); attachMouseTracking(); if (roots.jacketBase) on(roots.jacketBase,'load', ()=>{ if (gridEnabled) drawGrid(); }, { once:true }); }
  }

  const mo = new MutationObserver(()=>{ if(panel && panel.style.display!=='none'){ renderOverlayList(); if (gridEnabled) drawGrid(); } });
  function watch(){ refreshRoots(); if (roots.overlayLayer) mo.observe(roots.overlayLayer, { childList:true, subtree:true, attributes:true }); if (roots.epauletContainer) mo.observe(roots.epauletContainer, { childList:true, subtree:true, attributes:true }); }

  function onKey(e){
    if (e.altKey && (e.key==='d'||e.key==='D')) { e.preventDefault(); togglePanel(); }
    if (e.altKey && (e.key==='g'||e.key==='G')) { e.preventDefault(); actions['toggle-grid'](); }
  }

  // Boot AFTER full load so sizes/DOM exist even if app.js builds late
  function bootWhenReady(){
    refreshRoots(); watch(); document.addEventListener('keydown', onKey);
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') togglePanel(true);
    console.info('[CAP DevTools] Ready. Alt+D to toggle panel, Alt+G for grid.');
  }
  window.addEventListener('load', bootWhenReady);
})();
