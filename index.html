<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CAP Uniform Builder — Full Program</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --bg:#eef1f5;
    --ink:#0d1b2a;
    --muted:#516079;
    --panel:#ffffff;
    --line:#cfd6df;
    --brand:#002855;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg);
    color:var(--ink);
  }

  header{
    background:var(--brand);
    color:#fff;
    padding:14px 16px;
    text-align:center;
  }
  header h1{
    margin:0;
    font-size:18px;
    letter-spacing:.3px
  }

  /* ===============================
     LAYOUT SHELL / COLLAPSIBLE SIDEBAR
     =============================== */
  #layoutShell {
    display:flex;
    height:calc(100vh - 58px); /* minus header height */
    position:relative;
    background:var(--bg);
    color:var(--ink);
    overflow:hidden;
  }

  /* Sidebar / Controls panel */
  #controls {
    width:340px;
    max-width:340px;
    min-width:260px;
    background:var(--panel);
    border-right:1px solid var(--line);
    box-shadow:0 0 20px rgb(0 0 0 / .07);
    display:flex;
    flex-direction:column;
    z-index:10;
    transition:
      width .2s ease,
      min-width .2s ease,
      max-width .2s ease,
      transform .2s ease;
    overflow:hidden;
  }

  .controlsHeader {
    background:var(--brand);
    color:#fff;
    padding:12px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  .controlsHeader .controlsTitle {
    margin:0;
    font-size:14px;
    font-weight:600;
    line-height:1.2;
    letter-spacing:.2px;
  }
  .collapseBtn {
    background:rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.3);
    border-radius:6px;
    color:#fff;
    font-size:14px;
    line-height:1;
    padding:4px 8px;
    cursor:pointer;
  }

  .controlsScrollArea{
    flex:1;
    overflow-y:auto;
    padding:12px 14px 48px; /* leave room above footer bar */
  }

  /* panel block sections in sidebar */
  .panelBlock {
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:10px;
    padding:12px 12px 10px;
    margin-bottom:12px;
    box-shadow:0 8px 20px rgb(0 0 0 / .04);
  }

  .fieldLabel{
    font-size:13px;
    font-weight:600;
    color:var(--ink);
    display:block;
    margin-bottom:6px;
  }
  .hintText{
    font-size:11px;
    line-height:1.3;
    color:var(--muted);
    margin-top:6px;
  }

  select,button,input{
    width:100%;
    margin-top:6px;
    padding:8px;
    border:1px solid var(--line);
    border-radius:10px;
    background:#f8fafc;
    font-family:inherit;
    font-size:13px;
    color:var(--ink);
  }
  button{
    cursor:pointer;
    background:#0f2a54;
    color:#fff;
    border-color:#163766;
  }
  button.ghost{
    background:#ffffff;
    color:var(--ink);
  }

  .row{display:flex;gap:8px;flex-wrap:wrap}
  .two .col{flex:1}

  .hidden{display:none !important}

  /* uniform selector buttons */
  .uniformList{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .uniformOption{
    width:100%;
    text-align:left;
    background:#fff;
    border:1px solid var(--line);
    border-radius:8px;
    padding:10px 12px;
    font-family:inherit;
    cursor:pointer;
    position:relative;
    box-shadow:0 4px 12px rgb(0 0 0 / .03);
    transition:box-shadow .12s ease,border-color .12s ease,background .12s ease;
  }
  .uniformOption:hover{
    box-shadow:0 10px 24px rgb(0 0 0 / .07);
    border-color:var(--brand);
    background:rgba(0,40,85,.04);
  }
  .uniformOption .uName{
    font-size:13px;
    font-weight:600;
    color:var(--ink);
    margin-bottom:2px;
    line-height:1.3;
  }
  .uniformOption .uDesc{
    font-size:11px;
    color:var(--muted);
    line-height:1.3;
  }

  /* locked (not authorized for this member type) */
  .uniformOption.locked{
    cursor:not-allowed;
    opacity:.45;
    filter:grayscale(1);
    background:#f4f4f7;
    border-style:dashed;
    border-color:var(--line);
    box-shadow:none;
  }
  .uniformOption.locked:hover{
    border-color:var(--line);
    background:#f4f4f7;
    box-shadow:none;
  }
  .uniformOption.locked:hover::after{
    content:attr(data-locked-reason);
    position:absolute;
    left:100%;
    top:50%;
    transform:translate(8px,-50%);
    min-width:180px;
    max-width:220px;
    background:rgba(15,23,42,.95);
    color:#fff;
    font-size:11px;
    line-height:1.35;
    border-radius:8px;
    box-shadow:0 20px 40px rgb(0 0 0 / .6);
    padding:8px 10px;
    border:1px solid rgba(255,255,255,.2);
    pointer-events:none;
    white-space:normal;
    text-align:left;
    z-index:9999;
  }

  /* Advanced device tool box */
  #deviceTool{
    margin-top:10px;
    border:1px solid var(--line);
    border-radius:10px;
    padding:10px;
    background:#fefefe;
  }
  #devicePicker{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:8px;
    font-size:12px;
  }

  /* ===============================
     PREVIEW WRAPPER
     =============================== */
  #previewWrapper{
    flex:1;
    position:relative;
    padding:16px;
    display:flex;
    gap:16px;
    overflow:auto;
    align-items:flex-start;
    justify-content:center;
    background:var(--bg);
  }

  /* Preview canvas box */
  #previewArea{
    position:relative;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:12px;
    width:450px;
    height:600px;
    box-shadow:0 30px 60px rgb(0 0 0 / .12);
    overflow:hidden;
  }

  /* Your uniformCanvas lives INSIDE previewArea and holds all layers */
  #uniformCanvas{
    position:relative;
    width:100%;
    height:100%;
  }
  .layer{
    position:absolute;
    image-rendering:auto;
  }

  /* Drag calibration visual modes */
  .drag-mode-on .ribbonTile{
    outline:1px dashed rgba(0,40,85,.6);
    cursor:move;
    z-index:9999;
  }
  .dragging{
    opacity:.7;
  }

  #sideDisplay{
    display:flex;
    flex-direction:column;
    gap:16px;
    min-width:140px;
  }

  /* ===============================
     TOOLTIP BUBBLE
     =============================== */
  .tooltipBubble{
    position:fixed;
    z-index:9999;
    min-width:180px;
    max-width:240px;
    background:rgba(15,23,42,.95);
    color:#fff;
    font-size:12px;
    line-height:1.35;
    border-radius:8px;
    box-shadow:0 20px 40px rgb(0 0 0 / .6);
    padding:8px 10px;
    pointer-events:none;
    border:1px solid rgba(255,255,255,.2);
  }
  .tooltipBubble strong{
    font-size:12px;
    font-weight:600;
    color:#fff;
    display:block;
    margin-bottom:4px;
  }
  .tooltipBubble em{
    color:#94a3b8;
    font-style:normal;
    font-size:11px;
  }

  /* ===============================
     COLLAPSED SIDEBAR STATE
     =============================== */

  /* default: sidebar OPEN */
  #layoutShell.sidebar-open .reopenTab{
    opacity:0;
    pointer-events:none;
  }
  #layoutShell.sidebar-collapsed .reopenTab{
    opacity:1;
    pointer-events:auto;
  }

  /* desktop collapse */
  #layoutShell.sidebar-collapsed #controls{
    width:0;
    min-width:0;
    max-width:0;
    border-right:0;
    box-shadow:none;
    overflow:hidden;
  }

  /* The little arrow tab that reopens the controls */
  .reopenTab{
    position:fixed;
    left:0;
    top:50%;
    transform:translateY(-50%);
    z-index:9999;
    background:var(--brand);
    color:#fff;
    border:1px solid var(--line);
    border-left:none;
    border-radius:0 8px 8px 0;
    font-size:14px;
    line-height:1;
    padding:10px 8px;
    cursor:pointer;
    box-shadow:0 10px 25px rgb(0 0 0 / .25);
    transition:opacity .2s ease;
    display:flex;
    align-items:center;
    justify-content:center;
    min-width:24px;
    min-height:44px;
    font-weight:600;
  }

  /* GUIDE DOTS (positioning overlay helpers, still optional later) */
  .guideDot{
    position:absolute;
    background:rgba(0,40,85,.15);
    border:1px solid rgba(0,40,85,.4);
    color:var(--ink);
    font-size:10px;
    line-height:1.2;
    padding:2px 4px;
    border-radius:4px;
    pointer-events:none;
    white-space:nowrap;
  }

  /* COPYRIGHT FOOTER */
  #pageFooter{
    text-align:center;
    font-size:11px;
    color:var(--muted);
    background:var(--panel);
    border-top:1px solid var(--line);
    padding:8px 0;
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    z-index:5;
  }

  /* mobile adjustments */
  @media (max-width:768px){
    #layoutShell{
      flex-direction:column;
      height:auto;
      min-height:calc(100vh - 58px);
    }

    #controls{
      position:absolute;
      left:0;
      top:0;
      bottom:0;

      width:80%;
      max-width:80%;
      min-width:260px;

      box-shadow:0 30px 60px rgb(0 0 0 / .4);
      border-right:1px solid var(--line);
      background:var(--panel);
      transition:transform .2s ease;
    }
    #layoutShell.sidebar-open    #controls{ transform:translateX(0); }
    #layoutShell.sidebar-collapsed #controls{ transform:translateX(-100%); }

    #previewWrapper{
      order:2;
      flex:1;
    }

    /* tab still pinned left on mobile */
    .reopenTab{
      left:0;
      top:50%;
      transform:translateY(-50%);
    }
  }
</style>
</head>
<body>

<header>
  <h1>CAP Uniform Builder</h1>
</header>

<!-- MAIN APP LAYOUT -->
<main id="layoutShell" class="sidebar-open">

  <!-- SIDEBAR -->
  <aside id="controls">
    <div class="controlsHeader">
      <h2 class="controlsTitle">Uniform Builder Controls</h2>
      <button id="collapseBtn" class="collapseBtn" aria-label="Hide Controls">⟨</button>
    </div>

    <div class="controlsScrollArea">
      <!-- MEMBER TYPE -->
      <section class="panelBlock">
        <label class="fieldLabel">Member Type</label>
        <select id="memberSelect">
          <option value="cadet">Cadet</option>
          <option value="senior">Senior Member / Officer</option>
          <option value="senior_nco">Senior Member NCO</option>
        </select>
        <div class="hintText">Your status controls which uniforms and insignia are allowed.</div>
      </section>

      <!-- GENDER -->
      <section class="panelBlock">
        <label class="fieldLabel">Gender / Cut</label>
        <select id="jacketSelect">
          <option value="male">Male Cut</option>
          <option value="female">Female Cut</option>
        </select>
        <div class="hintText">This swaps which base jacket image we render.</div>
      </section>

      <!-- UNIFORM SELECTOR (buttons w/ auth lock) -->
      <section class="panelBlock">
        <label class="fieldLabel">Uniform</label>
        <div id="uniformList" class="uniformList">

          <!-- data-allowed-for lists which member types can wear it -->
          <button class="uniformOption"
                  data-uniform-id="blues_a"
                  data-allowed-for="cadet,senior,senior_nco">
            <div class="uName">Blues: Class A</div>
            <div class="uDesc smallText">Service coat, ribbons</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="blues_b"
                  data-allowed-for="cadet,senior,senior_nco">
            <div class="uName">Blues: Class B</div>
            <div class="uDesc smallText">Shirt, ribbons</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="mess_dress"
                  data-allowed-for="senior,senior_nco">
            <div class="uName">Mess Dress</div>
            <div class="uDesc smallText">Mini medals / formal</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="semi_formal"
                  data-allowed-for="senior,senior_nco">
            <div class="uName">Semi-formal</div>
            <div class="uDesc smallText">Mini medals</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="aviator"
                  data-allowed-for="senior,senior_nco">
            <div class="uName">Aviator Shirt</div>
            <div class="uDesc smallText">Corporate white shirt</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="aviator_blazer"
                  data-allowed-for="senior,senior_nco">
            <div class="uName">Aviator + Blazer</div>
            <div class="uDesc smallText">Corporate coat style</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="corporate_field"
                  data-allowed-for="senior,senior_nco">
            <div class="uName">Corporate Field Uniform</div>
            <div class="uDesc smallText">Field / utility variant</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="abu"
                  data-allowed-for="cadet,senior,senior_nco">
            <div class="uName">ABU</div>
            <div class="uDesc smallText">Legacy camo / tapes</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="flight_suit"
                  data-allowed-for="cadet,senior,senior_nco">
            <div class="uName">Flight Suit</div>
            <div class="uDesc smallText">Flight / utility</div>
          </button>

          <button class="uniformOption"
                  data-uniform-id="polo"
                  data-allowed-for="senior,senior_nco">
            <div class="uName">Polo</div>
            <div class="uDesc smallText">Corporate polo / gray slacks</div>
          </button>
        </div>

        <div class="hintText">
          Grayed-out uniforms are not authorized for the selected member type.
        </div>
      </section>

      <!-- ASSET BASE -->
      <section class="panelBlock">
        <div class="row two">
          <div class="col">
            <label class="fieldLabel">Asset Base Path</label>
            <input id="assetBase" value="images" placeholder="images"/>
          </div>
          <div class="col">
            <label class="fieldLabel">&nbsp;</label>
            <button id="applyJacket" class="ghost">Apply Jacket</button>
          </div>
        </div>
        <div class="hintText">Change this if your image folder path changes.</div>
      </section>

      <!-- RIBBONS / DEVICES -->
      <section id="groupRibbons" class="panelBlock">
        <label class="fieldLabel">Ribbons</label>
        <div class="row two">
          <div class="col"><select id="ribbonSelect"></select></div>
          <div class="col"><select id="deviceSelect"></select></div>
        </div>
        <div class="row two" style="margin-top:6px">
          <div class="col"><button id="addRibbon">Add Ribbon</button></div>
          <div class="col"><button id="clearRibbons" class="ghost">Clear Ribbons</button></div>
        </div>
        <label style="font-size:12px;color:var(--muted);display:block;margin-top:8px;">
          <input type="checkbox" id="autoMini" checked>
          Auto-convert ribbons → mini-medals on Mess/Semi-formal
        </label>

        <!-- multi device tool -->
        <div id="deviceTool">
          <strong style="font-size:12px;">Ribbon Devices — Multi-Apply</strong>
          <div id="devicePicker"></div>
          <div class="row" style="margin-top:8px">
            <button id="deviceApplyModeBtn" type="button">Enable Apply Mode</button>
            <button id="deviceRemoveModeBtn" type="button" class="ghost">Enable Remove Mode</button>
            <button id="deviceClearSelectionBtn" type="button" class="ghost">Clear Selection</button>
          </div>
          <small style="color:#516079;display:block;margin-top:6px;font-size:11px;line-height:1.3;">
            Choose devices + quantities → Enable Apply Mode → click a ribbon to add them.
            Use Remove Mode to clear devices from a ribbon.
          </small>
        </div>

        <!-- Drag calibration controls -->
        <div class="row two" style="margin-top:10px">
          <div class="col"><button id="toggleRibbonDrag" class="ghost">Enable Drag Mode</button></div>
          <div class="col"><button id="logRibbonCoords" class="ghost">Log Ribbon Coords</button></div>
        </div>
        <div class="hintText">
          Drag Mode lets you reposition ribbons on the jacket for calibration. "Log Ribbon Coords" prints their exact left/top to console.
        </div>
      </section>

      <!-- BADGES -->
      <section class="panelBlock">
        <label class="fieldLabel">Badges</label>
        <div class="row two">
          <div class="col"><select id="badgeSelect"></select></div>
          <div class="col"><button id="addBadge">Add Badge</button></div>
        </div>
        <div class="row two" style="margin-top:6px">
          <div class="col"><select id="removeBadgeSelect"></select></div>
          <div class="col"><button id="removeBadge" class="ghost">Remove Badge</button></div>
        </div>
        <div class="hintText">Placement follows CAPR 39-1 rules. Some badges are cadet-only / senior-only.</div>
      </section>

      <!-- PATCHES -->
      <section id="groupPatches" class="panelBlock">
        <label class="fieldLabel">Patches</label>
        <div class="row two">
          <div class="col"><select id="patchSelect"></select></div>
          <div class="col"><button id="addPatch">Add Patch</button></div>
        </div>
        <div class="row two" style="margin-top:6px">
          <div class="col"><select id="removePatchSelect"></select></div>
          <div class="col"><button id="removePatch" class="ghost">Remove Patch</button></div>
        </div>
        <div class="hintText">Field uniforms swap certain badges/ribbons into patch/tape equivalents automatically.</div>
      </section>

      <!-- RANK / NAME / DOWNLOAD -->
      <section class="panelBlock">
        <label class="fieldLabel">Rank Insignia & Output</label>
        <div class="row two">
          <div class="col"><select id="rankSelect"></select></div>
          <div class="col"><button id="addRank">Set Rank</button></div>
        </div>
        <div class="row two" style="margin-top:6px">
          <div class="col"><button id="addNameplate" class="ghost">Add Nameplate</button></div>
          <div class="col"><button id="downloadImage">Download PNG</button></div>
        </div>
        <div class="hintText">Download will export a high-res PNG of the uniform preview.</div>
      </section>

      <!-- COPYRIGHT inside panel as well (for when panel is open) -->
      <section class="panelBlock" style="text-align:center;font-size:10.5px;color:var(--muted);line-height:1.3;">
        <div id="sidebarCopyrightLine">
          © <span id="sidebarYear"></span> Civil Air Patrol Uniform Builder<br/>
          Developed by C/Capt. Guiseppe Doran
        </div>
      </section>
    </div>
  </aside>

  <!-- PREVIEW AREA -->
  <section id="previewWrapper">
    <div id="previewArea">
      <div id="uniformCanvas"></div>
    </div>

    <div id="sideDisplay">
      <div id="epauletContainer"></div>
      <div id="coverContainer"></div>
    </div>
  </section>

  <!-- LEFT EDGE REOPEN TAB -->
  <button id="reopenTab" class="reopenTab" aria-label="Show Controls">⟩</button>

  <!-- GLOBAL HOVER TOOLTIP -->
  <div id="tooltip" class="tooltipBubble" style="display:none;"></div>

</main>

<!-- Hidden assets root -->
<div class="layer" id="assets" style="display:none"></div>

<!-- COPYRIGHT FOOTER (fixed bottom) -->
<footer id="pageFooter">
  © <span id="footerYear"></span> Civil Air Patrol Uniform Builder – Developed by C/Capt. Guiseppe Doran
</footer>

<script>
/* ===========================
   STATE
   =========================== */
const State = {
  member:'cadet',          // "cadet" | "senior" | "senior_nco"
  gender:'male',           // "male" | "female"
  uniform:'blues_a',
  assetBase:'images',
  ribbons:[],              // [{id, devices:{ devId:qty, ...}}]
  badges:[],
  patches:[],
  rank:null,
  deviceApplyMode:false,
  deviceRemoveMode:false,
  selectedDevices:{},      // { deviceId: qty }

  // drag calibration
  ribbonDragMode:false
};

let currentDrag = null;
let dragOffsetX = 0;
let dragOffsetY = 0;

/* quick DOM helpers */
const $ = s => document.querySelector(s);
const by = id => document.getElementById(id);

const layoutShell      = by('layoutShell');
const collapseBtn      = by('collapseBtn');
const reopenTab        = by('reopenTab');
const uniformCanvas    = by('uniformCanvas');
const assetsContainer  = by('assets');
const uniformListEl    = by('uniformList');
const memberSelect     = by('memberSelect');
const jacketSelect     = by('jacketSelect');
const assetBaseInput   = by('assetBase');

/* ===========================
   YEAR AUTOFILL (copyright)
   =========================== */
(function setYears(){
  const y = new Date().getFullYear();
  const sidebarYear = by('sidebarYear');
  const footerYear  = by('footerYear');
  if(sidebarYear) sidebarYear.textContent = y;
  if(footerYear)  footerYear.textContent  = y;
})();

/* ===========================
   ASSET PATH HELPER
   =========================== */
function ASSET(p){
  const b=(State.assetBase||'images').replace(/\/$/,'');
  return `${b}/${p}`;
}

/* ===========================
   UNIFORMS + UI AUTHZ
   =========================== */
function isFieldUniform(u){
  return u==='abu' || u==='flight_suit' || u==='corporate_field';
}

const UNIFORMS = {
  blues_a:{male:'base/jacket_male.png',         female:'base/jacket_female.png',         ribbons:true,  mini:false},
  blues_b:{male:'base/blues_class_b_male.png',  female:'base/blues_class_b_female.png',  ribbons:true,  mini:false},
  mess_dress:{male:'base/mess_dress_male.png',  female:'base/mess_dress_female.png',     ribbons:false, mini:true},
  semi_formal:{male:'base/semi_male.png',       female:'base/semi_female.png',           ribbons:false, mini:true},
  aviator:{male:'base/aviator_shirt_male.png',  female:'base/aviator_shirt_female.png',  ribbons:true,  mini:false},
  aviator_blazer:{male:'base/aviator_blazer_male.png',female:'base/aviator_blazer_female.png', ribbons:true,mini:false},
  corporate_field:{male:'base/corporate_field_male.png',female:'base/corporate_field_female.png', ribbons:true, mini:false},
  abu:{male:'base/ABU_male.png',                female:'base/ABU_female.png',            ribbons:false, mini:false},
  flight_suit:{male:'base/flight_suit_male.png',female:'base/flight_suit_female.png',    ribbons:false, mini:false},
  polo:{male:'base/polo_male.png',              female:'base/polo_female.png',           ribbons:false, mini:false}
};

const UI_AUTHZ = {
  blues_a:{ showRibbons:true, showBadges:true,  showPatches:false },
  blues_b:{ showRibbons:true, showBadges:true,  showPatches:false },
  aviator:{ showRibbons:true, showBadges:true,  showPatches:false },
  aviator_blazer:{ showRibbons:true, showBadges:true, showPatches:false },
  corporate_field:{ showRibbons:true, showBadges:false, showPatches:true },
  mess_dress:{ showRibbons:false, showBadges:true,  showPatches:false },
  semi_formal:{ showRibbons:false, showBadges:true, showPatches:false },
  abu:{ showRibbons:false, showBadges:false, showPatches:true },
  flight_suit:{ showRibbons:false, showBadges:false, showPatches:true },
  polo:{ showRibbons:false, showBadges:false, showPatches:false }
};

/* ===========================
   RIBBONS / DEVICES
   =========================== */
const ribbonList = [
  'silver_medal_of_valor','bronze_medal_of_valor','distinguished_service_award','exceptional_service_award','meritorious_service_award','commander_commendation_award','cap_achievment_award','lifesaving_award','national_commander_unit_citation_award','unit_citation_award','spaatz_award','eaker_award','earhart_award','mitchell_award','armstrong_achievement','goddard_achievement','doolittle_achievement','lindbergh_achievement','rickenbacker_achievement','wright_brothers_award','mary_feik_achievement','hap_arnold_achievement','curry_achievement','afa_award','afsa_award','vfw_officer_award','vfw_nco_award','crisis_ribbon','red_service_ribbon','search_find_ribbon','air_search_and_rescue_ribbon','disaster_relief_ribbon','homeland_security_ribbon','community_service_ribbon','iace_ribbon','national_cadet_competition_ribbon','national_color_guard_competition_ribbon','cadet_advisory_council_ribbon','cadet_special_activity_ribbon','encampment_ribbon','cadet_recruiter_ribbon',
  'orientation_pilot_ribbon'
];

const precedence = id => ribbonList.indexOf(id);

const deviceList = ['1_Bronze_Star_Device','1_Silver_Star_Device'];
const deviceMeta = {
  '1_Bronze_Star_Device': { label:'Bronze Star', src:'devices/1_Bronze_Star_Device.webp', w:10, h:10, weight:1 },
  '1_Silver_Star_Device': { label:'Silver Star', src:'devices/1_Silver_Star_Device.webp', w:10, h:10, weight:2 }
};

/* ===========================
   BADGES
   =========================== */
const badgeList = [
  'AirCrew1_DB3F0FCC3650F','BalloonPilot1_442D89C94185B','CAPMasterPilot1_621A0E2ED15DA','CAPPilot1_FA9D33EA587D8','CAPSeniorPilot1_D9725AE959752','GliderPilot1_7BFB287379918','MasterAirCrew1_72AC4CAE7A310','MasterObserver1_1B88D5071FD5C','SeniorAirCrew1_B289BAE6E515C','SeniorObserver1_0E35802A29801',
  'buddist_chaplin','christian_chaplin','communications_technician_badge','cyber_badges','emergency_services_badge','emt_basic_badge','emt_intermediate','emt_paramedic','ground_team_basic_badge','historian_technicianIbadge','information_technology_technician_badge','jewish_chaplin','legal_officer','master_ground_team_badge','medical_officer','model_rocketry_badge','muslim_chaplin','nra_marksman_badge','nurse_officer','observer_badge','pre_solo_badge','senior_ground_team_badge','solo_badge','stem_badges'
];

const allowedCadetBadges = new Set([
  'solo_badge','pre_solo_badge','ground_team_basic_badge','senior_ground_team_badge','master_ground_team_badge','emt_basic_badge','emt_intermediate','emt_paramedic','aerospace','model_rocketry_badge','communications_technician_badge','information_technology_technician_badge','cyber_badges','stem_badges','cadetadvisory','cd','nra_marksman_badge','AirCrew1_DB3F0FCC3650F','BalloonPilot1_442D89C94185B','CAPMasterPilot1_621A0E2ED15DA','CAPPilot1_FA9D33EA587D8','CAPSeniorPilot1_D9725AE959752','GliderPilot1_7BFB287379918','MasterAirCrew1_72AC4CAE7A310','SeniorAirCrew1_B289BAE6E515C','SeniorObserver1_0E35802A29801','MasterObserver1_1B88D5071FD5C','observer_badge','emergency_services_badge','historian_technicianIbadge'
]);

const exclusiveBadges = [
  ['emt_basic_badge','ground_team_basic_badge'],
  ['emt_intermediate','senior_ground_team_badge'],
  ['emt_paramedic','master_ground_team_badge']
];

/*
  Badge slots meaning:
  OLP  - Over Left Pocket (wings/pilot etc)
  OLPU - Over Left Pocket Upper (ES etc)
  OLPA - Over Left Pocket Above (one step higher)
  ORP  - Over Right Pocket (chaplain/legal/etc)
  LP   - Left Pocket
  LRP  - Lower Right Pocket-ish (marksman type hangers)
  ON/UN fallback stacks
*/
const badgeLocations = {
  'AirCrew1_DB3F0FCC3650F':'OLP','BalloonPilot1_442D89C94185B':'OLP','CAPMasterPilot1_621A0E2ED15DA':'OLP','CAPPilot1_FA9D33EA587D8':'OLP','CAPSeniorPilot1_D9725AE959752':'OLP','GliderPilot1_7BFB287379918':'OLP','MasterAirCrew1_72AC4CAE7A310':'OLP',
  'SeniorAirCrew1_B289BAE6E515C':'OLP','pre_solo_badge':'OLP','solo_badge':'OLP',

  'cyber_badges':'LP','stem_badges':'LP','communications_technician_badge':'LP','information_technology_technician_badge':'LP','MasterObserver1_1B88D5071FD5C':'LP','SeniorObserver1_0E35802A29801':'LP','observer_badge':'LP','historian_technicianIbadge':'LP','model_rocketry_badge':'LP',

  'nra_marksman_badge':'LRP',

  'ground_team_basic_badge':'OLPU','senior_ground_team_badge':'OLPU','master_ground_team_badge':'OLPU','emergency_services_badge':'OLPU','emt_basic_badge':'OLPU','emt_intermediate':'OLPU','emt_paramedic':'OLPU',

  'buddist_chaplin':'ORP','christian_chaplin':'ORP','jewish_chaplin':'ORP','legal_officer':'ORP','medical_officer':'ORP','nurse_officer':'ORP','muslim_chaplin':'ORP'
};

const customBadgeSizes = {
  'AirCrew1_DB3F0FCC3650F':{width:60,height:25},'BalloonPilot1_442D89C94185B':{width:60,height:25},'CAPMasterPilot1_621A0E2ED15DA':{width:60,height:25},'CAPPilot1_FA9D33EA587D8':{width:60,height:25},'CAPSeniorPilot1_D9725AE959752':{width:60,height:25},'GliderPilot1_7BFB287379918':{width:60,height:25},'MasterAirCrew1_72AC4CAE7A310':{width:60,height:25},'MasterObserver1_1B88D5071FD5C':{width:60,height:25},'SeniorAirCrew1_B289BAE6E515C':{width:60,height:25},'SeniorObserver1_0E35802A29801':{width:60,height:25},
  'buddist_chaplin':{width:60,height:60},'christian_chaplin':{width:60,height:60},'communications_technician_badge':{width:60,height:60},
  'cyber_badges':{width:60,height:25},'emergency_services_badge':{width:60,height:60},'emt_basic_badge':{width:60,height:60},
  'emt_intermediate':{width:60,height:60},'emt_paramedic':{width:60,height:60},'ground_team_basic_badge':{width:25,height:20},
  'historian_technicianIbadge':{width:60,height:60},'information_technology_technician_badge':{width:60,height:60},
  'jewish_chaplin':{width:60,height:60},'legal_officer':{width:60,height:25},'master_ground_team_badge':{width:25,height:20},
  'medical_officer':{width:60,height:60},'model_rocketry_badge':{width:7,height:28.125},'muslim_chaplin':{width:60,height:60},
  'nra_marksman_badge':{width:40,height:60},'nurse_officer':{width:60,height:60},'observer_badge':{width:60,height:25},
  'pre_solo_badge':{width:60,height:25},'senior_ground_team_badge':{width:25,height:20},'solo_badge':{width:60,height:25},'stem_badges':{width:60,height:25}
};

/* ===========================
   PATCHES + ALTERNATES
   =========================== */
const patchList = [
  'us_flag_patch','command_patch','wing_patch','unit_patch','aerospace_education_patch','communications_patch','orientation_pilot_patch'
];

const PATCH_META = {
  'us_flag_patch':{slotHint:'R_SHOULDER', w:60,h:40, img:'patches/us_flag_patch.png'},
  'command_patch':{slotHint:'L_SHOULDER', w:70,h:70, img:'patches/command_patch.png'},
  'wing_patch':{slotHint:'L_SHOULDER', w:60,h:60, img:'patches/wing_patch.png'},
  'unit_patch':{slotHint:'R_SHOULDER', w:60,h:60, img:'patches/unit_patch.png'},
  'aerospace_education_patch':{slotHint:'CHEST_LEFT', w:60,h:60, img:'patches/aerospace_education_patch.png'},
  'communications_patch':{slotHint:'CHEST_RIGHT', w:60,h:60, img:'patches/communications_patch.png'},
  'orientation_pilot_patch':{slotHint:'CHEST_LEFT', w:60,h:60, img:'patches/orientation_pilot_patch.png'}
};

const ALTERNATES = {
  badgeToPatch: { 'communications_technician_badge':'communications_patch' },
  patchToBadge: { 'communications_patch':'communications_technician_badge' },
  ribbonToPatch:{ 'orientation_pilot_ribbon':'orientation_pilot_patch' },
  patchToRibbon:{ 'orientation_pilot_patch':'orientation_pilot_ribbon' }
};

/* ===========================
   RANKS
   =========================== */
const rankList = [
  'C/AB','C/Amn','C/A1C','C/SrA','C/SSgt','C/TSgt','C/MSgt','C/SMSgt','C/CMSgt',
  'C/2d Lt','C/1st Lt','C/Capt','C/Maj','C/Lt Col','C/Col'
];
const officerRanks = new Set(['C/2d Lt','C/1st Lt','C/Capt','C/Maj','C/Lt Col','C/Col']);

/* ===========================
   POPULATE SELECTS, PRELOAD
   =========================== */
function optionize(sel,list){
  sel.innerHTML='';
  list.forEach(v=>{
    const o=document.createElement('option');
    o.value=v;
    o.textContent=v.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    sel.appendChild(o);
  });
}

function populateBadgesRemove(){
  const sel=by('removeBadgeSelect'); if(!sel) return;
  sel.innerHTML='';
  State.badges.forEach(id=>{
    const o=document.createElement('option');
    o.value=id;
    o.textContent=id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    sel.appendChild(o);
  });
}
function populatePatchesRemove(){
  const sel=by('removePatchSelect'); if(!sel) return;
  sel.innerHTML='';
  State.patches.forEach(id=>{
    const o=document.createElement('option');
    o.value=id;
    o.textContent=id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    sel.appendChild(o);
  });
}

function preloadSimple(prefix,list,folder,ext=".png"){
  list.forEach(id=>{
    const img=document.createElement('img');
    img.id = `${prefix}-${id}`;
    img.src = ASSET(`${folder}/${id}${ext}`);
    img.style.display='none';
    img.loading='eager';
    img.decoding='sync';
    img.onerror=()=>{};
    assetsContainer.appendChild(img);
  });
}
function preloadWithResolver(prefix,list,resolver){
  list.forEach(id=>{
    const src = resolver(id);
    const img=document.createElement('img');
    img.id = `${prefix}-${id}`;
    img.src = ASSET(src);
    img.style.display='none';
    img.loading='eager';
    img.decoding='sync';
    img.onerror=()=>{};
    assetsContainer.appendChild(img);
  });
}

/* init form elements */
optionize(by('ribbonSelect'), ribbonList);
optionize(by('deviceSelect'), ['none',...deviceList]);
optionize(by('rankSelect'), rankList);
optionize(by('badgeSelect'), badgeList);
optionize(by('patchSelect'), patchList);

/* preload assets */
preloadSimple('ribbons', ribbonList, 'ribbons', '.png');
preloadWithResolver('devices', deviceList, id => deviceMeta[id].src);
preloadSimple('ranks', rankList, 'ranks', '.png');
preloadSimple('badges', badgeList, 'badges', '.png');
Object.entries(PATCH_META).forEach(([id,m])=>{
  const img=document.createElement('img');
  img.id=`patch-${id}`;
  img.src=ASSET(m.img);
  img.style.display='none';
  assetsContainer.appendChild(img);
});

/* ===========================
   SIDEBAR TOGGLE / REOPEN TAB
   =========================== */
layoutShell.classList.add('sidebar-open'); // default open

collapseBtn.addEventListener('click', ()=>{
  layoutShell.classList.remove('sidebar-open');
  layoutShell.classList.add('sidebar-collapsed');
});
reopenTab.addEventListener('click', ()=>{
  layoutShell.classList.remove('sidebar-collapsed');
  layoutShell.classList.add('sidebar-open');
});

/* ===========================
   TOOLTIP HOVER SYSTEM
   =========================== */
const tooltipEl = by('tooltip');

document.addEventListener('mouseover', e => {
  const t=e.target;
  if(t && t.dataset && t.dataset.tooltipTitle){
    const title=t.dataset.tooltipTitle||'';
    const reg  =t.dataset.tooltipReg||'';
    const why  =t.dataset.tooltipWhy||'';

    tooltipEl.innerHTML = `
      <strong>${title}</strong>
      ${reg ? `<div>${reg}</div>`:''}
      ${why ? `<div><em>${why}</em></div>`:''}
    `;
    tooltipEl.style.display='block';
  }
});
document.addEventListener('mousemove', e => {
  if(tooltipEl.style.display==='block'){
    tooltipEl.style.left = (e.clientX+14)+'px';
    tooltipEl.style.top  = (e.clientY+14)+'px';
  }
});
document.addEventListener('mouseout', e => {
  const t=e.target;
  if(t && t.dataset && t.dataset.tooltipTitle){
    tooltipEl.style.display='none';
  }
});

/* ===========================
   JACKET BASE RENDER
   =========================== */
function clearLayers(cls){
  const sel = cls?`.layer.${cls}`:'.layer';
  uniformCanvas.querySelectorAll(sel).forEach(n=>n.remove());
}

function applyJacket(){
  clearLayers('jacket');
  const base = UNIFORMS[State.uniform][State.gender];
  const img=document.createElement('img');
  img.className='layer jacket';
  img.src=ASSET(base);
  img.style.top='0px';
  img.style.left='0px';
  img.style.width='100%';
  img.style.height='100%';
  img.style.display='block';
  img.dataset.tooltipTitle = State.uniform.replace(/_/g,' ').toUpperCase();
  img.dataset.tooltipReg   = "Base uniform image";
  img.dataset.tooltipWhy   = "Selected uniform template for preview / alignment.";
  uniformCanvas.appendChild(img);
}

/* ===========================
   RIBBONS / MINI MEDALS
   =========================== */
function sortRibbons(arr){
  return [...arr].sort((a,b)=>precedence(a.id)-precedence(b.id));
}

// SAFE fallback Y so badges can anchor even with 0 ribbons
function getTopRibbonY(){
  const layers=[...uniformCanvas.querySelectorAll('.layer.ribbonTile')];
  if(!layers.length) {
    // about mid-chest in our 600px canvas
    return 360;
  }
  return Math.min(...layers.map(l=>parseFloat(l.style.top)||0));
}

function ensureRibbonObj(id){
  let r=State.ribbons.find(x=>x.id===id);
  if(!r){
    r={id,devices:{}};
    State.ribbons.push(r);
  }
  if(!r.devices) r.devices={};
  return r;
}

function drawDevicesOnRibbon(rid,leftPx,topPx,w,h){
  const r=ensureRibbonObj(rid);
  const flat=[];
  for(const [devId,count] of Object.entries(r.devices||{})){
    const meta=deviceMeta[devId];
    if(!meta) continue;
    for(let i=0;i<count;i++){ flat.push({id:devId,...meta}); }
  }
  if(!flat.length) return;

  flat.sort((a,b)=>(b.weight-a.weight)|| (a.label||a.id).localeCompare(b.label||b.id));
  const gap=3;
  const totalW=flat.reduce((s,d,i)=>s+d.w+(i>0?gap:0),0);
  let x=Math.round(leftPx+(w-totalW)/2);
  const y=Math.round(topPx+(h-10)/2)-1;

  flat.forEach(d=>{
    const im=document.createElement('img');
    im.className='layer ribbonDevice';
    im.dataset.parentRid = rid; // tie device to its ribbon for dragging sync
    im.src=ASSET(d.src);
    im.alt=d.label||d.id;
    im.style.display='block';
    im.style.left=`${x}px`;
    im.style.top =`${y}px`;
    im.style.width =`${d.w}px`;
    im.style.height=`${d.h}px`;
    im.onerror=()=>{ im.remove(); };
    im.dataset.tooltipTitle = d.label||d.id;
    im.dataset.tooltipReg   = "Device on ribbon";
    im.dataset.tooltipWhy   = "Represents additional awards/credit per CAPR 39-3.";
    uniformCanvas.appendChild(im);
    x+=d.w+gap;
  });
}

function onRibbonTileClick(rid){
  // If drag mode is on, clicking should not apply/remove devices.
  if(State.ribbonDragMode) return;

  if(State.deviceRemoveMode){
    const r=ensureRibbonObj(rid);
    r.devices={};
    renderRack();
    return;
  }
  if(!State.deviceApplyMode)return;
  const r=ensureRibbonObj(rid);
  for(const [devId,qty] of Object.entries(State.selectedDevices)){
    r.devices[devId]=(r.devices[devId]||0)+qty;
  }
  renderRack();
}

/* ===== DRAG HELPERS FOR RIBBONS ===== */
function initRibbonDragHandlers(tileEl){
  // mouse down = begin drag, but only if drag mode is ON
  tileEl.addEventListener('mousedown', e => {
    if(!State.ribbonDragMode) return;

    currentDrag = tileEl;
    currentDrag.classList.add('dragging');

    // current computed left/top in px
    const startLeft = parseFloat(currentDrag.style.left) || 0;
    const startTop  = parseFloat(currentDrag.style.top)  || 0;

    // where the mouse hit relative to the tile's top-left
    dragOffsetX = e.clientX - startLeft;
    dragOffsetY = e.clientY - startTop;

    e.preventDefault(); // stop text selection
  });
}

function syncDevicesToRibbon(ribbonTileEl){
  const rid = ribbonTileEl.dataset.rid;
  if(!rid) return;

  const baseLeft = parseFloat(ribbonTileEl.style.left) || 0;
  const baseTop  = parseFloat(ribbonTileEl.style.top)  || 0;
  const w = parseFloat(ribbonTileEl.style.width)  || 35;
  const h = parseFloat(ribbonTileEl.style.height) || 11.2;

  // replicate drawDevicesOnRibbon layout math
  const r = State.ribbons.find(x => x.id===rid);
  if(!r || !r.devices) return;

  const flat=[];
  for(const [devId,count] of Object.entries(r.devices)){
    const meta=deviceMeta[devId];
    if(!meta) continue;
    for(let i=0;i<count;i++){ flat.push({id:devId,...meta}); }
  }
  flat.sort((a,b)=>(b.weight-a.weight)|| (a.label||a.id).localeCompare(b.label||b.id));

  const gap=3;
  const totalW=flat.reduce((s,d,i)=>s+d.w+(i>0?gap:0),0);
  let x=Math.round(baseLeft+(w-totalW)/2);
  const y=Math.round(baseTop+(h-10)/2)-1;

  const devEls=[...uniformCanvas.querySelectorAll('.ribbonDevice')].filter(el=>el.dataset.parentRid===rid);

  devEls.forEach((el,idx)=>{
    const dv=flat[idx];
    if(!dv) return;
    el.style.left = x+'px';
    el.style.top  = y+'px';
    x+=dv.w+gap;
  });
}

/* global mousemove/mouseup for dragging */
document.addEventListener('mousemove', e => {
  if(!currentDrag || !State.ribbonDragMode) return;

  let newLeft = e.clientX - dragOffsetX;
  let newTop  = e.clientY - dragOffsetY;

  // clamp within 450x600 canvas bounds
  const maxX = 450 - (parseFloat(currentDrag.style.width)  || 60);
  const maxY = 600 - (parseFloat(currentDrag.style.height) || 20);

  if(newLeft < 0) newLeft = 0;
  if(newTop  < 0) newTop  = 0;
  if(newLeft > maxX) newLeft = maxX;
  if(newTop  > maxY) newTop  = maxY;

  currentDrag.style.left = newLeft + 'px';
  currentDrag.style.top  = newTop  + 'px';

  syncDevicesToRibbon(currentDrag);
});

document.addEventListener('mouseup', () => {
  if(currentDrag){
    currentDrag.classList.remove('dragging');
    currentDrag = null;
  }
});

/* ===== RACK RENDERER ===== */
function renderRack(){
  // clear old rack layers
  [...uniformCanvas.querySelectorAll('.layer.ribbonTile,.layer.ribbonMini,.layer.ribbonDevice')].forEach(n=>n.remove());

  const allowMini   = UNIFORMS[State.uniform].mini && by('autoMini').checked;
  const showRibbons = UNIFORMS[State.uniform].ribbons && !allowMini;
  const items       = sortRibbons(State.ribbons);
  if(!items.length) return;

  const canvasRect = uniformCanvas.getBoundingClientRect();
  const canvasW = canvasRect.width;
  const canvasH = canvasRect.height;

  if(showRibbons){
    // Service ribbons
    const TILE_W = 35;
    const TILE_H = 11.2;
    const PER_ROW = 3;
    const PAD = 0;

    // Anchor lower right chest
    const rackBaseY   = canvasH * 0.65;
    const rackCenterX = canvasW * 0.55;

    const ids = items.map(x=>x.id);

    const rows = [];
    if(ids.length % PER_ROW !== 0){
      rows.push(ids.slice(0, ids.length % PER_ROW));
    }
    for(let i=ids.length % PER_ROW; i<ids.length; i+=PER_ROW){
      rows.push(ids.slice(i,i+PER_ROW));
    }
    rows.reverse();

    rows.forEach((row,ri)=>{
      const totalW = row.length*TILE_W + (row.length-1)*PAD;
      const rowLeft = Math.round(rackCenterX - totalW/2);
      const rowTop  = Math.round(rackBaseY - ri*(TILE_H+PAD));

      row.forEach((rid,i)=>{
        const orig=by(`ribbons-${rid}`);
        if(!orig) return;

        const tile=orig.cloneNode();
        tile.className='layer ribbonTile';
        tile.style.display='block';

        const leftPx=rowLeft + i*(TILE_W+PAD);
        const topPx =rowTop;

        tile.style.left   = `${leftPx}px`;
        tile.style.top    = `${topPx}px`;
        tile.style.width  = `${TILE_W}px`;
        tile.style.height = `${TILE_H}px`;

        tile.dataset.rid=rid;
        tile.style.pointerEvents='auto';
        tile.onclick=()=>onRibbonTileClick(rid);

        tile.dataset.tooltipTitle = rid.replace(/_/g,' ').toUpperCase();
        tile.dataset.tooltipReg   = "CAPR 39-3 precedence applies";
        tile.dataset.tooltipWhy   = "Displayed in order of precedence, highest top left.";

        // make draggable in calibration mode
        initRibbonDragHandlers(tile);

        uniformCanvas.appendChild(tile);

        drawDevicesOnRibbon(rid,leftPx,topPx,TILE_W,TILE_H);
      });
    });

  } else {
    // Mini-medals (mess / semi-formal)
    const MINI_W = 20;
    const MINI_H = 28;
    const PER_ROW = 5;
    const PAD = 6;

    const medalBaseY   = canvasH * 0.58;
    const medalCenterX = canvasW * 0.5;

    const ids = items.map(x=>x.id);

    const rows = [];
    if(ids.length % PER_ROW !== 0){
      rows.push(ids.slice(0, ids.length % PER_ROW));
    }
    for(let i=ids.length % PER_ROW; i<ids.length; i+=PER_ROW){
      rows.push(ids.slice(i,i+PER_ROW));
    }
    rows.reverse();

    rows.forEach((row,ri)=>{
      const rowW   = row.length * MINI_W + (row.length-1)*PAD;
      const rowX0  = Math.round(medalCenterX - rowW/2);
      const rowTop = Math.round(medalBaseY - ri*(MINI_H+PAD));

      row.forEach((rid,i)=>{
        const mimg=document.createElement('img');
        mimg.src=ASSET(`mini_medals/${rid}.png`);
        mimg.className='layer ribbonMini';
        mimg.style.display='block';

        const leftPx = rowX0 + i*(MINI_W+PAD);
        const topPx  = rowTop - MINI_H;

        mimg.style.left   = `${leftPx}px`;
        mimg.style.top    = `${topPx}px`;
        mimg.style.width  = `${MINI_W}px`;
        mimg.style.height = `${MINI_H}px`;

        mimg.onerror=()=>{};

        mimg.dataset.tooltipTitle = rid.replace(/_/g,' ').toUpperCase();
        mimg.dataset.tooltipReg   = "Miniature medal arrangement";
        mimg.dataset.tooltipWhy   = "Used for mess dress / semi-formal vice ribbons.";

        uniformCanvas.appendChild(mimg);
      });
    });
  }
}

/* ===========================
   ADVANCED DEVICE TOOL
   =========================== */
function buildDevicePicker(){
  const wrap=by('devicePicker');
  wrap.innerHTML='';
  deviceList.forEach(id=>{
    const row=document.createElement('label');
    row.style.cssText="display:flex;align-items:center;gap:8px;font-size:12px;";
    row.innerHTML=`
      <input type="checkbox" data-device="${id}"/>
      <span>${deviceMeta[id].label}</span>
      <input type="number" min="1" max="10" value="1" data-qty="${id}" style="width:70px;margin-left:auto">
    `;
    wrap.appendChild(row);
  });
}
function readDevicePicker(){
  const wrap=by('devicePicker');
  const bundle={};
  wrap.querySelectorAll('input[type="checkbox"][data-device]').forEach(chk=>{
    const id=chk.getAttribute('data-device');
    if(chk.checked){
      const qty=parseInt(wrap.querySelector(`input[type="number"][data-qty="${id}"]`).value||"1",10);
      if(qty>0) bundle[id]=qty;
    }
  });
  return bundle;
}
function wireDeviceUI(){
  const applyBtn = by('deviceApplyModeBtn');
  const removeBtn= by('deviceRemoveModeBtn');
  const clearBtn = by('deviceClearSelectionBtn');

  applyBtn.addEventListener('click', ()=>{
    State.selectedDevices = readDevicePicker();
    const hasAny = Object.keys(State.selectedDevices).length>0;
    State.deviceApplyMode = hasAny;
    State.deviceRemoveMode = false;
    applyBtn.textContent = State.deviceApplyMode ? 'Apply Mode: ON' : 'Enable Apply Mode';
    applyBtn.classList.toggle('ghost', !State.deviceApplyMode);
    removeBtn.classList.add('ghost');
  });

  removeBtn.addEventListener('click', ()=>{
    State.deviceRemoveMode = !State.deviceRemoveMode;
    State.deviceApplyMode = false;
    removeBtn.textContent = State.deviceRemoveMode ? 'Remove Mode: ON' : 'Enable Remove Mode';
    removeBtn.classList.toggle('ghost', !State.deviceRemoveMode);
    applyBtn.textContent='Enable Apply Mode';
    applyBtn.classList.add('ghost');
  });

  clearBtn.addEventListener('click', ()=>{
    by('devicePicker').querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false);
    by('devicePicker').querySelectorAll('input[type="number"]').forEach(n=>n.value=1);
    State.selectedDevices={};
    State.deviceApplyMode=false;
    State.deviceRemoveMode=false;
    applyBtn.textContent='Enable Apply Mode';
    removeBtn.textContent='Enable Remove Mode';
    applyBtn.classList.add('ghost');
    removeBtn.classList.add('ghost');
  });
}

/* ===========================
   BADGES
   =========================== */
const badgeSlots = { OLPA:[], OLPU:[], OLP:[], ORP:[], ON:[], UN:[], LRP:[], LP:[] };
function resetBadgeSlots(){ Object.keys(badgeSlots).forEach(k=>badgeSlots[k]=[]); }

function isCadetAuthorized(id){ return allowedCadetBadges.has(id); }

function enforceExclusive(newId){
  exclusiveBadges.forEach(pair=>{
    if(pair.includes(newId)){
      pair.forEach(conf=>{
        if(conf!==newId && State.badges.includes(conf)){
          State.badges = State.badges.filter(b=>b!==conf);
        }
      });
    }
  });
}

function renderAllBadges(){
  [...uniformCanvas.querySelectorAll('.layer.badge')].forEach(n=>n.remove());
  resetBadgeSlots();
  if(!UI_AUTHZ[State.uniform]?.showBadges) return;

  const maxTotal=5;
  const applied=[];
  for(const id of State.badges){
    if(State.member==='cadet' && !isCadetAuthorized(id)){ continue; }
    if(applied.length>=maxTotal) break;
    placeBadgeByCategory(id);
    applied.push(id);
  }
}

function placeBadgeByCategory(id){
  const img=by(`badges-${id}`); if(!img) return;
  let slot = badgeLocations[id] || 'UN';
  if(id==='nra_marksman_badge') slot='LRP';
  if(id==='model_rocketry_badge') slot='LP';

  const single = new Set(['OLP','OLPU','OLPA','ORP','LRP','LP']);
  if(single.has(slot) && badgeSlots[slot].length>=1) return;
  if((slot==='ON'||slot==='UN') && badgeSlots[slot].length>=2) return;

  const size=customBadgeSizes[id]||{width:60,height:25};
  const spacing=5;
  const baseRibbonY=getTopRibbonY();

  // These coordinates are tuned to our 450x600 canvas coordinates.
  const yMap={
    OLP: baseRibbonY - 25,
    OLPU:baseRibbonY -  5,
    OLPA:baseRibbonY - 55,
    ORP:300,
    ON:350,
    UN:390,
    LRP:405,
    LP:450
  };
  const xMap={
    OLP:328,
    OLPU:328,
    OLPA:328,
    ORP:100,
    ON:150,
    UN:150,
    LRP:335,
    LP:350
  };

  let y=yMap[slot]||390, x=xMap[slot]||150;
  if(slot==='ON'||slot==='UN'){
    const stackIdx=badgeSlots[slot].length;
    for(let i=0;i<stackIdx;i++){
      const prev=badgeSlots[slot][i];
      const ps=customBadgeSizes[prev]||{height:25};
      y+=ps.height+spacing;
    }
  }
  if(id==='model_rocketry_badge' && State.badges.includes('nra_marksman_badge')){
    y+=50;
  }

  const clone=img.cloneNode();
  clone.className='layer badge';
  clone.style.display='block';
  clone.style.top =`${y}px`;
  clone.style.left=`${x}px`;
  clone.style.width =`${size.width}px`;
  clone.style.height=`${size.height}px`;

  clone.dataset.tooltipTitle = id.replace(/_/g,' ').toUpperCase();
  clone.dataset.tooltipReg   = "CAPR 39-1 badge placement";
  clone.dataset.tooltipWhy   = "Auto-placed above/over pocket per category rules.";

  uniformCanvas.appendChild(clone);
  badgeSlots[slot].push(id);
}

/* ===========================
   PATCHES
   =========================== */
const patchSlots = { L_SHOULDER:[], R_SHOULDER:[], CHEST_LEFT:[], CHEST_RIGHT:[] };
function resetPatchSlots(){ Object.keys(patchSlots).forEach(k=>patchSlots[k]=[]); }

function planPatches(ids){
  resetPatchSlots();
  const capsPerUniform = {
    blues_a:{L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:1,CHEST_RIGHT:1},
    blues_b:{L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:1,CHEST_RIGHT:1},
    aviator:{L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:1,CHEST_RIGHT:1},
    aviator_blazer:{L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:0,CHEST_RIGHT:0},
    corporate_field:{L_SHOULDER:2,R_SHOULDER:2,CHEST_LEFT:1,CHEST_RIGHT:1},
    abu:{L_SHOULDER:2,R_SHOULDER:2,CHEST_LEFT:1,CHEST_RIGHT:1},
    flight_suit:{L_SHOULDER:2,R_SHOULDER:2,CHEST_LEFT:2,CHEST_RIGHT:2},
    semi_formal:{L_SHOULDER:0,R_SHOULDER:0,CHEST_LEFT:0,CHEST_RIGHT:0},
    mess_dress:{L_SHOULDER:0,R_SHOULDER:0,CHEST_LEFT:0,CHEST_RIGHT:0},
    polo:{L_SHOULDER:0,R_SHOULDER:0,CHEST_LEFT:0,CHEST_RIGHT:0}
  }[State.uniform] || {L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:1,CHEST_RIGHT:1};

  for(const id of ids){
    const meta=PATCH_META[id]; if(!meta) continue;
    const hint=meta.slotHint || 'L_SHOULDER';
    const cap=capsPerUniform[hint]??0;
    if(cap===0) continue;
    if(patchSlots[hint].length>=cap) continue;
    patchSlots[hint].push(id);
  }
}

function renderPatches(){
  [...uniformCanvas.querySelectorAll('.layer.patch')].forEach(n=>n.remove());
  if(!UI_AUTHZ[State.uniform]?.showPatches) return;

  planPatches(State.patches);

  // tuned approx for 450x600 base art
  const coords={
    L_SHOULDER:{x:95,y:250,dy:80},
    R_SHOULDER:{x:505,y:250,dy:80},
    CHEST_LEFT:{x:260,y:420,dy:70},
    CHEST_RIGHT:{x:580,y:420,dy:70}
  };

  for(const slot of Object.keys(patchSlots)){
    const ids=patchSlots[slot];
    let {x,y,dy}=coords[slot]||{x:0,y:0,dy:70};
    for(const id of ids){
      const meta=PATCH_META[id];
      const src = by('patch-'+id);
      const el  = (src?src.cloneNode():new Image());
      if(!src){ el.src=ASSET(meta.img); }

      el.className='layer patch';
      el.style.display='block';
      el.style.left =`${x - meta.w/2}px`;
      el.style.top  =`${y - meta.h/2}px`;
      el.style.width =`${meta.w}px`;
      el.style.height=`${meta.h}px`;
      el.onerror=()=>{};

      el.dataset.tooltipTitle = id.replace(/_/g,' ').toUpperCase();
      el.dataset.tooltipReg   = "Field/utility patch placement";
      el.dataset.tooltipWhy   = "Displayed on sleeve/chest per OCP/ABU/corporate field rules.";

      uniformCanvas.appendChild(el);
      y+=dy;
    }
  }
}

/* ===========================
   RANK / NAMEPLATE
   =========================== */
function renderRank(id){
  [...uniformCanvas.querySelectorAll('.layer.rank')].forEach(n=>n.remove());
  if(!id)return;

  const insigniaEl = by('ranks-'+id);
  if(!insigniaEl)return;

  const isOfficer = officerRanks.has(id);

  if(isOfficer){
    const boardSrc=ASSET('ranks/C/shoulder_board.png');
    const boardCfg={width:50,height:100};
    const insigniaCfg={width:32,height:32};
    const placements=[
      {left:350,top:160,rot:90},
      {left:100,top:160,rot:-90}
    ];
    placements.forEach(({left,top,rot})=>{
      const board=document.createElement('img');
      board.src=boardSrc;
      board.className='layer rank';
      board.style.display='block';
      board.style.left =`${left}px`;
      board.style.top  =`${top}px`;
      board.style.width =`${boardCfg.width}px`;
      board.style.height=`${boardCfg.height}px`;
      board.style.transform=`rotate(${rot}deg)`;
      board.style.transformOrigin='center center';
      board.dataset.tooltipTitle = id;
      board.dataset.tooltipReg   = "Officer shoulder board";
      board.dataset.tooltipWhy   = "Displayed for cadet/senior officer grades.";
      uniformCanvas.appendChild(board);

      const ins=insigniaEl.cloneNode();
      ins.className='layer rank';
      ins.style.display='block';
      ins.style.left =`${left + (boardCfg.width/2 - insigniaCfg.width/2)}px`;
      ins.style.top  =`${top  + (boardCfg.height/2 - insigniaCfg.height/2)}px`;
      ins.style.width =`${insigniaCfg.width}px`;
      ins.style.height=`${insigniaCfg.height}px`;
      ins.style.transform=`rotate(${rot}deg)`;
      ins.style.transformOrigin='center center';
      ins.dataset.tooltipTitle = id;
      ins.dataset.tooltipReg   = "Rank insignia";
      ins.dataset.tooltipWhy   = "Placed on shoulder boards for officer grades.";
      uniformCanvas.appendChild(ins);
    });
    return;
  }

  // enlisted / NCO overlay
  const size={w:60,h:60};
  const pos ={left:420,top:200};
  const icon=insigniaEl.cloneNode();
  icon.className='layer rank';
  icon.style.display='block';
  icon.style.left =`${pos.left}px`;
  icon.style.top  =`${pos.top}px`;
  icon.style.width =`${size.w}px`;
  icon.style.height=`${size.h}px`;
  icon.dataset.tooltipTitle = id;
  icon.dataset.tooltipReg   = "Enlisted/NCO rank placement";
  icon.dataset.tooltipWhy   = "Displayed directly on the coat / sleeve area.";
  uniformCanvas.appendChild(icon);
}

function renderNameplate(){
  [...uniformCanvas.querySelectorAll('.layer.nameplate')].forEach(n=>n.remove());
  const el=document.createElement('img');
  el.src=ASSET('nameplate/nameplate.png');
  el.className='layer nameplate';
  el.style.display='block';
  el.style.top='440px';
  el.style.left='120px';
  el.style.width='100px';
  el.style.height='20px';
  el.dataset.tooltipTitle="Nameplate";
  el.dataset.tooltipReg="CAPR 39-1 nameplate location";
  el.dataset.tooltipWhy="Centered on pocket / aligned per spec.";
  uniformCanvas.appendChild(el);
}

/* ===========================
   AVAILABILITY + ALTERNATE LOGIC
   =========================== */
function updateAvailabilityUI(prevUniform){
  const auth = UI_AUTHZ[State.uniform] || {showRibbons:true,showPatches:true,showBadges:true};

  by('groupRibbons').classList.toggle('hidden', !auth.showRibbons);
  by('groupPatches').classList.toggle('hidden', !auth.showPatches);

  if(prevUniform && prevUniform!==State.uniform){
    applyAlternates(prevUniform, State.uniform);
  }

  populatePatchesRemove();
  populateBadgesRemove();
}

function applyAlternates(fromU,toU){
  const fromField=isFieldUniform(fromU);
  const toField  =isFieldUniform(toU);

  if(!fromField && toField){
    // badges → patches
    Object.entries(ALTERNATES.badgeToPatch).forEach(([badge,patch])=>{
      if(State.badges.includes(badge) && !State.patches.includes(patch)){
        State.patches.push(patch);
      }
    });
    // ribbons → patches
    Object.entries(ALTERNATES.ribbonToPatch).forEach(([ribbon,patch])=>{
      if(State.ribbons.find(r=>r.id===ribbon) && !State.patches.includes(patch)){
        State.patches.push(patch);
      }
    });
  } else if(fromField && !toField){
    // patches → badges
    Object.entries(ALTERNATES.patchToBadge).forEach(([patch,badge])=>{
      if(State.patches.includes(patch) && badge && !State.badges.includes(badge)){
        State.badges.push(badge);
      }
    });
    // patches → ribbons
    Object.entries(ALTERNATES.patchToRibbon).forEach(([patch,ribbon])=>{
      if(State.patches.includes(patch) && ribbon && !State.ribbons.find(r=>r.id===ribbon)){
        State.ribbons.push({id:ribbon,devices:{}});
      }
    });
  }

  // cadet cleanup
  if(State.member==='cadet'){
    State.badges = State.badges.filter(isCadetAuthorized);
  }
}

/* ===========================
   FULL RENDER PIPELINE
   =========================== */
function fullRender(prevUniform){
  applyJacket();
  updateAvailabilityUI(prevUniform);

  renderPatches();
  renderAllBadges();
  renderRack();
  renderRank(State.rank);
}
function refreshUI(){
  memberSelect.value=State.member;
  jacketSelect.value=State.gender;
  assetBaseInput.value=State.assetBase;
  populateBadgesRemove();
  populatePatchesRemove();
  highlightActiveUniformButton();
  applyMemberTypeToUniformOptions();
}

/* ===========================
   MEMBER TYPE / UNIFORM AUTHZ
   =========================== */
function isUniformAllowedFor(uniformId, memberType){
  const btn = uniformListEl.querySelector(`.uniformOption[data-uniform-id="${uniformId}"]`);
  if(!btn) return false;
  const allowed=(btn.dataset.allowedFor||'').split(',').map(s=>s.trim());
  return allowed.includes(memberType);
}
function findFirstAllowedUniform(memberType){
  const opts=[...uniformListEl.querySelectorAll('.uniformOption')];
  for(const opt of opts){
    const allowed=(opt.dataset.allowedFor||'').split(',').map(s=>s.trim());
    if(allowed.includes(memberType)){
      return opt.dataset.uniformId;
    }
  }
  return null;
}
function applyMemberTypeToUniformOptions(){
  const opts=uniformListEl.querySelectorAll('.uniformOption');
  opts.forEach(opt=>{
    const allowed=(opt.dataset.allowedFor||'').split(',').map(s=>s.trim());
    const isAllowed=allowed.includes(State.member);

    if(isAllowed){
      opt.classList.remove('locked');
      opt.removeAttribute('data-locked-reason');
    }else{
      opt.classList.add('locked');
      let warnText='';
      if(State.member==='cadet'){
        warnText="This Uniform Is Not Authorized For Cadets";
      }else{
        warnText="This Uniform Is Not Authorized For This Member Type";
      }
      opt.setAttribute('data-locked-reason', warnText);
    }
  });
}
function highlightActiveUniformButton(){
  const opts=uniformListEl.querySelectorAll('.uniformOption');
  opts.forEach(opt=>{
    if(opt.dataset.uniformId===State.uniform){
      opt.style.outline=`2px solid var(--brand)`;
      opt.style.boxShadow=`0 0 0 3px rgba(0,40,85,.15)`;
      opt.style.background=`rgba(0,40,85,.05)`;
    }else{
      opt.style.outline='';
      opt.style.boxShadow='';
      opt.style.background='';
    }
  });
}

/* ===========================
   EVENT WIRING
   =========================== */

/* Member type change */
memberSelect.addEventListener('change', ()=>{
  State.member = memberSelect.value;

  // enforce uniform auth
  if(State.member==='cadet' && !isUniformAllowedFor(State.uniform,'cadet')){
    const fallback=findFirstAllowedUniform('cadet') || 'blues_a';
    const prevU=State.uniform;
    State.uniform=fallback;
    State.badges = State.badges.filter(isCadetAuthorized);
    fullRender(prevU);
  }else{
    if(State.member==='cadet'){
      State.badges = State.badges.filter(isCadetAuthorized);
    }
    fullRender();
  }

  refreshUI();
});

/* Gender (jacket cut) change */
jacketSelect.addEventListener('change', ()=>{
  State.gender=jacketSelect.value;
  fullRender();
});

/* Uniform selection (button list instead of select) */
uniformListEl.addEventListener('click', e=>{
  const btn=e.target.closest('.uniformOption');
  if(!btn) return;
  if(btn.classList.contains('locked')) return; // can't select unauthorized

  const newUniform=btn.dataset.uniformId;
  const prevU=State.uniform;
  State.uniform=newUniform;
  fullRender(prevU);
  refreshUI();
});

/* Asset base apply */
by('applyJacket').addEventListener('click', ()=>{
  State.assetBase=(assetBaseInput.value||'images').trim()||'images';
  applyJacket();
});

/* Asset base live change */
assetBaseInput.addEventListener('change', ()=>{
  State.assetBase=(assetBaseInput.value||'images').trim()||'images';
  fullRender();
});

/* Add ribbon */
by('addRibbon').addEventListener('click', ()=>{
  const id=by('ribbonSelect').value;
  const dev=by('deviceSelect').value||'none';
  const r=ensureRibbonObj(id);
  if(dev && dev!=='none'){
    r.devices[dev]=(r.devices[dev]||0)+1;
  }
  renderRack();
});

/* Clear ribbons */
by('clearRibbons').addEventListener('click', ()=>{
  State.ribbons=[];
  renderRack();
});

/* Build and wire the device picker UI */
buildDevicePicker();
wireDeviceUI();

/* Add badge */
by('addBadge').addEventListener('click', ()=>{
  const id=by('badgeSelect').value;
  if(State.member==='cadet' && !isCadetAuthorized(id)){
    alert('This badge is not authorized for cadets.');
    return;
  }
  enforceExclusive(id);
  if(!State.badges.includes(id)) State.badges.push(id);
  populateBadgesRemove();
  renderAllBadges();
});

/* Remove badge */
by('removeBadge').addEventListener('click', ()=>{
  const id=by('removeBadgeSelect').value;
  State.badges=State.badges.filter(b=>b!==id);
  populateBadgesRemove();
  renderAllBadges();
});

/* Add patch */
by('addPatch').addEventListener('click', ()=>{
  const id=by('patchSelect').value;
  if(!State.patches.includes(id)) State.patches.push(id);
  populatePatchesRemove();
  renderPatches();
});

/* Remove patch */
by('removePatch').addEventListener('click', ()=>{
  const id=by('removePatchSelect').value;
  State.patches=State.patches.filter(p=>p!==id);
  populatePatchesRemove();
  renderPatches();
});

/* Set rank */
by('addRank').addEventListener('click', ()=>{
  State.rank=by('rankSelect').value;
  renderRank(State.rank);
});

/* Add nameplate */
by('addNameplate').addEventListener('click', ()=>{
  renderNameplate();
});

/* Download image */
by('downloadImage').addEventListener('click', ()=>{
  html2canvas(uniformCanvas,{scale:3,backgroundColor:'#ffffff'}).then(c=>{
    const a=document.createElement('a');
    a.download=`CAP_Uniform_${Date.now()}.png`;
    a.href=c.toDataURL();
    a.click();
  });
});

/* Drag Mode toggle + coord logger */
const toggleRibbonDragBtn = by('toggleRibbonDrag');
const logRibbonCoordsBtn  = by('logRibbonCoords');

toggleRibbonDragBtn.addEventListener('click', ()=>{
  State.ribbonDragMode = !State.ribbonDragMode;

  if(State.ribbonDragMode){
    toggleRibbonDragBtn.textContent = 'Disable Drag Mode';
    toggleRibbonDragBtn.classList.remove('ghost');
    uniformCanvas.classList.add('drag-mode-on');
  }else{
    toggleRibbonDragBtn.textContent = 'Enable Drag Mode';
    toggleRibbonDragBtn.classList.add('ghost');
    uniformCanvas.classList.remove('drag-mode-on');
  }
});

logRibbonCoordsBtn.addEventListener('click', ()=>{
  const data=[];
  uniformCanvas.querySelectorAll('.ribbonTile').forEach(tile=>{
    data.push({
      rid: tile.dataset.rid,
      left: tile.style.left,
      top: tile.style.top,
      width: tile.style.width,
      height: tile.style.height
    });
  });
  console.log('RIBBON_COORD_REPORT', data);
  alert('Ribbon coordinates logged to console.');
});

/* ===========================
   BOOTSTRAP
   =========================== */
(function init(){
  refreshUI();
  fullRender();
})();
</script>
</body>
</html>
