<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#002855" />
  <link rel="icon" href="images/favicon.png" />
  <title>CAP Uniform Builder</title>

  <!-- Styles -->
  <link rel="stylesheet" href="css/style.css" />

  <!-- Library -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <!-- Path resolver FIRST so all <img> use the same logic -->
  <script src="js/asset-paths.js" defer></script>

  <!-- Core + data (use your existing files) -->
  <script src="js/util.js" defer></script>
  <script src="js/state.js" defer></script>
  <script src="js/uniforms.js" defer></script>

  <!-- DATA: must expose window.ribbonsMeta, etc. -->
  <script src="js/ribbons.data.js" defer></script>
  <script src="js/badges.data.js" defer></script>
  <script src="js/patches.data.js" defer></script>

  <!-- UI (your existing modules) -->
  <script src="js/badges.ui.js" defer></script>
  <script src="js/patches.ui.js" defer></script>
  <script src="js/rank.ui.js" defer></script>

  <!-- Engine / layout -->
  <script src="js/calibration.js" defer></script>
  <script src="js/layout.js" defer></script>

  <!-- UPDATED renderer (uses AssetPath.url everywhere) -->
  <script src="js/render.js" defer></script>

  <!-- NEW: Ribbons selector (preview + grid) -->
  <script src="js/ribbons.selector.js" defer></script>

  <!-- Dev tools (your originals) -->
  <script src="js/devtools.js" defer></script>
  <script src="js/devtools.ui.js" defer></script>

  <!-- Optional worker / assets UI / shim -->
  <script src="js/worker.render.js" defer></script>
  <script src="js/assets.ui.js" defer></script>
  <script src="js/compat.shim.js" defer></script>

  <!-- App bootstrap (wire renderer to canvas & call fullRender) -->
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      // Ensure a state object exists
      window.state = window.state || {
        member: 'cadet',
        gender: 'male',
        uniform: 'blues_a',
        assetBase: 'images',
        ribbons: [],  // [{id, devices:{}}]
        badges: [],
        patches: [],
        rank: ''
      };
      AssetPath.setBase(state.assetBase);

      // Canvas mount
      const canvas = document.getElementById('uniformCanvas');
      // Build renderer once the module is loaded
      if (window.makeRenderer) {
        window.globalRenderer = makeRenderer({
          canvasEl: canvas,
          uniforms: window.uniforms || {},
          uiAuthz: window.uiAuthz || {},
          ribbonsMeta: window.ribbonsMeta || [],
          miniMedalMap: window.miniMedalMap || {},
          deviceMeta: window.deviceMeta || {},
          patchMeta: window.patchMeta || {},
          badgeLocations: window.badgeLocations || {},
          customBadgeSizes: window.customBadgeSizes || {},
          allowedCadetBadgesSet: window.allowedCadetBadgesSet || new Set(),
          isFieldUniform: (u) => (window.uniforms && window.uniforms[u] ? !!window.uniforms[u].isField : false),
          alternates: window.alternates || {},
          registerCalibratable: (id, label) => { /* no-op hook */ }
        });
        // Initial render
        window.globalRenderer.fullRender(window.state);
      }

      // Sidebar hamburger
      const btn=document.getElementById('hamburgerBtn');
      const shell=document.getElementById('layoutShell');
      if (btn && shell) btn.addEventListener('click',()=> shell.classList.toggle('sidebar-collapsed'));

      // Update base folder live
      const baseInput = document.getElementById('assetBase');
      if (baseInput) {
        baseInput.addEventListener('input',(e)=>{
          state.assetBase = e.target.value || 'images';
          AssetPath.setBase(state.assetBase);
          window.globalRenderer && window.globalRenderer.fullRender(state);
        });
      }

      // Member dropdown -> update eligibility & re-render
      const memberSelect = document.getElementById('memberSelect');
      if (memberSelect) {
        memberSelect.addEventListener('change', () => {
          state.member = memberSelect.value;
          window.dispatchEvent(new Event('member-changed'));
          window.globalRenderer && window.globalRenderer.fullRender(state);
        });
      }

      // Jacket apply
      const jacketSelect = document.getElementById('jacketSelect');
      const jacketBtn = document.getElementById('applyJacket');
      if (jacketBtn && jacketSelect) {
        jacketBtn.addEventListener('click', () => {
          state.gender = jacketSelect.value === 'female' ? 'female' : 'male';
          window.globalRenderer && window.globalRenderer.fullRender(state);
        });
      }
    });
  </script>
</head>
<body>
  <header class="appHeader">
    <button id="hamburgerBtn" class="iconBtn" aria-label="Toggle sidebar" type="button">☰</button>
    <h1 class="appTitle">CAP Uniform Builder</h1>
    <div class="headerActions">
      <button id="downloadImage" class="primary" type="button">Download Preview</button>
    </div>
  </header>

  <div id="layoutShell" class="layoutShell">
    <aside id="controls" class="sidebar" aria-label="Controls panel">
      <section class="panelSection">
        <h2 class="panelTitle">Profile</h2>
        <div class="row">
          <select id="memberSelect" aria-label="Member type">
            <option value="cadet">Cadet</option>
            <option value="senior">Senior</option>
            <option value="senior_nco">Senior NCO</option>
          </select>
        </div>
        <div class="row">
          <input id="assetBase" type="text" value="images" aria-label="Asset base folder" />
        </div>
      </section>

      <section class="panelSection">
        <h2 class="panelTitle">Jacket</h2>
        <div class="row">
          <select id="jacketSelect" aria-label="Select jacket">
            <option value="male">Male Jacket</option>
            <option value="female">Female Jacket</option>
          </select>
          <button id="applyJacket" type="button">Apply</button>
        </div>
      </section>

      <!-- NEW: RIBBONS SELECTOR (preview + 3-across grid with checkboxes) -->
      <section class="panelSection" id="ribbonsSelectorSection">
        <h2 class="panelTitle">Ribbons</h2>

        <!-- Live rack preview -->
        <div id="ribbonPreview" aria-live="polite"></div>

        <!-- Controls -->
        <div id="ribbonGridControls">
          <label><input type="checkbox" id="rbEligibleOnly" /> Eligible only</label>
          <button id="rbSelectAll" type="button">Select All (visible)</button>
          <button id="rbClearAll" type="button">Clear All</button>
        </div>

        <!-- Grid of all ribbons, 3 across -->
        <div id="ribbonGrid"></div>
      </section>

      <!-- Your other panels can remain here (devices, badges, patches, rank, etc.) -->
    </aside>

    <div id="panelResizer" class="resizer" role="separator" aria-orientation="vertical"></div>

    <main id="main" class="main">
      <div id="panelShell" style="min-height:calc(100vh - 50px);">
        <div id="uniformCanvas" class="canvasShell"></div>
        <div id="assets" class="assetPreload" aria-hidden="true" style="display:none"></div>
      </div>
    </main>
  </div>

  <div id="tooltip" class="tooltip" aria-hidden="true"></div>

  <footer class="appFooter">
    <small>© <span id="year"></span> C/Capt. Guiseppe Doran — CAP Uniform Builder</small>
  </footer>

  <script>
    (function(){ var y=document.getElementById('year'); if(y) y.textContent=new Date().getFullYear(); })();
  </script>
</body>
</html>
