<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CAP Uniform Builder — Full Program</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  :root{ --bg:#eef1f5; --ink:#0d1b2a; --muted:#516079; --panel:#ffffff; --line:#cfd6df; --brand:#002855; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
  header{background:var(--brand);color:#fff;padding:14px 16px;text-align:center}
  header h1{margin:0;font-size:18px;letter-spacing:.3px}
  main{display:flex}
  #controls{width:360px;background:var(--panel);padding:14px;border-right:1px solid var(--line);overflow:auto;height:calc(100vh - 58px)}
  #preview{flex:1;background:#d1d8e0;display:flex;align-items:flex-start;justify-content:center;position:relative;height:calc(100vh - 58px)}
  #uniformCanvas{position:relative;width:900px;height:1200px}
  .layer{position:absolute;image-rendering:auto}
  label{font-size:12px;color:var(--muted);margin-top:8px;display:block}
  select,button,input{width:100%;margin-top:6px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#f8fafc}
  button{cursor:pointer;background:#0f2a54;color:#fff;border-color:#163766}
  button.ghost{background:#ffffff;color:var(--ink)}
  .row{display:flex;gap:8px}
  .two .col{flex:1}

  /* Device tool */
  #deviceTool{margin-top:10px;border:1px solid var(--line);border-radius:10px;padding:10px;background:#fefefe}
  #devicePicker{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  #deviceTool button{width:auto}

  @media (max-width: 1024px){
    main{flex-direction:column}
    #controls{width:100%;height:auto;border-right:none;border-bottom:1px solid var(--line)}
    #preview{height:auto}
    #uniformCanvas{width:600px;height:900px}
  }
</style>
</head>
<body>
<header>
  <h1>CAP Uniform Builder — Full Program (images/ path)</h1>
</header>

<main>
  <section id="controls">
    <div class="row two">
      <div class="col">
        <label>Member</label>
        <select id="memberSelect">
          <option value="cadet">Cadet</option>
          <option value="senior">Senior</option>
        </select>
      </div>
      <div class="col">
        <label>Gender</label>
        <select id="jacketSelect">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </div>
    </div>

    <label>Uniform</label>
    <select id="uniformSelect">
      <option value="blues_a">Blues: Class A</option>
      <option value="blues_b">Blues: Class B</option>
      <option value="mess_dress">Mess Dress (Senior)</option>
      <option value="semi_formal">Semi-formal</option>
      <option value="aviator">Aviator (Senior)</option>
      <option value="aviator_blazer">Aviator + Blazer (Senior)</option>
      <option value="corporate_field">Corporate Field</option>
      <option value="abu">ABUs</option>
      <option value="flight_suit">Flight Suit</option>
      <option value="polo">Polo (Senior)</option>
    </select>

    <div class="row two">
      <div class="col">
        <label>Asset Base</label>
        <input id="assetBase" value="images" placeholder="images"/>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button id="applyJacket" class="ghost">Apply Jacket</button>
      </div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid var(--line)">

    <label>Ribbons</label>
    <div class="row two">
      <div class="col"><select id="ribbonSelect"></select></div>
      <div class="col"><select id="deviceSelect"></select></div>
    </div>
    <div class="row two" style="margin-top:6px">
      <div class="col"><button id="addRibbon">Add Ribbon</button></div>
      <div class="col"><button id="clearRibbons" class="ghost">Clear Ribbons</button></div>
    </div>
    <label><input type="checkbox" id="autoMini" checked> Auto-convert ribbons → mini-medals on Mess/Semi-formal</label>

    <!-- Advanced device tool (multi-select + quantities + click-to-apply) -->
    <div id="deviceTool">
      <strong>Ribbon Devices — Multi-Apply</strong>
      <div id="devicePicker"></div>
      <div class="row" style="margin-top:8px">
        <button id="deviceApplyModeBtn" type="button">Enable Apply Mode</button>
        <button id="deviceRemoveModeBtn" type="button" class="ghost">Enable Remove Mode</button>
        <button id="deviceClearSelectionBtn" type="button" class="ghost">Clear Selection</button>
      </div>
      <small style="color:#516079;display:block;margin-top:6px">
        Choose devices + quantities → Enable Apply Mode → click a ribbon to add them. Use Remove Mode to clear devices from a ribbon.
      </small>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid var(--line)">

    <label>Badges</label>
    <div class="row two">
      <div class="col"><select id="badgeSelect"></select></div>
      <div class="col"><button id="addBadge">Add Badge</button></div>
    </div>
    <div class="row two" style="margin-top:6px">
      <div class="col"><select id="removeBadgeSelect"></select></div>
      <div class="col"><button id="removeBadge" class="ghost">Remove Badge</button></div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid var(--line)">

    <label>Rank Insignia</label>
    <div class="row two">
      <div class="col"><select id="rankSelect"></select></div>
      <div class="col"><button id="addRank">Set Rank</button></div>
    </div>
    <div class="row two" style="margin-top:6px">
      <div class="col"><button id="addNameplate" class="ghost">Add Nameplate</button></div>
      <div class="col"><button id="downloadImage">Download PNG</button></div>
    </div>
  </section>

  <section id="preview">
    <div id="uniformCanvas"></div>
  </section>
</main>

<!-- Hidden assets root -->
<div class="layer" id="assets" style="display:none"></div>

<script>
/************** Config & Catalogs (kept exactly as in your first file) **************/
const State = {
  member:'cadet',
  gender:'male',
  uniform:'blues_a',
  assetBase:'images',
  // ribbons: [{id, devices:{ deviceId: qty, ... }}]
  ribbons:[],
  badges:[],
  rank:null,
  // device tool state
  deviceApplyMode:false,
  deviceRemoveMode:false,
  selectedDevices:{} // {deviceId: qty}
};

const $  = s => document.querySelector(s);
const by = id => document.getElementById(id);
const uniformCanvas  = by('uniformCanvas');
const assetsContainer= by('assets');

function ASSET(p){
  const b=(State.assetBase||'images').replace(/\/$/,'');
  return `${b}/${p}`;
}

/* ---------- Ribbons (unchanged list & precedence) ---------- */
const ribbonList = [
  'silver_medal_of_valor','bronze_medal_of_valor','distinguished_service_award','exceptional_service_award','meritorious_service_award','commander_commendation_award','cap_achievment_award','lifesaving_award','national_commander_unit_citation_award','unit_citation_award','spaatz_award','eaker_award','earhart_award','mitchell_award','armstrong_achievement','goddard_achievement','doolittle_achievement','lindbergh_achievement','rickenbacker_achievement','wright_brothers_award','mary_feik_achievement','hap_arnold_achievement','curry_achievement','afa_award','afsa_award','vfw_officer_award','vfw_nco_award','crisis_ribbon','red_service_ribbon','search_find_ribbon','air_search_and_rescue_ribbon','disaster_relief_ribbon','homeland_security_ribbon','community_service_ribbon','iace_ribbon','national_cadet_competition_ribbon','national_color_guard_competition_ribbon','cadet_advisory_council_ribbon','cadet_special_activity_ribbon','encampment_ribbon','cadet_recruiter_ribbon'
];
const precedence = id => ribbonList.indexOf(id);

/* ---------- Devices (kept list & .webp paths) ---------- */
const deviceList = ['1_Bronze_Star_Device','1_Silver_Star_Device'];
const deviceMeta = {
  '1_Bronze_Star_Device': { label:'Bronze Star', src:'devices/1_Bronze_Star_Device.webp', w:10, h:10, weight:1 },
  '1_Silver_Star_Device': { label:'Silver Star', src:'devices/1_Silver_Star_Device.webp', w:10, h:10, weight:2 }
};

/* ---------- Badges & rules (kept as in your first file) ---------- */
const badgeList = [
  'AirCrew1_DB3F0FCC3650F','BalloonPilot1_442D89C94185B','CAPMasterPilot1_621A0E2ED15DA','CAPPilot1_FA9D33EA587D8','CAPSeniorPilot1_D9725AE959752','GliderPilot1_7BFB287379918','MasterAirCrew1_72AC4CAE7A310','MasterObserver1_1B88D5071FD5C','SeniorAirCrew1_B289BAE6E515C','SeniorObserver1_0E35802A29801',
  'buddist_chaplin','christian_chaplin','communications_technician_badge','cyber_badges','emergency_services_badge','emt_basic_badge','emt_intermediate','emt_paramedic','ground_team_basic_badge','historian_technicianIbadge','information_technology_technician_badge','jewish_chaplin','legal_officer','master_ground_team_badge','medical_officer','model_rocketry_badge','muslim_chaplin','nra_marksman_badge','nurse_officer','observer_badge','pre_solo_badge','senior_ground_team_badge','solo_badge','stem_badges'
];
const allowedCadetBadges = new Set([
  'solo_badge','pre_solo_badge','ground_team_basic_badge','senior_ground_team_badge','master_ground_team_badge','emt_basic_badge','emt_intermediate','emt_paramedic','aerospace','model_rocketry_badge','communications_technician_badge','information_technology_technician_badge','cyber_badges','stem_badges','cadetadvisory','cd','nra_marksman_badge','AirCrew1_DB3F0FCC3650F','BalloonPilot1_442D89C94185B','CAPMasterPilot1_621A0E2ED15DA','CAPPilot1_FA9D33EA587D8','CAPSeniorPilot1_D9725AE959752','GliderPilot1_7BFB287379918','MasterAirCrew1_72AC4CAE7A310','SeniorAirCrew1_B289BAE6E515C','MasterObserver1_1B88D5071FD5C','SeniorObserver1_0E35802A29801','observer_badge','emergency_services_badge','historian_technicianIbadge'
]);
const exclusiveBadges = [
  ['emt_basic_badge','ground_team_basic_badge'],
  ['emt_intermediate','senior_ground_team_badge'],
  ['emt_paramedic','master_ground_team_badge']
];
const badgeLocations = {
  'AirCrew1_DB3F0FCC3650F':'OLP','BalloonPilot1_442D89C94185B':'OLP','CAPMasterPilot1_621A0E2ED15DA':'OLP','CAPPilot1_FA9D33EA587D8':'OLP','CAPSeniorPilot1_D9725AE959752':'OLP','GliderPilot1_7BFB287379918':'OLP','MasterAirCrew1_72AC4CAE7A310':'OLP',
  'SeniorAirCrew1_B289BAE6E515C':'OLP','pre_solo_badge':'OLP','solo_badge':'OLP',
  'cyber_badges':'LP','stem_badges':'LP','communications_technician_badge':'LP','information_technology_technician_badge':'LP',
  'nra_marksman_badge':'LRP',
  'MasterObserver1_1B88D5071FD5C':'LP','SeniorObserver1_0E35802A29801':'LP','observer_badge':'LP',
  'ground_team_basic_badge':'OLPU','senior_ground_team_badge':'OLPU','master_ground_team_badge':'OLPU','emergency_services_badge':'OLPU','emt_basic_badge':'OLPU','emt_intermediate':'OLPU','emt_paramedic':'OLPU',
  'historian_technicianIbadge':'LP','model_rocketry_badge':'LP',
  'buddist_chaplin':'ORP','christian_chaplin':'ORP','jewish_chaplin':'ORP','legal_officer':'ORP','medical_officer':'ORP','nurse_officer':'ORP','muslim_chaplin':'ORP'
};
const customBadgeSizes = {
  'AirCrew1_DB3F0FCC3650F':{width:60,height:25},'BalloonPilot1_442D89C94185B':{width:60,height:25},'CAPMasterPilot1_621A0E2ED15DA':{width:60,height:25},'CAPPilot1_FA9D33EA587D8':{width:60,height:25},'CAPSeniorPilot1_D9725AE959752':{width:60,height:25},'GliderPilot1_7BFB287379918':{width:60,height:25},'MasterAirCrew1_72AC4CAE7A310':{width:60,height:25},'MasterObserver1_1B88D5071FD5C':{width:60,height:25},'SeniorAirCrew1_0E35802A29801':{width:60,height:25},
  'buddist_chaplin':{width:60,height:60},'christian_chaplin':{width:60,height:60},'communications_technician_badge':{width:60,height:60},
  'cyber_badges':{width:60,height:25},'emergency_services_badge':{width:60,height:60},'emt_basic_badge':{width:60,height:60},
  'emt_intermediate':{width:60,height:60},'emt_paramedic':{width:60,height:60},'ground_team_basic_badge':{width:25,height:20},
  'historian_technicianIbadge':{width:60,height:60},'information_technology_technician_badge':{width:60,height:60},
  'jewish_chaplin':{width:60,height:60},'legal_officer':{width:60,height:25},'master_ground_team_badge':{width:25,height:20},
  'medical_officer':{width:60,height:60},'model_rocketry_badge':{width:7,height:28.125},'muslim_chaplin':{width:60,height:60},
  'nra_marksman_badge':{width:40,height:60},'nurse_officer':{width:60,height:60},'observer_badge':{width:60,height:25},
  'pre_solo_badge':{width:60,height:25},'senior_ground_team_badge':{width:25,height:20},'solo_badge':{width:60,height:25},'stem_badges':{width:60,height:25}
};

/* ---------- Ranks (unchanged) ---------- */
const rankList = ['C/AB','C/Amn','C/A1C','C/SrA','C/SSgt','C/TSgt','C/MSgt','C/SMSgt','C/CMSgt','C/2d Lt','C/1st Lt','C/Capt','C/Maj','C/Lt Col','C/Col'];
const officerRanks = new Set(['C/2d Lt','C/1st Lt','C/Capt','C/Maj','C/Lt Col','C/Col']);

/* ---------- Uniform bases (kept capitalized ABU as in your first file) ---------- */
const UNIFORMS = {
  blues_a:{male:'base/jacket_male.png',         female:'base/jacket_female.png',         ribbons:true,  mini:false},
  blues_b:{male:'base/blues_class_b_male.png',female:'base/blues_class_b_female.png',ribbons:true,mini:false},
  mess_dress:{male:'base/mess_dress_male.png',female:'base/mess_dress_female.png',ribbons:false,mini:true},
  semi_formal:{male:'base/semi_male.png',       female:'base/semi_female.png',           ribbons:false, mini:true},
  aviator:{male:'base/aviator_shirt_male.png',female:'base/aviator_shirt_female.png',ribbons:true,mini:false},
  aviator_blazer:{male:'base/aviator_blazer_male.png',female:'base/aviator_blazer_female.png', ribbons:true, mini:false},
  corporate_field:{male:'base/corporate_field_male.png',female:'base/corporate_field_female.png', ribbons:true, mini:false},
  abu:{male:'base/ABU_male.png',                female:'base/ABU_female.png',            ribbons:false, mini:false},
  flight_suit:{male:'base/flight_suit_male.png',female:'base/flight_suit_female.png',    ribbons:false, mini:false},
  polo:{male:'base/polo_male.png',              female:'base/polo_female.png',           ribbons:false, mini:false}
};

/******************** UI populate ********************/
function optionize(sel, list){
  sel.innerHTML='';
  list.forEach(v=>{
    const o=document.createElement('option');
    o.value=v;
    o.textContent=v.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    sel.appendChild(o);
  });
}
function populateBadgesRemove(){
  const sel=by('removeBadgeSelect');
  if(!sel) return;
  sel.innerHTML='';
  State.badges.forEach(id=>{
    const o=document.createElement('option');
    o.value=id;
    o.textContent=id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    sel.appendChild(o);
  });
}

/* Preload helpers (robust; tolerate missing) */
function preloadSimple(prefix, list, folder, ext=".png"){
  list.forEach(id=>{
    const img=document.createElement('img');
    img.id = `${prefix}-${id}`;
    img.src = ASSET(`${folder}/${id}${ext}`);
    img.style.display='none';
    img.loading='eager';
    img.decoding='sync';
    img.onerror=()=>{}; // tolerate missing assets
    assetsContainer.appendChild(img);
  });
}
function preloadWithResolver(prefix, list, resolver){
  list.forEach(id=>{
    const src = resolver(id);
    const img=document.createElement('img');
    img.id = `${prefix}-${id}`;
    img.src = ASSET(src);
    img.style.display='none';
    img.loading='eager';
    img.decoding='sync';
    img.onerror=()=>{};
    assetsContainer.appendChild(img);
  });
}

/* Populate & preload */
optionize(by('ribbonSelect'), ribbonList);
optionize(by('deviceSelect'), ['none', ...deviceList]);
optionize(by('rankSelect'), rankList);
optionize(by('badgeSelect'), badgeList);
preloadSimple('ribbons', ribbonList, 'ribbons', '.png');
preloadWithResolver('devices', deviceList, id => deviceMeta[id].src);
preloadSimple('ranks', rankList, 'ranks', '.png');
preloadSimple('badges', badgeList, 'badges', '.png');

/******************** Base & layers ********************/
function clearLayers(cls){
  const sel = cls ? `.layer.${cls}` : '.layer';
  uniformCanvas.querySelectorAll(sel).forEach(n=>n.remove());
}
function applyJacket(){
  clearLayers('jacket');
  const base = UNIFORMS[State.uniform][State.gender];
  const img=document.createElement('img');
  img.className='layer jacket';
  img.src=ASSET(base);
  img.style.top='150px';
  img.style.left='0px';
  img.style.width='100%';
  img.style.height='auto';
  img.style.display='block';
  uniformCanvas.appendChild(img);
}

/******************** Ribbons / Mini-Medals ********************/
function sortRibbons(arr){
  return [...arr].sort((a,b)=> precedence(a.id)-precedence(b.id));
}
function getTopRibbonY(){
  const layers=[...uniformCanvas.querySelectorAll('.layer.ribbonTile')];
  if(!layers.length) return null;
  return Math.min(...layers.map(l=>parseInt(l.style.top)));
}
function ensureRibbonObj(id){
  let r = State.ribbons.find(x=>x.id===id);
  if(!r){ r={id,devices:{}}; State.ribbons.push(r); }
  if(!r.devices) r.devices={};
  return r;
}

/* ======= UPDATED: centers rack at (580,507) with 60×19.2 ribbons ======= */
function renderRack(){
  // Clear prior ribbon tiles, minis, and device overlays
  [...uniformCanvas.querySelectorAll('.layer.ribbonTile,.layer.ribbonMini,.layer.ribbonDevice')].forEach(n=>n.remove());

  const allowMini = UNIFORMS[State.uniform].mini && by('autoMini').checked;
  const showRibbons = UNIFORMS[State.uniform].ribbons && !allowMini;
  const items = sortRibbons(State.ribbons);
  if(!items.length) return;

  if(showRibbons){
    // Anchor for the center of the entire rack
    const ANCHOR_CX = 580;
    const ANCHOR_CY = 507;

    // Ribbon geometry (from your sample element)
    const RIB_W = 60;
    const RIB_H = 19.2;
    const RIB_PAD = 2;

    // Device geometry (centered on each ribbon)
    const DEV_W = 10;
    const DEV_H = 10;
    const DEV_Y_OFFSET = Math.round((RIB_H - DEV_H) / 2);

    // Build rows of 3; top partial row (if any) comes first
    const ids = items.map(x=>x.id);
    const rows=[];
    if(ids.length%3!==0){ rows.push(ids.slice(0, ids.length%3)); }
    for(let i=ids.length%3;i<ids.length;i+=3) rows.push(ids.slice(i,i+3));

    // Total rack height to vertically center at ANCHOR_CY
    const totalRows = rows.length;
    const totalHeight = totalRows * RIB_H + (totalRows - 1) * RIB_PAD;
    const rackTopY = ANCHOR_CY - totalHeight/2;

    rows.forEach((row,ri)=>{
      const rowWidth = row.length * RIB_W + (row.length - 1) * RIB_PAD;
      const rowLeftX = ANCHOR_CX - rowWidth/2;
      const rowTopY  = rackTopY + ri * (RIB_H + RIB_PAD);

      row.forEach((rid,i)=>{
        const orig=by(`ribbons-${rid}`); if(!orig) return;

        // Ribbon tile (clickable for device tool)
        const el=orig.cloneNode();
        el.className='layer ribbonTile';
        el.style.display='block';
        const leftPx = rowLeftX + i*(RIB_W + RIB_PAD);
        const topPx  = rowTopY;
        el.style.left = `${leftPx}px`;
        el.style.top  = `${topPx}px`;
        el.style.width  = `${RIB_W}px`;
        el.style.height = `${RIB_H}px`;
        el.dataset.rid = rid;
        el.style.pointerEvents='auto';
        el.onclick = () => onRibbonTileClick(rid);
        uniformCanvas.appendChild(el);

        // Devices for this ribbon (centered horizontally)
        const r = ensureRibbonObj(rid);
        const flat=[];
        for(const [devId,count] of Object.entries(r.devices||{})){
          const meta = deviceMeta[devId]; if(!meta) continue;
          for(let k=0;k<count;k++) flat.push({id:devId,label:meta.label,src:meta.src,w:DEV_W,h:DEV_H,weight:meta.weight});
        }
        if(flat.length){
          flat.sort((a,b)=> (b.weight-a.weight) || (a.label||a.id).localeCompare(b.label||b.id));
          const GAP = 3;
          const totalW = flat.reduce((s,d,ix)=> s + d.w + (ix?GAP:0), 0);
          let dx = Math.round(leftPx + (RIB_W - totalW)/2);
          const dy = Math.round(topPx + DEV_Y_OFFSET);
          flat.forEach(d=>{
            const im=document.createElement('img');
            im.className='layer ribbonDevice';
            im.src = ASSET(d.src);
            im.alt = d.label || d.id;
            im.style.display='block';
            im.style.left = `${dx}px`;
            im.style.top  = `${dy}px`;
            im.style.width  = `${d.w}px`;
            im.style.height = `${d.h}px`;
            im.onerror=()=>{ im.remove(); };
            uniformCanvas.appendChild(im);
            dx += d.w + GAP;
          });
        }
      });
    });
  } else {
    // Mini-medals (unchanged layout)
    const w=20,h=28, pad=6;
    const startTop=400, startLeft=280;
    const ids = items.map(x=>x.id);
    const rows=[];
    if(ids.length%5!==0){ rows.push(ids.slice(0, ids.length%5)); }
    for(let i=ids.length%5;i<ids.length;i+=5) rows.push(ids.slice(i,i+5));
    rows.reverse();
    rows.forEach((row,ri)=>{
      const totalW = row.length * w + (row.length-1)*pad;
      const x0 = startLeft + Math.round((5*w + 4*pad - totalW)/2);
      const y  = startTop - ri*(h+pad);
      row.forEach((rid,i)=>{
        const el=document.createElement('img');
        el.src=ASSET(`mini_medals/${rid}.png`);
        el.className='layer ribbonMini';
        el.style.display='block';
        el.style.top  = `${y-h}px`;
        el.style.left = `${x0 + i*(w+pad)}px`;
        el.style.width  = `${w}px`;
        el.style.height = `${h}px`;
        el.onerror=()=>{}; // tolerate missing mini
        uniformCanvas.appendChild(el);
      });
    });
  }
}

function onRibbonTileClick(rid){
  if(State.deviceRemoveMode){
    const r = ensureRibbonObj(rid);
    r.devices = {};
    renderRack();
    return;
  }
  if(!State.deviceApplyMode) return;
  const r = ensureRibbonObj(rid);
  for(const [devId,qty] of Object.entries(State.selectedDevices)){
    r.devices[devId] = (r.devices[devId]||0) + qty;
  }
  renderRack();
}
function drawDevicesOnRibbon(rid, leftPx, topPx, w, h){
  // (kept for compatibility if called elsewhere)
  const r = ensureRibbonObj(rid);
  const flat=[];
  for(const [devId,count] of Object.entries(r.devices||{})){
    const meta = deviceMeta[devId];
    if(!meta) continue;
    for(let i=0;i<count;i++){
      flat.push({id:devId, ...meta});
    }
  }
  if(!flat.length) return;

  flat.sort((a,b)=>(b.weight-a.weight)|| (a.label||a.id).localeCompare(b.label||b.id));

  const gap = 3;
  const totalW = flat.reduce((s,d,i)=> s + d.w + (i>0?gap:0), 0);
  let x = Math.round(leftPx + (w-totalW)/2);
  const y = Math.round(topPx + (h-10)/2) - 1;

  flat.forEach(d=>{
    const im=document.createElement('img');
    im.className='layer ribbonDevice';
    im.src = ASSET(d.src);
    im.alt = d.label || d.id;
    im.style.display='block';
    im.style.left = `${x}px`;
    im.style.top  = `${y}px`;
    im.style.width  = `${d.w}px`;
    im.style.height= `${d.h}px`;
    im.onerror=()=>{ im.remove(); };
    uniformCanvas.appendChild(im);
    x += d.w + gap;
  });
}

/******************** Advanced Device Tool ********************/
function buildDevicePicker(){
  const wrap = by('devicePicker');
  wrap.innerHTML = '';
  deviceList.forEach(id=>{
    const row=document.createElement('label');
    row.style.cssText="display:flex;align-items:center;gap:8px";
    row.innerHTML = `
      <input type="checkbox" data-device="${id}"/>
      <span>${deviceMeta[id].label}</span>
      <input type="number" min="1" max="10" value="1" data-qty="${id}" style="width:70px;margin-left:auto">
    `;
    wrap.appendChild(row);
  });
}
function readDevicePicker(){
  const wrap=by('devicePicker');
  const bundle={};
  wrap.querySelectorAll('input[type="checkbox"][data-device]').forEach(chk=>{
    const id=chk.getAttribute('data-device');
    if(chk.checked){
      const qty=parseInt(wrap.querySelector(`input[type="number"][data-qty="${id}"]`).value||"1",10);
      if(qty>0) bundle[id]=qty;
    }
  });
  return bundle;
}
function wireDeviceUI(){
  const applyBtn = by('deviceApplyModeBtn');
  const removeBtn= by('deviceRemoveModeBtn');
  const clearBtn = by('deviceClearSelectionBtn');

  applyBtn.addEventListener('click', ()=>{
    State.selectedDevices = readDevicePicker();
    const hasAny = Object.keys(State.selectedDevices).length>0;
    State.deviceApplyMode = hasAny;
    State.deviceRemoveMode = false;
    applyBtn.textContent = State.deviceApplyMode ? 'Apply Mode: ON' : 'Enable Apply Mode';
    applyBtn.classList.toggle('ghost', !State.deviceApplyMode);
    removeBtn.classList.add('ghost');
  });
  removeBtn.addEventListener('click', ()=>{
    State.deviceRemoveMode = !State.deviceRemoveMode;
    State.deviceApplyMode = false;
    removeBtn.textContent = State.deviceRemoveMode ? 'Remove Mode: ON' : 'Enable Remove Mode';
    removeBtn.classList.toggle('ghost', !State.deviceRemoveMode);
    by('deviceApplyModeBtn').textContent = 'Enable Apply Mode';
  });
  clearBtn.addEventListener('click', ()=>{
    by('devicePicker').querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false);
    by('devicePicker').querySelectorAll('input[type="number"]').forEach(n=>n.value=1);
    State.selectedDevices = {};
    State.deviceApplyMode = false;
    State.deviceRemoveMode = false;
    applyBtn.textContent='Enable Apply Mode';
    removeBtn.textContent='Enable Remove Mode';
    applyBtn.classList.add('ghost');
    removeBtn.classList.add('ghost');
  });
}

/******************** Badges ********************/
const badgeSlots = { OLPA:[], OLPU:[], OLP:[], ORP:[], ON:[], UN:[], LRP:[], LP:[] };
function resetBadgeSlots(){ Object.keys(badgeSlots).forEach(k=> badgeSlots[k]=[] ); }
function isCadetAuthorized(id){ return allowedCadetBadges.has(id); }
function enforceExclusive(newId){
  exclusiveBadges.forEach(pair=>{
    if(pair.includes(newId)){
      pair.forEach(conf=>{
        if(conf!==newId && State.badges.includes(conf)){
          State.badges = State.badges.filter(b=>b!==conf);
        }
      });
    }
  });
}
function renderAllBadges(){
  clearLayers('badge');
  resetBadgeSlots();
  const maxTotal=5;
  const applied=[];
  for(const id of State.badges){
    if(applied.length>=maxTotal) break;
    placeBadgeByCategory(id);
    applied.push(id);
  }
}
function placeBadgeByCategory(id){
  const img=by(`badges-${id}`);
  if(!img) return;

  let slot = badgeLocations[id] || 'UN';
  if(id==='nra_marksman_badge') slot='LRP';
  if(id==='model_rocketry_badge') slot='LP';

  const single = new Set(['OLP','OLPU','OLPA','ORP','LRP','LP']);
  if(single.has(slot) && badgeSlots[slot].length>=1) return;
  if((slot==='ON' || slot==='UN') && badgeSlots[slot].length>=2) return;

  const size = customBadgeSizes[id] || {width:60,height:25};
  const spacing=5;
  const baseRibbonY = getTopRibbonY();
  const yMap = {
    OLP: baseRibbonY!==null? baseRibbonY - 25 : 394,
    OLPU: baseRibbonY!==null? baseRibbonY - 5 : 424,
    OLPA: baseRibbonY!==null? baseRibbonY - 55 : 364,
    ORP: 300, ON: 350, UN: 390, LRP: 405, LP: 450
  };
  const xMap = { OLP:328, OLPU:328, OLPA:328, ORP:100, ON:150, UN:150, LRP:335, LP:350 };

  let y=yMap[slot]||390, x=xMap[slot]||150;

  if(slot==='ON' || slot==='UN'){
    const stackIdx = badgeSlots[slot].length;
    for(let i=0;i<stackIdx;i++){
      const prev = badgeSlots[slot][i];
      const ps = customBadgeSizes[prev]||{height:25};
      y += ps.height + spacing;
    }
  }
  if(id==='model_rocketry_badge' && State.badges.includes('nra_marksman_badge')) y += 50;

  const clone = img.cloneNode();
  clone.className='layer badge';
  clone.style.display='block';
  clone.style.top=`${y}px`;
  clone.style.left=`${x}px`;
  clone.style.width=`${size.width}px`;
  clone.style.height=`${size.height}px`;
  uniformCanvas.appendChild(clone);
  badgeSlots[slot].push(id);
}

/******************** Rank & Nameplate ********************/
function renderRank(id){
  clearLayers('rank');
  if(!id) return;

  const insigniaEl = by('ranks-' + id);
  if(!insigniaEl) return;

  const isOfficer = officerRanks.has(id);

  if(isOfficer){
    const boardSrc = ASSET('ranks/C/shoulder_board.png');
    const boardCfg = {width:50,height:100};
    const insigniaCfg = {width:32,height:32};
    const placements = [
      {left:350, top:160, rot:90},   // left shoulder board (rotated right)
      {left:100, top:160, rot:-90}   // right shoulder board (rotated left)
    ];
    placements.forEach(({left,top,rot})=>{
      const board=document.createElement('img');
      board.src=boardSrc;
      board.className='layer rank';
      board.style.display='block';
      board.style.left=`${left}px`;
      board.style.top=`${top}px`;
      board.style.width=`${boardCfg.width}px`;
      board.style.height=`${boardCfg.height}px`;
      board.style.transform=`rotate(${rot}deg)`;
      board.style.transformOrigin='center center';
      uniformCanvas.appendChild(board);

      const ins=insigniaEl.cloneNode();
      ins.className='layer rank';
      ins.style.display='block';
      ins.style.left=`${left + (boardCfg.width/2 - insigniaCfg.width/2)}px`;
      ins.style.top=`${top + (boardCfg.height/2 - insigniaCfg.height/2)}px`;
      ins.style.width=`${insigniaCfg.width}px`;
      ins.style.height=`${insigniaCfg.height}px`;
      ins.style.transform=`rotate(${rot}deg)`;
      ins.style.transformOrigin='center center';
      uniformCanvas.appendChild(ins);
    });
    return;
  }

  // Enlisted (single overlay spot)
  const size = {w:60,h:60};
  const pos = {left:420, top:200};
  const icon=insigniaEl.cloneNode();
  icon.className='layer rank';
  icon.style.display='block';
  icon.style.left=`${pos.left}px`;
  icon.style.top=`${pos.top}px`;
  icon.style.width=`${size.w}px`;
  icon.style.height=`${size.h}px`;
  uniformCanvas.appendChild(icon);
}
function renderNameplate(){
  clearLayers('nameplate');
  const el=document.createElement('img');
  el.src=ASSET('nameplate/nameplate.png');
  el.className='layer nameplate';
  el.style.display='block';
  el.style.top='440px';
  el.style.left='120px';
  el.style.width='100px';
  el.style.height='20px';
  uniformCanvas.appendChild(el);
}

/******************** Persistence (optional) ********************/
function quickSave(){ try{ localStorage.setItem('cap_uniform', JSON.stringify(State)); }catch{} }
function quickLoad(){
  const t=localStorage.getItem('cap_uniform');
  if(!t) return;
  try{ Object.assign(State, JSON.parse(t)); refreshUI(); fullRender(); }catch{}
}

/******************** Rendering orchestrator ********************/
function fullRender(){
  applyJacket();
  renderRack();
  renderAllBadges();
  renderRank(State.rank);
}
function refreshUI(){
  by('memberSelect').value=State.member;
  by('jacketSelect').value=State.gender;
  by('uniformSelect').value=State.uniform;
  by('assetBase').value=State.assetBase;
  populateBadgesRemove();
}

/******************** Handlers ********************/
by('applyJacket').onclick=()=>{
  State.assetBase=by('assetBase').value.trim()||'images';
  State.gender=by('jacketSelect').value;
  applyJacket();
};

by('memberSelect').onchange=(e)=>{
  State.member=e.target.value;
  if(State.member==='cadet' && (State.uniform==='polo' || State.uniform==='mess_dress')){
    alert('Cadets are not authorized Polo or Mess Dress. Switching to Blues A.');
    State.uniform='blues_a';
    by('uniformSelect').value='blues_a';
  }
  if(State.member==='cadet'){
    State.badges = State.badges.filter(isCadetAuthorized);
    populateBadgesRemove();
    fullRender();
  }
};

by('jacketSelect').onchange=(e)=>{ State.gender=e.target.value; applyJacket(); };

by('uniformSelect').onchange=(e)=>{
  State.uniform=e.target.value;
  if(!UNIFORMS[State.uniform].ribbons && !UNIFORMS[State.uniform].mini){
    State.ribbons=[];
  }
  fullRender();
};

by('assetBase').onchange=(e)=>{ State.assetBase=e.target.value.trim()||'images'; fullRender(); };

by('addRibbon').onclick=()=>{
  const id=by('ribbonSelect').value;
  const dev=by('deviceSelect').value||'none';
  const r = ensureRibbonObj(id);
  if(dev && dev!=='none'){
    r.devices[dev] = (r.devices[dev]||0) + 1; // quick single add
  }
  renderRack();
};

by('clearRibbons').onclick=()=>{ State.ribbons=[]; renderRack(); };

/* Device tool wiring */
buildDevicePicker();
wireDeviceUI();

by('addBadge').onclick=()=>{
  const id=by('badgeSelect').value;
  if(State.member==='cadet' && !isCadetAuthorized(id)) { alert('This badge is not authorized for cadets.'); return; }
  enforceExclusive(id);
  if(!State.badges.includes(id)) State.badges.push(id);
  populateBadgesRemove();
  renderAllBadges();
};

by('removeBadge').onclick=()=>{
  const id=by('removeBadgeSelect').value;
  State.badges=State.badges.filter(b=>b!==id);
  populateBadgesRemove();
  renderAllBadges();
};

by('addRank').onclick=()=>{ State.rank=by('rankSelect').value; renderRank(State.rank); };
by('addNameplate').onclick=()=> renderNameplate();

by('downloadImage').onclick=()=>{
  html2canvas(uniformCanvas,{scale:3, backgroundColor:'#ffffff'}).then(c=>{
    const a=document.createElement('a');
    a.download=`CAP_Uniform_${Date.now()}.png`;
    a.href=c.toDataURL();
    a.click();
  });
};

/******************** Boot ********************/
(function init(){
  refreshUI();
  applyJacket();
  renderRack();
})();
</script>
</body>
</html>
