<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CAP Uniform Builder — Full Program</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --bg:#eef1f5;
    --ink:#0d1b2a;
    --muted:#516079;
    --panel:#ffffff;
    --line:#cfd6df;
    --brand:#002855;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg);
    color:var(--ink);
  }

  header{
    background:var(--brand);
    color:#fff;
    padding:14px 16px 14px 48px; /* leave space for hamburger in top-left */
    text-align:center;
    position:relative;
  }
  header h1{
    margin:0;
    font-size:18px;
    letter-spacing:.3px
  }

  .hamburgerBtn{
    position:fixed;
    left:12px;
    top:12px;
    z-index:10000;
    width:32px;
    height:32px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,.4);
    background:rgba(255,255,255,.12);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:4px;
    cursor:pointer;
    box-shadow:0 10px 25px rgb(0 0 0 / .3);
  }
  .hamburgerBtn span{
    display:block;
    width:18px;
    height:2px;
    background:#fff;
    border-radius:1px;
  }

  #layoutShell {
    display:flex;
    height:calc(100vh - 58px);
    position:relative;
    background:var(--bg);
    color:var(--ink);
    overflow:hidden;
  }

  #controls {
    width:340px;
    max-width:340px;
    min-width:260px;
    background:var(--panel);
    border-right:1px solid var(--line);
    box-shadow:0 0 20px rgb(0 0 0 / .07);
    display:flex;
    flex-direction:column;
    z-index:10;
    transition:
      width .2s ease,
      min-width .2s ease,
      max-width .2s ease,
      transform .2s ease;
    overflow:hidden;
  }

  .controlsHeader {
    background:var(--brand);
    color:#fff;
    padding:12px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  .controlsHeader .controlsTitle {
    margin:0;
    font-size:14px;
    font-weight:600;
    line-height:1.2;
    letter-spacing:.2px;
    width:100%;
    text-align:left;
  }

  .controlsScrollArea{
    flex:1;
    overflow-y:auto;
    padding:12px 14px 48px;
  }

  .panelBlock {
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:10px;
    padding:12px 12px 10px;
    margin-bottom:12px;
    box-shadow:0 8px 20px rgb(0 0 0 / .04);
  }

  .fieldLabel{
    font-size:13px;
    font-weight:600;
    color:var(--ink);
    display:block;
    margin-bottom:6px;
  }
  .hintText{
    font-size:11px;
    line-height:1.3;
    color:var(--muted);
    margin-top:6px;
  }

  select,button,input{
    width:100%;
    margin-top:6px;
    padding:8px;
    border:1px solid var(--line);
    border-radius:10px;
    background:#f8fafc;
    font-family:inherit;
    font-size:13px;
    color:var(--ink);
  }
  button{
    cursor:pointer;
    background:#0f2a54;
    color:#fff;
    border-color:#163766;
  }
  button.ghost{
    background:#ffffff;
    color:var(--ink);
  }

  .row{display:flex;gap:8px;flex-wrap:wrap}
  .two .col{flex:1}

  .hidden{display:none !important}
  .disabledBlock{opacity:.55; pointer-events:none; filter:grayscale(.25);}

  .uniformList{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .uniformOption{
    width:100%;
    text-align:left;
    background:#fff;
    border:1px solid var(--line);
    border-radius:8px;
    padding:10px 12px;
    font-family:inherit;
    cursor:pointer;
    position:relative;
    box-shadow:0 4px 12px rgb(0 0 0 / .03);
    transition:box-shadow .12s ease,border-color .12s ease,background .12s ease;
  }
  .uniformOption:hover{
    box-shadow:0 10px 24px rgb(0 0 0 / .07);
    border-color:var(--brand);
    background:rgba(0,40,85,.04);
  }
  .uniformOption .uName{
    font-size:13px;
    font-weight:600;
    color:var(--ink);
    margin-bottom:2px;
    line-height:1.3;
  }
  .uniformOption .uDesc{
    font-size:11px;
    color:var(--muted);
    line-height:1.3;
  }

  .uniformOption.locked{
    cursor:not-allowed;
    opacity:.45;
    filter:grayscale(1);
    background:#f4f4f7;
    border-style:dashed;
    border-color:var(--line);
    box-shadow:none;
  }
  .uniformOption.locked:hover{
    border-color:var(--line);
    background:#f4f4f7;
    box-shadow:none;
  }
  .uniformOption.locked:hover::after{
    content:attr(data-locked-reason);
    position:absolute;
    left:100%;
    top:50%;
    transform:translate(8px,-50%);
    min-width:180px;
    max-width:220px;
    background:rgba(15,23,42,.95);
    color:#fff;
    font-size:11px;
    line-height:1.35;
    border-radius:8px;
    box-shadow:0 20px 40px rgb(0 0 0 / .6);
    padding:8px 10px;
    border:1px solid rgba(255,255,255,.2);
    pointer-events:none;
    white-space:normal;
    text-align:left;
    z-index:9999;
  }

  #deviceTool{
    margin-top:10px;
    border:1px solid var(--line);
    border-radius:10px;
    padding:10px;
    background:#fefefe;
  }
  #devicePicker{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:8px;
    font-size:12px;
  }

  #previewWrapper{
    flex:1;
    position:relative;
    padding:16px;
    display:flex;
    gap:16px;
    overflow:auto;
    align-items:flex-start;
    justify-content:center;
    background:var(--bg);
  }

  #previewArea{
    position:relative;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:12px;
    width:450px;
    height:600px;
    box-shadow:0 30px 60px rgb(0 0 0 / .12);
    overflow:hidden;
  }

  #uniformCanvas{
    position:relative;
    width:100%;
    height:100%;
  }
  .layer{
    position:absolute;
    image-rendering:auto;
  }

  .drag-mode-on .ribbonTile{
    outline:1px dashed rgba(0,40,85,.6);
    cursor:move;
    z-index:9999;
  }
  .dragging{
    opacity:.7;
  }

  #sideDisplay{
    display:flex;
    flex-direction:column;
    gap:16px;
    min-width:140px;
  }

  .tooltipBubble{
    position:fixed;
    z-index:9999;
    min-width:180px;
    max-width:240px;
    background:rgba(15,23,42,.95);
    color:#fff;
    font-size:12px;
    line-height:1.35;
    border-radius:8px;
    box-shadow:0 20px 40px rgb(0 0 0 / .6);
    padding:8px 10px;
    pointer-events:none;
    border:1px solid rgba(255,255,255,.2);
  }
  .tooltipBubble strong{
    font-size:12px;
    font-weight:600;
    color:#fff;
    display:block;
    margin-bottom:4px;
  }
  .tooltipBubble em{
    color:#94a3b8;
    font-style:normal;
    font-size:11px;
  }

  #layoutShell.sidebar-open #controls{
    width:340px;
    max-width:340px;
    min-width:260px;
    box-shadow:0 0 20px rgb(0 0 0 / .07);
    border-right:1px solid var(--line);
  }

  #layoutShell.sidebar-collapsed #controls{
    width:0;
    min-width:0;
    max-width:0;
    border-right:0;
    box-shadow:none;
    overflow:hidden;
  }

  #pageFooter{
    text-align:center;
    font-size:11px;
    color:var(--muted);
    background:var(--panel);
    border-top:1px solid var(--line);
    padding:8px 0;
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    z-index:5;
  }

  /* Gallery UI (Ribbons/Badges/Patches) */
  .galleryGrid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:10px;
    margin-top:8px;
  }
  .galleryTile{
    border:1px solid var(--line);
    border-radius:10px;
    background:#fff;
    padding:8px;
    display:flex;
    gap:10px;
    align-items:flex-start;
  }
  .galleryTile img{
    width:72px;
    height:auto;
    border-radius:6px;
    border:1px solid rgba(0,0,0,.08);
    background:#f8fafc;
  }
  .galleryTile .title{
    font-size:12px;
    font-weight:700;
    line-height:1.2;
  }
  .galleryTile .sub{
    font-size:11px;
    color:var(--muted);
    line-height:1.25;
    margin-top:2px;
  }
  .galleryTile .miniRow{
    display:flex;
    gap:8px;
    align-items:center;
    margin-top:6px;
    flex-wrap:wrap;
  }
  .galleryTile .miniRow label{
    font-size:11px;
    color:var(--muted);
    display:flex;
    align-items:center;
    gap:6px;
  }
  .galleryTile .miniRow input[type="number"]{
    width:70px;
    margin-top:0;
    padding:6px;
    border-radius:8px;
    font-size:12px;
  }
  .galleryTile input[type="checkbox"]{
    width:auto;
    margin:0;
  }

  /* === NEW: hide galleries in LEFT SIDEBAR; only show in modal === */
  #controls .galleryGrid{
    display:none !important;
  }

  /* ===========================
     UNIVERSAL CALIBRATOR PANEL
     =========================== */
  #calibratorWrapper {
    position:fixed;
    top:80px;
    left:0;
    z-index:10001;
    display:flex;
    align-items:flex-start;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    color:var(--ink);
  }
  #calibratorTab {
    background:var(--brand);
    color:#fff;
    padding:8px 6px;
    font-size:12px;
    font-weight:600;
    border-top-right-radius:6px;
    border-bottom-right-radius:6px;
    cursor:pointer;
    user-select:none;
    line-height:1.2;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    box-shadow:2px 2px 6px rgb(0 0 0 / .2);
  }
  #calibratorTab span.arrow {
    font-size:16px;
    line-height:16px;
  }
  #calibratorPanel {
    background:var(--panel);
    border:1px solid var(--line);
    border-left:none;
    border-top-right-radius:8px;
    border-bottom-right-radius:8px;
    min-width:220px;
    padding:12px;
    box-shadow:2px 2px 10px rgb(0 0 0 / .25);
    display:none;
  }
  #calibratorPanel h3 {
    margin:0 0 8px 0;
    font-size:13px;
    font-weight:600;
    color:var(--ink);
  }
  .calib-row {
    font-size:12px;
    margin-bottom:10px;
    display:grid;
    grid-template-columns:1fr auto;
    align-items:center;
    column-gap:6px;
  }
  .calib-row label {
    display:block;
    font-weight:500;
    color:var(--muted);
    grid-column:1 / span 2;
    margin-bottom:4px;
  }
  .calib-row input[type="range"] {
    width:100%;
  }
  .calib-row .numField {
    width:60px;
    font-size:12px;
    padding:2px 4px;
    border:1px solid var(--line);
    border-radius:4px;
    text-align:center;
    background:#fff;
    color:var(--ink);
  }
  #calibReadout {
    font-size:11px;
    line-height:1.4;
    background:#f6f8fa;
    border:1px solid var(--line);
    border-radius:8px;
    padding:8px;
    white-space:normal;
  }
  #calibReadout code {
    font-family:ui-monospace,SFMono-Regular,Consolas,"Liberation Mono",monospace;
    font-size:11px;
    background:none;
    padding:0;
  }
  #calibratorPanel .btnRow{
    display:flex; gap:8px; margin-top:8px;
  }
  #calibratorPanel .btnRow button{
    width:auto; flex:1;
  }
  #calibKeyPill{
    display:inline-block;
    font-family:ui-monospace,SFMono-Regular,Consolas,"Liberation Mono",monospace;
    font-size:11px;
    background:#f1f5f9;
    border:1px solid var(--line);
    padding:3px 6px;
    border-radius:8px;
    color:var(--ink);
  }
  .calib-selectable{ cursor:crosshair; }
  .calib-selected{
    outline:2px solid rgba(0,40,85,.95) !important;
    box-shadow:0 0 0 3px rgba(0,40,85,.18) !important;
  }

  @media (max-width:768px){
    #layoutShell{
      flex-direction:column;
      height:auto;
      min-height:calc(100vh - 58px);
    }

    #controls{
      position:absolute;
      left:0;
      top:0;
      bottom:0;

      width:80%;
      max-width:80%;
      min-width:260px;

      box-shadow:0 30px 60px rgb(0 0 0 / .4);
      border-right:1px solid var(--line);
      background:var(--panel);
      transition:transform .2s ease;
    }

    #layoutShell.sidebar-open    #controls{ transform:translateX(0); }
    #layoutShell.sidebar-collapsed #controls{ transform:translateX(-100%); }

    #previewWrapper{
      order:2;
      flex:1;
    }
  }

  /* ===========================
     MODAL (POPUP GALLERY)
     =========================== */
  .modalOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.45);
    z-index:20000;
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
  }
  .modalOverlay.open{ display:flex; }

  .modal{
    width:min(1100px, 96vw);
    height:min(720px, 86vh);
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:14px;
    box-shadow:0 40px 90px rgb(0 0 0 / .45);
    overflow:hidden;
    resize:both; /* resizable by user */
    position:relative;
  }

  .modalHeader{
    background:var(--brand);
    color:#fff;
    padding:10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .modalHeader .title{
    font-size:13px;
    font-weight:700;
    letter-spacing:.2px;
    margin:0;
  }
  .modalHeader .actions{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .modalHeader .actions button{
    width:auto;
    padding:6px 10px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.35);
    background:rgba(255,255,255,.12);
    color:#fff;
    cursor:pointer;
  }

  .modalBody{
    height:calc(100% - 44px);
    overflow:auto;
    padding:12px;
  }

  .modal .galleryGrid{
    grid-template-columns:repeat(3,minmax(0,1fr));
  }
  @media (max-width:900px){
    .modal .galleryGrid{ grid-template-columns:repeat(2,minmax(0,1fr)); }
  }
  @media (max-width:560px){
    .modal .galleryGrid{ grid-template-columns:repeat(1,minmax(0,1fr)); }
  }

  .modal::after{
    content:"↘";
    position:absolute;
    right:10px;
    bottom:6px;
    font-size:14px;
    color:rgba(0,0,0,.35);
    pointer-events:none;
  }
</style>
</head>
<body>

<header>
  <h1>CAP Uniform Builder</h1>
</header>

<button id="hamburgerBtn" class="hamburgerBtn" aria-label="Menu">
  <span></span><span></span><span></span>
</button>

<!-- UNIVERSAL CALIBRATOR -->
<div id="calibratorWrapper">
  <div id="calibratorTab">
    <span>CAL</span>
    <span class="arrow" id="calibratorArrow">›</span>
  </div>

  <div id="calibratorPanel">
    <h3>Calibrator</h3>

    <div style="font-size:11px;color:var(--muted);line-height:1.35;margin-bottom:8px;">
      Turn on Calibrate Mode, then click any item on the uniform to edit its exact position/size.
    </div>

    <div class="calib-row">
      <label>Mode</label>
      <div class="row" style="gap:8px;">
        <button id="calibToggleMode" type="button" class="ghost" style="width:100%;">Calibrate Mode: OFF</button>
      </div>
    </div>

    <div class="calib-row">
      <label>Selected Key</label>
      <div id="calibKeyPill">none</div>
    </div>

    <div class="calib-row">
      <label for="calX">X (left px)</label>
      <input type="range" id="calX" min="-200" max="900" step="1">
      <input type="number" id="calXn" class="numField">
    </div>

    <div class="calib-row">
      <label for="calY">Y (top px)</label>
      <input type="range" id="calY" min="-200" max="1100" step="1">
      <input type="number" id="calYn" class="numField">
    </div>

    <div class="calib-row">
      <label for="calW">W (px)</label>
      <input type="range" id="calW" min="1" max="800" step="1">
      <input type="number" id="calWn" class="numField">
    </div>

    <div class="calib-row">
      <label for="calH">H (px)</label>
      <input type="range" id="calH" min="1" max="800" step="1">
      <input type="number" id="calHn" class="numField">
    </div>

    <div class="calib-row">
      <label for="calR">Rotation (deg)</label>
      <input type="range" id="calR" min="-180" max="180" step="1">
      <input type="number" id="calRn" class="numField">
    </div>

    <div class="btnRow">
      <button id="calibReset" class="ghost" type="button">Reset Selected</button>
      <button id="calibCopy" type="button">Copy JSON</button>
    </div>

    <div id="calibReadout" style="margin-top:10px;">
      <div><b>Tip:</b> Arrow keys nudge (Shift = 10px).</div>
      <div style="margin-top:6px;">JSON:</div>
      <code id="calibJson" style="display:block;white-space:pre-wrap;"></code>
    </div>
  </div>
</div>

<main id="layoutShell" class="sidebar-open">

  <aside id="controls">
    <div class="controlsHeader">
      <h2 class="controlsTitle">Uniform Builder Controls</h2>
    </div>

    <div class="controlsScrollArea">

      <section class="panelBlock">
        <label class="fieldLabel">Membership Type</label>
        <select id="membershipType">
          <option value="">Select Membership</option>
          <option value="senior">Senior Member</option>
          <option value="cadet">Cadet Member</option>
        </select>
        <div class="hintText">This controls which ranks are available and how the base uniform renders.</div>

        <label class="fieldLabel" style="margin-top:10px;">Rank</label>
        <select id="rankSetupSelect" disabled>
          <option value="">Select Rank</option>
        </select>
        <div class="hintText">For Senior Member NCO (SSgt–CMSgt), your NCO base images will be used as the jacket template (if present).</div>
      </section>

      <section id="genderBlock" class="panelBlock disabledBlock">
        <label class="fieldLabel">Gender / Cut</label>
        <select id="jacketSelect">
          <option value="">Select Gender</option>
          <option value="male">Male Cut</option>
          <option value="female">Female Cut</option>
        </select>
        <div class="hintText">This swaps which base jacket image we render.</div>
      </section>

      <section id="uniformBlock" class="panelBlock disabledBlock">
        <label class="fieldLabel">Uniform</label>
        <div id="uniformList" class="uniformList">

          <button class="uniformOption" data-uniform-id="blues_a" data-allowed-for="cadet,senior">
            <div class="uName">Blues: Class A</div>
            <div class="uDesc smallText">Service coat, ribbons</div>
          </button>

          <button class="uniformOption" data-uniform-id="blues_b" data-allowed-for="cadet,senior">
            <div class="uName">Blues: Class B</div>
            <div class="uDesc smallText">Shirt, ribbons</div>
          </button>

          <button class="uniformOption" data-uniform-id="mess_dress" data-allowed-for="senior">
            <div class="uName">Mess Dress</div>
            <div class="uDesc smallText">Mini medals / formal</div>
          </button>

          <button class="uniformOption" data-uniform-id="semi_formal" data-allowed-for="senior">
            <div class="uName">Semi-formal</div>
            <div class="uDesc smallText">Mini medals</div>
          </button>

          <button class="uniformOption" data-uniform-id="aviator" data-allowed-for="senior">
            <div class="uName">Aviator Shirt</div>
            <div class="uDesc smallText">Corporate white shirt</div>
          </button>

          <button class="uniformOption" data-uniform-id="aviator_blazer" data-allowed-for="senior">
            <div class="uName">Aviator + Blazer</div>
            <div class="uDesc smallText">Corporate coat style</div>
          </button>

          <button class="uniformOption" data-uniform-id="corporate_field" data-allowed-for="senior">
            <div class="uName">Corporate Field Uniform</div>
            <div class="uDesc smallText">Field / utility variant</div>
          </button>

          <button class="uniformOption" data-uniform-id="abu" data-allowed-for="cadet,senior">
            <div class="uName">ABU</div>
            <div class="uDesc smallText">Legacy camo / tapes</div>
          </button>

          <button class="uniformOption" data-uniform-id="ocp" data-allowed-for="cadet,senior">
            <div class="uName">OCP</div>
            <div class="uDesc smallText">Operational Camouflage Pattern</div>
          </button>

          <button class="uniformOption" data-uniform-id="flight_suit" data-allowed-for="cadet,senior">
            <div class="uName">Flight Suit</div>
            <div class="uDesc smallText">Flight / utility</div>
          </button>

          <button class="uniformOption" data-uniform-id="polo" data-allowed-for="senior">
            <div class="uName">Polo</div>
            <div class="uDesc smallText">Corporate polo / gray slacks</div>
          </button>
        </div>

        <div class="hintText">Grayed-out uniforms are not authorized for the selected membership type.</div>
      </section>

      <section class="panelBlock">
        <div class="row two">
          <div class="col">
            <label class="fieldLabel">Asset Base Path</label>
            <input id="assetBase" value="images" placeholder="images"/>
          </div>
          <div class="col">
            <label class="fieldLabel">&nbsp;</label>
            <button id="applyJacket" class="ghost">Apply Jacket</button>
          </div>
        </div>
        <div class="hintText">Change this if your image folder path changes.</div>
      </section>

      <!-- RIBBONS: PICKER BUTTON (NO SIDEBAR THUMBS) -->
      <section id="groupRibbons" class="panelBlock">
        <label class="fieldLabel">Ribbons / Mini Medals</label>

        <div class="hintText">
          Use “Choose Ribbons…” to pick ribbons and set devices in the popup.
        </div>

        <div class="row two" style="margin-top:6px">
          <div class="col"><button id="clearRibbons" class="ghost" type="button">Clear Ribbons</button></div>
          <div class="col"><button id="expandRibbons" type="button">Choose Ribbons…</button></div>
        </div>

        <!-- kept for modal plumbing, but hidden in sidebar via CSS -->
        <div id="ribbonGallery" class="galleryGrid"></div>

        <label style="font-size:12px;color:var(--muted);display:block;margin-top:8px;">
          <input type="checkbox" id="toggleMini">
          Show Mini Medals (override)
        </label>

        <label style="font-size:12px;color:var(--muted);display:block;margin-top:8px;">
          <input type="checkbox" id="autoMini" checked>
          Auto-convert ribbons → mini-medals on Mess/Semi-formal
        </label>

        <div id="deviceTool">
          <strong style="font-size:12px;">Ribbon Devices — Multi-Apply</strong>
          <div id="devicePicker"></div>
          <div class="row" style="margin-top:8px">
            <button id="deviceApplyModeBtn" type="button">Enable Apply Mode</button>
            <button id="deviceRemoveModeBtn" type="button" class="ghost">Enable Remove Mode</button>
            <button id="deviceClearSelectionBtn" type="button" class="ghost">Clear Selection</button>
          </div>
          <small style="color:#516079;display:block;margin-top:6px;font-size:11px;line-height:1.3;">
            Choose devices + quantities → Enable Apply Mode → click a ribbon to add them.
            Use Remove Mode to clear devices from a ribbon.
          </small>
        </div>

        <div class="row two" style="margin-top:10px">
          <div class="col"><button id="toggleRibbonDrag" class="ghost" type="button">Enable Drag Mode</button></div>
          <div class="col"><button id="logRibbonCoords" class="ghost" type="button">Log Ribbon Coords</button></div>
        </div>
      </section>

      <!-- BADGES: PICKER BUTTON (NO SIDEBAR THUMBS) -->
      <section class="panelBlock">
        <label class="fieldLabel">Badges</label>

        <div class="hintText">
          Use “Choose Badges…” to pick badges in the popup (grouped by category).
        </div>

        <div class="row two" style="margin-top:6px">
          <div class="col"><button id="clearBadges" class="ghost" type="button">Clear Badges</button></div>
          <div class="col"><button id="expandBadges" type="button">Choose Badges…</button></div>
        </div>

        <!-- kept for modal plumbing, but hidden in sidebar via CSS -->
        <div id="badgeGallery" class="galleryGrid"></div>

        <div class="hintText">
          Placement follows your CAPR 39-1 slot rules (OLP/OLPU/OLPA/ORP/ON/UN/LP/LRP).
        </div>
      </section>

      <!-- PATCHES: PICKER BUTTON (NO SIDEBAR THUMBS) -->
      <section id="groupPatches" class="panelBlock">
        <label class="fieldLabel">Patches</label>

        <div class="hintText">
          Use “Choose Patches…” to pick patches in the popup.
        </div>

        <div class="row two" style="margin-top:6px">
          <div class="col"><button id="clearPatches" class="ghost" type="button">Clear Patches</button></div>
          <div class="col"><button id="expandPatches" type="button">Choose Patches…</button></div>
        </div>

        <!-- kept for modal plumbing, but hidden in sidebar via CSS -->
        <div id="patchGallery" class="galleryGrid"></div>
      </section>

      <section class="panelBlock">
        <label class="fieldLabel">Rank Insignia & Output</label>
        <div class="row two">
          <div class="col"><select id="rankSelect"></select></div>
          <div class="col"><button id="addRank" type="button">Set Rank</button></div>
        </div>
        <div class="row two" style="margin-top:6px">
          <div class="col"><button id="addNameplate" class="ghost" type="button">Add Nameplate</button></div>
          <div class="col"><button id="downloadImage" type="button">Download PNG</button></div>
        </div>
        <div class="hintText">Download will export a high-res PNG of the uniform preview.</div>
      </section>

      <section class="panelBlock" style="text-align:center;font-size:10.5px;color:var(--muted);line-height:1.3;">
        <div id="sidebarCopyrightLine">
          © <span id="sidebarYear"></span> Civil Air Patrol Uniform Builder<br/>
          Developed by C/Maj. Guiseppe Doran
        </div>
      </section>
    </div>
  </aside>

  <section id="previewWrapper">
    <div id="previewArea">
      <div id="uniformCanvas"></div>
    </div>

    <div id="sideDisplay">
      <div id="epauletContainer"></div>
      <div id="coverContainer"></div>
    </div>
  </section>

  <div id="tooltip" class="tooltipBubble" style="display:none;"></div>

</main>

<div class="layer" id="assets" style="display:none"></div>

<footer id="pageFooter">
  © <span id="footerYear"></span> Civil Air Patrol Uniform Builder – Developed by C/Maj. Guiseppe Doran
</footer>

<!-- ===========================
     GALLERY MODAL
     =========================== -->
<div id="galleryModalOverlay" class="modalOverlay" aria-hidden="true">
  <div id="galleryModal" class="modal" role="dialog" aria-modal="true" aria-label="Gallery Popup">
    <div class="modalHeader">
      <div class="title" id="galleryModalTitle">Gallery</div>
      <div class="actions">
        <button id="galleryModalMaxBtn" type="button" title="Maximize">Max</button>
        <button id="galleryModalRestoreBtn" type="button" title="Restore" class="hidden">Restore</button>
        <button id="galleryModalCloseBtn" type="button" title="Close">Close</button>
      </div>
    </div>
    <div class="modalBody">
      <div id="galleryModalHost"></div>
    </div>
  </div>
</div>

<script>
/* ===========================
   GLOBAL STATE
   =========================== */
const State = {
  membership:'',
  gender:'',
  uniform:'blues_a',
  assetBase:'images',

  ribbons:[], // array of {id, devices:{}}
  badges:[],  // array of badge ids
  patches:[], // array of patch ids

  rank:null,

  deviceApplyMode:false,
  deviceRemoveMode:false,
  selectedDevices:{},
  ribbonDragMode:false,
  forceMini:false,

  ribbonSelections:{},
  ribbonGalleryExpanded:false,

  badgeSelections:{},
  badgeGalleryExpanded:false,

  patchSelections:{},
  patchGalleryExpanded:false,

  // UNIVERSAL calibration (per-layer key)
  calib:{
    enabled:false,
    selectedKey:null,
    map:{} // key -> {x,y,w,h,r}
  }
};

let currentDrag = null;
let dragOffsetX = 0;
let dragOffsetY = 0;

/* ===========================
   MEMBERSHIP/RANK DATA
   =========================== */
const RANKS = {
  senior: ["SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen"],
  cadet: ["C/AB","C/Amn","C/A1C","C/SrA","C/SSgt","C/TSgt","C/MSgt","C/SMSgt","C/CMSgt","C/2d Lt","C/1st Lt","C/Capt","C/Maj","C/Lt Col","C/Col"]
};

const SENIOR_NCO_RANKS = new Set(["SSgt","TSgt","MSgt","SMSgt","CMSgt"]);
const OFFICER_RANKS = new Set([
  "2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen",
  "C/2d Lt","C/1st Lt","C/Capt","C/Maj","C/Lt Col","C/Col"
]);

/* ===========================
   BASE PLACEMENT CONSTANTS
   =========================== */
let rackBaseX = 259; // LEFT EDGE of a 3-wide rack
let rackBaseY = 206; // TOP of bottom row

const RIBBON_WIDTH  = 23;
const RIBBON_HEIGHT = 7.2;
const RIBBON_GAP_X  = 0;
const RIBBON_GAP_Y  = 2;

function rackSpanW(){
  return (RIBBON_WIDTH*3) + (RIBBON_GAP_X*2);
}
function rackCenterX(){
  return rackBaseX + rackSpanW()/2;
}
function getRackOrigin(){
  return { x:rackBaseX, y:rackBaseY };
}

/* ===========================
   UNIVERSAL CALIBRATION SYSTEM
   =========================== */
function calibKeyFor(el){
  return el?.dataset?.calibKey || null;
}
function getCalib(key){
  if(!key) return null;
  return State.calib.map[key] || null;
}
function setCalib(key, patch){
  if(!key) return;
  const cur = State.calib.map[key] || {};
  State.calib.map[key] = { ...cur, ...patch };
}
function clearCalib(key){
  if(!key) return;
  delete State.calib.map[key];
}
function applyCalibToElement(el, key, base){
  const over = getCalib(key);
  const v = { ...base, ...(over||{}) };

  if(v.x !== undefined) el.style.left = `${v.x}px`;
  if(v.y !== undefined) el.style.top  = `${v.y}px`;
  if(v.w !== undefined) el.style.width  = `${v.w}px`;
  if(v.h !== undefined) el.style.height = `${v.h}px`;

  const rot = (v.r !== undefined) ? v.r : 0;
  el.style.transform = `rotate(${rot}deg)`;
  el.style.transformOrigin = 'center center';

  return v;
}
function buildCalibJson(key){
  const v = getCalib(key) || {};
  return JSON.stringify({ key, ...v }, null, 2);
}
function refreshCalibratorReadout(){
  const key = State.calib.selectedKey;
  const outJson = by('calibJson');
  if(!outJson) return;
  if(!key){ outJson.textContent=''; return; }
  outJson.textContent = buildCalibJson(key);
}
function nudgeSelected(dx,dy){
  const key = State.calib.selectedKey;
  if(!key) return;

  const xn = by('calXn');
  const yn = by('calYn');
  const xr = by('calX');
  const yr = by('calY');

  const x = parseInt(xn?.value||"0",10);
  const y = parseInt(yn?.value||"0",10);
  const nx = x + dx;
  const ny = y + dy;

  if(xn) xn.value = nx;
  if(yn) yn.value = ny;
  if(xr) xr.value = nx;
  if(yr) yr.value = ny;

  setCalib(key, { x:nx, y:ny });

  const el = uniformCanvas.querySelector(`.layer[data-calib-key="${CSS.escape(key)}"]`);
  if(el){
    el.style.left = nx+'px';
    el.style.top  = ny+'px';
  }
  refreshCalibratorReadout();
}

/* ===========================
   DOM SHORTCUTS
   =========================== */
const $ = s => document.querySelector(s);
const by = id => document.getElementById(id);

const layoutShell      = by('layoutShell');
const hamburgerBtn     = by('hamburgerBtn');
const uniformCanvas    = by('uniformCanvas');
const assetsContainer  = by('assets');
const uniformListEl    = by('uniformList');

const membershipTypeEl = by('membershipType');
const rankSetupSelect  = by('rankSetupSelect');
const jacketSelect     = by('jacketSelect');
const assetBaseInput   = by('assetBase');

const genderBlock      = by('genderBlock');
const uniformBlock     = by('uniformBlock');

/* ===========================
   YEAR AUTOFILL
   =========================== */
(function setYears(){
  const y = new Date().getFullYear();
  const sidebarYear = by('sidebarYear');
  const footerYear  = by('footerYear');
  if(sidebarYear) sidebarYear.textContent = y;
  if(footerYear)  footerYear.textContent  = y;
})();

/* ===========================
   ASSET PATH HELPER
   =========================== */
function ASSET(p){
  const b=(State.assetBase||'images').replace(/\/$/,'');
  return `${b}/${p}`;
}

/* ===========================
   UNIFORM DEFINITIONS
   =========================== */
function isFieldUniform(u){
  return u==='abu' || u==='ocp' || u==='flight_suit' || u==='corporate_field';
}

const UNIFORMS = {
  blues_a:{male:'base/jacket_male.png',         female:'base/jacket_female.png',         ribbons:true,  mini:false},
  blues_b:{male:'base/blues_class_b_male.png',  female:'base/blues_class_b_female.png',  ribbons:true,  mini:false},
  mess_dress:{male:'base/mess_dress_male.png',  female:'base/mess_dress_female.png',     ribbons:false, mini:true},
  semi_formal:{male:'base/semi_male.png',       female:'base/semi_female.png',           ribbons:false, mini:true},
  aviator:{male:'base/aviator_shirt_male.png',  female:'base/aviator_shirt_female.png',  ribbons:true,  mini:false},
  aviator_blazer:{male:'base/aviator_blazer_male.png',female:'base/aviator_blazer_female.png', ribbons:true,mini:false},
  corporate_field:{male:'base/corporate_field_male.png',female:'base/corporate_field_female.png', ribbons:true, mini:false},
  abu:{male:'base/ABU_male.png',                female:'base/ABU_female.png',            ribbons:false, mini:false},
  ocp:{male:'base/OCP_male.png',                female:'base/OCP_female.png',            ribbons:false, mini:false},
  flight_suit:{male:'base/flight_suit_male.png',female:'base/flight_suit_female.png',    ribbons:false, mini:false},
  polo:{male:'base/polo_male.png',              female:'base/polo_female.png',           ribbons:false, mini:false}
};

const UI_AUTHZ = {
  blues_a:{ showRibbons:true, showBadges:true,  showPatches:false },
  blues_b:{ showRibbons:true, showBadges:true,  showPatches:false },
  aviator:{ showRibbons:true, showBadges:true,  showPatches:false },
  aviator_blazer:{ showRibbons:true, showBadges:true, showPatches:false },
  corporate_field:{ showRibbons:true, showBadges:false, showPatches:true },
  mess_dress:{ showRibbons:false, showBadges:true,  showPatches:false },
  semi_formal:{ showRibbons:false, showBadges:true, showPatches:false },
  abu:{ showRibbons:false, showBadges:false, showPatches:true },
  ocp:{ showRibbons:false, showBadges:false, showPatches:true },
  flight_suit:{ showRibbons:false, showBadges:false, showPatches:true },
  polo:{ showRibbons:false, showBadges:false, showPatches:false }
};

/* ===========================
   SENIOR MEMBER NCO BASE IMAGES
   =========================== */
const SENIOR_NCO_BASE = {
  blues_a: {
    male: {
      "SSgt": "base/CAP_SM_SSgt_Class_A_Jacket.png",
      "TSgt": "base/CAP_SM_TSgt_Class_A_Jacket.png",
      "MSgt": "base/CAP_SM_MSgt_Class_A_Jacket.png",
      "SMSgt":"base/CAP_SM_SMSgt_Class_A_Jacket.png",
      "CMSgt":"base/CAP_SM_CMSgt_Class_A_Jacket.png"
    },
    female: {
      "SSgt": "base/CAP_SM_SSgt_Class_A_Jacket.png",
      "TSgt": "base/CAP_SM_TSgt_Class_A_Jacket.png",
      "MSgt": "base/CAP_SM_MSgt_Class_A_Jacket.png",
      "SMSgt":"base/CAP_SM_SMSgt_Class_A_Jacket.png",
      "CMSgt":"base/CAP_SM_CMSgt_Class_A_Jacket.png"
    }
  }
};

/* ===========================
   RIBBONS / DEVICES / MINI MEDALS
   =========================== */
const ribbonList = [
  'silver_medal_of_valor','bronze_medal_of_valor','distinguished_service_award','exceptional_service_award','meritorious_service_award','commander_commendation_award','cap_achievment_award','lifesaving_award','national_commander_unit_citation_award','unit_citation_award',

  'cap_gill_robb_wilson_ribbon',
  'cap_paul_e_garber_ribbon',
  'cap_grover_loening_aerospace_ribbon',
  'cap_leadership_ribbon',
  'cap_membership_ribbon',
  'cap_command_service_ribbon',
  'cap_counterdrug_ribbon',
  'cap_world_war_2_service_ribbon',
  'cap_senior_recruiter_ribbon',
  'cap_bridgadier_general_charles_yaeger_ribbon',
  'cap_a_scott_crossfield_ribbon',

  'spaatz_award','eaker_award','earhart_award','mitchell_award','armstrong_achievement','goddard_achievement','doolittle_achievement','lindbergh_achievement','rickenbacker_achievement','wright_brothers_award','mary_feik_achievement','hap_arnold_achievement','curry_achievement',

  'afa_award','afsa_award','vfw_officer_award','vfw_nco_award','crisis_ribbon','red_service_ribbon','search_find_ribbon','air_search_and_rescue_ribbon','disaster_relief_ribbon','homeland_security_ribbon','community_service_ribbon','iace_ribbon','national_cadet_competition_ribbon','national_color_guard_competition_ribbon','cadet_advisory_council_ribbon','cadet_special_activity_ribbon','encampment_ribbon','cadet_recruiter_ribbon','cap_cadet_orientation_pilot_ribbon'
];

const precedence = id => ribbonList.indexOf(id);

/* Senior member: show only cadet milestone ribbons; and enforce only ONE milestone can be selected */
const CADET_ACHIEVEMENT_RIBBONS = new Set([
  'curry_achievement','hap_arnold_achievement','mary_feik_achievement','wright_brothers_award',
  'rickenbacker_achievement','lindbergh_achievement','doolittle_achievement','goddard_achievement',
  'armstrong_achievement','mitchell_award','earhart_award','eaker_award','spaatz_award'
]);
const CADET_MILESTONES = new Set([
  'wright_brothers_award','mitchell_award','earhart_award','eaker_award','spaatz_award'
]);

const deviceList = [
  '1_Bronze_Star_Device',
  '1_Silver_Star_Device'
];
const deviceMeta = {
  '1_Bronze_Star_Device': { label:'Bronze Star', src:'devices/1_Bronze_Star_Device.webp', w:10, h:10, weight:1 },
  '1_Silver_Star_Device': { label:'Silver Star', src:'devices/1_Silver_Star_Device.webp', w:10, h:10, weight:2 }
};

// device cap per ribbon (overflow creates additional ribbon instances)
const RIBBON_DEVICE_CAP = {
  '1_Silver_Star_Device': 4,
  '1_Bronze_Star_Device': 4
};

const miniMedalImages = {};
Object.assign(miniMedalImages, {
  'exceptional_service_award':      'medals/exceptional_service.png',
  'meritorious_service_award':      'medals/meritorious_service.png',
  'commander_commendation_award':   'medals/commanders_comendation.png',
  'cap_achievment_award':           'medals/achievement.png',
  'lifesaving_award':               'medals/crisis.png',
  'national_commander_unit_citation_award': 'medals/commanders_citation.png',
  'unit_citation_award':            'medals/unit_citation.png',
  'cap_gill_robb_wilson_ribbon':    'medals/gill_robb_wilson.png',
  'cap_paul_e_garber_ribbon':       'medals/paul_e_garber.png',
  'cap_grover_loening_aerospace_ribbon':'medals/grover_loening.png',
  'cap_leadership_ribbon':          'medals/leadership.png',
  'cap_membership_ribbon':          'medals/membership.png',
  'cap_command_service_ribbon':     'medals/command_service.png',
  'cap_counterdrug_ribbon':         'medals/counterdrug.png',
  'cap_world_war_2_service_ribbon': 'medals/world_war_2_service.png',
  'cap_senior_recruiter_ribbon':    'medals/recruiting.png',
  'cap_bridgadier_general_charles_yaeger_ribbon':'medals/charles_yaeger.png',
  'cap_a_scott_crossfield_ribbon':  'medals/a_scott_crossfield.png',
  'crisis_ribbon':                  'medals/crisis.png',
  'red_service_ribbon':             'medals/red_service.png',
  'search_find_ribbon':             'medals/find.png',
  'air_search_and_rescue_ribbon':   'medals/search_and_rescue.png',
  'disaster_relief_ribbon':         'medals/wartime_service.png',
  'homeland_security_ribbon':       'medals/wartime_service.png',
  'community_service_ribbon':       'medals/membership.png',
  'iace_ribbon':                    'medals/iace.png',
  'spaatz_award':                   'medals/carl_a_spaatz.png',
  'eaker_award':                    'medals/ira_c_eaker.png',
  'earhart_award':                  'medals/amelia_earhart.png',
  'mitchell_award':                 'medals/billy_mitchell.png',
  'armstrong_achievement':          'medals/aerospace_award.png',
  'goddard_achievement':            'medals/a_scott_crossfield.png',
  'doolittle_achievement':          'medals/aerospace_education.png',
  'lindbergh_achievement':          'medals/leadership.png',
  'rickenbacker_achievement':       'medals/proficency.png',
  'wright_brothers_award':          'medals/leadership.png',
  'mary_feik_achievement':          'medals/leadership.png',
  'hap_arnold_achievement':         'medals/leadership.png',
  'curry_achievement':              'medals/leadership.png',
  'national_cadet_competition_ribbon':      'medals/cadet_compeition.png',
  'national_color_guard_competition_ribbon':'medals/color_guard_competition.png',
  'cadet_advisory_council_ribbon':          'medals/command_service.png',
  'cadet_special_activity_ribbon':          'medals/aerospace_award.png',
  'encampment_ribbon':                      'medals/encampment.png',
  'cadet_recruiter_ribbon':                 'medals/recruiting.png',
  'cap_cadet_orientation_pilot_ribbon':     'medals/aerospace_award.png',
  'afa_award':                              'medals/aerospace_award.png',
  'afsa_award':                             'medals/paul_e_garber.png',
  'vfw_officer_award':                      'medals/wartime_service.png',
  'vfw_nco_award':                          'medals/wartime_service.png'
});

/* ===========================
   BADGES / PATCHES
   =========================== */
const badgeList = [
  'AirCrew1_DB3F0FCC3650F','BalloonPilot1_442D89C94185B','CAPMasterPilot1_621A0E2ED15DA','CAPPilot1_FA9D33EA587D8','CAPSeniorPilot1_D9725AE959752','GliderPilot1_7BFB287379918','MasterAirCrew1_72AC4CAE7A310','MasterObserver1_1B88D5071FD5C','SeniorAirCrew1_B289BAE6E515C','SeniorObserver1_0E35802A29801',
  'buddist_chaplin','christian_chaplin','communications_technician_badge','cyber_badges','emergency_services_badge','emt_basic_badge','emt_intermediate','emt_paramedic','ground_team_basic_badge','historian_technicianIbadge','information_technology_technician_badge','jewish_chaplin','legal_officer','master_ground_team_badge','medical_officer','model_rocketry_badge','muslim_chaplin','nra_marksman_badge','nurse_officer','observer_badge','pre_solo_badge','senior_ground_team_badge','solo_badge','stem_badges'
];

const allowedCadetBadges = new Set([
  'solo_badge','pre_solo_badge',
  'ground_team_basic_badge','senior_ground_team_badge','master_ground_team_badge',
  'emt_basic_badge','emt_intermediate','emt_paramedic',
  'model_rocketry_badge',
  'communications_technician_badge','information_technology_technician_badge',
  'cyber_badges','stem_badges',
  'nra_marksman_badge',
  'AirCrew1_DB3F0FCC3650F','BalloonPilot1_442D89C94185B','CAPMasterPilot1_621A0E2ED15DA','CAPPilot1_FA9D33EA587D8','CAPSeniorPilot1_D9725AE959752','GliderPilot1_7BFB287379918','MasterAirCrew1_72AC4CAE7A310',
  'SeniorAirCrew1_B289BAE6E515C','SeniorObserver1_0E35802A29801','MasterObserver1_1B88D5071FD5C',
  'observer_badge','emergency_services_badge','historian_technicianIbadge'
]);

const exclusiveBadges = [
  ['emt_basic_badge','ground_team_basic_badge'],
  ['emt_intermediate','senior_ground_team_badge'],
  ['emt_paramedic','master_ground_team_badge']
];

const badgeLocations = {
  'AirCrew1_DB3F0FCC3650F':'OLP','BalloonPilot1_442D89C94185B':'OLP','CAPMasterPilot1_621A0E2ED15DA':'OLP','CAPPilot1_FA9D33EA587D8':'OLP','CAPSeniorPilot1_D9725AE959752':'OLP','GliderPilot1_7BFB287379918':'OLP','MasterAirCrew1_72AC4CAE7A310':'OLP',
  'SeniorAirCrew1_B289BAE6E515C':'OLP','pre_solo_badge':'OLP','solo_badge':'OLP',
  'cyber_badges':'LP','stem_badges':'LP','communications_technician_badge':'LP','information_technology_technician_badge':'LP','MasterObserver1_1B88D5071FD5C':'LP','SeniorObserver1_0E35802A29801':'LP','observer_badge':'LP','historian_technicianIbadge':'LP','model_rocketry_badge':'LP',
  'nra_marksman_badge':'LRP',
  'ground_team_basic_badge':'OLPU','senior_ground_team_badge':'OLPU','master_ground_team_badge':'OLPU','emergency_services_badge':'OLPU','emt_basic_badge':'OLPU','emt_intermediate':'OLPU','emt_paramedic':'OLPU',
  'buddist_chaplin':'ORP','christian_chaplin':'ORP','jewish_chaplin':'ORP','legal_officer':'ORP','medical_officer':'ORP','nurse_officer':'ORP','muslim_chaplin':'ORP'
};

const customBadgeSizes = {
  'AirCrew1_DB3F0FCC3650F':{width:60,height:25},'BalloonPilot1_442D89C94185B':{width:60,height:25},'CAPMasterPilot1_621A0E2ED15DA':{width:60,height:25},'CAPPilot1_FA9D33EA587D8':{width:60,height:25},'CAPSeniorPilot1_D9725AE959752':{width:60,height:25},'GliderPilot1_7BFB287379918':{width:60,height:25},'MasterAirCrew1_72AC4CAE7A310':{width:60,height:25},'MasterObserver1_1B88D5071FD5C':{width:60,height:25},'SeniorAirCrew1_B289BAE6E515C':{width:60,height:25},'SeniorObserver1_0E35802A29801':{width:60,height:25},
  'buddist_chaplin':{width:60,height:60},'christian_chaplin':{width:60,height:60},'communications_technician_badge':{width:60,height:60},
  'cyber_badges':{width:60,height:25},'emergency_services_badge':{width:60,height:60},'emt_basic_badge':{width:60,height:60},
  'emt_intermediate':{width:60,height:60},'emt_paramedic':{width:60,height:60},'ground_team_basic_badge':{width:25,height:20},
  'historian_technicianIbadge':{width:60,height:60},'information_technology_technician_badge':{width:60,height:60},
  'jewish_chaplin':{width:60,height:60},'legal_officer':{width:60,height:25},'master_ground_team_badge':{width:25,height:20},
  'medical_officer':{width:60,height:60},'model_rocketry_badge':{width:7,height:28.125},'muslim_chaplin':{width:60,height:60},
  'nra_marksman_badge':{width:40,height:60},'nurse_officer':{width:60,height:60},'observer_badge':{width:60,height:25},
  'pre_solo_badge':{width:60,height:25},'senior_ground_team_badge':{width:25,height:20},'solo_badge':{width:60,height:25},'stem_badges':{width:60,height:25}
};

/* NEW: badge grouping for modal */
const BADGE_CATEGORIES = [
  { key:'Aviation', ids:[
    'CAPPilot1_FA9D33EA587D8','CAPSeniorPilot1_D9725AE959752','CAPMasterPilot1_621A0E2ED15DA',
    'AirCrew1_DB3F0FCC3650F','SeniorAirCrew1_B289BAE6E515C','MasterAirCrew1_72AC4CAE7A310',
    'observer_badge','SeniorObserver1_0E35802A29801','MasterObserver1_1B88D5071FD5C',
    'GliderPilot1_7BFB287379918','BalloonPilot1_442D89C94185B',
    'solo_badge','pre_solo_badge'
  ]},
  { key:'Emergency Services / Ground', ids:[
    'emergency_services_badge','ground_team_basic_badge','senior_ground_team_badge','master_ground_team_badge'
  ]},
  { key:'Medical / EMS', ids:[
    'emt_basic_badge','emt_intermediate','emt_paramedic','medical_officer','nurse_officer'
  ]},
  { key:'Comms / IT / Cyber / STEM', ids:[
    'communications_technician_badge','information_technology_technician_badge','cyber_badges','stem_badges'
  ]},
  { key:'Chaplain / Legal / Admin', ids:[
    'christian_chaplin','jewish_chaplin','muslim_chaplin','buddist_chaplin','legal_officer','historian_technicianIbadge'
  ]},
  { key:'Other', ids:[
    'model_rocketry_badge','nra_marksman_badge'
  ]}
];

const patchList = [
  'us_flag_patch','command_patch','wing_patch','unit_patch','aerospace_education_patch','communications_patch','orientation_pilot_patch'
];

const PATCH_META = {
  'us_flag_patch':{slotHint:'R_SHOULDER', w:60,h:40, img:'patches/us_flag_patch.png'},
  'command_patch':{slotHint:'L_SHOULDER', w:70,h:70, img:'patches/command_patch.png'},
  'wing_patch':{slotHint:'L_SHOULDER', w:60,h:60, img:'patches/wing_patch.png'},
  'unit_patch':{slotHint:'R_SHOULDER', w:60,h:60, img:'patches/unit_patch.png'},
  'aerospace_education_patch':{slotHint:'CHEST_LEFT', w:60,h:60, img:'patches/aerospace_education_patch.png'},
  'communications_patch':{slotHint:'CHEST_RIGHT', w:60,h:60, img:'patches/communications_patch.png'},
  'orientation_pilot_patch':{slotHint:'CHEST_LEFT', w:60,h:60, img:'patches/orientation_pilot_patch.png'}
};

const ALTERNATES = {
  badgeToPatch: { 'communications_technician_badge':'communications_patch' },
  patchToBadge: { 'communications_patch':'communications_technician_badge' },
  ribbonToPatch:{ 'cap_cadet_orientation_pilot_ribbon':'orientation_pilot_patch' },
  patchToRibbon:{ 'orientation_pilot_patch':'cap_cadet_orientation_pilot_ribbon' }
};

const rankListAll = [...RANKS.senior, ...RANKS.cadet];

/* ===========================
   POPULATE SELECTS & PRELOAD
   =========================== */
function optionize(sel,list, pretty=false){
  sel.innerHTML='';
  list.forEach(v=>{
    const o=document.createElement('option');
    o.value=v;
    o.textContent = pretty ? v : v.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    sel.appendChild(o);
  });
}

function preloadSimple(prefix,list,folder,ext=".png"){
  list.forEach(id=>{
    const img=document.createElement('img');
    img.id = `${prefix}-${id}`;
    img.src = ASSET(`${folder}/${id}${ext}`);
    img.style.display='none';
    img.loading='eager';
    img.decoding='sync';
    img.onerror=()=>{};
    assetsContainer.appendChild(img);
  });
}
function preloadWithResolver(prefix,list,resolver){
  list.forEach(id=>{
    const src = resolver(id);
    const img=document.createElement('img');
    img.id = `${prefix}-${id}`;
    img.src = ASSET(src);
    img.style.display='none';
    img.loading='eager';
    img.decoding='sync';
    img.onerror=()=>{};
    assetsContainer.appendChild(img);
  });
}

optionize(by('rankSelect'), rankListAll, true);

preloadSimple('ribbons', ribbonList, 'ribbons', '.png');
preloadWithResolver('devices', deviceList, id => deviceMeta[id].src);
preloadSimple('ranks', rankListAll, 'ranks', '.png');
preloadSimple('badges', badgeList, 'badges', '.png');
Object.entries(PATCH_META).forEach(([id,m])=>{
  const img=document.createElement('img');
  img.id=`patch-${id}`;
  img.src=ASSET(m.img);
  img.style.display='none';
  img.loading='eager';
  img.decoding='sync';
  img.onerror=()=>{};
  assetsContainer.appendChild(img);
});

/* ===========================
   SIDEBAR TOGGLE (HAMBURGER)
   =========================== */
layoutShell.classList.add('sidebar-open');
hamburgerBtn.addEventListener('click', ()=>{
  if(layoutShell.classList.contains('sidebar-open')){
    layoutShell.classList.remove('sidebar-open');
    layoutShell.classList.add('sidebar-collapsed');
  }else{
    layoutShell.classList.remove('sidebar-collapsed');
    layoutShell.classList.add('sidebar-open');
  }
});

/* ===========================
   TOOLTIP HOVER
   =========================== */
const tooltipEl = by('tooltip');
document.addEventListener('mouseover', e => {
  const t=e.target;
  if(t && t.dataset && t.dataset.tooltipTitle){
    const title=t.dataset.tooltipTitle||'';
    const reg  =t.dataset.tooltipReg||'';
    const why  =t.dataset.tooltipWhy||'';

    tooltipEl.innerHTML = `
      <strong>${title}</strong>
      ${reg ? `<div>${reg}</div>`:''}
      ${why ? `<div><em>${why}</em></div>`:''}
    `;
    tooltipEl.style.display='block';
  }
});
document.addEventListener('mousemove', e => {
  if(tooltipEl.style.display==='block'){
    tooltipEl.style.left = (e.clientX+14)+'px';
    tooltipEl.style.top  = (e.clientY+14)+'px';
  }
});
document.addEventListener('mouseout', e => {
  const t=e.target;
  if(t && t.dataset && t.dataset.tooltipTitle){
    tooltipEl.style.display='none';
  }
});

/* ===========================
   SETUP FLOW
   =========================== */
function updateSetupGates(){
  const readyMembership = !!State.membership;
  const readyRank       = !!State.rank;
  const readyGender     = !!State.gender;

  rankSetupSelect.disabled = !readyMembership;

  const enableUniformGender = readyMembership && readyRank;
  uniformBlock.classList.toggle('disabledBlock', !enableUniformGender);
  genderBlock.classList.toggle('disabledBlock', !enableUniformGender);

  if(readyMembership && readyRank && readyGender && State.uniform){
    fullRender();
    refreshUI();
  }
}
function populateRankSetup(){
  rankSetupSelect.innerHTML = `<option value="">Select Rank</option>`;
  if(!State.membership) return;
  RANKS[State.membership].forEach(r=>{
    const opt=document.createElement('option');
    opt.value=r;
    opt.textContent=r;
    rankSetupSelect.appendChild(opt);
  });
}

membershipTypeEl.addEventListener('change', ()=>{
  State.membership = membershipTypeEl.value || '';
  State.rank = null;

  State.gender = '';
  jacketSelect.value = '';

  populateRankSetup();
  rankSetupSelect.value = '';

  // filter badges if cadet
  if(State.membership==='cadet'){
    State.badges = State.badges.filter(isCadetAuthorized);
    Object.keys(State.badgeSelections).forEach(id=>{
      if(!isCadetAuthorized(id)) State.badgeSelections[id].checked=false;
    });
  }

  // rebuild ribbon gallery whenever membership changes
  buildRibbonGallery();

  if(State.membership && !isUniformAllowedFor(State.uniform, State.membership)){
    const fallback=findFirstAllowedUniform(State.membership) || 'blues_a';
    State.uniform=fallback;
  }

  updateSetupGates();
  applyMemberTypeToUniformOptions();
  highlightActiveUniformButton();

  fullRender();
  buildBadgeGallery();
});

rankSetupSelect.addEventListener('change', ()=>{
  State.rank = rankSetupSelect.value || null;
  by('rankSelect').value = State.rank || '';
  updateSetupGates();
  fullRender();
});

jacketSelect.addEventListener('change', ()=>{
  State.gender = jacketSelect.value || '';
  updateSetupGates();
  fullRender();
});

/* ===========================
   MEMBER TYPE / UNIFORM AUTHZ
   =========================== */
function isUniformAllowedFor(uniformId, membership){
  const btn = uniformListEl.querySelector(`.uniformOption[data-uniform-id="${uniformId}"]`);
  if(!btn) return false;
  const allowed=(btn.dataset.allowedFor||'').split(',').map(s=>s.trim());
  return membership ? allowed.includes(membership) : true;
}
function findFirstAllowedUniform(membership){
  const opts=[...uniformListEl.querySelectorAll('.uniformOption')];
  for(const opt of opts){
    const allowed=(opt.dataset.allowedFor||'').split(',').map(s=>s.trim());
    if(allowed.includes(membership)){
      return opt.dataset.uniformId;
    }
  }
  return null;
}
function applyMemberTypeToUniformOptions(){
  const opts=uniformListEl.querySelectorAll('.uniformOption');
  opts.forEach(opt=>{
    const allowed=(opt.dataset.allowedFor||'').split(',').map(s=>s.trim());
    const isAllowed = State.membership ? allowed.includes(State.membership) : true;

    if(isAllowed){
      opt.classList.remove('locked');
      opt.removeAttribute('data-locked-reason');
    }else{
      opt.classList.add('locked');
      opt.setAttribute('data-locked-reason', 'This Uniform Is Not Authorized For This Membership Type');
    }
  });
}
function highlightActiveUniformButton(){
  const opts=uniformListEl.querySelectorAll('.uniformOption');
  opts.forEach(opt=>{
    if(opt.dataset.uniformId===State.uniform){
      opt.style.outline=`2px solid var(--brand)`;
      opt.style.boxShadow=`0 0 0 3px rgba(0,40,85,.15)`;
      opt.style.background=`rgba(0,40,85,.05)`;
    }else{
      opt.style.outline='';
      opt.style.boxShadow='';
      opt.style.background='';
    }
  });
}

/* ===========================
   JACKET BASE RENDER (ROBUST)
   =========================== */
function clearLayers(cls){
  const sel = cls?`.layer.${cls}`:'.layer';
  uniformCanvas.querySelectorAll(sel).forEach(n=>n.remove());
}

function getBaseCandidates(){
  const u = State.uniform;
  const g = State.gender;
  const list = [];
  if(!u || !g) return list;

  // NCO special (try first)
  if(State.membership==='senior' && State.rank && SENIOR_NCO_RANKS.has(State.rank)){
    const ncoPath = SENIOR_NCO_BASE[u]?.[g]?.[State.rank];
    if(ncoPath) list.push(ncoPath);
  }

  // Default base
  const def = UNIFORMS[u]?.[g];
  if(def) list.push(def);

  return [...new Set(list)];
}

function applyJacket(){
  clearLayers('jacket');

  const candidates = getBaseCandidates();
  if(!candidates.length) return;

  function showJacketError(text){
    const msg = document.createElement('div');
    msg.className = 'layer jacket';
    msg.style.left = '12px';
    msg.style.top = '12px';
    msg.style.padding = '10px 12px';
    msg.style.borderRadius = '10px';
    msg.style.background = 'rgba(220, 38, 38, .10)';
    msg.style.border = '1px solid rgba(220, 38, 38, .35)';
    msg.style.color = '#991b1b';
    msg.style.fontSize = '12px';
    msg.style.maxWidth = '420px';
    msg.textContent = text;
    uniformCanvas.appendChild(msg);
  }

  let idx = 0;

  function tryNext(){
    if(idx >= candidates.length){
      showJacketError(`Jacket image failed to load. Verify filenames in "${State.assetBase}/base/". Check browser console for 404s.`);
      return;
    }

    const path = candidates[idx++];
    const img=document.createElement('img');
    img.className='layer jacket';
    img.src=ASSET(path);
    img.style.top='0px';
    img.style.left='0px';
    img.style.width='100%';
    img.style.height='100%';
    img.style.display='block';

    img.dataset.calibKey = 'jacket';
    // base for jacket: fill canvas; allow manual overrides if desired
    applyCalibToElement(img, img.dataset.calibKey, { x:0, y:0, w:450, h:600, r:0 });
    img.style.width = img.style.width || '100%';
    img.style.height = img.style.height || '100%';

    img.dataset.tooltipTitle = (State.uniform||'').replace(/_/g,' ').toUpperCase();
    img.dataset.tooltipReg   = "Base uniform image";
    img.dataset.tooltipWhy   = `Loaded: ${path}`;

    img.onerror = () => {
      console.warn('[JACKET LOAD FAIL]', img.src);
      img.remove();
      tryNext();
    };

    uniformCanvas.appendChild(img);
  }

  tryNext();
}

/* ===========================
   RIBBON / MEDAL RENDER LOGIC
   =========================== */
function sortRibbons(arr){
  return [...arr].sort((a,b)=>precedence(a.id)-precedence(b.id));
}
function getTopRibbonY(){
  const layers=[...uniformCanvas.querySelectorAll('.layer.ribbonTile,.layer.ribbonMini')];
  if(!layers.length) return rackBaseY;
  return Math.min(...layers.map(l=>parseFloat(l.style.top)||0));
}
function ensureRibbonObj(id){
  let r=State.ribbons.find(x=>x.id===id);
  if(!r){
    r={id,devices:{}};
    State.ribbons.push(r);
  }
  if(!r.devices) r.devices={};
  return r;
}

function drawDevicesOnRibbon(rid,leftPx,topPx,w,h){
  const r=State.ribbons.find(x=>x.id===rid && x.devices);
  if(!r) return;

  const flat=[];
  for(const [devId,count] of Object.entries(r.devices||{})){
    const meta=deviceMeta[devId];
    if(!meta) continue;
    for(let i=0;i<count;i++){ flat.push({id:devId,...meta}); }
  }
  if(!flat.length) return;

  flat.sort((a,b)=>(b.weight-a.weight)|| (a.label||a.id).localeCompare(b.label||b.id));
  const gap=3;
  const totalW=flat.reduce((s,d,i)=>s+d.w+(i>0?gap:0),0);
  let x=Math.round(leftPx+(w-totalW)/2);
  const y=Math.round(topPx+(h-10)/2)-1;

  flat.forEach((d,i)=>{
    const im=document.createElement('img');
    im.className='layer ribbonDevice';
    im.dataset.parentRid = rid;
    im.dataset.calibKey = `device:${rid}:${d.id}:${i}`;
    im.src=ASSET(d.src);
    im.alt=d.label||d.id;
    im.style.display='block';

    applyCalibToElement(im, im.dataset.calibKey, { x, y, w:d.w, h:d.h, r:0 });

    im.onerror=()=>{ im.remove(); };
    im.dataset.tooltipTitle = d.label||d.id;
    im.dataset.tooltipReg   = "Device on ribbon";
    im.dataset.tooltipWhy   = "Represents additional awards/credit per CAPR 39-3.";
    uniformCanvas.appendChild(im);
    x+=d.w+gap;
  });
}

function onRibbonTileClick(rid){
  if(State.ribbonDragMode) return;

  if(State.deviceRemoveMode){
    const r=ensureRibbonObj(rid);
    r.devices={};
    renderRack();
    return;
  }
  if(!State.deviceApplyMode) return;

  const r=ensureRibbonObj(rid);
  for(const [devId,qty] of Object.entries(State.selectedDevices)){
    r.devices[devId]=(r.devices[devId]||0)+qty;
  }
  renderRack();
}

function initRibbonDragHandlers(tileEl){
  tileEl.addEventListener('mousedown', e => {
    if(!State.ribbonDragMode) return;
    currentDrag = tileEl;
    currentDrag.classList.add('dragging');
    const startLeft = parseFloat(currentDrag.style.left) || 0;
    const startTop  = parseFloat(currentDrag.style.top)  || 0;
    dragOffsetX = e.clientX - startLeft;
    dragOffsetY = e.clientY - startTop;
    e.preventDefault();
  });
}
function syncDevicesToRibbon(ribbonTileEl){
  const rid = ribbonTileEl.dataset.rid;
  if(!rid) return;

  // do nothing if user calibrated devices independently
  // (devices have their own calib keys; we keep the old behavior for non-calibrated devices)
  const baseLeft = parseFloat(ribbonTileEl.style.left) || 0;
  const baseTop  = parseFloat(ribbonTileEl.style.top)  || 0;
  const w = parseFloat(ribbonTileEl.style.width)  || RIBBON_WIDTH;
  const h = parseFloat(ribbonTileEl.style.height) || RIBBON_HEIGHT;

  const r = State.ribbons.find(x => x.id===rid);
  if(!r || !r.devices) return;

  const flat=[];
  for(const [devId,count] of Object.entries(r.devices)){
    const meta=deviceMeta[devId];
    if(!meta) continue;
    for(let i=0;i<count;i++){ flat.push({id:devId,...meta}); }
  }
  flat.sort((a,b)=>(b.weight-a.weight)|| (a.label||a.id).localeCompare(b.label||b.id));

  const gap=3;
  const totalW=flat.reduce((s,d,i)=>s+d.w+(i>0?gap:0),0);
  let x=Math.round(baseLeft+(w-totalW)/2);
  const y=Math.round(baseTop+(h-10)/2)-1;

  const devEls=[...uniformCanvas.querySelectorAll('.ribbonDevice')].filter(el=>el.dataset.parentRid===rid);
  devEls.forEach((el,idx)=>{
    const dv=flat[idx];
    if(!dv) return;

    // only auto-move if NO explicit calib override exists
    const key = el.dataset.calibKey;
    const hasOverride = !!getCalib(key);
    if(!hasOverride){
      el.style.left = x+'px';
      el.style.top  = y+'px';
    }
    x+=dv.w+gap;
  });
}
document.addEventListener('mousemove', e => {
  if(!currentDrag || !State.ribbonDragMode) return;
  let newLeft = e.clientX - dragOffsetX;
  let newTop  = e.clientY - dragOffsetY;

  const box = uniformCanvas.getBoundingClientRect();
  const maxX = box.width  - (parseFloat(currentDrag.style.width)  || RIBBON_WIDTH);
  const maxY = box.height - (parseFloat(currentDrag.style.height) || RIBBON_HEIGHT);
  if(newLeft < 0) newLeft = 0;
  if(newTop  < 0) newTop  = 0;
  if(newLeft > maxX) newLeft = maxX;
  if(newTop  > maxY) newTop  = maxY;

  currentDrag.style.left = newLeft + 'px';
  currentDrag.style.top  = newTop  + 'px';

  syncDevicesToRibbon(currentDrag);
});
document.addEventListener('mouseup', () => {
  if(currentDrag){
    currentDrag.classList.remove('dragging');
    currentDrag = null;
  }
});

function renderRack(){
  [...uniformCanvas.querySelectorAll('.layer.ribbonTile,.layer.ribbonMini,.layer.ribbonDevice')].forEach(n=>n.remove());

  const baseCfg = UNIFORMS[State.uniform];
  if(!baseCfg) return;

  const uniformPrefersMini   = baseCfg.mini;
  const uniformAllowsRibbons = baseCfg.ribbons;
  const autoMini   = by('autoMini').checked;
  const manualMini = State.forceMini;
  const useMini = (uniformPrefersMini && autoMini) || manualMini;

  const items = sortRibbons(State.ribbons);
  if(!items.length) return;

  const BOTTOM_ROW_Y   = rackBaseY;
  const RACK_CENTER_X  = rackCenterX();

  function getRowLeftPositions(count){
    const totalWidth = count * RIBBON_WIDTH + (count-1)*RIBBON_GAP_X;
    const rowLeftBase = RACK_CENTER_X - totalWidth/2;
    const arr=[];
    for(let i=0;i<count;i++){
      arr.push(rowLeftBase + i*(RIBBON_WIDTH+RIBBON_GAP_X));
    }
    return arr;
  }

  if(!useMini && uniformAllowsRibbons){
    const lowestFirst = [...items].reverse();
    const rowsBottomFirst = [];
    for(let i=0;i<lowestFirst.length;i+=3){
      rowsBottomFirst.push(lowestFirst.slice(i,i+3));
    }
    const rowsTopFirst = [...rowsBottomFirst].reverse();
    const totalRows = rowsTopFirst.length;

    rowsTopFirst.forEach((row,topIndex)=>{
      const indexFromBottom = (totalRows - 1 - topIndex);
      const rowTopPx = BOTTOM_ROW_Y - indexFromBottom * (RIBBON_HEIGHT + RIBBON_GAP_Y);

      const rowSortedForDisplay = [...row].reverse();
      const leftPositions = getRowLeftPositions(rowSortedForDisplay.length);

      rowSortedForDisplay.forEach((ribbonObj,i)=>{
        const rid = ribbonObj.id;
        const orig=by(`ribbons-${rid}`);
        if(!orig) return;

        const tile=orig.cloneNode();
        tile.className='layer ribbonTile';
        tile.style.display='block';

        const leftPx = leftPositions[i];
        const topPx  = rowTopPx;

        tile.dataset.rid=rid;
        tile.dataset.calibKey = `ribbon:${rid}`;

        applyCalibToElement(tile, tile.dataset.calibKey, { x:leftPx, y:topPx, w:RIBBON_WIDTH, h:RIBBON_HEIGHT, r:0 });

        tile.style.pointerEvents='auto';
        tile.onclick=()=>onRibbonTileClick(rid);

        tile.dataset.tooltipTitle = rid.replace(/_/g,' ').toUpperCase();
        tile.dataset.tooltipReg   = "CAPR 39-3 precedence applies";
        tile.dataset.tooltipWhy   = "Highest awards sit top row, leftward.";

        initRibbonDragHandlers(tile);
        uniformCanvas.appendChild(tile);

        // devices use base left/top positions (pre-calibration) as reference; user can calibrate each device instance
        drawDevicesOnRibbon(rid,leftPx,topPx,RIBBON_WIDTH,RIBBON_HEIGHT);
      });
    });

    return;
  }

  // MINI MEDALS
  const MINI_W = 20;
  const MINI_H = 28;
  const MEDAL_PER_ROW = 5;
  const PAD = 6;

  const medalItems = [];
  for(const r of items){
    const medalPath = miniMedalImages[r.id];
    if(medalPath){
      medalItems.push({ id:r.id, path:medalPath });
    }
  }
  if(!medalItems.length) return;

  const lowestFirstMedals = [...medalItems].reverse();
  const medalRowsBottomFirst = [];
  for(let i=0;i<lowestFirstMedals.length;i+=MEDAL_PER_ROW){
    medalRowsBottomFirst.push(lowestFirstMedals.slice(i,i+MEDAL_PER_ROW));
  }
  const medalRowsTopFirst = [...medalRowsBottomFirst].reverse();
  const totalMedalRows = medalRowsTopFirst.length;

  const BOTTOM_ROW_Y_MEDALS = BOTTOM_ROW_Y + 20;

  function getMedalRowLeftPositions(count){
    const totalWidth = count * MINI_W + (count-1)*PAD;
    const rowLeftBase = RACK_CENTER_X - totalWidth/2;
    const arr=[];
    for(let i=0;i<count;i++){
      arr.push(rowLeftBase + i*(MINI_W+PAD));
    }
    return arr;
  }

  medalRowsTopFirst.forEach((row,topIndex)=>{
    const indexFromBottom = (totalMedalRows - 1 - topIndex);
    const rowTopPx = BOTTOM_ROW_Y_MEDALS - indexFromBottom * (MINI_H + PAD);

    const rowSortedForDisplay = [...row].reverse();
    const leftPositions = getMedalRowLeftPositions(rowSortedForDisplay.length);

    rowSortedForDisplay.forEach((entry,i)=>{
      const mimg=document.createElement('img');
      mimg.src=ASSET(entry.path);

      mimg.className='layer ribbonMini';
      mimg.style.display='block';

      const leftPx=leftPositions[i];
      const topPx =rowTopPx;

      mimg.dataset.calibKey = `mini:${entry.id}`;
      applyCalibToElement(mimg, mimg.dataset.calibKey, { x:leftPx, y:topPx, w:MINI_W, h:MINI_H, r:0 });

      mimg.onerror=()=>{};

      mimg.dataset.tooltipTitle = entry.id.replace(/_/g,' ').toUpperCase();
      mimg.dataset.tooltipReg   = "Miniature medal arrangement";
      mimg.dataset.tooltipWhy   = "Highest awards sit top row, centered.";

      uniformCanvas.appendChild(mimg);
    });
  });
}

/* ===========================
   DEVICE TOOL UI
   =========================== */
function buildDevicePicker(){
  const wrap=by('devicePicker');
  wrap.innerHTML='';
  deviceList.forEach(id=>{
    const row=document.createElement('label');
    row.style.cssText="display:flex;align-items:center;gap:8px;font-size:12px;";
    row.innerHTML=`
      <input type="checkbox" data-device="${id}"/>
      <span>${deviceMeta[id].label}</span>
      <input type="number" min="1" max="10" value="1" data-qty="${id}" style="width:70px;margin-left:auto">
    `;
    wrap.appendChild(row);
  });
}
function readDevicePicker(){
  const wrap=by('devicePicker');
  const bundle={};
  wrap.querySelectorAll('input[type="checkbox"][data-device]').forEach(chk=>{
    const id=chk.getAttribute('data-device');
    if(chk.checked){
      const qty=parseInt(wrap.querySelector(`input[type="number"][data-qty="${id}"]`).value||"1",10);
      if(qty>0) bundle[id]=qty;
    }
  });
  return bundle;
}
function wireDeviceUI(){
  const applyBtn = by('deviceApplyModeBtn');
  const removeBtn= by('deviceRemoveModeBtn');
  const clearBtn = by('deviceClearSelectionBtn');

  applyBtn.addEventListener('click', ()=>{
    State.selectedDevices = readDevicePicker();
    const hasAny = Object.keys(State.selectedDevices).length>0;
    State.deviceApplyMode = hasAny;
    State.deviceRemoveMode = false;
    applyBtn.textContent = State.deviceApplyMode ? 'Apply Mode: ON' : 'Enable Apply Mode';
    applyBtn.classList.toggle('ghost', !State.deviceApplyMode);
    removeBtn.classList.add('ghost');
    removeBtn.textContent='Enable Remove Mode';
  });

  removeBtn.addEventListener('click', ()=>{
    State.deviceRemoveMode = !State.deviceRemoveMode;
    State.deviceApplyMode = false;
    removeBtn.textContent = State.deviceRemoveMode ? 'Remove Mode: ON' : 'Enable Remove Mode';
    removeBtn.classList.toggle('ghost', !State.deviceRemoveMode);
    applyBtn.textContent='Enable Apply Mode';
    applyBtn.classList.add('ghost');
  });

  clearBtn.addEventListener('click', ()=>{
    by('devicePicker').querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false);
    by('devicePicker').querySelectorAll('input[type="number"]').forEach(n=>n.value=1);
    State.selectedDevices={};
    State.deviceApplyMode=false;
    State.deviceRemoveMode=false;
    applyBtn.textContent='Enable Apply Mode';
    removeBtn.textContent='Enable Remove Mode';
    applyBtn.classList.add('ghost');
    removeBtn.classList.add('ghost');
  });
}

/* ===========================
   RIBBONS: GALLERY LOGIC
   =========================== */
function normalizeRibbonSelections(){
  ribbonList.forEach(id=>{
    if(!State.ribbonSelections[id]){
      State.ribbonSelections[id] = { checked:false, devices:{} };
    }else{
      if(!State.ribbonSelections[id].devices) State.ribbonSelections[id].devices={};
    }
  });
}

function rebuildRibbonsFromGallery(){
  State.ribbons = [];
  normalizeRibbonSelections();

  for(const id of ribbonList){
    const sel = State.ribbonSelections[id];
    if(!sel || !sel.checked) continue;

    // compute stacks needed due to caps
    let stacks = 1;
    for(const [dev,count] of Object.entries(sel.devices||{})){
      const cap = RIBBON_DEVICE_CAP[dev] || 0;
      if(cap > 0) stacks = Math.max(stacks, Math.ceil((count||0)/cap));
    }

    for(let i=0;i<stacks;i++){
      const inst = { id, devices:{} };
      for(const [dev,count] of Object.entries(sel.devices||{})){
        const cap = RIBBON_DEVICE_CAP[dev] || 0;
        if(cap<=0) continue;
        const remain = (count||0) - i*cap;
        if(remain>0) inst.devices[dev] = Math.min(cap, remain);
      }
      State.ribbons.push(inst);
    }
  }

  renderRack();
  renderAllBadges();
}

function buildRibbonGallery(){
  const wrap = by('ribbonGallery');
  if(!wrap) return;

  normalizeRibbonSelections();
  wrap.innerHTML = '';

  // Senior filters out non-milestone cadet achievements
  let eligible = [...ribbonList];
  if(State.membership === 'senior'){
    eligible = eligible.filter(id=>{
      if(CADET_ACHIEVEMENT_RIBBONS.has(id)) return CADET_MILESTONES.has(id);
      return true;
    });
  }

  const showCount = State.ribbonGalleryExpanded ? eligible.length : Math.min(12, eligible.length);

  for(let idx=0; idx<showCount; idx++){
    const id = eligible[idx];
    const sel = State.ribbonSelections[id];

    const tile = document.createElement('div');
    tile.className = 'galleryTile';

    const title = id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    tile.innerHTML = `
      <img src="${ASSET(`ribbons/${id}.png`)}" alt="${title}">
      <div style="flex:1;min-width:0;">
        <div class="title">${title}</div>
        <div class="sub">(${id})</div>
        <div class="miniRow">
          <label><input type="checkbox" class="rbChk"> Add</label>
        </div>
        <div class="miniRow">
          <label>Silver <input type="number" class="rbSilver" min="0" value="${sel.devices['1_Silver_Star_Device']||0}"></label>
          <label>Bronze <input type="number" class="rbBronze" min="0" value="${sel.devices['1_Bronze_Star_Device']||0}"></label>
        </div>
        <div class="sub">Device cap: 4 per ribbon (extra copies auto-created)</div>
      </div>
    `;

    const chk = tile.querySelector('.rbChk');
    const silver = tile.querySelector('.rbSilver');
    const bronze = tile.querySelector('.rbBronze');

    chk.checked = !!sel.checked;

    chk.onchange = ()=>{
      sel.checked = chk.checked;

      // Senior -> only ONE milestone ribbon can be selected at a time
      if(State.membership === 'senior' && CADET_MILESTONES.has(id) && sel.checked){
        for(const otherId of Object.keys(State.ribbonSelections)){
          if(otherId !== id && CADET_MILESTONES.has(otherId)){
            State.ribbonSelections[otherId].checked = false;
          }
        }
      }

      rebuildRibbonsFromGallery();
    };

    function bumpOnNumber(){
      sel.devices['1_Silver_Star_Device'] = Math.max(0, parseInt(silver.value||"0",10)||0);
      sel.devices['1_Bronze_Star_Device'] = Math.max(0, parseInt(bronze.value||"0",10)||0);
      sel.checked = true;
      chk.checked = true;

      // Senior -> only ONE milestone ribbon can be selected at a time
      if(State.membership === 'senior' && CADET_MILESTONES.has(id)){
        for(const otherId of Object.keys(State.ribbonSelections)){
          if(otherId !== id && CADET_MILESTONES.has(otherId)){
            State.ribbonSelections[otherId].checked = false;
          }
        }
      }

      rebuildRibbonsFromGallery();
    }
    silver.oninput = bumpOnNumber;
    bronze.oninput = bumpOnNumber;

    wrap.appendChild(tile);
  }
}

/* ===========================
   BADGES: GALLERY LOGIC
   =========================== */
function isCadetAuthorized(id){ return allowedCadetBadges.has(id); }

function normalizeBadgeSelections(){
  badgeList.forEach(id=>{
    if(!State.badgeSelections[id]){
      State.badgeSelections[id] = { checked:false };
    }
    if(State.membership==='cadet' && !isCadetAuthorized(id)){
      State.badgeSelections[id].checked=false;
    }
  });
}

function enforceExclusive(newId){
  exclusiveBadges.forEach(pair=>{
    if(pair.includes(newId)){
      pair.forEach(conf=>{
        if(conf!==newId){
          State.badges = State.badges.filter(b=>b!==conf);
          if(State.badgeSelections[conf]) State.badgeSelections[conf].checked=false;
        }
      });
    }
  });
}

function rebuildBadgesFromGallery(){
  State.badges = [];
  normalizeBadgeSelections();

  for(const id of badgeList){
    if(State.membership==='cadet' && !isCadetAuthorized(id)) continue;
    if(State.badgeSelections[id]?.checked){
      enforceExclusive(id);
      if(!State.badges.includes(id)) State.badges.push(id);
    }
  }

  renderAllBadges();
}

function buildBadgeGallery(){
  const wrap = by('badgeGallery');
  if(!wrap) return;

  normalizeBadgeSelections();
  wrap.innerHTML = '';

  const eligible = (State.membership==='cadet')
    ? badgeList.filter(isCadetAuthorized)
    : [...badgeList];

  const showCount = State.badgeGalleryExpanded ? eligible.length : Math.min(12, eligible.length);

  for(let idx=0; idx<showCount; idx++){
    const id = eligible[idx];
    const sel = State.badgeSelections[id] || {checked:false};

    const tile = document.createElement('div');
    tile.className = 'galleryTile';

    const title = id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    tile.innerHTML = `
      <img src="${ASSET(`badges/${id}.png`)}" alt="${title}">
      <div style="flex:1;min-width:0;">
        <div class="title">${title}</div>
        <div class="sub">(${id})</div>
        <div class="miniRow">
          <label><input type="checkbox" class="bdChk"> Add</label>
        </div>
        <div class="sub">Slot: <b>${badgeLocations[id] || 'UN'}</b> • Size: ${(customBadgeSizes[id]?.width||60)}×${(customBadgeSizes[id]?.height||25)} px</div>
      </div>
    `;

    const chk = tile.querySelector('.bdChk');
    chk.checked = !!sel.checked;

    chk.onchange = ()=>{
      sel.checked = chk.checked;
      State.badgeSelections[id] = sel;
      rebuildBadgesFromGallery();
    };

    wrap.appendChild(tile);
  }
}

/* ===========================
   PATCHES: GALLERY LOGIC
   =========================== */
function normalizePatchSelections(){
  patchList.forEach(id=>{
    if(!State.patchSelections[id]){
      State.patchSelections[id] = { checked:false };
    }
  });
}

function rebuildPatchesFromGallery(){
  State.patches = [];
  normalizePatchSelections();

  for(const id of patchList){
    if(State.patchSelections[id]?.checked){
      if(!State.patches.includes(id)) State.patches.push(id);
    }
  }
  renderPatches();
}

function buildPatchGallery(){
  const wrap = by('patchGallery');
  if(!wrap) return;

  normalizePatchSelections();
  wrap.innerHTML='';

  const showCount = State.patchGalleryExpanded ? patchList.length : Math.min(10, patchList.length);

  for(let idx=0; idx<showCount; idx++){
    const id = patchList[idx];
    const meta = PATCH_META[id];
    const sel = State.patchSelections[id];

    const tile = document.createElement('div');
    tile.className='galleryTile';

    const title = id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    tile.innerHTML=`
      <img src="${ASSET(meta.img)}" alt="${title}">
      <div style="flex:1;min-width:0;">
        <div class="title">${title}</div>
        <div class="sub">(${id})</div>
        <div class="miniRow">
          <label><input type="checkbox" class="ptChk"> Add</label>
        </div>
        <div class="sub">Slot hint: <b>${meta.slotHint}</b> • Size: ${meta.w}×${meta.h} px</div>
      </div>
    `;

    const chk = tile.querySelector('.ptChk');
    chk.checked = !!sel.checked;

    chk.onchange=()=>{
      sel.checked = chk.checked;
      rebuildPatchesFromGallery();
    };

    wrap.appendChild(tile);
  }
}

/* ===========================
   BADGES (RENDER)
   =========================== */
const badgeSlots = { OLPA:[], OLPU:[], OLP:[], ORP:[], ON:[], UN:[], LRP:[], LP:[], OVERSTACK:[] };
function resetBadgeSlots(){ Object.keys(badgeSlots).forEach(k=>badgeSlots[k]=[]); }

function renderAllBadges(){
  [...uniformCanvas.querySelectorAll('.layer.badge')].forEach(n=>n.remove());
  resetBadgeSlots();
  if(!UI_AUTHZ[State.uniform]?.showBadges) return;

  const maxTotal=5;
  const applied=[];
  for(const id of State.badges){
    if(State.membership==='cadet' && !isCadetAuthorized(id)){ continue; }
    if(applied.length>=maxTotal) break;
    placeBadgeByCategory(id);
    applied.push(id);
  }
}

function placeBadgeByCategory(id){
  const img=by(`badges-${id}`);
  if(!img) return;

  let slot = badgeLocations[id] || 'UN';
  if(id==='nra_marksman_badge') slot='LRP';
  if(id==='model_rocketry_badge') slot='LP';

  const size = customBadgeSizes[id] || { width:60, height:25 };
  const spacing = 5;

  const baseRibbonY = getTopRibbonY();
  const RACK_CENTER_X = rackCenterX();

  const overRibbonSlots = new Set(['OLP','OLPU','OLPA','ORP']);

  if(overRibbonSlots.has(slot)){
    const stackIdx = badgeSlots.OVERSTACK.length;
    const bottomEdgeY = baseRibbonY - 25 - (stackIdx * (size.height + spacing));
    const topY = bottomEdgeY - size.height;
    const leftX = RACK_CENTER_X - (size.width / 2);

    const clone = img.cloneNode();
    clone.className='layer badge';
    clone.style.display='block';

    clone.dataset.calibKey = `badge:${id}`;
    applyCalibToElement(clone, clone.dataset.calibKey, { x:leftX, y:topY, w:size.width, h:size.height, r:0 });

    clone.dataset.tooltipTitle = id.replace(/_/g,' ').toUpperCase();
    clone.dataset.tooltipReg   = "Over-rack qualification badge";
    clone.dataset.tooltipWhy   = "Centered above ribbon rack per spec.";

    uniformCanvas.appendChild(clone);
    badgeSlots.OVERSTACK.push(id);
    return;
  }

  const single = new Set(['LRP','LP']);
  if(single.has(slot) && badgeSlots[slot] && badgeSlots[slot].length>=1){
    return;
  }

  if(!badgeSlots[slot]) badgeSlots[slot] = [];

  const yMap={
    ON:  baseRibbonY + 140,
    UN:  baseRibbonY + 180,
    LRP: baseRibbonY + 199,
    LP:  baseRibbonY + 244
  };
  const xMap={
    ON:  rackBaseX - 105,
    UN:  rackBaseX - 105,
    LRP: rackBaseX + rackSpanW() + 60,
    LP:  rackBaseX + rackSpanW() + 80
  };

  let y = yMap[slot] !== undefined ? yMap[slot] : (baseRibbonY+180);
  let x = xMap[slot] !== undefined ? xMap[slot] : (rackBaseX-105);

  if(slot==='ON'||slot==='UN'){
    const stackIdx = badgeSlots[slot].length;
    for(let i=0;i<stackIdx;i++){
      const prev=badgeSlots[slot][i];
      const ps=customBadgeSizes[prev]||{height:25};
      y+=ps.height+spacing;
    }
  }

  if(id==='model_rocketry_badge' && State.badges.includes('nra_marksman_badge')){
    y+=50;
  }

  const clone=img.cloneNode();
  clone.className='layer badge';
  clone.style.display='block';

  clone.dataset.calibKey = `badge:${id}`;
  applyCalibToElement(clone, clone.dataset.calibKey, { x, y, w:size.width, h:size.height, r:0 });

  clone.dataset.tooltipTitle = id.replace(/_/g,' ').toUpperCase();
  clone.dataset.tooltipReg   = "CAPR 39-1 badge placement";
  clone.dataset.tooltipWhy   = "Auto-placed relative to pockets / nameplate.";

  uniformCanvas.appendChild(clone);
  badgeSlots[slot].push(id);
}

/* ===========================
   PATCHES (RENDER)
   =========================== */
const patchSlots = { L_SHOULDER:[], R_SHOULDER:[], CHEST_LEFT:[], CHEST_RIGHT:[] };
function resetPatchSlots(){ Object.keys(patchSlots).forEach(k=>patchSlots[k]=[]); }

function planPatches(ids){
  resetPatchSlots();
  const capsPerUniform = {
    blues_a:{L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:1,CHEST_RIGHT:1},
    blues_b:{L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:1,CHEST_RIGHT:1},
    aviator:{L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:1,CHEST_RIGHT:1},
    aviator_blazer:{L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:0,CHEST_RIGHT:0},
    corporate_field:{L_SHOULDER:2,R_SHOULDER:2,CHEST_LEFT:1,CHEST_RIGHT:1},
    abu:{L_SHOULDER:2,R_SHOULDER:2,CHEST_LEFT:1,CHEST_RIGHT:1},
    ocp:{L_SHOULDER:2,R_SHOULDER:2,CHEST_LEFT:1,CHEST_RIGHT:1},
    flight_suit:{L_SHOULDER:2,R_SHOULDER:2,CHEST_LEFT:2,CHEST_RIGHT:2},
    semi_formal:{L_SHOULDER:0,R_SHOULDER:0,CHEST_LEFT:0,CHEST_RIGHT:0},
    mess_dress:{L_SHOULDER:0,R_SHOULDER:0,CHEST_LEFT:0,CHEST_RIGHT:0},
    polo:{L_SHOULDER:0,R_SHOULDER:0,CHEST_LEFT:0,CHEST_RIGHT:0}
  }[State.uniform] || {L_SHOULDER:1,R_SHOULDER:1,CHEST_LEFT:1,CHEST_RIGHT:1};

  for(const id of ids){
    const meta=PATCH_META[id]; if(!meta) continue;
    const hint=meta.slotHint || 'L_SHOULDER';
    const cap=capsPerUniform[hint]??0;
    if(cap===0) continue;
    if(patchSlots[hint].length>=cap) continue;
    patchSlots[hint].push(id);
  }
}

function renderPatches(){
  [...uniformCanvas.querySelectorAll('.layer.patch')].forEach(n=>n.remove());
  if(!UI_AUTHZ[State.uniform]?.showPatches) return;

  planPatches(State.patches);

  const box = uniformCanvas.getBoundingClientRect();
  const W = box.width || 450;
  const H = box.height || 600;

  const coords={
    L_SHOULDER:{x:W*0.27,y:H*0.35,dy:80},
    R_SHOULDER:{x:W*0.73,y:H*0.35,dy:80},
    CHEST_LEFT:{x:W*0.40,y:H*0.60,dy:70},
    CHEST_RIGHT:{x:W*0.60,y:H*0.60,dy:70}
  };

  for(const slot of Object.keys(patchSlots)){
    const ids=patchSlots[slot];
    let {x,y,dy}=coords[slot]||{x:0,y:0,dy:70};
    for(const id of ids){
      const meta=PATCH_META[id];
      const src = by('patch-'+id);
      const el  = (src?src.cloneNode():new Image());
      if(!src){ el.src=ASSET(meta.img); }

      el.className='layer patch';
      el.style.display='block';

      const baseX = (x - meta.w/2);
      const baseY = (y - meta.h/2);

      el.dataset.calibKey = `patch:${id}`;
      applyCalibToElement(el, el.dataset.calibKey, { x:baseX, y:baseY, w:meta.w, h:meta.h, r:0 });

      el.onerror=()=>{};

      el.dataset.tooltipTitle = id.replace(/_/g,' ').toUpperCase();
      el.dataset.tooltipReg   = "Field/utility patch placement";
      el.dataset.tooltipWhy   = "Displayed on sleeve/chest per field uniform rules.";

      uniformCanvas.appendChild(el);
      y+=dy;
    }
  }
}

/* ===========================
   RANK / NAMEPLATE
   =========================== */
function renderRank(id){
  [...uniformCanvas.querySelectorAll('.layer.rank')].forEach(n=>n.remove());
  if(!id) return;

  if(State.membership==='senior' && SENIOR_NCO_RANKS.has(id)){
    return;
  }

  const insigniaEl = by('ranks-'+id);
  if(!insigniaEl) return;

  const isOfficer = OFFICER_RANKS.has(id);

  if(isOfficer){
    const boardSrc=ASSET('ranks/C/shoulder_board.png');
    const boardCfg={width:50,height:100};
    const insigniaCfg={width:32,height:32};
    const placements=[
      {left:350,top:160,rot:90, side:'R'},
      {left:100,top:160,rot:-90, side:'L'}
    ];
    placements.forEach(({left,top,rot,side})=>{
      const board=document.createElement('img');
      board.src=boardSrc;
      board.className='layer rank';
      board.style.display='block';
      board.onerror=()=>{ board.remove(); };

      board.dataset.calibKey = `rankboard:${id}:${side}`;
      applyCalibToElement(board, board.dataset.calibKey, { x:left, y:top, w:boardCfg.width, h:boardCfg.height, r:rot });

      uniformCanvas.appendChild(board);

      const ins=insigniaEl.cloneNode();
      ins.className='layer rank';
      ins.style.display='block';
      ins.onerror=()=>{ ins.remove(); };

      const ix = left + (boardCfg.width/2 - insigniaCfg.width/2);
      const iy = top  + (boardCfg.height/2 - insigniaCfg.height/2);

      ins.dataset.calibKey = `rank:${id}:${side}`;
      applyCalibToElement(ins, ins.dataset.calibKey, { x:ix, y:iy, w:insigniaCfg.width, h:insigniaCfg.height, r:rot });

      uniformCanvas.appendChild(ins);
    });
    return;
  }

  const size={w:60,h:60};
  const pos ={left:420,top:200};
  const icon=insigniaEl.cloneNode();
  icon.className='layer rank';
  icon.style.display='block';
  icon.onerror=()=>{ icon.remove(); };

  icon.dataset.calibKey = `rank:${id}`;
  applyCalibToElement(icon, icon.dataset.calibKey, { x:pos.left, y:pos.top, w:size.w, h:size.h, r:0 });

  uniformCanvas.appendChild(icon);
}

function renderNameplate(){
  [...uniformCanvas.querySelectorAll('.layer.nameplate')].forEach(n=>n.remove());
  const baseRibbonY=getTopRibbonY();
  const npTop  = baseRibbonY + 150;
  const npLeft = rackBaseX - 120;

  const el=document.createElement('img');
  el.src=ASSET('nameplate/nameplate.png');
  el.className='layer nameplate';
  el.style.display='block';
  el.onerror=()=>{ el.remove(); };

  el.dataset.calibKey = 'nameplate';
  applyCalibToElement(el, el.dataset.calibKey, { x:npLeft, y:npTop, w:100, h:20, r:0 });

  uniformCanvas.appendChild(el);
}

/* ===========================
   AVAILABILITY / ALTERNATES
   =========================== */
function updateAvailabilityUI(prevUniform){
  const auth = UI_AUTHZ[State.uniform] || {showRibbons:true,showPatches:true,showBadges:true};
  by('groupRibbons').classList.toggle('hidden', !auth.showRibbons && !UNIFORMS[State.uniform].mini);
  by('groupPatches').classList.toggle('hidden', !auth.showPatches);

  if(prevUniform && prevUniform!==State.uniform){
    applyAlternates(prevUniform, State.uniform);
  }
}

function applyAlternates(fromU,toU){
  const fromField=isFieldUniform(fromU);
  const toField  =isFieldUniform(toU);

  if(!fromField && toField){
    Object.entries(ALTERNATES.badgeToPatch).forEach(([badge,patch])=>{
      if(State.badges.includes(badge)){
        State.patchSelections[patch] = {checked:true};
      }
    });
    Object.entries(ALTERNATES.ribbonToPatch).forEach(([ribbon,patch])=>{
      if(State.ribbons.find(r=>r.id===ribbon)){
        State.patchSelections[patch] = {checked:true};
      }
    });

    State.badges = [];
    State.ribbons = [];

    Object.keys(State.badgeSelections).forEach(k=>State.badgeSelections[k].checked=false);
    Object.keys(State.ribbonSelections).forEach(k=>State.ribbonSelections[k].checked=false);

    rebuildPatchesFromGallery();
  } else if(fromField && !toField){
    Object.entries(ALTERNATES.patchToBadge).forEach(([patch,badge])=>{
      if(State.patches.includes(patch) && badge){
        State.badgeSelections[badge] = {checked:true};
      }
    });
    Object.entries(ALTERNATES.patchToRibbon).forEach(([patch,ribbon])=>{
      if(State.patches.includes(patch) && ribbon){
        State.ribbonSelections[ribbon] = State.ribbonSelections[ribbon] || {checked:true, devices:{}};
        State.ribbonSelections[ribbon].checked = true;
      }
    });

    rebuildBadgesFromGallery();
    rebuildRibbonsFromGallery();
  }

  if(State.membership==='cadet'){
    State.badges = State.badges.filter(isCadetAuthorized);
    Object.keys(State.badgeSelections).forEach(id=>{
      if(!isCadetAuthorized(id)) State.badgeSelections[id].checked=false;
    });
  }
}

/* ===========================
   RENDER PIPELINE
   =========================== */
function fullRender(prevUniform){
  clearLayers();
  applyJacket();

  if(!getBaseCandidates().length) return;

  updateAvailabilityUI(prevUniform);
  renderPatches();
  renderRack();
  renderAllBadges();
  renderRank(State.rank);
}

function refreshUI(){
  membershipTypeEl.value = State.membership || '';
  rankSetupSelect.value = State.rank || '';
  jacketSelect.value = State.gender || '';
  assetBaseInput.value=State.assetBase;

  highlightActiveUniformButton();
  applyMemberTypeToUniformOptions();

  if(State.rank) by('rankSelect').value = State.rank;
}

/* ===========================
   UNIFORM BUTTON CLICK
   =========================== */
uniformListEl.addEventListener('click', e=>{
  const btn=e.target.closest('.uniformOption');
  if(!btn) return;
  if(btn.classList.contains('locked')) return;

  const newUniform=btn.dataset.uniformId;
  const prevU=State.uniform;
  State.uniform=newUniform;

  fullRender(prevU);
  refreshUI();
});

/* ===========================
   EVENT WIRING
   =========================== */
by('applyJacket').addEventListener('click', ()=>{
  State.assetBase=(assetBaseInput.value||'images').trim()||'images';
  fullRender();
  buildRibbonGallery();
  buildBadgeGallery();
  buildPatchGallery();
});
assetBaseInput.addEventListener('change', ()=>{
  State.assetBase=(assetBaseInput.value||'images').trim()||'images';
  fullRender();
  buildRibbonGallery();
  buildBadgeGallery();
  buildPatchGallery();
});

by('toggleMini').addEventListener('change', e=>{
  State.forceMini = e.target.checked;
  renderRack();
  renderAllBadges();
});

buildDevicePicker();
wireDeviceUI();

/* Ribbon gallery buttons */
by('clearRibbons').addEventListener('click', ()=>{
  State.ribbons=[];
  State.ribbonSelections={};
  buildRibbonGallery();
  renderRack();
  renderAllBadges();
});

/* Badge gallery buttons */
by('clearBadges').addEventListener('click', ()=>{
  State.badges=[];
  State.badgeSelections={};
  buildBadgeGallery();
  renderAllBadges();
});

/* Patch gallery buttons */
by('clearPatches').addEventListener('click', ()=>{
  State.patches=[];
  State.patchSelections={};
  buildPatchGallery();
  renderPatches();
});

by('addRank').addEventListener('click', ()=>{
  State.rank=by('rankSelect').value || null;
  rankSetupSelect.value = State.rank || '';
  renderRank(State.rank);
});

by('addNameplate').addEventListener('click', ()=>{
  renderNameplate();
});

by('downloadImage').addEventListener('click', ()=>{
  html2canvas(uniformCanvas,{scale:3,backgroundColor:'#ffffff'}).then(c=>{
    const a=document.createElement('a');
    a.download=`CAP_Uniform_${Date.now()}.png`;
    a.href=c.toDataURL();
    a.click();
  });
});

const toggleRibbonDragBtn = by('toggleRibbonDrag');
const logRibbonCoordsBtn  = by('logRibbonCoords');

toggleRibbonDragBtn.addEventListener('click', ()=>{
  State.ribbonDragMode = !State.ribbonDragMode;
  if(State.ribbonDragMode){
    toggleRibbonDragBtn.textContent = 'Disable Drag Mode';
    toggleRibbonDragBtn.classList.remove('ghost');
    uniformCanvas.classList.add('drag-mode-on');
  }else{
    toggleRibbonDragBtn.textContent = 'Enable Drag Mode';
    toggleRibbonDragBtn.classList.add('ghost');
    uniformCanvas.classList.remove('drag-mode-on');
  }
});

logRibbonCoordsBtn.addEventListener('click', ()=>{
  const data=[];
  uniformCanvas.querySelectorAll('.ribbonTile').forEach(tile=>{
    data.push({
      rid: tile.dataset.rid,
      left: tile.style.left,
      top: tile.style.top,
      width: tile.style.width,
      height: tile.style.height
    });
  });
  console.log('RIBBON_COORD_REPORT', data);
  alert('Ribbon coordinates logged to console.');
});

/* ===========================
   UNIVERSAL CALIBRATOR UI
   =========================== */
function initCalibratorUI(){
  const tab   = by('calibratorTab');
  const arrow = by('calibratorArrow');
  const panel = by('calibratorPanel');

  const btnMode = by('calibToggleMode');
  const pillKey = by('calibKeyPill');

  const calX  = by('calX'),  calXn = by('calXn');
  const calY  = by('calY'),  calYn = by('calYn');
  const calW  = by('calW'),  calWn = by('calWn');
  const calH  = by('calH'),  calHn = by('calHn');
  const calR  = by('calR'),  calRn = by('calRn');

  const btnReset = by('calibReset');
  const btnCopy  = by('calibCopy');

  let open=false;
  tab.addEventListener('click', ()=>{
    open=!open;
    panel.style.display=open?'block':'none';
    arrow.textContent=open?'‹':'›';
  });

  function setSelected(key){
    // clear old selection outline
    uniformCanvas.querySelectorAll('.calib-selected').forEach(n=>n.classList.remove('calib-selected'));

    State.calib.selectedKey = key;
    pillKey.textContent = key || 'none';

    if(!key){
      refreshCalibratorReadout();
      return;
    }

    const el = uniformCanvas.querySelector(`.layer[data-calib-key="${CSS.escape(key)}"]`);
    if(!el){
      refreshCalibratorReadout();
      return;
    }
    el.classList.add('calib-selected');

    const st = window.getComputedStyle(el);
    const x = Math.round(parseFloat(st.left)||0);
    const y = Math.round(parseFloat(st.top)||0);
    const w = Math.round(parseFloat(st.width)||0);
    const h = Math.round(parseFloat(st.height)||0);

    const o = getCalib(key) || {};
    const r = (o.r !== undefined) ? o.r : 0;

    calX.value=x; calXn.value=x;
    calY.value=y; calYn.value=y;
    calW.value=w; calWn.value=w;
    calH.value=h; calHn.value=h;
    calR.value=r; calRn.value=r;

    refreshCalibratorReadout();
  }

  function applyFromControls(){
    const key = State.calib.selectedKey;
    if(!key) return;

    const x = parseInt(calXn.value||"0",10);
    const y = parseInt(calYn.value||"0",10);
    const w = Math.max(1, parseInt(calWn.value||"1",10));
    const h = Math.max(1, parseInt(calHn.value||"1",10));
    const r = parseInt(calRn.value||"0",10);

    setCalib(key, { x,y,w,h,r });

    const el = uniformCanvas.querySelector(`.layer[data-calib-key="${CSS.escape(key)}"]`);
    if(el){
      el.style.left = x+'px';
      el.style.top  = y+'px';
      el.style.width  = w+'px';
      el.style.height = h+'px';
      el.style.transform = `rotate(${r}deg)`;
      el.style.transformOrigin='center center';
    }

    refreshCalibratorReadout();
  }

  function bindPair(rangeEl, numEl){
    rangeEl.addEventListener('input', ()=>{ numEl.value = rangeEl.value; applyFromControls(); });
    numEl.addEventListener('input', ()=>{ rangeEl.value = numEl.value; applyFromControls(); });
  }
  bindPair(calX, calXn);
  bindPair(calY, calYn);
  bindPair(calW, calWn);
  bindPair(calH, calHn);
  bindPair(calR, calRn);

  btnMode.addEventListener('click', ()=>{
    State.calib.enabled = !State.calib.enabled;
    btnMode.textContent = State.calib.enabled ? 'Calibrate Mode: ON' : 'Calibrate Mode: OFF';
    btnMode.classList.toggle('ghost', !State.calib.enabled);

    if(State.calib.enabled){
      uniformCanvas.classList.add('calib-selectable');
    }else{
      uniformCanvas.classList.remove('calib-selectable');
      setSelected(null);
    }
  });

  uniformCanvas.addEventListener('click', (e)=>{
    if(!State.calib.enabled) return;
    const layer = e.target.closest('.layer');
    if(!layer) return;
    const key = calibKeyFor(layer);
    if(!key) return;
    setSelected(key);
    e.preventDefault();
    e.stopPropagation();
  });

  document.addEventListener('keydown', (e)=>{
    if(!State.calib.enabled) return;
    if(!State.calib.selectedKey) return;

    const step = e.shiftKey ? 10 : 1;
    if(e.key==='ArrowLeft'){  nudgeSelected(-step,0); e.preventDefault(); }
    if(e.key==='ArrowRight'){ nudgeSelected(step,0);  e.preventDefault(); }
    if(e.key==='ArrowUp'){    nudgeSelected(0,-step); e.preventDefault(); }
    if(e.key==='ArrowDown'){  nudgeSelected(0,step);  e.preventDefault(); }
  });

  btnReset.addEventListener('click', ()=>{
    const key = State.calib.selectedKey;
    if(!key) return;
    clearCalib(key);

    const keep = key;
    fullRender();
    setTimeout(()=> setSelected(keep), 0);
  });

  btnCopy.addEventListener('click', async ()=>{
    const key = State.calib.selectedKey;
    if(!key) return;
    const txt = buildCalibJson(key);

    try{
      await navigator.clipboard.writeText(txt);
      btnCopy.textContent = 'Copied!';
      setTimeout(()=>btnCopy.textContent='Copy JSON', 700);
    }catch{
      const ta=document.createElement('textarea');
      ta.value=txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      btnCopy.textContent = 'Copied!';
      setTimeout(()=>btnCopy.textContent='Copy JSON', 700);
    }
  });
}

/* ===========================
   MODAL GALLERY (Ribbons/Badges/Patches)
   - Expand buttons open popup
   - Popup is resizable + Max/Restore
   =========================== */
const modalOverlay = by('galleryModalOverlay');
const modalEl      = by('galleryModal');
const modalTitle   = by('galleryModalTitle');
const modalHost    = by('galleryModalHost');
const modalClose   = by('galleryModalCloseBtn');
const modalMaxBtn  = by('galleryModalMaxBtn');
const modalRestore = by('galleryModalRestoreBtn');

let modalLast = null;

function openGalleryModal(kind){
  modalHost.innerHTML = '';

  const host = document.createElement('div');

  const header = document.createElement('div');
  header.style.cssText = "display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px;";
  header.innerHTML = `
    <div style="font-size:12px;color:var(--muted);line-height:1.3;">
      Tip: Drag the bottom-right corner to resize this window.
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="modalShowLess" class="ghost" type="button" style="width:auto;padding:8px 10px;border-radius:10px;">Show Less</button>
      <button id="modalShowAll" class="ghost" type="button" style="width:auto;padding:8px 10px;border-radius:10px;">Show All</button>
    </div>
  `;
  host.appendChild(header);

  const grid = document.createElement('div');
  grid.className = 'galleryGrid';
  host.appendChild(grid);

  modalHost.appendChild(host);

  function syncFromSidebar(){
    if(kind==='ribbons'){
      State.ribbonGalleryExpanded = true;
      buildRibbonGallery();
      modalTitle.textContent = "Ribbons / Mini Medals";
      const sidebar = by('ribbonGallery');
      grid.innerHTML = sidebar ? sidebar.innerHTML : '';
      wireModalInteractions('ribbons');
    }

    if(kind==='badges'){
      State.badgeGalleryExpanded = true;
      modalTitle.textContent = "Badges";
      buildGroupedBadgeModal(grid);
      return;
    }

    if(kind==='patches'){
      State.patchGalleryExpanded = true;
      buildPatchGallery();
      modalTitle.textContent = "Patches";
      const sidebar = by('patchGallery');
      grid.innerHTML = sidebar ? sidebar.innerHTML : '';
      wireModalInteractions('patches');
    }
  }

  function buildGroupedBadgeModal(rootGrid){
    rootGrid.innerHTML = '';
    normalizeBadgeSelections();

    const eligibleSet = new Set(
      (State.membership==='cadet') ? badgeList.filter(isCadetAuthorized) : badgeList
    );

    BADGE_CATEGORIES.forEach(cat=>{
      const ids = cat.ids.filter(id => eligibleSet.has(id));
      if(!ids.length) return;

      const h = document.createElement('div');
      h.style.cssText = "margin:10px 0 6px;font-weight:800;color:var(--ink);font-size:13px;";
      h.textContent = cat.key;

      const subGrid = document.createElement('div');
      subGrid.className = 'galleryGrid';

      ids.forEach(id=>{
        const sel = State.badgeSelections[id] || {checked:false};
        const title = id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());

        const tile = document.createElement('div');
        tile.className = 'galleryTile';
        tile.innerHTML = `
          <img src="${ASSET(`badges/${id}.png`)}" alt="${title}">
          <div style="flex:1;min-width:0;">
            <div class="title">${title}</div>
            <div class="sub">(${id})</div>
            <div class="miniRow">
              <label><input type="checkbox" class="bdChk"> Add</label>
            </div>
            <div class="sub">Slot: <b>${badgeLocations[id] || 'UN'}</b> • Size: ${(customBadgeSizes[id]?.width||60)}×${(customBadgeSizes[id]?.height||25)} px</div>
          </div>
        `;

        const chk = tile.querySelector('.bdChk');
        chk.checked = !!sel.checked;
        chk.onchange = ()=>{
          sel.checked = chk.checked;
          State.badgeSelections[id] = sel;
          rebuildBadgesFromGallery();
        };

        subGrid.appendChild(tile);
      });

      modalHost.appendChild(h);
      modalHost.appendChild(subGrid);
    });
  }

  function wireModalInteractions(k){
    if(k==='ribbons'){
      let eligible = [...ribbonList];
      if(State.membership === 'senior'){
        eligible = eligible.filter(id=>{
          if(CADET_ACHIEVEMENT_RIBBONS.has(id)) return CADET_MILESTONES.has(id);
          return true;
        });
      }

      const showCount = State.ribbonGalleryExpanded ? eligible.length : Math.min(12, eligible.length);
      const ids = eligible.slice(0, showCount);

      const tiles = [...grid.querySelectorAll('.galleryTile')];
      tiles.forEach((tile, i) => {
        const id = ids[i];
        if(!id) return;
        const sel = State.ribbonSelections[id];

        const chk = tile.querySelector('.rbChk');
        const silver = tile.querySelector('.rbSilver');
        const bronze = tile.querySelector('.rbBronze');

        if(chk){
          chk.checked = !!sel.checked;
          chk.onchange = () => {
            sel.checked = chk.checked;

            if(State.membership === 'senior' && CADET_MILESTONES.has(id) && sel.checked){
              for(const otherId of Object.keys(State.ribbonSelections)){
                if(otherId !== id && CADET_MILESTONES.has(otherId)){
                  State.ribbonSelections[otherId].checked = false;
                }
              }
            }

            rebuildRibbonsFromGallery();
            syncFromSidebar();
          };
        }
        function bump(){
          sel.devices['1_Silver_Star_Device'] = Math.max(0, parseInt(silver?.value||"0",10)||0);
          sel.devices['1_Bronze_Star_Device'] = Math.max(0, parseInt(bronze?.value||"0",10)||0);
          sel.checked = true;
          if(chk) chk.checked = true;

          if(State.membership === 'senior' && CADET_MILESTONES.has(id)){
            for(const otherId of Object.keys(State.ribbonSelections)){
              if(otherId !== id && CADET_MILESTONES.has(otherId)){
                State.ribbonSelections[otherId].checked = false;
              }
            }
          }

          rebuildRibbonsFromGallery();
          syncFromSidebar();
        }
        if(silver) silver.oninput = bump;
        if(bronze) bronze.oninput = bump;
      });
    }

    if(k==='patches'){
      const showCount = State.patchGalleryExpanded ? patchList.length : Math.min(10, patchList.length);
      const ids = patchList.slice(0, showCount);

      const tiles = [...grid.querySelectorAll('.galleryTile')];
      tiles.forEach((tile, i) => {
        const id = ids[i];
        if(!id) return;
        const sel = State.patchSelections[id] || {checked:false};

        const chk = tile.querySelector('.ptChk');
        if(chk){
          chk.checked = !!sel.checked;
          chk.onchange = () => {
            sel.checked = chk.checked;
            rebuildPatchesFromGallery();
            syncFromSidebar();
          };
        }
      });
    }
  }

  host.querySelector('#modalShowLess').onclick = ()=>{
    if(kind==='ribbons'){ State.ribbonGalleryExpanded=false; buildRibbonGallery(); }
    if(kind==='badges'){ State.badgeGalleryExpanded=false; buildBadgeGallery(); }
    if(kind==='patches'){ State.patchGalleryExpanded=false; buildPatchGallery(); }
    syncFromSidebar();
  };
  host.querySelector('#modalShowAll').onclick = ()=>{
    if(kind==='ribbons'){ State.ribbonGalleryExpanded=true; buildRibbonGallery(); }
    if(kind==='badges'){ State.badgeGalleryExpanded=true; buildBadgeGallery(); }
    if(kind==='patches'){ State.patchGalleryExpanded=true; buildPatchGallery(); }
    syncFromSidebar();
  };

  syncFromSidebar();

  modalOverlay.classList.add('open');
  modalOverlay.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
}

function closeGalleryModal(){
  modalOverlay.classList.remove('open');
  modalOverlay.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';

  buildRibbonGallery();
  buildBadgeGallery();
  buildPatchGallery();
}

modalClose.addEventListener('click', closeGalleryModal);
modalOverlay.addEventListener('click', (e)=>{
  if(e.target === modalOverlay) closeGalleryModal();
});
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && modalOverlay.classList.contains('open')) closeGalleryModal();
});

modalMaxBtn.addEventListener('click', ()=>{
  modalLast = {
    w: modalEl.style.width,
    h: modalEl.style.height,
    resize: modalEl.style.resize
  };
  modalEl.style.width = '96vw';
  modalEl.style.height = '90vh';
  modalEl.style.resize = 'none';
  modalMaxBtn.classList.add('hidden');
  modalRestore.classList.remove('hidden');
});
modalRestore.addEventListener('click', ()=>{
  if(modalLast){
    modalEl.style.width = modalLast.w || '';
    modalEl.style.height = modalLast.h || '';
    modalEl.style.resize = modalLast.resize || 'both';
  }else{
    modalEl.style.width = '';
    modalEl.style.height = '';
    modalEl.style.resize = 'both';
  }
  modalRestore.classList.add('hidden');
  modalMaxBtn.classList.remove('hidden');
});

/* IMPORTANT: Picker buttons open the popup */
by('expandRibbons').addEventListener('click', ()=> openGalleryModal('ribbons'));
by('expandBadges').addEventListener('click',  ()=> openGalleryModal('badges'));
by('expandPatches').addEventListener('click', ()=> openGalleryModal('patches'));

/* ===========================
   BOOTSTRAP
   =========================== */
(function init(){
  applyMemberTypeToUniformOptions();
  populateRankSetup();
  updateSetupGates();
  refreshUI();

  buildRibbonGallery();
  buildBadgeGallery();
  buildPatchGallery();

  fullRender();
  initCalibratorUI();
})();
</script>
</body>
</html>

