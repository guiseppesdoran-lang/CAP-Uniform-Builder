<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CAP Class A Uniform Builder — Full Program (with Device Click-to-Apply)</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{
      --bg:#eef1f5; --ink:#0d1b2a; --muted:#516079; --panel:#ffffff; --line:#cfd6df; --brand:#002855;
      --tileW:120px; --tileH:35px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    header{background:var(--brand);color:#fff;padding:14px 16px;text-align:center}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    main{display:flex;gap:16px;align-items:stretch;min-height:calc(100vh - 60px)}
    #controls{width:360px;background:var(--panel);padding:14px;border-right:1px solid var(--line);overflow:auto}
    #stage{flex:1;padding:16px;display:flex;flex-direction:column;gap:14px}

    fieldset{border:1px solid var(--line);border-radius:10px;padding:10px}
    legend{padding:0 6px;color:var(--muted);font-size:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select,input[type="number"],input[type="text"]{padding:6px 8px;border:1px solid var(--line);border-radius:8px;background:#fff;min-height:34px}
    .btn{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
    .btn.primary{background:#0b5cff;color:#fff;border-color:#0b5cff}

    /* Canvas / preview area */
    #previewWrap{
      position:relative;
      display:inline-block;
      margin:auto;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
    }
    #jacketStage{
      position:relative;
      width:600px;   /* tweak to your base image */
      height:900px;  /* tweak to your base image */
      background:#f8f9fb;
      overflow:hidden;
      border-radius:10px;
    }
    #jacketImg{
      position:absolute; inset:0; width:100%; height:100%; object-fit:contain; image-rendering:auto;
    }

    /* Layers */
    .layer{position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none}
    #ribbonLayer{pointer-events:auto} /* needed for click handlers */

    /* Ribbon tiles rendered on the jacket */
    .ribbon-tile{
      position:absolute;
      width:var(--tileW);
      height:var(--tileH);
      border-radius:6px;
      overflow:hidden;
      box-shadow:0 1px 1px rgba(0,0,0,.05), inset 0 0 0 1px #dcdcdc;
      background:linear-gradient(180deg,#e6e6e6,#d8d8d8);
      image-rendering:auto;
    }
    .ribbon-tile img.ribbon{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; display:block;
    }
    .device-overlay{position:absolute; pointer-events:none; filter:drop-shadow(0 0 0.5px rgba(0,0,0,.35))}
    .hint{color:var(--muted);font-size:12px}

    /* Devices UI */
    #deviceTool button{padding:6px 10px;border:1px solid var(--line);background:#fff;border-radius:8px;cursor:pointer}
    #deviceTool button.active{outline:2px solid #2b7fff}
    #devicePicker{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}

    @media (max-width: 900px){
      main{flex-direction:column}
      #controls{width:auto;border-right:none;border-bottom:1px solid var(--line)}
      #jacketStage{width:92vw; height:calc(92vw*1.5)}
    }
  </style>
</head>
<body>
<header><h1>CAP Class A Uniform Builder — Full Program</h1></header>

<main>
  <aside id="controls">
    <fieldset>
      <legend>Uniform</legend>
      <div class="row">
        <label>Gender
          <select id="genderSelect">
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </label>
        <label>Jacket
          <select id="jacketSelect">
            <option value="images/jackets/classA_male.png">Class A (Male)</option>
            <option value="images/jackets/classA_female.png">Class A (Female)</option>
          </select>
        </label>
      </div>
      <div class="row">
        <button id="downloadBtn" class="btn primary">Download High-Res PNG</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Ribbons</legend>
      <div class="row">
        <select id="ribbonSelect"></select>
        <button id="addRibbonBtn" class="btn primary">Add</button>
        <button id="clearRibbonsBtn" class="btn">Clear All</button>
      </div>
      <small class="hint">Rack rules: rows of 3; any partial row (1–2) appears at the top and is centered. Highest precedence is top-left.</small>
    </fieldset>

    <section id="deviceTool" style="margin-top:16px;border-top:1px solid var(--line);padding-top:12px">
      <h3 style="margin:0 0 8px 0;font-size:14px">Ribbon Devices</h3>

      <div id="devicePicker">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" data-device="star_bronze" />
          <span>Bronze Star</span>
          <input type="number" min="1" max="10" value="1" data-qty="star_bronze" style="width:54px;margin-left:auto">
        </label>

        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" data-device="star_silver" />
          <span>Silver Star</span>
          <input type="number" min="1" max="10" value="1" data-qty="star_silver" style="width:54px;margin-left:auto">
        </label>

        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" data-device="clasp_bronze" />
          <span>Bronze Clasp</span>
          <input type="number" min="1" max="10" value="1" data-qty="clasp_bronze" style="width:54px;margin-left:auto">
        </label>

        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" data-device="clasp_silver" />
          <span>Silver Clasp</span>
          <input type="number" min="1" max="10" value="1" data-qty="clasp_silver" style="width:54px;margin-left:auto">
        </label>

        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" data-device="propeller" />
          <span>Propeller</span>
          <input type="number" min="1" max="10" value="1" data-qty="propeller" style="width:54px;margin-left:auto">
        </label>

        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" data-device="leaf_bronze" />
          <span>Bronze Leaf</span>
          <input type="number" min="1" max="10" value="1" data-qty="leaf_bronze" style="width:54px;margin-left:auto">
        </label>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button id="deviceApplyModeBtn" type="button">Enable Device Apply Mode</button>
        <button id="deviceClearSelectionBtn" type="button">Clear Selection</button>
        <button id="deviceRemoveModeBtn" type="button">Enable Remove Mode</button>
      </div>

      <small id="deviceHint" class="hint" style="display:block;margin-top:6px">
        Pick devices + quantities → Enable → click a ribbon to apply. Remove Mode clears devices from a clicked ribbon.
      </small>
    </section>

    <fieldset style="margin-top:16px">
      <legend>Badges (placeholder wiring)</legend>
      <div class="row">
        <select id="badgeSelect">
          <option value="">-- choose badge --</option>
          <option value="aviation_basic">Aviation (Basic)</option>
          <option value="ground_team">Ground Team</option>
          <option value="ems">EMS</option>
        </select>
        <button id="addBadgeBtn" class="btn">Add</button>
        <button id="clearBadgesBtn" class="btn">Clear</button>
      </div>
      <small class="hint">Rendered over left/right pocket areas. You can plug in your full CAPR 39-1 logic later — hooks are ready.</small>
    </fieldset>

  </aside>

  <section id="stage">
    <fieldset>
      <legend>Preview</legend>
      <div id="previewWrap">
        <div id="jacketStage" aria-label="Uniform Preview">
          <img id="jacketImg" alt="Jacket"/>
          <div id="ribbonLayer" class="layer" aria-label="Ribbon Layer"></div>
          <div id="badgeLayer"  class="layer" aria-label="Badge Layer"></div>
          <!-- You can add epaulet/rank layers here -->
        </div>
      </div>
      <div class="hint" style="margin-top:8px">
        Tip: Devices are centered across each ribbon. Mix anything (e.g., 3 silver stars + 1 bronze star).
      </div>
    </fieldset>
  </section>
</main>

<script>
/* =========================
   SAFE STARTUP
========================= */
document.addEventListener('DOMContentLoaded', () => init());

/* =========================
   DATA (replace paths)
========================= */
const JACKETS = {
  male:   "images/jackets/classA_male.png",
  female: "images/jackets/classA_female.png"
};

// Example ribbon catalog with precedence (lower number = higher precedence)
const RIBBON_CATALOG = [
  { id:'gen_billy_mitchell', name:'Billy Mitchell', img:'images/ribbons/billy_mitchell.png', precedence:1 },
  { id:'ach_1',              name:'Achievement 1', img:'images/ribbons/achievement_1.png',   precedence:50 },
  { id:'ach_2',              name:'Achievement 2', img:'images/ribbons/achievement_2.png',   precedence:60 },
  { id:'community',          name:'Community Svc', img:'images/ribbons/community.png',       precedence:120 },
  { id:'general_service',    name:'General Service', img:'images/ribbons/general_service.png', precedence:150 },
];

const DEVICE_SPRITES = {
  star_bronze: { label:"Bronze Star",  src:"images/devices/star_bronze.png",  width:12, height:12, weight:1 },
  star_silver: { label:"Silver Star",  src:"images/devices/star_silver.png",  width:12, height:12, weight:2 },
  clasp_bronze:{ label:"Bronze Clasp", src:"images/devices/clasp_bronze.png", width:14, height: 8, weight:1 },
  clasp_silver:{ label:"Silver Clasp", src:"images/devices/clasp_silver.png", width:14, height: 8, weight:2 },
  propeller:   { label:"Propeller",    src:"images/devices/propeller.png",    width:14, height:14, weight:3 },
  leaf_bronze: { label:"Bronze Leaf",  src:"images/devices/leaf_bronze.png",  width:12, height:12, weight:1 },
};

// Badge demo — swap to your full table later
const BADGE_SPRITES = {
  aviation_basic: { src:"images/badges/aviation_basic.png", w:70, h:22, side:"left",  yOffset:-36 },
  ground_team:    { src:"images/badges/ground_team.png",    w:64, h:24, side:"left",  yOffset:-36 },
  ems:            { src:"images/badges/ems.png",            w:64, h:24, side:"right", yOffset:-36 },
};

/* =========================
   STATE
========================= */
let gender = "male";
let jacketPath = JACKETS[gender];

let rack = [];     // array of ribbons on the jacket: {id, name, img, precedence, devices:{}}
let badges = [];   // array of badges: { key, side, x, y, w, h }

let deviceApplyMode = false;
let deviceRemoveMode = false;
let selectedDeviceBundle = {}; // e.g., { star_silver:3, star_bronze:1 }

/* =========================
   INIT & WIRING
========================= */
function init(){
  // Populate selects
  const ribbonSel = document.getElementById('ribbonSelect');
  ribbonSel.innerHTML = RIBBON_CATALOG
    .sort((a,b)=>a.precedence-b.precedence)
    .map(r=>`<option value="${r.id}">${r.name}</option>`).join('');

  // Set jacket
  document.getElementById('genderSelect')?.addEventListener('change', (e)=>{
    gender = e.target.value;
    const suggested = JACKETS[gender];
    document.getElementById('jacketSelect').value = suggested;
    jacketPath = suggested;
    renderJacket();
  });
  document.getElementById('jacketSelect')?.addEventListener('change', (e)=>{
    jacketPath = e.target.value;
    renderJacket();
  });

  document.getElementById('addRibbonBtn')?.addEventListener('click', onAddRibbon);
  document.getElementById('clearRibbonsBtn')?.addEventListener('click', ()=>{
    rack = [];
    renderAll();
  });

  // Devices UI
  wireDeviceUI();

  // Badges
  document.getElementById('addBadgeBtn')?.addEventListener('click', ()=>{
    const key = document.getElementById('badgeSelect').value;
    if (!key) return;
    const meta = BADGE_SPRITES[key];
    if (!meta) return;
    // Simple placement: relative to ribbon top left; refined logic can use your final rules
    const anchor = computeRibbonAnchor();
    const x = meta.side === "left" ? anchor.left - meta.w - 10 : anchor.right + 10;
    const y = anchor.top + meta.yOffset;
    badges.push({ key, x, y, w: meta.w, h: meta.h, side: meta.side });
    renderBadges();
  });
  document.getElementById('clearBadgesBtn')?.addEventListener('click', ()=>{
    badges = [];
    renderBadges();
  });

  // Download
  document.getElementById('downloadBtn')?.addEventListener('click', downloadHighRes);

  // Initial
  renderAll();
}

/* =========================
   DEVICES UI
========================= */
function wireDeviceUI(){
  const applyBtn = document.getElementById('deviceApplyModeBtn');
  const clearBtn = document.getElementById('deviceClearSelectionBtn');
  const removeBtn= document.getElementById('deviceRemoveModeBtn');

  applyBtn?.addEventListener('click', ()=>{
    selectedDeviceBundle = buildSelectedDeviceBundleFromUI();
    const hasAny = Object.keys(selectedDeviceBundle).length>0;
    deviceApplyMode = hasAny;
    deviceRemoveMode = false;
    applyBtn.classList.toggle('active', deviceApplyMode);
    removeBtn?.classList.remove('active');
    applyBtn.textContent = deviceApplyMode ? "Device Apply Mode: ON" : "Enable Device Apply Mode";
  });

  clearBtn?.addEventListener('click', ()=>{
    const picker = document.getElementById('devicePicker');
    picker?.querySelectorAll('input[type="checkbox"][data-device]').forEach(c=>c.checked=false);
    picker?.querySelectorAll('input[type="number"][data-qty]').forEach(n=>n.value=1);
    selectedDeviceBundle = {};
    deviceApplyMode = false;
    deviceRemoveMode = false;
    document.getElementById('deviceApplyModeBtn')?.classList.remove('active');
    document.getElementById('deviceRemoveModeBtn')?.classList.remove('active');
    document.getElementById('deviceApplyModeBtn').textContent = "Enable Device Apply Mode";
  });

  removeBtn?.addEventListener('click', ()=>{
    deviceRemoveMode = !deviceRemoveMode;
    deviceApplyMode = false;
    removeBtn.classList.toggle('active', deviceRemoveMode);
    applyBtn?.classList.remove('active');
    if (applyBtn) applyBtn.textContent = "Enable Device Apply Mode";
  });
}

function buildSelectedDeviceBundleFromUI(){
  const picker = document.getElementById('devicePicker');
  const checks = picker?.querySelectorAll('input[type="checkbox"][data-device]') || [];
  const bundle = {};
  checks.forEach(chk=>{
    const id = chk.getAttribute('data-device');
    if (chk.checked){
      const qty = parseInt(picker.querySelector(`input[type="number"][data-qty="${id}"]`)?.value||"1",10);
      if (qty>0) bundle[id] = qty;
    }
  });
  return bundle;
}

/* =========================
   RENDER PIPELINE
========================= */
function renderAll(){
  renderJacket();
  renderRibbons();
  renderBadges();
}

function renderJacket(){
  const img = document.getElementById('jacketImg');
  if (!img) return;
  img.src = jacketPath || JACKETS[gender] || "";
  img.onerror = ()=>{ img.style.opacity=.15; img.alt="Jacket image missing"; };
}

/* RIBBONS */
function onAddRibbon(){
  const id = document.getElementById('ribbonSelect')?.value;
  const meta = RIBBON_CATALOG.find(r=>r.id===id);
  if (!meta) return;
  rack.push({ ...meta, devices:{} });
  renderRibbons();
  renderBadges(); // badges may reposition relative to ribbons
}

function renderRibbons(){
  const layer = document.getElementById('ribbonLayer');
  if (!layer) return;
  layer.innerHTML = '';

  // Sort by precedence (lower = higher precedence)
  const sorted = [...rack].sort((a,b)=>a.precedence - b.precedence);

  // Row of 3, partial row (1–2) sits on top and centered
  const N = sorted.length;
  const perRow = 3;
  const remainder = N % perRow;
  const topCount = remainder === 0 ? perRow : remainder;

  // Coordinates (tweak to your jacket): anchor for top row
  const anchorX = 300; // center X of jacket ribbons area
  const startY  = 420; // Y position of top row
  const vGap    = 8;   // vertical spacing between rows
  const tileW   = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tileW')) || 120;
  const tileH   = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tileH')) || 35;

  // Helper to place a row centered on anchorX
  function placeRow(items, rowIndex, y){
    const count = items.length;
    const totalW = count*tileW + (count-1)*6;
    let x = Math.round(anchorX - totalW/2);
    items.forEach((ribbonObj, i)=>{
      const tile = createRibbonTile(ribbonObj);
      tile.style.left = `${x}px`;
      tile.style.top  = `${y}px`;
      layer.appendChild(tile);
      x += tileW + 6;
    });
  }

  // Build rows
  const rows = [];
  if (N>0){
    rows.push(sorted.slice(0, topCount)); // top row (1–3)
    let idx = topCount;
    while (idx < N){
      rows.push(sorted.slice(idx, idx+perRow));
      idx += perRow;
    }
  }

  // Render rows
  rows.forEach((rowItems, rIdx)=>{
    const y = startY + rIdx*(tileH+vGap);
    placeRow(rowItems, rIdx, y);
  });
}

function createRibbonTile(ribbonObj){
  const tile = document.createElement('div');
  tile.className = 'ribbon-tile';
  const img = document.createElement('img');
  img.className = 'ribbon';
  img.alt = ribbonObj.name;
  img.src = ribbonObj.img;
  img.decoding = 'async';
  img.loading  = 'lazy';
  img.onerror = function(){
    tile.style.background = 'linear-gradient(90deg,#9bbcff,#6aa3ff)';
    this.style.display='none';
  };
  tile.appendChild(img);

  // Make clickable for device actions
  makeRibbonClickableForDevices(tile, ribbonObj);

  // Draw devices overlay
  drawDevicesOnTile(tile, ribbonObj);

  return tile;
}

function makeRibbonClickableForDevices(tileEl, ribbonObj){
  tileEl.style.cursor = 'pointer';
  tileEl.onclick = () => {
    if (deviceRemoveMode){
      ribbonObj.devices = {};
      renderRibbons();
      return;
    }
    if (!deviceApplyMode) return;

    ribbonObj.devices = ribbonObj.devices || {};
    for (const [devId, qty] of Object.entries(selectedDeviceBundle)){
      ribbonObj.devices[devId] = (ribbonObj.devices[devId] || 0) + qty;
    }
    renderRibbons();
  };
}

function drawDevicesOnTile(tileEl, ribbonObj){
  tileEl.querySelectorAll('.device-overlay').forEach(n=>n.remove());
  const map = ribbonObj.devices || {};
  if (!Object.keys(map).length) return;

  const flat = [];
  for (const [devId,count] of Object.entries(map)){
    const meta = DEVICE_SPRITES[devId];
    if (!meta) continue;
    for (let i=0;i<count;i++) flat.push({ id:devId, ...meta });
  }
  flat.sort((a,b)=> (b.weight - a.weight) || a.label.localeCompare(b.label));

  const tileW = tileEl.clientWidth || 120;
  const tileH = tileEl.clientHeight || 35;
  const gap = 3;

  const totalW = flat.reduce((sum,d,idx)=> sum + d.width + (idx>0?gap:0), 0);
  let x = Math.round((tileW - totalW)/2);
  const y = Math.round((tileH - 12)/2) - 1;

  flat.forEach(d=>{
    const im = document.createElement('img');
    im.className = 'device-overlay';
    im.src = d.src;
    im.alt = d.label;
    im.style.left = `${x}px`;
    im.style.top  = `${y}px`;
    im.style.width = `${d.width}px`;
    im.style.height= `${d.height}px`;
    im.draggable = false;
    im.onerror = function(){
      this.remove();
      const dot = document.createElement('div');
      dot.className = 'device-overlay';
      dot.style.left = `${x}px`;
      dot.style.top  = `${y}px`;
      dot.style.width = `${d.width}px`;
      dot.style.height= `${d.height}px`;
      dot.style.background = '#222';
      dot.style.borderRadius = '2px';
      tileEl.appendChild(dot);
    };
    tileEl.appendChild(im);
    x += d.width + gap;
  });
}

/* BADGES (placeholder layout; plug in your full rules) */
function renderBadges(){
  const layer = document.getElementById('badgeLayer');
  if (!layer) return;
  layer.innerHTML = '';

  badges.forEach(b=>{
    const meta = BADGE_SPRITES[b.key];
    if (!meta) return;
    const img = document.createElement('img');
    img.src = meta.src;
    img.alt = b.key;
    img.style.position = 'absolute';
    img.style.left = `${b.x}px`;
    img.style.top  = `${b.y}px`;
    img.style.width = `${b.w}px`;
    img.style.height= `${b.h}px`;
    img.draggable = false;
    img.onerror = ()=>{ img.style.display='none'; };
    layer.appendChild(img);
  });
}

/* Simple anchor near the ribbon rack for badge placement math */
function computeRibbonAnchor(){
  // Mirror the anchor used in renderRibbons()
  const anchorX = 300;
  const startY  = 420;
  const tileW = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tileW')) || 120;
  const left  = Math.round(anchorX - tileW/2);
  const right = Math.round(anchorX + tileW/2);
  const top   = startY;
  return { left, right, top };
}

/* =========================
   DOWNLOAD
========================= */
async function downloadHighRes(){
  const target = document.getElementById('jacketStage');
  if (!target) return;
  const canvas = await html2canvas(target, { scale: 2, backgroundColor:'#ffffff', useCORS:true });
  const link = document.createElement('a');
  link.download = 'CAP_Uniform.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
}
</script>
</body>
</html>
