<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAP Class A Blues Uniform Builder</title>
  <style>
    #uniformCanvas {
      position: relative;
      width: 600px;
      height: 900px;
    }
    .layer { position: absolute; }
    label, select, button {
      display: block; margin: 0.5rem 0; width: 100%;
    }
    select, button { padding: 0.3rem; }
    .hidden-assets { display: none; }
  </style>
</head>
<body>
  <header>
    <h1>CAP Class A Blues Uniform Builder</h1>
  </header>
  <main>
    <section id="controls">
      <label for="ribbonSelect">Ribbons</label>
      <select id="ribbonSelect"></select>
      <button id="addRibbon">Add Ribbon</button>
      <button id="clearRibbons">Clear Ribbons</button>

      <label for="deviceSelect">Devices</label>
      <select id="deviceSelect"></select>
      <button id="addDevice">Add Device</button>

      <label for="badgeSelect">Badges</label>
      <select id="badgeSelect"></select>
      <button id="addBadge">Add Badge</button>

      <label for="rankSelect">Rank Insignia</label>
      <select id="rankSelect"></select>
      <button id="addRank">Add Rank</button>

      <button id="addNameplate">Add Nameplate</button>
      <button id="addUSInsignia">Add U.S. Collar Insignia</button>
      <button id="addCAPInsignia">Add CAP Collar Insignia</button>
      <label for="jacketSelect">Jacket</label>
      <select id="jacketSelect">
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
      <button id="changeJacket">Apply Jacket</button>
      <button id="downloadImage">Download Image</button>
    </section>
    <section id="preview">
      <div id="uniformCanvas"></div>
    </section>
  </main>

  <div class="hidden-assets" id="assets">
    <img id="jacket-male" src="images/base/jacket_male.png" style="display:none;">
    <img id="jacket-female" src="images/base/jacket_female.png" style="display:none;">
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const ribbonSelect = document.getElementById("ribbonSelect");
    const badgeSelect = document.getElementById("badgeSelect");
    const rankSelect = document.getElementById("rankSelect");
    const deviceSelect = document.getElementById("deviceSelect");
    const uniformCanvas = document.getElementById("uniformCanvas");

    let currentGender = "male";
    const selectedRibbons = [];
    const ribbonDevices = {}; // key: ribbon, value: array of device names

    function renderRibbons() {
      document.querySelectorAll(".layer.ribbon, .layer.device").forEach(el => el.remove());
      const sorted = [...selectedRibbons].sort((a, b) => ribbonList.indexOf(a) - ribbonList.indexOf(b));
      const ribbonWidth = 90;
      const ribbonHeight = 30;
      const ribbonsPerRow = 3;
      const spacingX = 5;
      const spacingY = 5;
      const offsetX = 135;
      const offsetY = currentGender === "female" ? 210 : 200;

      sorted.forEach((key, i) => {
        const col = i % ribbonsPerRow;
        const row = Math.floor(i / ribbonsPerRow);
        let leftOffset;

        const total = sorted.length;
        const lastRowCount = total % ribbonsPerRow;
        const isLastRow = row === Math.floor((total - 1) / ribbonsPerRow);

        if (isLastRow && lastRowCount !== 0 && i >= total - lastRowCount) {
          if (lastRowCount === 1) {
            leftOffset = offsetX + ribbonWidth + spacingX; // center
          } else if (lastRowCount === 2) {
            leftOffset = offsetX + (ribbonWidth / 2 + spacingX / 2) * col;
          }
        } else {
          leftOffset = offsetX + col * (ribbonWidth + spacingX);
        }

        const top = offsetY + row * (ribbonHeight + spacingY);
        const original = document.getElementById(`ribbons-${key}`);
        if (!original) return;
        const clone = original.cloneNode();
        clone.className = "layer ribbon";
        clone.style.top = `${top}px`;
        clone.style.left = `${leftOffset}px`;
        clone.style.width = `${ribbonWidth}px`;
        clone.style.height = `${ribbonHeight}px`;
        clone.style.display = "block";
        uniformCanvas.appendChild(clone);

        // Add all devices for this ribbon
        const devices = ribbonDevices[key] || [];
        devices.forEach((device, dIndex) => {
          const devImg = document.getElementById(`devices-${device}`)?.cloneNode();
          if (!devImg) return;
          devImg.className = "layer device";
          devImg.style.top = `${top + 5}px`;
          devImg.style.left = `${leftOffset + 20 + dIndex * 15}px`;
          devImg.style.width = "20px";
          devImg.style.height = "20px";
          devImg.style.display = "block";
          uniformCanvas.appendChild(devImg);
        });
      });
    }

    // UI logic to bind device to a selected ribbon
    document.getElementById("addDevice").onclick = () => {
      const ribbon = ribbonSelect.value;
      const device = deviceSelect.value;
      if (!ribbonDevices[ribbon]) ribbonDevices[ribbon] = [];
      if (!ribbonDevices[ribbon].includes(device)) {
        ribbonDevices[ribbon].push(device);
        renderRibbons();
      }
    };
  </script>
</body>
</html>
