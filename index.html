<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAP Class A Blues Uniform Builder</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #eef1f5; }
    header { background-color: #002855; color: white; padding: 1rem; text-align: center; }
    main { display: flex; }
    #controls {
      width: 320px; background: white; padding: 1rem;
      border-right: 1px solid #ccc; overflow-y: auto;
      height: calc(100vh - 72px);
    }
    #preview {
      flex-grow: 1; background: #d1d8e0;
      display: flex; align-items: center; justify-content: center;
      position: relative; height: calc(100vh - 72px);
    }
    #uniformCanvas {
      position: relative; width: 450px; height: 700px;
    }
    .layer { position: absolute; }
    label, select, button {
      display: block; margin: 0.5rem 0; width: 100%;
    }
    select, button { padding: 0.3rem; }
    .hidden-assets { display: none; }
  </style>
</head>
<body>
  <header>
    <h1>CAP Class A Blues Uniform Builder</h1>
  </header>
  <main>
    <section id="controls">
      <label for="ribbonSelect">Ribbons</label>
      <select id="ribbonSelect"></select>
      <button id="addRibbon">Add Ribbon</button>
      <button id="clearRibbons">Clear Ribbons</button>

      <label for="deviceSelect">Devices</label>
      <select id="deviceSelect"></select>
      <button id="addDevice">Add Device</button>

      <label for="badgeSelect">Badges</label>
      <select id="badgeSelect"></select>
      <button id="addBadge">Add Badge</button>

      <label for="rankSelect">Rank Insignia</label>
      <select id="rankSelect"></select>
      <button id="addRank">Add Rank</button>

      <button id="addNameplate">Add Nameplate</button>
      <button id="addCutouts">Add CAP Cutouts</button>
      <button id="addInsignia">Add U.S. Insignia</button>
      <button id="addFlagPatch">Add Flag Patch</button>
      <button id="downloadImage">Download Image</button>
      <button id="downloadPDF">Download PDF</button>
    </section>
    <section id="preview">
      <div id="uniformCanvas"></div>
    </section>
  </main>

  <div class="hidden-assets" id="assets"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const uniformCanvas = document.getElementById("uniformCanvas");
    const ribbonSelect = document.getElementById("ribbonSelect");
    const badgeSelect = document.getElementById("badgeSelect");
    const rankSelect = document.getElementById("rankSelect");
    const deviceSelect = document.getElementById("deviceSelect");

    const ribbonList = [
      "silver_medal_of_valor", "bronze_medal_of_valor", "distinguished_service_award",
      "exceptional_service_award", "meritorious_service_award", "commanders_commendation_award",
      "cap_achievement_award", "lifesaving_award", "national_commanders_unit_citation_award",
      "unit_citation_award", "spaatz_award", "eaker_award", "earhart_award", "mitchell_award",
      "armstrong_achievement", "goddard_achievement", "doolittle_achievement", "lindbergh_achievement",
      "rickenbacker_achievement", "wright_brothers_award", "mary_feik_achievement", "hap_arnold_achievement",
      "curry_achievement", "afa_award", "afsa_award", "vfw_officer_award", "vfw_nco_award", "red_service_ribbon",
      "search_find_ribbon", "air_search_and_rescue_ribbon", "disaster_relief_ribbon",
      "homeland_security_ribbon", "community_service_ribbon", "iace_ribbon",
      "national_cadet_competition_ribbon", "national_color_guard_competition_ribbon",
      "cadet_advisory_council_ribbon", "cadet_special_activity_ribbon", "encampment_ribbon",
      "cadet_recruiter_ribbon", "crisis_ribbon"
    ];

    const deviceList = [
      "bronze_star", "silver_star", "gold_clasp", "oak_leaf_cluster_bronze", "oak_leaf_cluster_silver",
      "year_service_star", "prop_device", "command_device"
    ];

    const badgeList = [
      "aviation_badge", "gtm_badge", "emergency_services_badge", "cadet_programs_badge",
      "recruiting_badge", "solo_badge", "pre_solo_badge", "senior_badge", "master_badge",
      "observer_badge", "health_services_badge", "cyber_badge", "communications_badge",
      "aerospace_education_badge"
    ];

    const rankList = [
      "c_ab", "c_amn", "c_a1c", "c_sra", "c_ssgt", "c_tsgt", "c_msgt", "c_smsgt", "c_cmsgt",
      "c_2dlt", "c_1stlt", "c_capt", "c_maj", "c_ltcol", "c_col"
    ];

    const loadOptions = (selectElement, list, prefix) => {
      list.forEach(item => {
        const option = document.createElement("option");
        option.value = item;
        option.textContent = item.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
        selectElement.appendChild(option);

        const img = document.createElement("img");
        img.id = `${prefix}-${item}`;
        img.src = `images/${prefix}/${item}.png`;
        document.getElementById("assets").appendChild(img);
      });
    };

    loadOptions(ribbonSelect, ribbonList, "ribbons");
    loadOptions(deviceSelect, deviceList, "devices");
    loadOptions(badgeSelect, badgeList, "badges");
    loadOptions(rankSelect, rankList, "ranks");

    let selectedRibbons = [];
    let badgeCount = 0;

    function renderRibbons() {
      document.querySelectorAll(".layer.ribbon").forEach(el => el.remove());
      const sorted = [...selectedRibbons].sort((a, b) => ribbonList.indexOf(a) - ribbonList.indexOf(b));
      const total = sorted.length;
      sorted.forEach((key, i) => {
        const col = i % 3;
        const row = Math.floor(i / 3);
        let leftOffset;

        const isLastRow = row === Math.floor((total - 1) / 3);
        const remaining = total % 3;

        if (isLastRow && remaining !== 0 && i >= total - remaining) {
          if (remaining === 1) {
            leftOffset = 180;
          } else if (remaining === 2) {
            leftOffset = 135 + col * 95;
          }
        } else {
          leftOffset = 135 + col * 95;
        }

        const top = 200 + row * 30;
        const original = document.getElementById(`ribbons-${key}`);
        const clone = original.cloneNode();
        clone.className = "layer ribbon";
        clone.style.top = `${top}px`;
        clone.style.left = `${leftOffset}px`;
        clone.style.width = "90px";
        clone.style.height = "30px";
        clone.style.display = "block";
        uniformCanvas.appendChild(clone);
      });
    }

    document.getElementById("addRibbon").onclick = () => {
      const key = ribbonSelect.value;
      if (!selectedRibbons.includes(key)) {
        selectedRibbons.push(key);
        renderRibbons();
      } else {
        alert("Ribbon already added.");
      }
    };

    document.getElementById("clearRibbons").onclick = () => {
      selectedRibbons = [];
      renderRibbons();
    };

    document.getElementById("addDevice").onclick = () => {
      const key = deviceSelect.value;
      addClonedImage(`devices-${key}`, "195px", "210px", 20, 20);
    };

    document.getElementById("addBadge").onclick = () => {
      const key = badgeSelect.value;
      const top = 150 - (badgeCount * 35);
      addClonedImage(`badges-${key}`, `${top}px`, "180px", 90, 30);
      badgeCount++;
    };

    document.getElementById("addRank").onclick = () => {
      const key = rankSelect.value;
      addClonedImage(`ranks-${key}`, "80px", "200px", 40, 40);
    };

    document.getElementById("addNameplate").onclick = () => {
      addClonedImage("nameplate", "235px", "90px", 120, 20);
    };

    document.getElementById("addCutouts").onclick = () => {
      addClonedImage("cutouts-cap_left", "100px", "140px", 25, 25);
      addClonedImage("cutouts-cap_right", "100px", "275px", 25, 25);
    };

    document.getElementById("addInsignia").onclick = () => {
      addClonedImage("insignia-us_insignia_left", "105px", "125px", 20, 20);
      addClonedImage("insignia-us_insignia_right", "105px", "300px", 20, 20);
    };

    document.getElementById("addFlagPatch").onclick = () => {
      addClonedImage("flag_patch", "60px", "360px", 40, 25);
    };

    document.getElementById("downloadImage").onclick = () => {
      html2canvas(uniformCanvas).then(canvas => {
        const a = document.createElement("a");
        a.href = canvas.toDataURL("image/png");
        a.download = "CAP_ClassA_Uniform.png";
        a.click();
      });
    };

    document.getElementById("downloadPDF").onclick = () => {
      html2canvas(uniformCanvas).then(canvas => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const imgData = canvas.toDataURL("image/png");
        pdf.addImage(imgData, "PNG", 10, 10, 180, 280);
        pdf.save("CAP_ClassA_Uniform.pdf");
      });
    };

    function addClonedImage(id, top, left, width, height) {
      const original = document.getElementById(id);
      const clone = original.cloneNode();
      clone.className = "layer";
      clone.style.top = top;
      clone.style.left = left;
      clone.style.width = width + "px";
      clone.style.height = height + "px";
      clone.style.display = "block";
      uniformCanvas.appendChild(clone);
    }
  </script>
</body>
</html>
