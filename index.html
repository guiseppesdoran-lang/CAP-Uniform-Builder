<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>CAP Uniform Builder — All Variants (CAPR 39-1)</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  :root{
    --bg:#eef1f5; --ink:#0d1b2a; --muted:#516079; --panel:#ffffff; --line:#cfd6df; --brand:#002855;
    --tileW:120px; --tileH:35px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
  header{background:var(--brand);color:#fff;padding:14px 16px;text-align:center}
  header h1{margin:0;font-size:18px}
  main{display:flex;gap:16px;align-items:stretch;min-height:calc(100vh - 60px)}
  #controls{width:410px;background:var(--panel);padding:14px;border-right:1px solid var(--line);overflow:auto}
  #stage{flex:1;padding:16px;display:flex;flex-direction:column;gap:14px}
  fieldset{border:1px solid var(--line);border-radius:10px;padding:10px}
  legend{padding:0 6px;color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,input[type="number"],input[type="text"]{padding:6px 8px;border:1px solid var(--line);border-radius:8px;background:#fff;min-height:34px}
  .btn{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
  .btn.primary{background:#0b5cff;color:#fff;border-color:#0b5cff}
  .hint{color:var(--muted);font-size:12px}

  #previewWrap{position:relative;display:inline-block;margin:auto;background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  #jacketStage{position:relative;width:740px;height:1100px;background:#f8f9fb;overflow:hidden;border-radius:10px}
  #jacketImg{position:absolute;inset:0;width:100%;height:100%;object-fit:contain}

  .layer{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
  #ribbonLayer{pointer-events:auto}
  .ribbon-tile{position:absolute;width:var(--tileW);height:var(--tileH);border-radius:6px;overflow:hidden;
    box-shadow:0 1px 1px rgba(0,0,0,.05), inset 0 0 0 1px #dcdcdc;background:linear-gradient(180deg,#e6e6e6,#d8d8d8)}
  .ribbon-tile img.ribbon{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .device-overlay{position:absolute;pointer-events:none;filter:drop-shadow(0 0 .5px rgba(0,0,0,.35))}
  .badge{position:absolute;image-rendering:auto}
  .nameplate{position:absolute;background:#0b273f;color:#fff;border-radius:2px;padding:2px 6px;font-size:12px;letter-spacing:.3px}

  #epauletLayer .board{position:absolute;width:100px;height:50px;image-rendering:auto}
  #epauletLayer .insignia{position:absolute;image-rendering:auto}

  #deviceTool button{padding:6px 10px;border:1px solid var(--line);background:#fff;border-radius:8px;cursor:pointer}
  #deviceTool button.active{outline:2px solid #2b7fff}
  #devicePicker{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}

  #regList{display:grid;gap:6px;margin-top:6px}
  .reg-ok{color:#0a7f2e}
  .reg-warn{color:#a66b00}
  .reg-err{color:#b00020}

  @media (max-width: 980px){
    main{flex-direction:column}
    #controls{width:auto;border-right:none;border-bottom:1px solid var(--line)}
    #jacketStage{width:92vw;height:calc(92vw*1.48)}
  }
</style>
</head>
<body>
<header><h1>CAP Uniform Builder — All Cadet & Senior Variants (CAPR 39-1)</h1></header>

<main>
  <aside id="controls">
    <fieldset>
      <legend>Member & Uniform</legend>
      <div class="row">
        <label>Member
          <select id="memberType">
            <option value="cadet">Cadet</option>
            <option value="senior">Senior Member</option>
          </select>
        </label>
        <label>Gender
          <select id="gender">
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </label>
        <label>Uniform
          <select id="uniformType"></select>
        </label>
      </div>
      <div class="row">
        <label>Grade
          <select id="gradeSelect"></select>
        </label>
        <button id="downloadBtn" class="btn primary">Download High-Res PNG</button>
      </div>
      <small class="hint">Uniform list is filtered by member type per CAPR 39-1.</small>
    </fieldset>

    <fieldset>
      <legend>Ribbons</legend>
      <div class="row">
        <select id="ribbonSelect"></select>
        <button id="addRibbonBtn" class="btn primary">Add</button>
        <button id="clearRibbonsBtn" class="btn">Clear All</button>
      </div>
      <small class="hint">Rack: rows of 3. Partial row (1–2) is top row and centered. Highest precedence at top-left.</small>
    </fieldset>

    <section id="deviceTool" style="margin-top:16px;border-top:1px solid var(--line);padding-top:12px">
      <h3 style="margin:0 0 8px 0;font-size:14px">Ribbon Devices (Click-to-Apply)</h3>

      <div id="devicePicker">
        <!-- Device checkboxes are built from ASSETS.devices below -->
      </div>

      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button id="deviceApplyModeBtn" type="button">Enable Apply Mode</button>
        <button id="deviceClearSelectionBtn" type="button">Clear Selection</button>
        <button id="deviceRemoveModeBtn" type="button">Enable Remove Mode</button>
      </div>
      <small class="hint">Choose devices + quantities → Enable → click a ribbon to apply. Remove Mode clears devices.</small>
    </section>

    <fieldset style="margin-top:16px">
      <legend>Badges & Insignia</legend>
      <div class="row">
        <select id="badgeSelect"></select>
        <button id="addBadgeBtn" class="btn">Add</button>
        <button id="clearBadgesBtn" class="btn">Clear</button>
      </div>
      <small class="hint">Placement follows CAPR 39-1 slot logic (OLP/OLPA/OLPU/ORP/ON/UN/LP/LRP).</small>
    </fieldset>

    <fieldset style="margin-top:16px">
      <legend>Regulation Checker (CAPR 39-1)</legend>
      <div id="regList"></div>
    </fieldset>
  </aside>

  <section id="stage">
    <fieldset>
      <legend>Preview</legend>
      <div id="previewWrap">
        <div id="jacketStage" aria-label="Uniform Preview">
          <img id="jacketImg" alt="Jacket"/>
          <div id="ribbonLayer" class="layer" aria-label="Ribbon Layer"></div>
          <div id="badgeLayer" class="layer" aria-label="Badge Layer"></div>
          <div id="epauletLayer" class="layer" aria-label="Epaulet/Rank Layer"></div>
        </div>
      </div>
      <div class="hint" style="margin-top:8px">Tip: Officer grades show shoulder boards; enlisted/cadet grades render on collar.</div>
    </fieldset>
  </section>
</main>

<script>
/* =========================================================
   ASSETS — update/add to match your repo.
   ABU images set per your paths.
   ========================================================= */
const ASSETS = {
  jackets: {
    // Use your specific ABU art:
    abu:          { male:"images/base/ABU_male.png",    female:"images/base/ABU_female.png" },

    // For other uniforms, point to your current base art (replace these if you have specific coats/shirts):
    blues_classA: { male:"images/base/jacket_male.png", female:"images/base/jacket_female.png" },
    blues_classB: { male:"images/base/jacket_male.png", female:"images/base/jacket_female.png" },
    corporate:    { male:"images/base/jacket_male.png", female:"images/base/jacket_female.png" },
    flightsuit:   { male:"images/base/jacket_male.png", female:"images/base/jacket_female.png" },
    mess:         { male:"images/base/jacket_male.png", female:"images/base/jacket_female.png" }
  },

  /* Example ribbons; extend with your full set */
  ribbons: [
    { id:'earhart',   name:'Earhart',    img:'images/ribbons/earhart_award.png',               precedence:1 },
    { id:'mitchell',  name:'Mitchell',   img:'images/ribbons/mitchell_award.png',              precedence:2 },
    { id:'dist_svc',  name:'Distinguished Service', img:'images/ribbons/distinguished_service_award.png', precedence:10 },
    { id:'community', name:'Community Service', img:'images/ribbons/community_service_ribbon.png',        precedence:120 }
  ],

  /* Devices — these three exist in your repo; add more if you add files */
  devices: {
    star_bronze: { label:"Bronze Star",  src:"images/devices/1_Bronze_Star_Device.webp",      width:12, height:12, weight:1 },
    star_silver: { label:"Silver Star",  src:"images/devices/1_Silver_Star_Device.webp",      width:12, height:12, weight:2 },
    propeller:   { label:"Propeller",    src:"images/devices/1_Bronze_Propeller_Device.webp", width:14, height:14, weight:3 }
    // If you add clasp/leaf images later, put them here and they'll auto-appear in the picker.
  },

  /* Badges — seed set mapped to your filenames; add the rest from images/badges/ */
  badges: {
    aviation_basic: { name:"Aviation (Basic)", src:"images/badges/CAPPilot1_FA9D33EA587D8.png", w:70, h:22, category:"aviation", precedence:100 },
    ground_team:    { name:"Ground Team",      src:"images/badges/ground_team_basic_badge.png", w:64, h:24, category:"occupational", precedence:200 },
    ems:            { name:"EMS",              src:"images/badges/emt_basic_badge.png",         w:64, h:24, category:"occupational", precedence:210 },
    model_rocketry: { name:"Model Rocketry",   src:"images/badges/model_rocketry_badge.png",    w:58, h:20, category:"lp_only", precedence:400 },
    marksmanship:   { name:"Marksmanship",     src:"images/badges/nra_marksman_badge.png",      w:58, h:20, category:"flap_only", precedence:500 }
  },

  /* Officer boards: your single board file used for both shoulders */
  officerBoards: {
    boardLeft:  { src:"images/ranks/C/shoulder_board.png", w:100, h:50, left:140, top:155, rotate:90 },
    boardRight: { src:"images/ranks/C/shoulder_board.png", w:100, h:50, left:500, top:155, rotate:-90 }
  },

  /* If/when you add officer/enlisted insignia files, map them here and they'll render automatically */
  officerInsignia: {
    // "2dLt": { src:"images/ranks/officer/2dLt.png", w:24, h:24, left:0, top:0 },
  },
  enlistedCollar: { male:{ left:280, top:175 }, female:{ left:280, top:175 } },
  enlistedInsignia: {
    // "C/AB":   { src:"images/ranks/enlisted/C-AB.png",   w:32, h:32, dx:0, dy:0 },
  }
};

/* =========================================================
   UNIFORMS (cadet vs senior availability)
   ========================================================= */
const UNIFORMS = [
  { id:"blues_classA", label:"Blues — Class A (Service Dress Coat)", cadet:true, senior:true },
  { id:"blues_classB", label:"Blues — Class B (Shirt)",              cadet:true, senior:true },
  { id:"corporate",    label:"Corporate (Aviator Gray)",             cadet:false, senior:true },
  { id:"flightsuit",   label:"Flight Suit",                           cadet:true, senior:true },
  { id:"abu",          label:"ABU / Utility",                         cadet:true, senior:true },
  { id:"mess",         label:"Mess Dress",                            cadet:false, senior:true } // Cadets not authorized
];

/* =========================================================
   SLOT MAPS & OFFSETS (tweak to match your art exactly)
   ========================================================= */
const UNIFORM_SLOTS = {
  blues_classA: {
    ribbonAnchor:{ x:370, y:500 },
    genderOffset:{ male:{x:0,y:0}, female:{x:0,y:-6} },
    slot:{ OLP:{x:320,y:460}, OLPA:{x:320,y:440}, OLPU:{x:320,y:480},
           ORP:{x:470,y:460}, ON:{x:470,y:422},  UN:{x:470,y:485},
           LP:{x:320,y:548}, RP:{x:470,y:548},   LRP:{x:320,y:536} }
  },
  blues_classB: {
    ribbonAnchor:{ x:370, y:450 },
    genderOffset:{ male:{x:0,y:0}, female:{x:0,y:-6} },
    slot:{ OLP:{x:320,y:402}, OLPA:{x:320,y:382}, OLPU:{x:320,y:422},
           ORP:{x:470,y:402}, ON:{x:470,y:364},  UN:{x:470,y:426},
           LP:{x:320,y:505}, RP:{x:470,y:505},   LRP:{x:320,y:494} }
  },
  corporate: {
    ribbonAnchor:{ x:370, y:450 },
    genderOffset:{ male:{x:0,y:0}, female:{x:0,y:-6} },
    slot:{ OLP:{x:320,y:405}, OLPA:{x:320,y:385}, OLPU:{x:320,y:425},
           ORP:{x:470,y:405}, ON:{x:470,y:368},  UN:{x:470,y:430},
           LP:{x:320,y:505}, RP:{x:470,y:505},   LRP:{x:320,y:495} }
  },
  flightsuit: {
    ribbonAnchor:{ x:370, y:450 },
    genderOffset:{ male:{x:0,y:0}, female:{x:0,y:-6} },
    slot:{ OLP:{x:320,y:395}, OLPA:{x:320,y:375}, OLPU:{x:320,y:415},
           ORP:{x:470,y:395}, ON:{x:470,y:358},  UN:{x:470,y:420},
           LP:{x:320,y:495}, RP:{x:470,y:495},   LRP:{x:320,y:485} }
  },
  abu: {
    ribbonAnchor:{ x:370, y:450 },
    genderOffset:{ male:{x:0,y:0}, female:{x:0,y:-6} },
    slot:{ OLP:{x:320,y:402}, OLPA:{x:320,y:382}, OLPU:{x:320,y:422},
           ORP:{x:470,y:402}, ON:{x:470,y:364},  UN:{x:470,y:426},
           LP:{x:320,y:505}, RP:{x:470,y:505},   LRP:{x:320,y:494} }
  },
  mess: {
    ribbonAnchor:{ x:370, y:450 },
    genderOffset:{ male:{x:0,y:0}, female:{x:0,y:-6} },
    slot:{ OLP:{x:320,y:405}, OLPA:{x:320,y:385}, OLPU:{x:320,y:425},
           ORP:{x:470,y:405}, ON:{x:470,y:368},  UN:{x:470,y:430},
           LP:{x:320,y:505}, RP:{x:470,y:505},   LRP:{x:320,y:495} }
  }
};

/* =========================================================
   RULES (CAPR 39-1 subset for layout checks)
   ========================================================= */
const RULES_39_1 = {
  cadet: { disallowedUniforms: new Set(["mess"]) },
  senior:{ disallowedUniforms: new Set([]) },

  caps: {
    maxAboveLeftPocket: 2,
    maxAboveRightPocket:2,
    maxOnNameArea: 2,
    maxFlapMarksman: 1,
    maxModelRocketry:1,
    maxTotalBadges: 5
  },

  badgePlacement: {
    aviation:            { slots:["OLPU","OLPA","OLP"], perSlotMax:2 },
    occupational:        { slots:["ORP"],               perSlotMax:2 },
    specialty_over_name: { slots:["ON","UN"],           perSlotMax:2 },
    lp_only:             { slots:["LP"],                perSlotMax:1 },
    flap_only:           { slots:["LRP"],               perSlotMax:1 }
  },

  categoryOrder: ["aviation","occupational","specialty_over_name","lp_only","flap_only"]
};

/* =========================================================
   GRADES (officer vs enlisted/cadet)
   ========================================================= */
const GRADES = [
  { id:"2dLt",  label:"2d Lt (Officer)", officer:true },
  { id:"1stLt", label:"1st Lt (Officer)", officer:true },
  { id:"Capt",  label:"Captain (Officer)", officer:true },
  { id:"Maj",   label:"Major (Officer)", officer:true },
  { id:"LtCol", label:"Lt Col (Officer)", officer:true },
  { id:"Col",   label:"Colonel (Officer)", officer:true },
  { id:"C/AB",   label:"C/AB",   officer:false },
  { id:"C/Amn",  label:"C/Amn",  officer:false },
  { id:"C/A1C",  label:"C/A1C",  officer:false },
  { id:"C/SrA",  label:"C/SrA",  officer:false },
  { id:"C/SSgt", label:"C/SSgt", officer:false },
  { id:"C/TSgt", label:"C/TSgt", officer:false },
  { id:"C/MSgt", label:"C/MSgt", officer:false },
  { id:"C/SMSgt",label:"C/SMSgt", officer:false },
  { id:"C/CMSgt",label:"C/CMSgt", officer:false }
];

/* =========================================================
   STATE
   ========================================================= */
let state = {
  memberType:"cadet",
  gender:"male",
  uniformType:"blues_classA",
  grade:"C/Amn",
  rack:[],
  badges:[],
  deviceApplyMode:false,
  deviceRemoveMode:false,
  selectedDevices:{}
};

/* =========================================================
   INIT
   ========================================================= */
document.addEventListener('DOMContentLoaded', () => init());

function init(){
  populateUniforms();
  populateRibbons();
  populateBadges();
  populateGrades();

  document.getElementById('memberType').addEventListener('change', e=>{
    state.memberType = e.target.value;
    populateUniforms();
    renderAll();
  });
  document.getElementById('gender').addEventListener('change', e=>{
    state.gender = e.target.value;
    renderAll();
  });
  document.getElementById('uniformType').addEventListener('change', e=>{
    state.uniformType = e.target.value;
    renderAll();
  });
  document.getElementById('gradeSelect').addEventListener('change', e=>{
    state.grade = e.target.value;
    renderEpauletsAndRank();
  });

  document.getElementById('addRibbonBtn').addEventListener('click', onAddRibbon);
  document.getElementById('clearRibbonsBtn').addEventListener('click', ()=>{
    state.rack = [];
    renderAll();
  });

  wireDeviceUI();
  buildDevicePicker();

  document.getElementById('addBadgeBtn').addEventListener('click', onAddBadge);
  document.getElementById('clearBadgesBtn').addEventListener('click', ()=>{
    state.badges = [];
    renderAll();
  });

  document.getElementById('downloadBtn').addEventListener('click', downloadHighRes);

  renderAll();
}

/* =========================================================
   POPULATE CONTROLS
   ========================================================= */
function populateUniforms(){
  const sel = document.getElementById('uniformType');
  const isCadet = state.memberType==="cadet";
  sel.innerHTML = "";
  UNIFORMS.forEach(u=>{
    if ((isCadet && u.cadet) || (!isCadet && u.senior)){
      const o = document.createElement('option');
      o.value=u.id; o.textContent=u.label; sel.appendChild(o);
    }
  });
  if (![...sel.options].some(o=>o.value===state.uniformType)){
    state.uniformType = sel.options[0]?.value || "blues_classA";
  }
  sel.value = state.uniformType;
}

function populateRibbons(){
  const sel = document.getElementById('ribbonSelect');
  const arr = [...ASSETS.ribbons].sort((a,b)=>a.precedence-b.precedence);
  sel.innerHTML = arr.map(r=>`<option value="${r.id}">${r.name||r.id}</option>`).join('');
}

function populateBadges(){
  const sel = document.getElementById('badgeSelect');
  sel.innerHTML = "";
  for (const [key,meta] of Object.entries(ASSETS.badges)){
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = meta.name || key.replace(/_/g,' ');
    sel.appendChild(opt);
  }
}

function populateGrades(){
  const sel = document.getElementById('gradeSelect');
  sel.innerHTML = GRADES.map(g=>`<option value="${g.id}">${g.label}</option>`).join('');
  sel.value = state.grade;
}

/* =========================================================
   DEVICE UI
   ========================================================= */
function buildDevicePicker(){
  const wrap=document.getElementById('devicePicker');
  wrap.innerHTML="";
  Object.entries(ASSETS.devices).forEach(([id,meta])=>{
    const row=document.createElement('label');
    row.style.cssText="display:flex;align-items:center;gap:8px";
    row.innerHTML=`
      <input type="checkbox" data-device="${id}"/><span>${meta.label||id}</span>
      <input type="number" min="1" max="10" value="1" data-qty="${id}" style="width:54px;margin-left:auto">
    `;
    wrap.appendChild(row);
  });
}

function wireDeviceUI(){
  const applyBtn = document.getElementById('deviceApplyModeBtn');
  const clearBtn = document.getElementById('deviceClearSelectionBtn');
  const removeBtn= document.getElementById('deviceRemoveModeBtn');

  applyBtn.addEventListener('click', ()=>{
    state.selectedDevices = readDevicePicker();
    const hasAny = Object.keys(state.selectedDevices).length>0;
    state.deviceApplyMode = hasAny;
    state.deviceRemoveMode = false;
    applyBtn.classList.toggle('active', state.deviceApplyMode);
    removeBtn.classList.remove('active');
    applyBtn.textContent = state.deviceApplyMode ? "Apply Mode: ON" : "Enable Apply Mode";
  });

  clearBtn.addEventListener('click', ()=>{
    const picker=document.getElementById('devicePicker');
    picker.querySelectorAll('input[type="checkbox"][data-device]').forEach(c=>c.checked=false);
    picker.querySelectorAll('input[type="number"][data-qty]').forEach(n=>n.value=1);
    state.selectedDevices = {};
    state.deviceApplyMode = false;
    state.deviceRemoveMode = false;
    document.getElementById('deviceApplyModeBtn').classList.remove('active');
    document.getElementById('deviceRemoveModeBtn').classList.remove('active');
    document.getElementById('deviceApplyModeBtn').textContent = "Enable Apply Mode";
  });

  removeBtn.addEventListener('click', ()=>{
    state.deviceRemoveMode = !state.deviceRemoveMode;
    state.deviceApplyMode = false;
    removeBtn.classList.toggle('active', state.deviceRemoveMode);
    applyBtn.classList.remove('active');
    applyBtn.textContent = "Enable Apply Mode";
  });
}

function readDevicePicker(){
  const picker=document.getElementById('devicePicker');
  const bundle={};
  picker.querySelectorAll('input[type="checkbox"][data-device]').forEach(chk=>{
    const id = chk.getAttribute('data-device');
    if (chk.checked){
      const qty = parseInt(picker.querySelector(`input[type="number"][data-qty="${id}"]`).value||"1",10);
      if (qty>0) bundle[id]=qty;
    }
  });
  return bundle;
}

/* =========================================================
   RIBBONS (rack rendering + click-to-apply devices)
   ========================================================= */
function onAddRibbon(){
  const id = document.getElementById('ribbonSelect').value;
  const meta = ASSETS.ribbons.find(r=>r.id===id);
  if (!meta) return;
  state.rack.push({ ...meta, devices:{} });
  renderRibbons();
  renderBadges(); // some badge offsets are relative
  runRegulationCheck();
}

function renderRibbons(){
  const layer = document.getElementById('ribbonLayer');
  layer.innerHTML = '';
  const slots = UNIFORM_SLOTS[state.uniformType] || UNIFORM_SLOTS.blues_classA;
  const gOff = slots.genderOffset?.[state.gender] || {x:0,y:0};
  const anchor = { x: (slots.ribbonAnchor.x + gOff.x), y: (slots.ribbonAnchor.y + gOff.y) };

  const sorted = [...state.rack].sort((a,b)=>a.precedence-b.precedence);
  const N=sorted.length, perRow=3, rem=N%perRow, topCount=(rem===0?perRow:rem);
  const vGap=8, tileW=120, tileH=35;

  const rows=[];
  if (N>0){
    rows.push(sorted.slice(0, topCount));
    for (let i=topCount;i<N;i+=perRow) rows.push(sorted.slice(i,i+perRow));
  }
  rows.forEach((rowItems, rIdx)=>{
    const totalW = rowItems.length*tileW + (rowItems.length-1)*6;
    let x = Math.round(anchor.x - totalW/2);
    const y = anchor.y + rIdx*(tileH+vGap);
    rowItems.forEach(ribbon=>{
      const tile = createRibbonTile(ribbon);
      tile.style.left = `${x}px`;
      tile.style.top  = `${y}px`;
      layer.appendChild(tile);
      x += tileW + 6;
    });
  });
}

function createRibbonTile(ribbon){
  const tile = document.createElement('div');
  tile.className='ribbon-tile';
  const img = document.createElement('img');
  img.className='ribbon';
  img.alt=ribbon.name||ribbon.id; img.src=ribbon.img;
  img.onerror=function(){ this.style.display='none'; tile.style.background='linear-gradient(90deg,#9bbcff,#6aa3ff)'; };
  tile.appendChild(img);
  // click to apply/remove devices
  makeRibbonClickableForDevices(tile, ribbon);
  drawDevicesOnTile(tile, ribbon);
  return tile;
}

function makeRibbonClickableForDevices(tileEl, ribbonObj){
  tileEl.style.cursor='pointer';
  tileEl.onclick = ()=>{
    if (state.deviceRemoveMode){
      ribbonObj.devices = {};
      renderRibbons();
      return;
    }
    if (!state.deviceApplyMode) return;
    ribbonObj.devices = ribbonObj.devices || {};
    for (const [devId,qty] of Object.entries(state.selectedDevices)){
      ribbonObj.devices[devId] = (ribbonObj.devices[devId]||0) + qty;
    }
    renderRibbons();
  };
}

function drawDevicesOnTile(tileEl, ribbonObj){
  tileEl.querySelectorAll('.device-overlay').forEach(n=>n.remove());
  const map = ribbonObj.devices||{};
  if (!Object.keys(map).length) return;

  const flat=[];
  for (const [devId,count] of Object.entries(map)){
    const meta = ASSETS.devices[devId];
    if (!meta) continue;
    for (let i=0;i<count;i++) flat.push({ id:devId, ...meta });
  }
  flat.sort((a,b)=> (b.weight-a.weight) || (a.label||a.id).localeCompare(b.label||b.id));

  const tileW=tileEl.clientWidth||120, tileH=tileEl.clientHeight||35, gap=3;
  const totalW = flat.reduce((s,d,i)=> s+d.width+(i>0?gap:0),0);
  let x = Math.round((tileW-totalW)/2);
  const y = Math.round((tileH-12)/2)-1;

  flat.forEach(d=>{
    const im=document.createElement('img');
    im.className='device-overlay';
    im.src=d.src; im.alt=d.label||d.id;
    im.style.left=`${x}px`; im.style.top=`${y}px`;
    im.style.width=`${d.width}px`; im.style.height=`${d.height}px`;
    im.onerror=function(){ this.remove(); const stub=document.createElement('div'); stub.className='device-overlay';
      stub.style.left=`${x}px`; stub.style.top=`${y}px`; stub.style.width=`${d.width}px`; stub.style.height=`${d.height}px`; stub.style.background="#222"; tileEl.appendChild(stub);
    };
    tileEl.appendChild(im);
    x += d.width + gap;
  });
}

/* =========================================================
   BADGES
   ========================================================= */
function onAddBadge(){
  const key = document.getElementById('badgeSelect').value;
  if (!key) return;
  const meta = ASSETS.badges[key];
  if (!meta) return;

  const chosen = chooseBadgeSlot(key, meta);
  if (!chosen){
    alert("No available slot for this badge based on CAPR 39-1 limits for the current uniform.");
    return;
  }
  state.badges.push({ key, category: meta.category, precedence: meta.precedence ?? 200,
    slot:chosen.slot, x:chosen.x, y:chosen.y, w:meta.w, h:meta.h });

  renderBadges();
  runRegulationCheck();
}

function chooseBadgeSlot(key, meta){
  const slotsMap = UNIFORM_SLOTS[state.uniformType]?.slot || {};
  const gOff    = UNIFORM_SLOTS[state.uniformType]?.genderOffset?.[state.gender] || {x:0,y:0};
  const rule    = RULES_39_1.badgePlacement[meta.category];
  const caps    = RULES_39_1.caps;

  const aboveLeft = countSlots(["OLP","OLPA","OLPU"]);
  const aboveRight= countSlots(["ORP"]);
  const nameArea  = countSlots(["ON","UN"]);
  const total     = state.badges.length;

  if (total >= caps.maxTotalBadges) return null;

  if (meta.category==="lp_only"){
    if (countSlot("LP") >= caps.maxModelRocketry) return null;
    const p = slotsMap["LP"]; if (!p) return null;
    return { slot:"LP", x:p.x+gOff.x, y:p.y+gOff.y };
  }
  if (meta.category==="flap_only"){
    if (countSlot("LRP") >= caps.maxFlapMarksman) return null;
    const p = slotsMap["LRP"]; if (!p) return null;
    return { slot:"LRP", x:p.x+gOff.x, y:p.y+gOff.y };
  }

  const pref = rule?.slots || [];
  for (const s of pref){
    const perSlotMax = rule.perSlotMax ?? 2;
    if (countSlot(s) >= perSlotMax) continue;

    if (["OLP","OLPA","OLPU"].includes(s) && aboveLeft >= caps.maxAboveLeftPocket) continue;
    if (s==="ORP" && aboveRight >= caps.maxAboveRightPocket) continue;
    if (["ON","UN"].includes(s) && nameArea >= caps.maxOnNameArea) continue;

    const p = slotsMap[s];
    if (!p) continue;
    return { slot:s, x:p.x+gOff.x, y:p.y+gOff.y };
  }
  return null;
}

function countSlot(slot){ return state.badges.filter(b=>b.slot===slot).length; }
function countSlots(list){ return state.badges.filter(b=>list.includes(b.slot)).length; }

function renderBadges(){
  const layer = document.getElementById('badgeLayer');
  layer.innerHTML = '';

  const catIndex = (c)=> RULES_39_1.categoryOrder.indexOf(c);
  const sorted = [...state.badges].sort((a,b)=>{
    const ca = catIndex(a.category), cb = catIndex(b.category);
    if (ca!==cb) return ca-cb;
    if (a.precedence!==b.precedence) return a.precedence-b.precedence;
    return a.key.localeCompare(b.key);
  });

  sorted.forEach(b=>{
    const meta = ASSETS.badges[b.key];
    if (!meta) return;
    const img = document.createElement('img');
    img.className='badge';
    img.src = meta.src;
    img.alt = meta.name || b.key;
    img.style.left = `${b.x}px`;
    img.style.top  = `${b.y + badgeVerticalAdjust(b.slot)}px`;
    img.style.width = `${b.w}px`;
    img.style.height= `${b.h}px`;
    img.onerror = ()=>{ img.style.display='none'; };
    layer.appendChild(img);
  });
}

function badgeVerticalAdjust(slot){
  if (["OLP","OLPA","OLPU"].includes(slot)) return -36;
  return 0;
}

/* =========================================================
   EPAULETS & RANK
   ========================================================= */
function renderEpauletsAndRank(){
  const layer = document.getElementById('epauletLayer');
  layer.innerHTML = '';
  const grade = state.grade;
  const isOfficer = GRADES.find(g=>g.id===grade)?.officer;

  if (isOfficer){
    const L = ASSETS.officerBoards?.boardLeft;
    const R = ASSETS.officerBoards?.boardRight;
    if (L && R){
      [L,R].forEach(b=>{
        const board = document.createElement('img');
        board.className='board';
        board.src=b.src; board.style.left=`${b.left}px`; board.style.top=`${b.top}px`;
        board.style.width=`${b.w}px`; board.style.height=`${b.h}px`;
        board.style.transform=`rotate(${b.rotate}deg)`;
        board.onerror=()=>{ board.style.display='none'; };
        layer.appendChild(board);
      });
    }

    const ins = ASSETS.officerInsignia?.[grade];
    if (ins && L && R){
      const leftIns = document.createElement('img');
      leftIns.className='insignia';
      leftIns.src=ins.src;
      leftIns.style.left = `${L.left + (L.w-ins.w)/2}px`;
      leftIns.style.top  = `${L.top  + (L.h-ins.h)/2}px`;
      leftIns.style.width = `${ins.w}px`;
      leftIns.style.height= `${ins.h}px`;
      leftIns.onerror=()=>{ leftIns.style.display='none'; };
      layer.appendChild(leftIns);

      const rightIns = document.createElement('img');
      rightIns.className='insignia';
      rightIns.src=ins.src;
      rightIns.style.left = `${R.left + (R.w-ins.w)/2}px`;
      rightIns.style.top  = `${R.top  + (R.h-ins.h)/2}px`;
      rightIns.style.width = `${ins.w}px`;
      rightIns.style.height= `${ins.h}px`;
      rightIns.onerror=()=>{ rightIns.style.display='none'; };
      layer.appendChild(rightIns);
    }
  } else {
    const base = ASSETS.enlistedCollar?.[state.gender];
    const ins  = ASSETS.enlistedInsignia?.[grade];
    if (base && ins){
      const collar = document.createElement('img');
      collar.className='insignia';
      collar.src=ins.src;
      collar.style.left = `${base.left + (ins.dx||0)}px`;
      collar.style.top  = `${base.top  + (ins.dy||0)}px`;
      collar.style.width = `${ins.w}px`;
      collar.style.height= `${ins.h}px`;
      collar.onerror=()=>{ collar.style.display='none'; };
      layer.appendChild(collar);
    }
  }
}

/* =========================================================
   REGULATION CHECK
   ========================================================= */
function runRegulationCheck(){
  const list = document.getElementById('regList');
  list.innerHTML = '';
  const issues = [];

  if (state.memberType==="cadet" && state.uniformType==="mess"){
    issues.push({level:'err', text:'Cadets may not wear Mess Dress (CAPR 39-1).'});
  }

  const caps = RULES_39_1.caps;
  const aboveLeft = countSlots(["OLP","OLPA","OLPU"]);
  const aboveRight= countSlots(["ORP"]);
  const nameArea  = countSlots(["ON","UN"]);
  const lrp       = countSlot("LRP");
  const lp        = countSlot("LP");
  const total     = state.badges.length;

  if (aboveLeft > caps.maxAboveLeftPocket) issues.push({level:'err', text:`Left pocket area > ${caps.maxAboveLeftPocket} badges.`});
  if (aboveRight> caps.maxAboveRightPocket) issues.push({level:'err', text:`Right pocket area > ${caps.maxAboveRightPocket} badges.`});
  if (nameArea  > caps.maxOnNameArea) issues.push({level:'err', text:`Over/Under name area > ${caps.maxOnNameArea} badges.`});
  if (lrp > caps.maxFlapMarksman) issues.push({level:'err', text:'Only one Marksmanship badge allowed on pocket flap (LRP).'});
  if (lp  > caps.maxModelRocketry) issues.push({level:'err', text:'Only one Model Rocketry badge allowed on left pocket (LP).'});
  if (total > caps.maxTotalBadges) issues.push({level:'err', text:`Total badges exceed ${caps.maxTotalBadges}.`});

  if (!issues.length) issues.push({level:'ok', text:'No violations detected with current rule set.'});

  issues.forEach(it=>{
    const div=document.createElement('div');
    div.textContent = `• ${it.text}`;
    div.className = it.level==='ok' ? 'reg-ok' : (it.level==='warn' ? 'reg-warn' : 'reg-err');
    list.appendChild(div);
  });
}

/* =========================================================
   DOWNLOAD
   ========================================================= */
async function downloadHighRes(){
  const target = document.getElementById('jacketStage');
  const canvas = await html2canvas(target, { scale:2, backgroundColor:'#ffffff', useCORS:true });
  const link = document.createElement('a');
  link.download = `CAP_${state.memberType}_${state.uniformType}_${state.gender}.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
}
</script>
</body>
</html>
