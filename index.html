<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAP Class A Blues Uniform Builder</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #eef1f5; }
    header { background-color: #002855; color: white; padding: 1rem; text-align: center; }
    main { display: flex; }
    #controls {
      width: 320px; background: white; padding: 1rem;
      border-right: 1px solid #ccc; overflow-y: auto;
      height: calc(100vh - 72px);
    }
    #preview {
      flex-grow: 1; background: #d1d8e0;
      display: flex; align-items: center; justify-content: center;
      position: relative; height: calc(100vh - 72px);
    }
    #uniformCanvas {
      position: relative; width: 900px; height: 1200px;
    }
    .layer { position: absolute; }
    label, select, button {
      display: block; margin: 0.5rem 0; width: 100%;
    }
    select, button { padding: 0.3rem; }
    .hidden-assets { display: none; }
  </style>
</head>
<body>
  <header>
    <h1>CAP Class A Blues Uniform Builder</h1>
  </header>
  <main>
    <section id="controls">
      <label for="ribbonSelect">Ribbons</label>
      <select id="ribbonSelect"></select>
      <button id="addRibbon">Add Ribbon</button>
      <button id="clearRibbons">Clear Ribbons</button>

      <label for="deviceSelect">Devices</label>
      <select id="deviceSelect"></select>
      <button id="addDevice">Add Device</button>

      <label for="badgeSelect">Badges</label>
      <select id="badgeSelect"></select>
      <button id="addBadge">Add Badge</button>

      <label for="rankSelect">Rank Insignia</label>
      <select id="rankSelect"></select>
      <button id="addRank">Add Rank</button>

      <button id="addNameplate">Add Nameplate</button>
      <button id="addUSInsignia">Add U.S. Collar Insignia</button>
      <button id="addCAPInsignia">Add CAP Collar Insignia</button>
      <label for="jacketSelect">Jacket</label>
      <select id="jacketSelect">
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
      <button id="changeJacket">Apply Jacket</button>
      <button id="downloadImage">Download Image</button>
    </section>
    <section id="preview">
      <div id="uniformCanvas"></div>
    </section>
  </main>

  <div class="hidden-assets" id="assets">
    <img id="jacket-male" src="images/base/jacket_male.png" style="display:none;">
    <img id="jacket-female" src="images/base/jacket_female.png" style="display:none;">
  </div>

  <script>
    const ribbonSelect = document.getElementById("ribbonSelect");
    const badgeSelect = document.getElementById("badgeSelect");
    const rankSelect = document.getElementById("rankSelect");
    const deviceSelect = document.getElementById("deviceSelect");
    const uniformCanvas = document.getElementById("uniformCanvas");
    const assetsContainer = document.getElementById("assets");

    let currentGender = "male";
    const selectedRibbons = [];

    const ribbonList = [
      "air_search_and_rescue_ribbon", "afa_award", "afsa_award", "armstrong_achievement", "bronze_medal_of_valor",
      "cadet_advisory_council_ribbon", "cadet_recruiter_ribbon", "cadet_special_activity_ribbon", "commander_commendation_award",
      "community_service_ribbon", "crisis_ribbon", "curry_achievement", "disaster_relief_ribbon", "dolittle_achievement",
      "distinguished_service_award", "earhart_award", "eaker_award", "encampment_ribbon", "exceptional_service_award",
      "goddard_achievement", "hap_arnold_achievement", "homeland_security_ribbon", "iace_ribbon", "lifesaving_award",
      "lindbergh_achievement", "mary_feik_achievement", "meritorious_service_award", "mitchell_award",
      "national_cadet_competition_ribbon", "national_color_guard_competition_ribbon", "national_commander_unit_citation_award",
      "red_service_ribbon", "rickenbacker_achievement", "search_find_ribbon", "silver_medal_of_valor", "spaatz_award",
      "unit_citation_award", "vfw_nco_award", "vfw_officer_award", "wright_brothers_award"
    ];

    const deviceList = [
      "1_Bronze_Star_Device", "1_Silver_Star_Device"
    ];

    const rankList = [
      "c_ab", "c_amn", "c_a1c", "c_sra", "c_ssgt", "c_tsgt", "c_msgt",
      "c_smsgt", "c_cmsgt", "c_2dlt", "c_1stlt", "c_capt", "c_maj", "c_ltcol", "c_col"
    ];

    const badgeList = [
      "aviation_badge", "gtm_badge"
    ];

    function populateDropdown(selectElement, list) {
      selectElement.innerHTML = "";
      list.forEach(item => {
        const option = document.createElement("option");
        option.value = item;
        option.textContent = item.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
        selectElement.appendChild(option);
      });
    }

    function preloadImages(prefix, list, folder) {
      list.forEach(item => {
        const img = document.createElement("img");
        img.id = `${prefix}-${item}`;
        img.src = `images/${folder}/${item}.png`;
        img.style.display = "none";
        assetsContainer.appendChild(img);
      });
    }

    populateDropdown(ribbonSelect, ribbonList);
    populateDropdown(deviceSelect, deviceList);
    populateDropdown(rankSelect, rankList);
    populateDropdown(badgeSelect, badgeList);

    preloadImages("ribbons", ribbonList, "ribbons");
    preloadImages("devices", deviceList, "devices");
    preloadImages("ranks", rankList, "ranks");
    preloadImages("badges", badgeList, "badges");

    function applyJacket(type) {
      currentGender = type;
      document.querySelectorAll(".layer.jacket").forEach(el => el.remove());
      const jacketImg = document.getElementById(`jacket-${type}`);
      const clone = jacketImg.cloneNode();
      clone.className = "layer jacket";
      clone.style.top = "150px";
      clone.style.left = "0px";
      clone.style.width = "100%";
      clone.style.height = "auto";
      clone.style.display = "block";
      uniformCanvas.appendChild(clone);
    }

    function renderRibbons() {
      document.querySelectorAll(".layer.ribbon").forEach(el => el.remove());
      const sorted = [...selectedRibbons].sort((a, b) => ribbonList.indexOf(a) - ribbonList.indexOf(b));
      const total = sorted.length;

      let ribbonWidth = 30;
      let ribbonHeight = 10;
      let spacing = 4;
      let startTop = 370;
      let startLeft = 300;

      let rows = Math.ceil(total / 3);
      for (let i = 0; i < total; i++) {
        let indexFromBottom = total - 1 - i;
        let row = Math.floor(indexFromBottom / 3);
        let col = indexFromBottom % 3;
        let x = startLeft + col * (ribbonWidth + spacing);
        let y = startTop - row * (ribbonHeight + spacing);

        if (total % 3 === 1 && i === 0) x = startLeft + ribbonWidth + spacing;
        if (total % 3 === 2 && i === 0) x = startLeft + (ribbonWidth / 2);
        if (total % 3 === 2 && i === 1) x = startLeft + (ribbonWidth * 1.5) + spacing;

        const original = document.getElementById(`ribbons-${sorted[i]}`);
        const clone = original.cloneNode();
        clone.className = "layer ribbon";
        clone.style.top = `${y - ribbonHeight}px`;
        clone.style.left = `${x}px`;
        clone.style.width = `${ribbonWidth}px`;
        clone.style.height = `${ribbonHeight}px`;
        clone.style.display = "block";
        uniformCanvas.appendChild(clone);
      }
    }

    function renderBadge(key) {
      const original = document.getElementById(`badges-${key}`);
      const clone = original.cloneNode();
      clone.className = "layer badge";
      clone.style.top = currentGender === "female" ? "670px" : "660px";
      clone.style.left = currentGender === "female" ? "100px" : "110px";
      clone.style.width = "60px";
      clone.style.height = "60px";
      clone.style.display = "block";
      uniformCanvas.appendChild(clone);
    }

    function renderRank(key) {
      const original = document.getElementById(`ranks-${key}`);
      const clone = original.cloneNode();
      clone.className = "layer rank";
      clone.style.top = currentGender === "female" ? "180px" : "170px";
      clone.style.left = currentGender === "female" ? "270px" : "280px";
      clone.style.width = "50px";
      clone.style.height = "50px";
      clone.style.display = "block";
      uniformCanvas.appendChild(clone);
    }

    applyJacket(currentGender);

    document.getElementById("changeJacket").onclick = () => {
      const jacketType = document.getElementById("jacketSelect").value;
      applyJacket(jacketType);
    };

    document.getElementById("addRibbon").onclick = () => {
      const key = ribbonSelect.value;
      if (!selectedRibbons.includes(key)) {
        selectedRibbons.push(key);
        renderRibbons();
      } else {
        alert("Ribbon already added.");
      }
    };

    document.getElementById("clearRibbons").onclick = () => {
      selectedRibbons.length = 0;
      renderRibbons();
    };

    document.getElementById("addBadge").onclick = () => {
      const key = badgeSelect.value;
      renderBadge(key);
    };

    document.getElementById("addRank").onclick = () => {
      const key = rankSelect.value;
      renderRank(key);
    };
  </script>
</body>
</html>
