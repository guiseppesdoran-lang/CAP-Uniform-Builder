<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CAP Uniform Builder — Aviator Badge Rules (ICL 25-02)</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  :root{ --bg:#eef1f5; --ink:#0d1b2a; --muted:#516079; --panel:#ffffff; --line:#cfd6df; --brand:#002855; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
  header{background:var(--brand);color:#fff;padding:14px 16px;text-align:center}
  header h1{margin:0;font-size:18px;letter-spacing:.3px}
  main{display:flex}
  #controls{width:360px;background:var(--panel);padding:14px;border-right:1px solid var(--line);overflow:auto;height:calc(100vh - 58px)}
  #preview{flex:1;background:#d1d8e0;display:flex;align-items:flex-start;justify-content:center;position:relative;height:calc(100vh - 58px)}
  #uniformCanvas{position:relative;width:900px;height:1200px;transform-origin:top left}
  .layer{position:absolute;image-rendering:auto}
  label{font-size:12px;color:var(--muted);margin-top:8px;display:block}
  select,button,input{width:100%;margin-top:6px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#f8fafc}
  button{cursor:pointer;background:#0f2a54;color:#fff;border-color:#163766}
  button.ghost{background:#ffffff;color:var(--ink)}
  .row{display:flex;gap:8px}
  .two .col{flex:1}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  @media (max-width: 1024px){
    main{flex-direction:column}
    #controls{width:100%;height:auto;border-right:none;border-bottom:1px solid var(--line)}
    #preview{height:calc(100vh - 320px)}
  }
</style>
</head>
<body>
<header><h1>CAP Uniform Builder — Aviator Shirt (ICL 25-02 Rules)</h1></header>

<main>
  <section id="controls">
    <div class="row two">
      <div class="col">
        <label>Member</label>
        <select id="memberSelect">
          <option value="cadet">Cadet</option>
          <option value="senior">Senior</option>
        </select>
      </div>
      <div class="col">
        <label>Gender</label>
        <select id="genderSelect">
          <option value="male">Male (Men’s Aviator)</option>
          <option value="female">Female (Women’s Aviator)</option>
        </select>
      </div>
    </div>

    <label>Uniform Base</label>
    <select id="uniformSelect">
      <option value="aviator">Aviator Shirt</option>
    </select>

    <div class="row two">
      <div class="col">
        <label>Asset Base</label>
        <input id="assetBase" value="images" placeholder="images"/>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button id="applyBase" class="ghost">Apply Base</button>
      </div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid var(--line)">

    <label>Add Badge</label>
    <div class="row two">
      <div class="col"><select id="badgeSelect"></select></div>
      <div class="col"><button id="addBadge">Add</button></div>
    </div>
    <div class="row two" style="margin-top:6px">
      <div class="col"><select id="removeBadgeSelect"></select></div>
      <div class="col"><button id="removeBadge" class="ghost">Remove</button></div>
    </div>

    <div class="hint">
      Rules enforced: ≤4 total (commander pin excluded); ≤2 aviation/occupational on left; Rocketry left pocket only; NRA marksmanship on top edge of left pocket flap (only one); National Cmdr Staff always right; SAG/CC/NB/NEC always left; Women may use alternate pattern over nametag.
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid var(--line)">

    <div class="row two">
      <div class="col"><button id="downloadImage">Download PNG</button></div>
      <div class="col"><button id="clearAll" class="ghost">Clear All</button></div>
    </div>
    <div class="hint">Canvas auto-scales with window size.</div>
  </section>

  <section id="preview">
    <div id="uniformCanvas" aria-label="Uniform canvas"></div>
  </section>
</main>

<!-- hidden preloads -->
<div id="assets" style="display:none"></div>

<script>
/* ========== State & helpers ========== */
const State = {
  member: 'cadet',
  gender: 'male',        // 'male'|'female'
  uniform: 'aviator',
  assetBase: 'images',
  badges: []             // array of badge ids user added (any order)
};
const $ = s => document.querySelector(s);
const uniformCanvas = $('#uniformCanvas');
const assetsContainer = $('#assets');

function ASSET(p){
  const b=(State.assetBase||'images').replace(/\/$/,'');
  return `${b}/${p}`;
}

/* ========== Minimal base art ========== */
const BASES = {
  aviator: {
    male:   'base/aviator_male.png',
    female: 'base/aviator_female.png'
  }
};

/* ========== Badge catalog & metadata (map IDs → category/priority/asset path/size) ========== */
/* Categories we reason on:
   AVN (aviation), OCC (occupational), SRV (service), SPC (specialty track), STEM, CYB, ROCK (model rocketry), NRA, CMD (commander pin),
   NSTF (National Cmdr Staff), COUNCIL (SAG/CC/NB/NEC), OTHER
*/
const BADGE_META = {
  // --- Aviation / Occupational examples ---
  'CAPPilot1':          {cat:'AVN',  img:'badges/CAPPilot1_FA9D33EA587D8.png', w:60, h:25, capAero:true},
  'CAPObserver1':       {cat:'AVN',  img:'badges/observer_badge.png', w:60, h:25, capAero:true},
  'Chaplain':           {cat:'OCC',  img:'badges/christian_chaplin.png', w:60, h:60, chaplain:true},
  'IT_Tech':            {cat:'OCC',  img:'badges/information_technology_technician_badge.png', w:60, h:60},

  // --- Service/Specialty/STEM/Cyber/Rocketry/NRA ---
  'ServiceBadge':       {cat:'SRV',  img:'badges/emergency_services_badge.png', w:60, h:60},
  'Specialty_Admin':    {cat:'SPC',  img:'badges/historian_technicianIbadge.png', w:60, h:60},
  'STEM':               {cat:'STEM', img:'badges/stem_badges.png', w:60, h:25},
  'Cyber':              {cat:'CYB',  img:'badges/cyber_badges.png', w:60, h:25},
  'ModelRocketry':      {cat:'ROCK', img:'badges/model_rocketry_badge.png', w:7,  h:28.125},
  'NRA_Marksman':       {cat:'NRA',  img:'badges/nra_marksman_badge.png', w:40, h:60},

  // --- Commander insignia, staff/council ---
  'Command_Pin':        {cat:'CMD',  img:'badges/command_pin.png', w:18, h:18},
  'National_Staff':     {cat:'NSTF', img:'badges/national_staff.png', w:60, h:25},
  'SAG_or_Council':     {cat:'COUNCIL', img:'badges/council.png', w:60, h:25},

  // --- Fallback example ---
  'OtherBadge':         {cat:'OTHER', img:'badges/other.png', w:50, h:20}
};

// Allowed list to show in UI (adjust for your assets)
const BADGE_LIST = Object.keys(BADGE_META);

/* ========== UI populate ========== */
function populate(sel, list){
  sel.innerHTML='';
  list.forEach(v=>{
    const o=document.createElement('option');
    o.value=v;
    o.textContent=v.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    sel.appendChild(o);
  });
}
function populateRemover(){
  const sel=$('#removeBadgeSelect');
  sel.innerHTML='';
  State.badges.forEach(id=>{
    const o=document.createElement('option');
    o.value=id; o.textContent=id;
    sel.appendChild(o);
  });
}
populate($('#badgeSelect'), BADGE_LIST);

/* ========== Preload assets ========== */
function preloadImg(id, src){
  const img=document.createElement('img');
  img.id=`badge-${id}`;
  img.src=ASSET(src);
  img.style.display='none';
  assetsContainer.appendChild(img);
}
for(const [id,meta] of Object.entries(BADGE_META)){
  preloadImg(id, meta.img);
}

/* ========== Base render & scaling ========== */
function clearLayers(cls){
  uniformCanvas.querySelectorAll(cls?`.layer.${cls}`:'.layer').forEach(n=>n.remove());
}
function applyBase(){
  clearLayers('base');
  const img=document.createElement('img');
  img.className='layer base';
  img.src=ASSET(BASES[State.uniform][State.gender]);
  img.style.top='150px';
  img.style.left='0px';
  img.style.width='100%';
  img.style.height='auto';
  img.style.display='block';
  uniformCanvas.appendChild(img);
}
function fitToContainer(){
  // Scale canvas to fit visible preview while keeping aspect
  const container = $('#preview');
  const canvasW = 900, canvasH = 1200;
  const pad = 16;
  const maxW = container.clientWidth - pad*2;
  const maxH = container.clientHeight - pad*2;
  const scale = Math.max(0.2, Math.min(maxW/canvasW, maxH/canvasH));
  uniformCanvas.style.transform = `scale(${scale})`;
}
window.addEventListener('resize', fitToContainer);

/* ========== Slot definitions (pixel guides for our base art) ========== */
/* Coordinates reference the 900x1200 canvas, with the shirt base anchored at top:150px.
   We'll define anchor points for:
   - Left pocket lower area (LPK), Right pocket lower (RPK)
   - Left pocket flap top edge center (LPK_FLAP_CENTER) for NRA
   - Above ribbons/left pocket (L_OVER) stack for Aviation/Occupational (½" above ribbons/pocket) — we approximate fixed y
   - Over nameplate right region (RNAMETAG) for men 3rd badge & women alternate pattern
   - Women alternate second badge offset right by “½ inch” → we simulate with px spacing
*/
const PX = {
  // pockets (approx) on our base art — tune to your template
  LPK:  { x: 155, y: 460 },   // lower-left pocket center for service/specialty/etc. (men 1st)
  RPK:  { x: 475, y: 460 },   // lower-right pocket center (men 2nd)
  LPK_FLAP_CENTER: { x: 155, y: 430 }, // for NRA marksmanship top edge of flap (centered)

  // ribbons area: in your art from earlier, ribbons start ~402 top baseline; ½" above → use ~380
  L_OVER_1: { x: 330, y: 375 },  // Left above ribbons/pocket (first AVN/OCC)
  L_OVER_STEP: 28,               // vertical step (½″) for second

  // nameplate baseline on right pocket (men): y ~ 440; ½″ above ≈ 28px up
  RNAMETAG: { x: 475, y: 412 },  // center over nametag (½″ above)

  // Women alternate second badge: same y, but shift x by +30px to the right (approx ½″ spacing)
  WOMEN_ALT_DX: 30,

  // Commander pin sits above nametag if present; stack ½″ above anything over nametag
  CMD_STEP: 28
};

/* ========== Rule engine: normalize, slot, then render ========== */
function enforceRulesAndComputeLayout(){
  // 1) Prepare working arrays by category
  const items = State.badges.map(id=>({id, meta: BADGE_META[id]})).filter(b=>!!b.meta);

  // 2) Eligibility gates based on member type
  const isCadet = State.member === 'cadet';
  const isSenior = State.member === 'senior';

  const isService = b=> b.meta.cat==='SRV';
  const isSTEMcyber = b=> b.meta.cat==='STEM' || b.meta.cat==='CYB';
  const isRock = b=> b.meta.cat==='ROCK';
  const isNRA = b=> b.meta.cat==='NRA';
  const isAviOcc = b=> b.meta.cat==='AVN' || b.meta.cat==='OCC';
  const isCmd = b=> b.meta.cat==='CMD';
  const isNatStaff = b=> b.meta.cat==='NSTF';
  const isCouncil = b=> b.meta.cat==='COUNCIL';

  // Service badges: officers/NCOs only; STEM/Cyber/Rocketry/NRA cadets only (enforced in placement too)
  let filtered = items.filter(b=>{
    if(isService(b) && !isSenior) return false; // service only for seniors (officers/NCOs) per reg
    if((isSTEMcyber(b) || isRock(b) || isNRA(b)) && !isCadet) return false;
    return true;
  });

  // 3) Count limits
  // Commander pin does not count toward 4; everything else does. Keep a stable order by priority buckets.
  const cmd = filtered.filter(isCmd);
  filtered = filtered.filter(b=>!isCmd(b));

  // splash “special location” badges that are always on a side regardless of count
  const natRight = filtered.filter(isNatStaff);       // National Commander’s Staff → right
  const councilLeft = filtered.filter(isCouncil);     // SAG/Command Council/NB/NEC → left

  filtered = filtered.filter(b=>!isNatStaff(b) && !isCouncil(b));

  // Aviation/Occupational max 2 on left; with precedence: Chaplain highest, then highest CAP aero (pilot before observer)
  let aviOcc = filtered.filter(isAviOcc);
  // sort avi/occ: Chaplain first, then CAP aero (capAero:true), then others
  aviOcc.sort((a,b)=>{
    const aC = a.meta.chaplain?1:0, bC=b.meta.chaplain?1:0;
    if(bC-aC) return bC-aC;
    const aA = a.meta.capAero?1:0, bA=b.meta.capAero?1:0;
    if(bA-aA) return bA-aA;
    return 0;
  });
  aviOcc = aviOcc.slice(0,2); // at most two
  filtered = filtered.filter(b=>!isAviOcc(b));

  // NRA Marksmanship: only one
  const nra = filtered.filter(isNRA).slice(0,1);
  filtered = filtered.filter(b=>!isNRA(b));

  // Model Rocketry: keep at most one (common real-world case)
  const rock = filtered.filter(isRock).slice(0,1);
  filtered = filtered.filter(b=>!isRock(b));

  // Everything left that can occupy Service/Specialty/etc lanes:
  let svcEtc = filtered.filter(b=> isService(b) || isSTEMcyber(b) || b.meta.cat==='SPC' || b.meta.cat==='OTHER');

  // Now enforce overall max count of 4 (excluding cmd). We must also include aviOcc, nra, rock, natRight, councilLeft in the count.
  let combined = [...aviOcc, ...nra, ...rock, ...natRight, ...councilLeft, ...svcEtc];
  // Determine “counted” items: commander excluded. All others counted.
  const counted = combined.length;

  // Slice to four counted (but keep commander aside)
  if (counted > 4){
    // Keep priorities: (1) avi/occ, (2) council/national staff (they have fixed sides), (3) nra/rock, (4) svcEtc
    const prio = (b)=>{
      if(isAviOcc(b)) return 1;
      if(isCouncil(b) || isNatStaff(b)) return 2;
      if(isNRA(b) || isRock(b)) return 3;
      return 4;
    };
    combined.sort((a,b)=> prio(a)-prio(b));
    combined = combined.slice(0,4);
  }

  // Rebuild buckets from the truncated set
  aviOcc      = combined.filter(isAviOcc);
  const natR  = combined.filter(isNatStaff);
  const counL = combined.filter(isCouncil);
  const nraF  = combined.filter(isNRA);
  const rockF = combined.filter(isRock);
  svcEtc      = combined.filter(b=> !isAviOcc(b) && !isNRA(b) && !isRock(b) && !isNatStaff(b) && !isCouncil(b));

  // 4) Compute positions per gender rules
  const placements = [];

  // --- Aviation & Occupational (left over ribbons/pocket), stacked with ½″ spacing ---
  if(aviOcc.length){
    const first = aviOcc[0];
    placements.push({id:first.id, x:PX.L_OVER_1.x, y:PX.L_OVER_1.y});
    if(aviOcc[1]){
      placements.push({id:aviOcc[1].id, x:PX.L_OVER_1.x, y:PX.L_OVER_1.y - PX.L_OVER_STEP});
    }
  }

  // --- Side mandates ---
  // National Staff always right; Council always left
  for(const b of natR){
    placements.push({id:b.id, x:PX.RNAMETAG.x, y:PX.RNAMETAG.y});  // place over nametag area on right
  }
  for(const b of counL){
    placements.push({id:b.id, x:PX.LPK.x, y:PX.LPK.y});  // left side; use left-pocket area
  }

  // --- Men vs Women logic for service/specialty/STEM/Cyber/etc ---
  const gender = State.gender;

  if(gender==='male'){
    // Men’s: 1st = lower left pocket, 2nd = right pocket, 3rd = ½″ above nametag
    const first = svcEtc[0]; if(first) placements.push({id:first.id, x:PX.LPK.x, y:PX.LPK.y});
    const second = svcEtc[1]; if(second) placements.push({id:second.id, x:PX.RPK.x, y:PX.RPK.y});
    const third = svcEtc[2]; if(third) placements.push({id:third.id, x:PX.RNAMETAG.x, y:PX.RNAMETAG.y});
  } else {
    // Women alternate (this demo uses alternate pattern by default):
    // 1st = right, ½″ above nametag; 2nd = same height, spaced ½″ to the right
    const first = svcEtc[0]; if(first) placements.push({id:first.id, x:PX.RNAMETAG.x, y:PX.RNAMETAG.y});
    const second = svcEtc[1]; if(second) placements.push({id:PX.RNAMETAG.x + PX.WOMEN_ALT_DX, y:PX.RNAMETAG.y, id:second.id});
    // Any remaining (e.g., third) we fall back to men’s “third” position over nametag for simplicity
    const third = svcEtc[2]; if(third) placements.push({id:third.id, x:PX.RNAMETAG.x, y:PX.RNAMETAG.y - PX.CMD_STEP});
  }

  // --- Model Rocketry & NRA specifics ---
  // Rocketry: only left pocket. If women have already badges over nametag, keep Rocketry on left pocket too.
  if(rockF[0]){
    placements.push({id:rockF[0].id, x:PX.LPK.x, y:PX.LPK.y});
  }

  // NRA: top edge of left pocket flap, centered (only one)
  if(nraF[0]){
    placements.push({id:nraF[0].id, x:PX.LPK_FLAP_CENTER.x, y:PX.LPK_FLAP_CENTER.y});
  }

  // --- Commander Insignia (does not count), place above any over-nametag items on right ---
  // If present, stack ½″ above the highest thing at RNAMETAG area
  if(cmd.length){
    // find highest y (smallest value) among placements near RNAMETAG.x
    let highestY = PX.RNAMETAG.y;
    placements.forEach(p=>{
      if(Math.abs(p.x - PX.RNAMETAG.x) <= 40){ highestY = Math.min(highestY, p.y); }
    });
    placements.push({id:cmd[0].id, x:PX.RNAMETAG.x, y:highestY - PX.CMD_STEP});
  }

  return placements;
}

/* ========== Render badges ========== */
function renderBadges(){
  clearLayers('badge');
  const placements = enforceRulesAndComputeLayout();

  // Draw
  for(const {id,x,y} of placements){
    const meta = BADGE_META[id];
    const srcEl = document.getElementById('badge-'+id);
    const el = srcEl ? srcEl.cloneNode() : new Image();
    if(!srcEl){ el.src = ASSET(meta.img); }
    el.className='layer badge';
    el.style.display='block';
    el.style.left = `${x - (meta.w/2)}px`;
    el.style.top  = `${y - (meta.h/2)}px`;
    el.style.width  = `${meta.w}px`;
    el.style.height = `${meta.h}px`;
    uniformCanvas.appendChild(el);
  }
}

/* ========== Orchestrator ========== */
function fullRender(){
  applyBase();
  renderBadges();
  fitToContainer();
}

/* ========== Handlers ========== */
$('#applyBase').onclick = ()=>{ State.assetBase=$('#assetBase').value.trim()||'images'; fullRender(); };
$('#memberSelect').onchange=(e)=>{ State.member=e.target.value; fullRender(); };
$('#genderSelect').onchange=(e)=>{ State.gender=e.target.value; fullRender(); };
$('#badgeSelect').onchange=()=>{};
$('#addBadge').onclick=()=>{
  const id=$('#badgeSelect').value;
  if(!State.badges.includes(id)) State.badges.push(id);
  populateRemover(); fullRender();
};
$('#removeBadge').onclick=()=>{
  const id=$('#removeBadgeSelect').value;
  State.badges = State.badges.filter(b=>b!==id);
  populateRemover(); fullRender();
};
$('#clearAll').onclick=()=>{
  State.badges = [];
  populateRemover(); fullRender();
};
$('#downloadImage').onclick=()=>{
  html2canvas(uniformCanvas,{scale:3}).then(c=>{
    const a=document.createElement('a');
    a.download=`CAP_Aviator_${Date.now()}.png`;
    a.href=c.toDataURL();
    a.click();
  });
};

/* ========== Boot ========== */
(function init(){
  applyBase();
  populateRemover();
  fitToContainer();
})();
</script>
</body>
</html>
